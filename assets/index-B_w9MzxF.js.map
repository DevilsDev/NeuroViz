{"version":3,"mappings":"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C,EAAG,CAAC,IAAM,KAAO,CAAC,EAAG,CAAC,GAAM,IAAM,CAAC,EAAG,CAAC,IAAM,KAAO,CAAC,EACtF,CAAC,IAAM,IAAM,CAAC,EAAG,CAAC,IAAM,KAAO,CAAC,EAAG,CAAC,GAAM,KAAO,CAAC,EAAG,CAAC,IAAM,EAAM,CAAC,EAAG,CAAC,IAAM,IAAM,CAAC,EACpF,CAAC,IAAM,IAAM,CAAC,EAAG,CAAC,IAAM,IAAM,CAAC,EAAG,CAAC,IAAM,KAAO,CAAC,EAAG,CAAC,IAAM,IAAM,CAAC,EAAG,CAAC,IAAM,KAAO,CAAC,EACpF,CAAC,IAAM,IAAM,CAAC,EAAG,CAAC,IAAM,KAAO,CAAC,EAAG,CAAC,IAAM,KAAO,CAAC,EAAG,CAAC,IAAM,IAAM,CAAC,EAAG,CAAC,GAAM,KAAO,CAAC,EACrF,CAAC,IAAM,KAAO,CAAC,EAAG,CAAC,IAAM,EAAM,CAAC,EAAG,CAAC,IAAM,KAAO,CAAC,EAAG,CAAC,GAAM,IAAM,CAAC,EAAG,CAAC,IAAM,KAAO,CAAC,EACrF,CAAC,IAAM,IAAM,CAAC,EAAG,CAAC,IAAM,KAAO,CAAC,EAAG,CAAC,IAAM,KAAO,CAAC,EAAG,CAAC,IAAM,IAAM,CAAC,EAAG,CAAC,IAAM,IAAM,CAAC,EACpF,CAAC,IAAM,KAAO,CAAC,EAAG,CAAC,IAAM,IAAM,CAAC,EAAG,CAAC,IAAM,EAAM,CAAC,EAAG,CAAC,GAAM,KAAO,CAAC,EAAG,CAAC,IAAM,KAAO,CAAC,EACrF,CAAC,IAAM,IAAM,CAAC,EAAG,CAAC,IAAM,KAAO,CAAC,EAAG,CAAC,IAAM,KAAO,CAAC,EAAG,CAAC,IAAM,IAAM,CAAC,EAAG,CAAC,GAAM,KAAO,CAAC,EACrF,CAAC,IAAM,KAAO,CAAC,EAAG,CAAC,IAAM,IAAM,CAAC,EAAG,CAAC,IAAM,IAAM,CAAC,EAAG,CAAC,IAAM,KAAO,CAAC,EAAG,CAAC,IAAM,KAAO,CAAC,EACrF,CAAC,IAAM,EAAM,CAAC,EAAG,CAAC,IAAM,KAAO,CAAC,EAAG,CAAC,IAAM,IAAM,CAAC,EAAG,CAAC,IAAM,KAAO,CAAC,EAAG,CAAC,GAAM,IAAM,CAAC,EACpF,CAAC,IAAM,KAAO,CAAC,EAAG,CAAC,IAAM,KAAO,CAAC,EAAG,CAAC,IAAM,IAAM,CAAC,EAAG,CAAC,IAAM,EAAM,CAAC,EAEnE,CAAC,KAAO,IAAM,CAAC,EAAG,CAAC,KAAO,IAAM,CAAC,EAAG,CAAC,KAAO,IAAM,CAAC,EAAG,CAAC,KAAO,IAAM,CAAC,EAAG,CAAC,KAAO,IAAM,CAAC,EACvF,CAAC,KAAO,IAAM,CAAC,EAAG,CAAC,IAAO,IAAM,CAAC,EAAG,CAAC,KAAO,IAAM,CAAC,EAAG,CAAC,KAAO,IAAM,CAAC,EAAG,CAAC,KAAO,IAAM,CAAC,EACvF,CAAC,KAAO,IAAM,CAAC,EAAG,CAAC,KAAO,IAAM,CAAC,EAAG,CAAC,KAAO,IAAM,CAAC,EAAG,CAAC,KAAO,IAAM,CAAC,EAAG,CAAC,KAAO,IAAM,CAAC,EACvF,CAAC,KAAO,IAAM,CAAC,EAAG,CAAC,KAAO,IAAM,CAAC,EAAG,CAAC,KAAO,IAAM,CAAC,EAAG,CAAC,KAAO,IAAM,CAAC,EAAG,CAAC,KAAO,IAAM,CAAC,EACvF,CAAC,IAAO,IAAM,CAAC,EAAG,CAAC,KAAO,IAAM,CAAC,EAAG,CAAC,KAAO,IAAM,CAAC,EAAG,CAAC,KAAO,IAAM,CAAC,EAAG,CAAC,KAAO,IAAM,CAAC,EACvF,CAAC,KAAO,IAAM,CAAC,EAAG,CAAC,KAAO,IAAM,CAAC,EAAG,CAAC,KAAO,IAAM,CAAC,EAAG,CAAC,KAAO,IAAM,CAAC,EAAG,CAAC,KAAO,IAAM,CAAC,EACvF,CAAC,KAAO,IAAM,CAAC,EAAG,CAAC,KAAO,IAAM,CAAC,EAAG,CAAC,KAAO,IAAM,CAAC,EAAG,CAAC,KAAO,IAAM,CAAC,EAAG,CAAC,IAAO,IAAM,CAAC,EACvF,CAAC,KAAO,IAAM,CAAC,EAAG,CAAC,KAAO,IAAM,CAAC,EAAG,CAAC,KAAO,IAAM,CAAC,EAAG,CAAC,KAAO,IAAM,CAAC,EAAG,CAAC,KAAO,IAAM,CAAC,EACvF,CAAC,KAAO,IAAM,CAAC,EAAG,CAAC,KAAO,IAAM,CAAC,EAAG,CAAC,KAAO,IAAM,CAAC,EAAG,CAAC,KAAO,IAAM,CAAC,EAAG,CAAC,KAAO,IAAM,CAAC,EACvF,CAAC,KAAO,IAAM,CAAC,EAAG,CAAC,KAAO,IAAM,CAAC,EAAG,CAAC,KAAO,IAAM,CAAC,EAAG,CAAC,IAAO,IAAM,CAAC,EAAG,CAAC,KAAO,IAAM,CAAC,EACvF,CAAC,KAAO,IAAM,CAAC,EAAG,CAAC,KAAO,IAAM,CAAC,EAAG,CAAC,KAAO,IAAM,CAAC,EAAG,CAAC,KAAO,IAAM,CAAC,EAAG,CAAC,KAAO,IAAM,CAAC,EACvF,CAAC,KAAO,IAAM,CAAC,EAAG,CAAC,KAAO,IAAM,CAAC,EAAG,CAAC,KAAO,IAAM,CAAC,EAAG,CAAC,KAAO,IAAM,CAAC,EAAG,CAAC,KAAO,IAAM,CAAC,EACvF,CAAC,KAAO,IAAM,CAAC,EAAG,CAAC,KAAO,IAAM,CAAC,EAAG,CAAC,IAAO,IAAM,CAAC,EAAG,CAAC,KAAO,IAAM,CAAC,EAAG,CAAC,KAAO,IAAM,CAAC,EACvF,CAAC,KAAO,IAAM,CAAC,EAAG,CAAC,KAAO,IAAM,CAAC,EAAG,CAAC,KAAO,IAAM,CAAC,EAAG,CAAC,KAAO,IAAM,CAAC,EAAG,CAAC,KAAO,IAAM,CAAC,EACvF,CAAC,KAAO,IAAM,CAAC,EAEf,CAAC,KAAO,KAAO,CAAC,EAAG,CAAC,KAAO,KAAO,CAAC,EAAG,CAAC,KAAO,KAAO,CAAC,EAAG,CAAC,KAAO,KAAO,CAAC,EAAG,CAAC,KAAO,KAAO,CAAC,EAC5F,CAAC,IAAO,KAAO,CAAC,EAAG,CAAC,KAAO,KAAO,CAAC,EAAG,CAAC,KAAO,KAAO,CAAC,EAAG,CAAC,KAAO,IAAO,CAAC,EAAG,CAAC,KAAO,KAAO,CAAC,EAC5F,CAAC,KAAO,KAAO,CAAC,EAAG,CAAC,IAAO,KAAO,CAAC,EAAG,CAAC,KAAO,KAAO,CAAC,EAAG,CAAC,KAAO,KAAO,CAAC,EAAG,CAAC,KAAO,KAAO,CAAC,EAC5F,CAAC,KAAO,KAAO,CAAC,EAAG,CAAC,KAAO,KAAO,CAAC,EAAG,CAAC,KAAO,IAAO,CAAC,EAAG,CAAC,KAAO,KAAO,CAAC,EAAG,CAAC,IAAO,KAAO,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","names":["DEFAULT_HYPERPARAMETERS","DEFAULT_LR_SCHEDULE","DEFAULT_TRAINING_CONFIG","createEmptyHistory","addHistoryRecord","history","record","records","isBestLoss","isBestValLoss","exportHistory","format","lastRecord","header","rows","r","DEFAULT_VISUALIZATION_CONFIG","COLOUR_PALETTES","MULTI_CLASS_COLOURS","Logger","config","message","context","error","level","entry","time","label","startTime","duration","enabled","logger","DEFAULT_CONFIG","TrainingSession","neuralNet","visualizer","dataRepo","datasetType","options","rawData","data","method","xs","p","ys","xMin","xMax","yMin","yMax","xRange","yRange","xMean","a","b","yMean","xStd","sum","x","yStd","y","validationSplit","shuffled","j","temp","splitIndex","result","valLoss","valAccuracy","valResult","callback","maxEpochs","now","batch","batchSize","i","gridSize","state","listener","points","epoch","schedule","initialLR","warmupEpochs","effectiveEpoch","decayRate","decaySteps","numDecays","progress","cycleLength","minLR","cyclePosition","halfCycle","triangleValue","cosineValue","newLR","patience","interval","maxLR","steps","results","lrMultiplier","currentLR","originalHyperparams","GradientExplosionError","ModelNotInitialisedError","TFNeuralNet","newLearningRate","model","weights","optimizer","loss","w","tf.tensor2d","accuracy","lossValue","accuracyValue","t","grid","inputTensor","outputTensor","outputData","point","index","confidence","startIdx","probs","maxProb","predictedClass","c","prob","modelArtifacts","resolve","reject","saveHandler","artifacts","modelTopology","weightsManifest","modelJson","modelJsonBlob","weightsData","weightsBlob","buffers","modelJsonFile","weightsFile","modelJsonText","handler","weightsBuffer","tf.loadLayersModel","info","tf.memory","allWeights","tensor","value","matrices","kernel","shape","inputSize","outputSize","matrix","from","row","to","idx","activations","input","currentInput","layer","output","layers","defaultActivation","layerActivations","tf.sequential","regularizer","numClasses","dropoutRate","useBatchNorm","getActivation","layerIndex","act","tf.layers.dense","tf.layers.batchNormalization","tf.layers.activation","tf.layers.dropout","tf.oneHot","tf.tensor1d","type","learningRate","momentum","clipNorm","tf.train","l1Strength","l2Strength","tf.regularizers.l1l2","newOptimizer","D3VoronoiOverlay","svg","width","height","xScale","yScale","predictions","opacity","screenPoints","voronoi","d3.Delaunay","_","pred","classIndex","defs","gradientId","classColour","gradient","D3Chart","containerId","element","d3.select","d3.scaleLinear","entries","d3.axisBottom","d3.axisLeft","theme","getColour","dataPoints","d","tooltip","event","confidenceValues","step","contours","d3.contours","d3.range","palette","colourScale","xContourScale","yContourScale","pathGenerator","d3.geoPath","d3.geoTransform","cellWidth","cellHeight","misclassifiedIndices","maxRadius","minRadius","uncertainty","mouseX","mouseY","d3.pointer","axesGroup","d3.zoom","d3.zoomIdentity","filename","svgElement","clonedSvg","background","svgString","svgBlob","url","canvas","scale","ctx","img","pngUrl","link","metadata","metadataHeight","cols","colWidth","startY","lineHeight","key","col","blob","el","computed","style","inlined","prop","D3LossChart","d3.line","d3.curveMonotoneX","d3.format","d3.axisRight","maxEpoch","d3.max","maxTrainLoss","maxValLoss","maxLoss","legend","D3NetworkDiagram","container","rect","innerWidth","innerHeight","g","nodes","links","layerSpacing","maxNodes","nodeCount","nodeSpacing","layerType","node","prevLayerSize","weight","n","nodeGroup","nodeRadius","labelGroup","layerLabels","size","MockDataRepository","latencyMs","samples","noise","classBalance","generator","s","classSamples","classIdx","baseRadius","samplesForClass","angle","radius","_numClasses","samplesClass0","samplesClass1","arm","deltaAngle","samplesForArm","clusters","cx","cy","count","samplesForCluster","totalSamples","class0Samples","class1Samples","remainingSamples","samplesPerOtherClass","irisData","wineData","stdDev","u1","u2","array","LocalStorageService","testKey","serialized","defaultValue","item","keys","APP_CONFIG","toastContainer","ensureToastContainer","showToast","dismissible","toast","icon","getToastIcon","messageSpan","closeBtn","dismissToast","timeoutId","ErrorBoundary","reportError","pattern","additionalContext","escapeHTML","str","div","safeHTML","strings","values","safeValue","ELI5_EXPLANATIONS","ELI5TooltipManager","e","target","content","html","tooltipRect","left","top","initELI5Tooltips","dismissSuggestions","resetSuggestionsDismissal","DatasetController","session","visualizerService","elements","loadDataHandler","datasetChangeHandler","clearCustomHandler","samplesChangeHandler","noiseChangeHandler","csvUploadHandler","downloadHandler","isRealWorld","preprocessing","datasetInfo","isCustom","colour","button","btn","show","file","reader","text","lines","startIndex","line","parts","csvContent","TrainingController","callbacks","activation","l1Regularization","l2Regularization","batchNorm","targetFps","lrScheduleType","earlyStoppingPatience","scheduleType","fps","split","statusText","canStart","canReset","validActivations","D3GradientFlow","layerGradients","layerNames","maxGradient","d3.scaleBand","colorScale","d3.scaleSequential","d3.interpolateYlOrRd","gradients","layerIdx","layerName","barWidth","xOffset","grad","neuronIdx","barHeight","legendWidth","legendHeight","legendX","legendY","estimateGradients","previousWeights","currentWeights","prevLayer","currLayer","numOutputs","out","sumSquaredDiff","numInputs","inp","prev","diff","gradMagnitude","D3ActivationHeatmap","d3.interpolateViridis","numLayers","maxNeurons","layerGroup","layerHeight","yOffset","neuronIndex","normalizedActivation","legendScale","legendAxis","VisualizationController","neuralNetService","scheme","ThreeVisualization","__vitePreload","gridPoints","predictions3d","points3d","structure","_i","generatePythonCode","hyperparams","lrSchedule","layers_config","units","regParts","regStr","lr","generateONNXModel","biases","initializers","layerWeights","layerBiases","weightName","biasName","matmulOutput","addOutput","activationOutput","flatWeights","k","onnxActivation","mapActivationToONNX","generateONNXPythonScript","modelInfo","inputShape","outputShape","init","downloadONNXPythonScript","script","ExportController","code","fullLayers","weightMatrices","modelUrl","modelLink","weightsUrl","weightsLink","mimeType","SESSION_KEY","BOOKMARKS_KEY","THEME_KEY","SessionController","storage","bookmarkId","bookmark","stored","newTheme","bookmarks","option","divider","name","newBookmarks","json","encoded","ModelComparison","createModel","training","validation","resultA","valResultA","resultB","valResultB","winner","metric","accA","accB","ModelEnsemble","maxMembers","id","m","member","memberPredictions","pointIdx","memberIdx","classVotes","totalWeight","currentVote","winningClass","maxVotes","classId","votes","agreement","ComparisonController","configSummary","accDiff","lossDiff","accClass","lossClass","accSign","lossSign","layersA","layersB","configA","configB","valSplit","splitIdx","trainingData","validationData","winnerText","D3LRFinder","suggestedLR","validPoints","xExtent","d3.extent","yExtent","d3.scaleLog","xAxis","findOptimalLR","valid","bestIdx","bestGradient","curr","next","logLRDiff","optimalIdx","ResearchController","optimalLR","btnApply","safeGetElement","elementType","getRequiredElement","getDatasetElements","getTrainingElements","getVisualizationElements","getExportElements","getSessionElements","getComparisonElements","getResearchElements","setupSidebarTabs","tabs","panels","tab","targetId","panel","setupTouchGestures","touchStartX","touchStartY","touch","touchEndX","touchEndY","handleGesture","startX","endX","endY","diffX","diffY","threshold","setupBottomSheet","sheet","handle","overlay","currentY","isDragging","closeBottomSheet","TUTORIALS","TutorialManager","tutorialId","onComplete","tutorial","titleEl","contentEl","progressEl","prevBtn","nextBtn","position","padding","highlight","tutorialManager","setupOnboardingWizard","showOnboardingWizard","tf","errorBoundary","lossChart","networkDiagram","datasetController","trainingController","visualizationController","comparisonController","appContainer"],"ignoreList":[],"sources":["../../src/core/domain/Hyperparameters.ts","../../src/core/domain/TrainingHistory.ts","../../src/core/domain/VisualizationConfig.ts","../../src/infrastructure/logging/Logger.ts","../../src/core/application/TrainingSession.ts","../../src/infrastructure/tensorflow/errors.ts","../../src/infrastructure/tensorflow/TFNeuralNet.ts","../../src/infrastructure/d3/D3VoronoiOverlay.ts","../../src/infrastructure/d3/D3Chart.ts","../../src/infrastructure/d3/D3LossChart.ts","../../src/infrastructure/d3/D3NetworkDiagram.ts","../../src/infrastructure/api/MockDataRepository.ts","../../src/infrastructure/storage/LocalStorageService.ts","../../src/config/app.config.ts","../../src/presentation/toast.ts","../../src/infrastructure/errorHandling/ErrorBoundary.ts","../../src/infrastructure/security/htmlSanitizer.ts","../../src/presentation/ELI5Tooltips.ts","../../src/presentation/SuggestedFixes.ts","../../src/presentation/controllers/DatasetController.ts","../../src/presentation/controllers/TrainingController.ts","../../src/infrastructure/d3/D3GradientFlow.ts","../../src/infrastructure/d3/D3ActivationHeatmap.ts","../../src/presentation/controllers/VisualizationController.ts","../../src/infrastructure/export/PythonCodeGenerator.ts","../../src/infrastructure/export/onnxExport.ts","../../src/presentation/controllers/ExportController.ts","../../src/presentation/controllers/SessionController.ts","../../src/core/application/ModelComparison.ts","../../src/core/application/ModelEnsemble.ts","../../src/presentation/controllers/ComparisonController.ts","../../src/infrastructure/d3/D3LRFinder.ts","../../src/presentation/controllers/ResearchController.ts","../../src/utils/dom.ts","../../src/utils/UIFactory.ts","../../src/presentation/Sidebar.ts","../../src/presentation/TouchGestures.ts","../../src/presentation/BottomSheet.ts","../../src/presentation/Tutorial.ts","../../src/presentation/Onboarding.ts","../../src/main.ts"],"sourcesContent":["/**\n * Supported optimizer algorithms.\n */\nexport type OptimizerType = 'sgd' | 'adam' | 'rmsprop' | 'adagrad';\n\n/**\n * Supported activation functions.\n */\nexport type ActivationType = 'linear' | 'relu' | 'sigmoid' | 'tanh' | 'elu' | 'leaky_relu' | 'selu' | 'softmax';\n\n/**\n * Learning rate schedule types.\n * - none: constant learning rate\n * - exponential: LR * decayRate^(epoch/decaySteps)\n * - step: LR * decayRate every decaySteps epochs\n * - cosine: cosine annealing to 0\n * - cyclic_triangular: triangle wave between minLR and maxLR\n * - cyclic_cosine: cosine wave between minLR and maxLR\n */\nexport type LRScheduleType = 'none' | 'exponential' | 'step' | 'cosine' | 'cyclic_triangular' | 'cyclic_cosine';\n\n/**\n * Learning rate schedule configuration.\n */\nexport interface LRScheduleConfig {\n  /** Schedule type */\n  readonly type: LRScheduleType;\n  /** Decay rate for exponential/step decay (e.g., 0.95 = 5% decay) */\n  readonly decayRate?: number;\n  /** Steps between decay for step schedule */\n  readonly decaySteps?: number;\n  /** Number of warmup epochs (gradual increase from 0 to target LR). 0 = disabled. */\n  readonly warmupEpochs?: number;\n  /** Cycle length in epochs for cyclic schedules (default: 20) */\n  readonly cycleLength?: number;\n  /** Minimum learning rate for cyclic schedules (default: LR/10) */\n  readonly minLR?: number;\n}\n\n/**\n * Configuration for neural network architecture and training.\n * Encapsulates tuneable parameters that affect model behaviour.\n */\nexport interface Hyperparameters {\n  /** Learning rate for gradient descent optimisation */\n  readonly learningRate: number;\n\n  /** Array defining neurons per hidden layer (e.g., [4, 2] = two layers with 4 and 2 neurons) */\n  readonly layers: readonly number[];\n\n  /** Optimizer algorithm (default: 'adam') */\n  readonly optimizer?: OptimizerType;\n\n  /** Momentum for SGD optimizer (0-1). Only used when optimizer is 'sgd'. Default: 0.9 */\n  readonly momentum?: number;\n\n  /** Default activation function for hidden layers (default: 'relu') */\n  readonly activation?: ActivationType;\n\n  /** Per-layer activation functions. If provided, overrides `activation` for each layer. */\n  readonly layerActivations?: readonly ActivationType[];\n\n  /** L1 regularization strength (sparsity). 0 = disabled. */\n  readonly l1Regularization?: number;\n\n  /** L2 regularization strength (weight decay). 0 = disabled. */\n  readonly l2Regularization?: number;\n\n  /** Number of output classes (default: 2 for binary classification) */\n  readonly numClasses?: number;\n\n  /** Dropout rate (0-1). 0 = disabled. Applied after each hidden layer. */\n  readonly dropoutRate?: number;\n\n  /** Gradient clipping norm. 0 = disabled. Clips gradients to this max norm. */\n  readonly clipNorm?: number;\n\n  /** Whether to use batch normalization between layers. */\n  readonly batchNorm?: boolean;\n}\n\n/**\n * Runtime training configuration (can be changed during training).\n */\nexport interface TrainingConfig {\n  /** Number of samples per training batch (default: all samples) */\n  readonly batchSize?: number;\n\n  /** Maximum epochs before auto-stop. 0 = unlimited. */\n  readonly maxEpochs?: number;\n\n  /** Target frames per second for training loop (default: 60) */\n  readonly targetFps?: number;\n\n  /** Delay between epochs in milliseconds (alternative to FPS control) */\n  readonly epochDelayMs?: number;\n\n  /** Fraction of data to use for validation (0-1). 0 = no validation. */\n  readonly validationSplit?: number;\n\n  /** Learning rate schedule configuration */\n  readonly lrSchedule?: LRScheduleConfig;\n\n  /** Early stopping patience (epochs without improvement). 0 = disabled. */\n  readonly earlyStoppingPatience?: number;\n}\n\n/**\n * Default hyperparameters for new networks.\n */\nexport const DEFAULT_HYPERPARAMETERS: Required<Hyperparameters> = {\n  learningRate: 0.003,\n  layers: [8, 4],\n  optimizer: 'adam',\n  momentum: 0.9,\n  activation: 'relu',\n  layerActivations: [],\n  l1Regularization: 0,\n  l2Regularization: 0,\n  numClasses: 2,\n  dropoutRate: 0,\n  clipNorm: 0,\n  batchNorm: false,\n};\n\n/**\n * Default learning rate schedule.\n */\nexport const DEFAULT_LR_SCHEDULE: LRScheduleConfig = {\n  type: 'none',\n  decayRate: 0.95,\n  decaySteps: 10,\n  warmupEpochs: 0,\n  cycleLength: 20,\n  minLR: 0.001,\n};\n\n/**\n * Default training configuration.\n */\nexport const DEFAULT_TRAINING_CONFIG: Required<TrainingConfig> = {\n  batchSize: 0, // 0 = use all samples\n  maxEpochs: 0, // 0 = unlimited\n  targetFps: 60,\n  epochDelayMs: 0,\n  validationSplit: 0.2, // 20% validation by default\n  lrSchedule: DEFAULT_LR_SCHEDULE,\n  earlyStoppingPatience: 0, // 0 = disabled\n};\n","/**\n * A single record in the training history.\n */\nexport interface TrainingRecord {\n  /** Epoch number (1-indexed) */\n  readonly epoch: number;\n  /** Training loss at this epoch */\n  readonly loss: number;\n  /** Training accuracy at this epoch (0-1) */\n  readonly accuracy: number;\n  /** Validation loss at this epoch (null if no validation) */\n  readonly valLoss: number | null;\n  /** Validation accuracy at this epoch (null if no validation) */\n  readonly valAccuracy: number | null;\n  /** Timestamp when this epoch completed */\n  readonly timestamp: number;\n}\n\n/**\n * Complete training history for a session.\n */\nexport interface TrainingHistory {\n  /** All training records */\n  readonly records: readonly TrainingRecord[];\n  /** Best (lowest) training loss achieved */\n  readonly bestLoss: number | null;\n  /** Epoch where best training loss was achieved */\n  readonly bestEpoch: number | null;\n  /** Best (lowest) validation loss achieved */\n  readonly bestValLoss: number | null;\n  /** Epoch where best validation loss was achieved */\n  readonly bestValEpoch: number | null;\n  /** Total training time in milliseconds */\n  readonly totalTimeMs: number;\n}\n\n/**\n * Creates an empty training history.\n */\nexport function createEmptyHistory(): TrainingHistory {\n  return {\n    records: [],\n    bestLoss: null,\n    bestEpoch: null,\n    bestValLoss: null,\n    bestValEpoch: null,\n    totalTimeMs: 0,\n  };\n}\n\n/**\n * Adds a record to the training history and updates best metrics.\n */\nexport function addHistoryRecord(\n  history: TrainingHistory,\n  record: TrainingRecord\n): TrainingHistory {\n  const records = [...history.records, record];\n\n  const isBestLoss = history.bestLoss === null || record.loss < history.bestLoss;\n  const isBestValLoss =\n    record.valLoss !== null &&\n    (history.bestValLoss === null || record.valLoss < history.bestValLoss);\n\n  return {\n    records,\n    bestLoss: isBestLoss ? record.loss : history.bestLoss,\n    bestEpoch: isBestLoss ? record.epoch : history.bestEpoch,\n    bestValLoss: isBestValLoss ? record.valLoss : history.bestValLoss,\n    bestValEpoch: isBestValLoss ? record.epoch : history.bestValEpoch,\n    totalTimeMs: record.timestamp - (history.records[0]?.timestamp ?? record.timestamp),\n  };\n}\n\n/**\n * Export format options for training history.\n */\nexport type ExportFormat = 'json' | 'csv';\n\n/**\n * Exports training history to the specified format.\n */\nexport function exportHistory(history: TrainingHistory, format: ExportFormat): string {\n  const lastRecord = history.records[history.records.length - 1];\n\n  if (format === 'json') {\n    return JSON.stringify(\n      {\n        records: history.records,\n        summary: {\n          totalEpochs: history.records.length,\n          bestLoss: history.bestLoss,\n          bestEpoch: history.bestEpoch,\n          bestValLoss: history.bestValLoss,\n          bestValEpoch: history.bestValEpoch,\n          totalTimeMs: history.totalTimeMs,\n          finalLoss: lastRecord?.loss ?? null,\n          finalAccuracy: lastRecord?.accuracy ?? null,\n          finalValLoss: lastRecord?.valLoss ?? null,\n          finalValAccuracy: lastRecord?.valAccuracy ?? null,\n        },\n      },\n      null,\n      2\n    );\n  }\n\n  // CSV format\n  const header = 'epoch,loss,accuracy,val_loss,val_accuracy,timestamp';\n  const rows = history.records.map(\n    (r) =>\n      `${r.epoch},${r.loss.toFixed(6)},${r.accuracy.toFixed(4)},${r.valLoss?.toFixed(6) ?? ''},${r.valAccuracy?.toFixed(4) ?? ''},${r.timestamp}`\n  );\n  return [header, ...rows].join('\\n');\n}\n","/**\n * Available colour schemes for decision boundary visualization.\n */\nexport type ColourScheme = 'default' | 'viridis' | 'plasma' | 'cool' | 'warm';\n\n/**\n * Configuration for visualization appearance.\n */\nexport interface VisualizationConfig {\n  /** Decision boundary opacity (0-1). Default: 0.7 */\n  readonly boundaryOpacity: number;\n\n  /** Data point radius in pixels. Default: 5 */\n  readonly pointRadius: number;\n\n  /** Colour scheme for decision boundary. Default: 'default' */\n  readonly colourScheme: ColourScheme;\n\n  /** Whether zoom/pan is enabled. Default: true */\n  readonly zoomEnabled: boolean;\n\n  /** Whether tooltips are shown on hover. Default: true */\n  readonly tooltipsEnabled: boolean;\n\n  /** Number of contour lines for binary classification. Default: 10 */\n  readonly contourCount: number;\n}\n\n/**\n * Default visualization configuration.\n */\nexport const DEFAULT_VISUALIZATION_CONFIG: VisualizationConfig = {\n  boundaryOpacity: 0.7,\n  pointRadius: 5,\n  colourScheme: 'default',\n  zoomEnabled: true,\n  tooltipsEnabled: true,\n  contourCount: 10,\n};\n\n/**\n * Colour palette definitions for each scheme.\n * Each palette maps confidence [0, 1] to a colour.\n * Updated to match wireframe design (Cyan/Magenta)\n */\nexport const COLOUR_PALETTES: Record<ColourScheme, { low: string; high: string }> = {\n  default: { low: '#00D9FF', high: '#f97316' }, // Cyan to Orange (wireframe)\n  viridis: { low: '#440154', high: '#fde725' }, // Purple to Yellow\n  plasma: { low: '#0d0887', high: '#f0f921' }, // Dark Blue to Yellow\n  cool: { low: '#00D9FF', high: '#06b6d4' }, // Cyan gradient\n  warm: { low: '#FF00AA', high: '#facc15' }, // Magenta to Yellow\n};\n\n/**\n * Multi-class colour palette (up to 10 classes).\n * Distinct, colourblind-friendly colours updated for wireframe theme.\n */\nexport const MULTI_CLASS_COLOURS: readonly string[] = [\n  '#00D9FF', // Cyan (class 0) - Primary accent\n  '#f97316', // Orange (class 1) - High contrast\n  '#10B981', // Green (class 2) - Success\n  '#FF00AA', // Magenta (class 3) - Secondary accent\n  '#EF4444', // Red (class 4) - Danger\n  '#06b6d4', // Teal (class 5)\n  '#F59E0B', // Amber (class 6) - Warning\n  '#ec4899', // Pink (class 7)\n  '#64748b', // Slate (class 8)\n  '#8B5CF6', // Purple (class 9)\n];\n","/**\n * Logging Service\n *\n * Centralized logging system that:\n * - Provides structured logging with levels (debug, info, warn, error)\n * - Can be disabled in production\n * - Integrates with toast notifications\n * - Supports optional telemetry (Sentry, LogRocket, etc.)\n * - Provides performance timing utilities\n */\n\nexport enum LogLevel {\n  DEBUG = 0,\n  INFO = 1,\n  WARN = 2,\n  ERROR = 3,\n  NONE = 4,\n}\n\nexport interface LogContext {\n  component?: string;\n  action?: string;\n  userId?: string;\n  sessionId?: string;\n  [key: string]: unknown;\n}\n\nexport interface LogEntry {\n  level: LogLevel;\n  message: string;\n  timestamp: number;\n  context?: LogContext;\n  error?: Error;\n}\n\n/**\n * Logger configuration options.\n */\nexport interface LoggerConfig {\n  /** Minimum log level to output. Default: INFO in production, DEBUG in development */\n  minLevel?: LogLevel;\n\n  /** Enable console output. Default: true */\n  enableConsole?: boolean;\n\n  /** Enable storing logs in memory. Default: false */\n  enableHistory?: boolean;\n\n  /** Maximum history size. Default: 100 */\n  maxHistorySize?: number;\n\n  /** Optional external logger (e.g., Sentry, LogRocket) */\n  externalLogger?: ExternalLogger;\n}\n\nexport interface ExternalLogger {\n  captureException?(error: Error, context?: LogContext): void;\n  captureMessage?(message: string, level: string, context?: LogContext): void;\n}\n\n/**\n * Centralized logging service.\n */\nexport class Logger {\n  private config: Required<Omit<LoggerConfig, 'externalLogger'>> & { externalLogger?: ExternalLogger };\n  private history: LogEntry[] = [];\n  private timers: Map<string, number> = new Map();\n\n  constructor(config: LoggerConfig = {}) {\n    const isDevelopment = import.meta.env.DEV;\n\n    this.config = {\n      minLevel: config.minLevel ?? (isDevelopment ? LogLevel.DEBUG : LogLevel.INFO),\n      enableConsole: config.enableConsole ?? true,\n      enableHistory: config.enableHistory ?? false,\n      maxHistorySize: config.maxHistorySize ?? 100,\n      externalLogger: config.externalLogger,\n    };\n  }\n\n  /**\n   * Logs a debug message (development only).\n   *\n   * @param message - Log message\n   * @param context - Optional context data\n   *\n   * @example\n   * ```typescript\n   * logger.debug('Training step completed', { epoch: 10, loss: 0.5 });\n   * ```\n   */\n  debug(message: string, context?: LogContext): void {\n    this.log(LogLevel.DEBUG, message, context);\n  }\n\n  /**\n   * Logs an informational message.\n   *\n   * @param message - Log message\n   * @param context - Optional context data\n   *\n   * @example\n   * ```typescript\n   * logger.info('Dataset loaded', { samples: 200 });\n   * ```\n   */\n  info(message: string, context?: LogContext): void {\n    this.log(LogLevel.INFO, message, context);\n  }\n\n  /**\n   * Logs a warning message.\n   *\n   * @param message - Log message\n   * @param context - Optional context data\n   *\n   * @example\n   * ```typescript\n   * logger.warn('Training appears stuck', { epoch: 50, loss: 2.5 });\n   * ```\n   */\n  warn(message: string, context?: LogContext): void {\n    this.log(LogLevel.WARN, message, context);\n  }\n\n  /**\n   * Logs an error message.\n   *\n   * @param message - Log message\n   * @param error - Optional error object\n   * @param context - Optional context data\n   *\n   * @example\n   * ```typescript\n   * logger.error('Failed to load model', error, { modelId: '123' });\n   * ```\n   */\n  error(message: string, error?: Error, context?: LogContext): void {\n    this.log(LogLevel.ERROR, message, context, error);\n\n    // Send to external error tracking\n    if (this.config.externalLogger?.captureException && error) {\n      this.config.externalLogger.captureException(error, context);\n    } else if (this.config.externalLogger?.captureMessage) {\n      this.config.externalLogger.captureMessage(message, 'error', context);\n    }\n  }\n\n  /**\n   * Core logging method.\n   *\n   * @param level - Log level\n   * @param message - Log message\n   * @param context - Optional context\n   * @param error - Optional error object\n   * @returns The log entry\n   */\n  private log(level: LogLevel, message: string, context?: LogContext, error?: Error): LogEntry {\n    // Check if this log level should be output\n    if (level < this.config.minLevel) {\n      // Still create entry for history even if not logged\n      const entry: LogEntry = {\n        level,\n        message,\n        timestamp: Date.now(),\n        context,\n        error,\n      };\n\n      if (this.config.enableHistory) {\n        this.addToHistory(entry);\n      }\n\n      return entry;\n    }\n\n    const entry: LogEntry = {\n      level,\n      message,\n      timestamp: Date.now(),\n      context,\n      error,\n    };\n\n    // Console output\n    if (this.config.enableConsole) {\n      this.logToConsole(entry);\n    }\n\n    // Store in history\n    if (this.config.enableHistory) {\n      this.addToHistory(entry);\n    }\n\n    return entry;\n  }\n\n  /**\n   * Outputs log entry to console.\n   */\n  private logToConsole(entry: LogEntry): void {\n    const time = new Date(entry.timestamp).toLocaleTimeString();\n    const component = entry.context?.component ? `[${entry.context.component}]` : '';\n    const message = `${component} ${entry.message}`;\n\n    /* eslint-disable no-console */\n    switch (entry.level) {\n      case LogLevel.DEBUG:\n        if (entry.context && Object.keys(entry.context).length > 0) {\n          console.log(`%c${time} DEBUG`, 'color: #888', message, entry.context);\n        } else {\n          console.log(`%c${time} DEBUG`, 'color: #888', message);\n        }\n        break;\n      case LogLevel.INFO:\n        if (entry.context && Object.keys(entry.context).length > 0) {\n          console.log(`%c${time} INFO`, 'color: #0ea5e9', message, entry.context);\n        } else {\n          console.log(`%c${time} INFO`, 'color: #0ea5e9', message);\n        }\n        break;\n      case LogLevel.WARN:\n        if (entry.context && Object.keys(entry.context).length > 0) {\n          console.warn(`%c${time} WARN`, 'color: #f59e0b', message, entry.context);\n        } else {\n          console.warn(`%c${time} WARN`, 'color: #f59e0b', message);\n        }\n        break;\n      case LogLevel.ERROR:\n        if (entry.error) {\n          if (entry.context && Object.keys(entry.context).length > 0) {\n            console.error(`%c${time} ERROR`, 'color: #ef4444', message, entry.error, entry.context);\n          } else {\n            console.error(`%c${time} ERROR`, 'color: #ef4444', message, entry.error);\n          }\n        } else {\n          if (entry.context && Object.keys(entry.context).length > 0) {\n            console.error(`%c${time} ERROR`, 'color: #ef4444', message, entry.context);\n          } else {\n            console.error(`%c${time} ERROR`, 'color: #ef4444', message);\n          }\n        }\n        break;\n    }\n    /* eslint-enable no-console */\n  }\n\n  /**\n   * Adds entry to history buffer.\n   */\n  private addToHistory(entry: LogEntry): void {\n    this.history.push(entry);\n\n    // Trim history if it exceeds max size\n    if (this.history.length > this.config.maxHistorySize) {\n      this.history.shift();\n    }\n  }\n\n  /**\n   * Gets the string name of a log level.\n   */\n  private getLevelName(level: LogLevel): string {\n    switch (level) {\n      case LogLevel.DEBUG:\n        return 'DEBUG';\n      case LogLevel.INFO:\n        return 'INFO';\n      case LogLevel.WARN:\n        return 'WARN';\n      case LogLevel.ERROR:\n        return 'ERROR';\n      default:\n        return 'UNKNOWN';\n    }\n  }\n\n  /**\n   * Starts a performance timer.\n   *\n   * @param label - Timer label\n   *\n   * @example\n   * ```typescript\n   * logger.time('training');\n   * // ... training code ...\n   * logger.timeEnd('training');  // Logs: \"training: 1234ms\"\n   * ```\n   */\n  time(label: string): void {\n    this.timers.set(label, performance.now());\n  }\n\n  /**\n   * Ends a performance timer and logs the duration.\n   *\n   * @param label - Timer label\n   * @returns Duration in milliseconds\n   */\n  timeEnd(label: string): number | undefined {\n    const startTime = this.timers.get(label);\n    if (!startTime) {\n      this.warn(`Timer \"${label}\" does not exist`);\n      return undefined;\n    }\n\n    const duration = performance.now() - startTime;\n    this.timers.delete(label);\n\n    this.info(`${label}: ${duration.toFixed(2)}ms`);\n    return duration;\n  }\n\n  /**\n   * Gets the log history.\n   *\n   * @returns Array of log entries\n   */\n  getHistory(): LogEntry[] {\n    return [...this.history];\n  }\n\n  /**\n   * Clears the log history.\n   */\n  clearHistory(): void {\n    this.history = [];\n  }\n\n  /**\n   * Sets the minimum log level.\n   *\n   * @param level - New minimum log level\n   */\n  setLevel(level: LogLevel): void {\n    this.config.minLevel = level;\n  }\n\n  /**\n   * Gets the current minimum log level.\n   *\n   * @returns Current log level\n   */\n  getLevel(): LogLevel {\n    return this.config.minLevel;\n  }\n\n  /**\n   * Enables or disables console output.\n   *\n   * @param enabled - Whether to enable console output\n   */\n  setConsoleEnabled(enabled: boolean): void {\n    this.config.enableConsole = enabled;\n  }\n\n  /**\n   * Checks if a log level would be output.\n   *\n   * @param level - Log level to check\n   * @returns True if the level would be logged\n   */\n  isLevelEnabled(level: LogLevel): boolean {\n    return level >= this.config.minLevel;\n  }\n}\n\n/**\n * Global logger instance.\n */\nexport const logger = new Logger({\n  enableHistory: true,\n  maxHistorySize: 100,\n});\n\n/**\n * Creates a logger with a specific context that's included in all log calls.\n *\n * @param baseContext - Context to include in all logs\n * @returns Logger instance\n *\n * @example\n * ```typescript\n * const trainingLogger = createContextLogger({ component: 'TrainingSession' });\n * trainingLogger.info('Started training');  // Includes component: 'TrainingSession'\n * ```\n */\nexport function createContextLogger(baseContext: LogContext): Logger {\n  const contextLogger = new Logger();\n\n  // Override methods to include base context\n  const originalDebug = contextLogger.debug.bind(contextLogger);\n  const originalInfo = contextLogger.info.bind(contextLogger);\n  const originalWarn = contextLogger.warn.bind(contextLogger);\n  const originalError = contextLogger.error.bind(contextLogger);\n\n  contextLogger.debug = (message: string, context?: LogContext) => {\n    originalDebug(message, { ...baseContext, ...context });\n  };\n\n  contextLogger.info = (message: string, context?: LogContext) => {\n    originalInfo(message, { ...baseContext, ...context });\n  };\n\n  contextLogger.warn = (message: string, context?: LogContext) => {\n    originalWarn(message, { ...baseContext, ...context });\n  };\n\n  contextLogger.error = (message: string, error?: Error, context?: LogContext) => {\n    originalError(message, error, { ...baseContext, ...context });\n  };\n\n  return contextLogger;\n}\n","import type { Hyperparameters, Point, Prediction, TrainingConfig, TrainingHistory, ExportFormat } from '../domain';\nimport { DEFAULT_TRAINING_CONFIG, DEFAULT_LR_SCHEDULE, createEmptyHistory, addHistoryRecord, exportHistory } from '../domain';\nimport type { INeuralNetworkService, IVisualizerService, IDatasetRepository, DatasetOptions } from '../ports';\nimport type { ITrainingSession, TrainingState } from './ITrainingSession';\nimport { logger } from '../../infrastructure/logging/Logger';\n\n/**\n * Configuration for training session behaviour.\n */\nexport interface TrainingSessionConfig {\n  /** How often to render decision boundary (every N epochs). Default: 10 */\n  readonly renderInterval: number;\n  /** Grid resolution for boundary prediction. Default: 50 */\n  readonly gridSize: number;\n}\n\nconst DEFAULT_CONFIG: TrainingSessionConfig = {\n  renderInterval: 10,\n  gridSize: 50,\n};\n\n/**\n * Orchestrates the training workflow.\n * Acts as the \"Director\" coordinating neural network, visualiser, and data repository.\n *\n * @remarks\n * Concurrency Strategy (Guard-Rail Loop):\n * - `isTraining` controls whether the loop should continue\n * - `isProcessingStep` acts as a mutex to prevent overlapping async calls\n * - `requestAnimationFrame` fires ~60fps, but we skip frames while GPU is busy\n *\n * This prevents \"call stack pile-up\" where Step 2 starts before Step 1 finishes.\n *\n * @example\n * ```\n * Frame 1: isProcessingStep=false  Execute train()  isProcessingStep=true\n * Frame 2: isProcessingStep=true   Skip (GPU busy)\n * Frame 3: isProcessingStep=true   Skip (GPU busy)\n * Frame 4: train() completes       isProcessingStep=false\n * Frame 5: isProcessingStep=false  Execute train()  ...\n * ```\n */\nexport class TrainingSession implements ITrainingSession {\n  private readonly config: TrainingSessionConfig;\n  private readonly stateListeners: Set<(state: TrainingState) => void> = new Set();\n\n  // Training state\n  private currentEpoch = 0;\n  private currentLoss: number | null = null;\n  private currentAccuracy: number | null = null;\n  private currentValLoss: number | null = null;\n  private currentValAccuracy: number | null = null;\n  private isInitialised = false;\n  private datasetLoaded = false;\n\n  // Training history\n  private history: TrainingHistory = createEmptyHistory();\n  private trainingStartTime = 0;\n\n  // Loop control flags\n  private isTraining = false;\n  private isPaused = false;\n  private isProcessingStep = false;\n\n  // Data caches (reused to reduce GC pressure)\n  private allData: Point[] = []; // Original full dataset\n  private trainingData: Point[] = []; // Training split\n  private validationData: Point[] = []; // Validation split\n  private readonly predictionGrid: Point[] = [];\n  private cachedPredictions: Prediction[] = [];\n\n  // Runtime training configuration\n  private trainingConfig: Required<TrainingConfig> = { ...DEFAULT_TRAINING_CONFIG };\n\n  // Timing control\n  private lastFrameTime = 0;\n  private frameInterval = 0; // ms between frames (0 = no limit)\n\n  // Early stopping tracking\n  private bestValLoss: number | null = null;\n  private epochsWithoutImprovement = 0;\n\n  // Learning rate scheduling\n  private initialLearningRate = 0.03;\n  private currentLearningRate = 0.03;\n  private currentHyperparameters: Hyperparameters | null = null;\n\n  // Completion callback\n  private onCompleteCallback: ((reason: 'maxEpochs' | 'earlyStopping' | 'manual') => void) | null = null;\n\n  // Boundary evolution recording\n  private boundarySnapshots: Array<{ epoch: number; predictions: Prediction[] }> = [];\n  private recordingEnabled = false;\n  private snapshotInterval = 10; // Record every N epochs\n\n  constructor(\n    private readonly neuralNet: INeuralNetworkService,\n    private readonly visualizer: IVisualizerService,\n    private readonly dataRepo: IDatasetRepository,\n    config: Partial<TrainingSessionConfig> = {}\n  ) {\n    this.config = { ...DEFAULT_CONFIG, ...config };\n    this.initialisePredictionGrid();\n  }\n\n  /**\n   * Returns a snapshot of the current training state.\n   * isRunning is derived from isTraining flag.\n   */\n  getState(): TrainingState {\n    return {\n      currentEpoch: this.currentEpoch,\n      currentLoss: this.currentLoss,\n      currentAccuracy: this.currentAccuracy,\n      currentValLoss: this.currentValLoss,\n      currentValAccuracy: this.currentValAccuracy,\n      isRunning: this.isTraining,\n      isPaused: this.isPaused,\n      isInitialised: this.isInitialised,\n      datasetLoaded: this.datasetLoaded,\n      maxEpochs: this.trainingConfig.maxEpochs,\n      batchSize: this.trainingConfig.batchSize,\n      targetFps: this.trainingConfig.targetFps,\n      validationSplit: this.trainingConfig.validationSplit,\n      history: this.history,\n    };\n  }\n\n  /**\n   * Updates runtime training configuration.\n   * Can be called during training to adjust batch size, speed, etc.\n   */\n  setTrainingConfig(config: Partial<TrainingConfig>): void {\n    this.trainingConfig = { ...this.trainingConfig, ...config };\n\n    // Update frame interval based on target FPS\n    if (config.targetFps !== undefined) {\n      this.frameInterval = config.targetFps > 0 ? 1000 / config.targetFps : 0;\n    }\n\n    // Update frame interval based on epoch delay\n    if (config.epochDelayMs !== undefined && config.epochDelayMs > 0) {\n      this.frameInterval = config.epochDelayMs;\n    }\n\n    // Re-split data if validation split changed\n    if (config.validationSplit !== undefined && this.allData.length > 0) {\n      this.splitData();\n    }\n\n    this.notifyListeners();\n  }\n\n  async setHyperparameters(config: Hyperparameters): Promise<void> {\n    await this.neuralNet.initialize(config);\n    this.isInitialised = true;\n    this.currentEpoch = 0;\n    this.currentLoss = null;\n    this.currentAccuracy = null;\n    this.history = createEmptyHistory();\n\n    // Store for LR scheduling\n    this.currentHyperparameters = config;\n    this.initialLearningRate = config.learningRate;\n    this.currentLearningRate = config.learningRate;\n\n    // Reset early stopping\n    this.bestValLoss = null;\n    this.epochsWithoutImprovement = 0;\n\n    this.notifyListeners();\n  }\n\n  /**\n   * Exports training history in the specified format.\n   */\n  exportHistory(format: ExportFormat): string {\n    return exportHistory(this.history, format);\n  }\n\n  async loadData(datasetType: string, options?: DatasetOptions): Promise<void> {\n    const rawData = await this.dataRepo.getDataset(datasetType, options);\n    this.allData = this.applyPreprocessing(rawData, options?.preprocessing ?? 'none');\n    this.splitData();\n    this.datasetLoaded = true;\n    this.visualizer.renderData(this.allData);\n    this.notifyListeners();\n  }\n\n  /**\n   * Applies preprocessing to the dataset features.\n   */\n  private applyPreprocessing(data: Point[], method: 'none' | 'normalize' | 'standardize'): Point[] {\n    if (method === 'none' || data.length === 0) {\n      return data;\n    }\n\n    const xs = data.map(p => p.x);\n    const ys = data.map(p => p.y);\n\n    if (method === 'normalize') {\n      // Min-max normalization to [-1, 1]\n      const xMin = Math.min(...xs);\n      const xMax = Math.max(...xs);\n      const yMin = Math.min(...ys);\n      const yMax = Math.max(...ys);\n\n      const xRange = xMax - xMin || 1;\n      const yRange = yMax - yMin || 1;\n\n      return data.map(p => ({\n        x: ((p.x - xMin) / xRange) * 2 - 1,\n        y: ((p.y - yMin) / yRange) * 2 - 1,\n        label: p.label,\n      }));\n    }\n\n    if (method === 'standardize') {\n      // Z-score standardization\n      const xMean = xs.reduce((a, b) => a + b, 0) / xs.length;\n      const yMean = ys.reduce((a, b) => a + b, 0) / ys.length;\n\n      const xStd = Math.sqrt(xs.reduce((sum, x) => sum + (x - xMean) ** 2, 0) / xs.length) || 1;\n      const yStd = Math.sqrt(ys.reduce((sum, y) => sum + (y - yMean) ** 2, 0) / ys.length) || 1;\n\n      return data.map(p => ({\n        x: (p.x - xMean) / xStd,\n        y: (p.y - yMean) / yStd,\n        label: p.label,\n      }));\n    }\n\n    return data;\n  }\n\n  /**\n   * Splits the dataset into training and validation sets based on validationSplit.\n   * Shuffles data before splitting for randomness.\n   */\n  private splitData(): void {\n    const { validationSplit } = this.trainingConfig;\n\n    if (validationSplit <= 0 || validationSplit >= 1) {\n      // No validation split\n      this.trainingData = this.allData;\n      this.validationData = [];\n      return;\n    }\n\n    // Shuffle data\n    const shuffled = [...this.allData];\n    for (let i = shuffled.length - 1; i > 0; i--) {\n      const j = Math.floor(Math.random() * (i + 1));\n      const temp = shuffled[i] as Point;\n      shuffled[i] = shuffled[j] as Point;\n      shuffled[j] = temp;\n    }\n\n    // Split\n    const splitIndex = Math.floor(shuffled.length * (1 - validationSplit));\n    this.trainingData = shuffled.slice(0, splitIndex).map(p => ({ ...p, isValidation: false }));\n    this.validationData = shuffled.slice(splitIndex).map(p => ({ ...p, isValidation: true }));\n\n    // Update allData with validation markers for visualization\n    this.allData = [...this.trainingData, ...this.validationData];\n  }\n\n  /**\n   * Starts the training loop.\n   * Uses requestAnimationFrame with a guard-rail to prevent overlapping calls.\n   */\n  start(): void {\n    this.assertReadyToTrain();\n\n    if (this.isTraining && !this.isPaused) {\n      return; // Already running\n    }\n\n    this.isTraining = true;\n    this.isPaused = false;\n    this.notifyListeners();\n\n    // Kick off the guard-rail loop\n    void this.loop();\n  }\n\n  /**\n   * Pauses the training loop.\n   * The current step will complete, but no new steps will start.\n   */\n  pause(): void {\n    if (!this.isTraining) {\n      return;\n    }\n\n    this.isPaused = true;\n    this.notifyListeners();\n  }\n\n  /**\n   * Resets training state to initial values.\n   * Stops the loop and clears epoch/loss/history.\n   */\n  reset(): void {\n    this.isTraining = false;\n    this.isPaused = false;\n    this.isProcessingStep = false;\n    this.currentEpoch = 0;\n    this.currentLoss = null;\n    this.currentAccuracy = null;\n    this.currentValLoss = null;\n    this.currentValAccuracy = null;\n    this.history = createEmptyHistory();\n\n    // Re-split data (shuffles again for different validation set)\n    if (this.allData.length > 0) {\n      this.splitData();\n    }\n\n    // Re-render data points without boundary\n    if (this.datasetLoaded) {\n      this.visualizer.renderData(this.allData);\n    }\n\n    this.notifyListeners();\n  }\n\n  /**\n   * Clears all data and resets to initial state.\n   * Use this for a full session clear.\n   */\n  clearAll(): void {\n    // Stop training\n    this.isTraining = false;\n    this.isPaused = false;\n    this.isProcessingStep = false;\n\n    // Clear training progress\n    this.currentEpoch = 0;\n    this.currentLoss = null;\n    this.currentAccuracy = null;\n    this.currentValLoss = null;\n    this.currentValAccuracy = null;\n    this.history = createEmptyHistory();\n\n    // Clear all data\n    this.allData = [];\n    this.trainingData = [];\n    this.validationData = [];\n    this.datasetLoaded = false;\n    this.isInitialised = false;\n\n    // Clear visualisation\n    this.visualizer.clear();\n\n    this.notifyListeners();\n  }\n\n  /**\n   * Executes a single training step manually.\n   * Useful for step-by-step debugging.\n   */\n  async step(): Promise<void> {\n    this.assertReadyToTrain();\n\n    // Prevent overlapping manual steps\n    if (this.isProcessingStep) {\n      return;\n    }\n\n    this.isProcessingStep = true;\n\n    try {\n      this.currentEpoch++;\n\n      // Train on training data\n      const result = await this.neuralNet.train(this.trainingData);\n      this.currentLoss = result.loss;\n      this.currentAccuracy = result.accuracy;\n\n      // Evaluate on validation data if available\n      let valLoss: number | null = null;\n      let valAccuracy: number | null = null;\n\n      if (this.validationData.length > 0) {\n        const valResult = await this.neuralNet.evaluate(this.validationData);\n        valLoss = valResult.loss;\n        valAccuracy = valResult.accuracy;\n        this.currentValLoss = valLoss;\n        this.currentValAccuracy = valAccuracy;\n      }\n\n      // Record in history\n      this.history = addHistoryRecord(this.history, {\n        epoch: this.currentEpoch,\n        loss: result.loss,\n        accuracy: result.accuracy,\n        valLoss,\n        valAccuracy,\n        timestamp: performance.now(),\n      });\n\n      // Render boundary at intervals\n      if (this.currentEpoch % this.config.renderInterval === 0) {\n        await this.updateVisualisation();\n      }\n\n      this.notifyListeners();\n    } finally {\n      this.isProcessingStep = false;\n    }\n  }\n\n  onStateChange(callback: (state: TrainingState) => void): () => void {\n    this.stateListeners.add(callback);\n    return () => this.stateListeners.delete(callback);\n  }\n\n  /**\n   * Cleans up resources and stops the training loop.\n   */\n  dispose(): void {\n    this.isTraining = false;\n    this.isPaused = false;\n    this.isProcessingStep = false;\n    this.stateListeners.clear();\n    // Note: neuralNet.dispose() should be called by the composition root\n  }\n\n  // ===========================================================================\n  // Guard-Rail Training Loop\n  // ===========================================================================\n\n  /**\n   * The main training loop with guard-rail protection.\n   *\n   * Key behaviour:\n   * 1. If not training or paused  exit\n   * 2. If max epochs reached  auto-stop\n   * 3. If already processing a step  skip this frame (GPU busy)\n   * 4. If frame interval not elapsed  skip (speed control)\n   * 5. Otherwise  execute step, then schedule next frame\n   *\n   * This ensures we never start Step N+1 before Step N completes,\n   * even if requestAnimationFrame fires faster than GPU training.\n   */\n  private async loop(): Promise<void> {\n    // Exit condition: training stopped or paused\n    if (!this.isTraining || this.isPaused) {\n      return;\n    }\n\n    // Check epoch limit (auto-stop)\n    const { maxEpochs } = this.trainingConfig;\n    if (maxEpochs > 0 && this.currentEpoch >= maxEpochs) {\n      this.isTraining = false;\n      this.notifyListeners();\n      this.onCompleteCallback?.('maxEpochs');\n      return;\n    }\n\n    // Guard-rail: skip if previous step still processing\n    if (this.isProcessingStep) {\n      // Schedule next check without executing a step\n      requestAnimationFrame(() => void this.loop());\n      return;\n    }\n\n    // Speed control: check if enough time has passed\n    const now = performance.now();\n    if (this.frameInterval > 0 && now - this.lastFrameTime < this.frameInterval) {\n      requestAnimationFrame(() => void this.loop());\n      return;\n    }\n    this.lastFrameTime = now;\n\n    // Lock: prevent overlapping execution\n    this.isProcessingStep = true;\n\n    try {\n      // Get training batch (all data or subset)\n      const batch = this.getTrainingBatch();\n\n      // Execute training step\n      this.currentEpoch++;\n      const result = await this.neuralNet.train(batch);\n      this.currentLoss = result.loss;\n      this.currentAccuracy = result.accuracy;\n\n      // Evaluate on validation data if available\n      let valLoss: number | null = null;\n      let valAccuracy: number | null = null;\n\n      if (this.validationData.length > 0) {\n        const valResult = await this.neuralNet.evaluate(this.validationData);\n        valLoss = valResult.loss;\n        valAccuracy = valResult.accuracy;\n        this.currentValLoss = valLoss;\n        this.currentValAccuracy = valAccuracy;\n      }\n\n      // Record in history\n      this.history = addHistoryRecord(this.history, {\n        epoch: this.currentEpoch,\n        loss: result.loss,\n        accuracy: result.accuracy,\n        valLoss,\n        valAccuracy,\n        timestamp: performance.now(),\n      });\n\n      // Check early stopping\n      if (this.checkEarlyStopping(valLoss)) {\n        this.isTraining = false;\n        this.notifyListeners();\n        this.onCompleteCallback?.('earlyStopping');\n        logger.info(`Early stopping triggered at epoch ${this.currentEpoch}`, {\n          component: 'TrainingSession',\n          action: 'earlyStopping',\n          epoch: this.currentEpoch,\n        });\n        return; // Exit loop\n      }\n\n      // Update learning rate based on schedule\n      this.updateLearningRateIfNeeded();\n\n      // Update visualisation at intervals (decouples rendering from training)\n      if (this.currentEpoch % this.config.renderInterval === 0) {\n        await this.updateVisualisation();\n      }\n\n      // Record boundary snapshot if recording is enabled\n      if (this.recordingEnabled && this.currentEpoch % this.snapshotInterval === 0) {\n        this.boundarySnapshots.push({\n          epoch: this.currentEpoch,\n          predictions: [...this.cachedPredictions],\n        });\n      }\n\n      this.notifyListeners();\n    } catch (error) {\n      // Stop training on error (e.g., GradientExplosionError)\n      this.isTraining = false;\n      this.notifyListeners();\n      console.error('Training loop error:', error);\n      logger.error(\n        'Training loop crashed',\n        error instanceof Error ? error : new Error(String(error)),\n        {\n          component: 'TrainingSession',\n          action: 'loop',\n          epoch: this.currentEpoch,\n        }\n      );\n    } finally {\n      // Unlock: allow next step\n      this.isProcessingStep = false;\n    }\n\n    // Schedule next frame (only if still training and not at epoch limit)\n    if (this.isTraining && !this.isPaused) {\n      const stillUnderLimit = maxEpochs === 0 || this.currentEpoch < maxEpochs;\n      if (stillUnderLimit) {\n        requestAnimationFrame(() => void this.loop());\n      } else {\n        // Reached epoch limit\n        this.isTraining = false;\n        this.notifyListeners();\n        this.onCompleteCallback?.('maxEpochs');\n      }\n    }\n  }\n\n  /**\n   * Returns a batch of training data based on batchSize config.\n   * If batchSize is 0 or >= data length, returns all data.\n   * Otherwise, returns a random subset.\n   */\n  private getTrainingBatch(): Point[] {\n    const { batchSize } = this.trainingConfig;\n\n    // Use all data if batchSize is 0 or larger than dataset\n    if (batchSize <= 0 || batchSize >= this.trainingData.length) {\n      return this.trainingData;\n    }\n\n    // Random sampling without replacement\n    const shuffled = [...this.trainingData];\n    for (let i = shuffled.length - 1; i > 0; i--) {\n      const j = Math.floor(Math.random() * (i + 1));\n      const temp = shuffled[i] as Point;\n      shuffled[i] = shuffled[j] as Point;\n      shuffled[j] = temp;\n    }\n\n    return shuffled.slice(0, batchSize);\n  }\n\n  // ===========================================================================\n  // Visualisation\n  // ===========================================================================\n\n  /**\n   * Updates the decision boundary visualisation.\n   *\n   * @remarks\n   * The predictionGrid is reused across calls (no new allocations for input).\n   * Predictions are immutable by design, so we replace the cached array.\n   * Guards against rendering after session has been cleared.\n   */\n  private async updateVisualisation(): Promise<void> {\n    // Guard: don't render if session was cleared while async operation was pending\n    if (!this.datasetLoaded) {\n      return;\n    }\n\n    // Get predictions (predictionGrid is reused, reducing input allocations)\n    this.cachedPredictions = await this.neuralNet.predict(this.predictionGrid);\n\n    // Guard again after async operation - session may have been cleared\n    if (!this.datasetLoaded) {\n      return;\n    }\n\n    // Render boundary, then data points on top\n    this.visualizer.renderBoundary(this.cachedPredictions, this.config.gridSize);\n    this.visualizer.renderData(this.allData);\n  }\n\n  // ===========================================================================\n  // Initialisation Helpers\n  // ===========================================================================\n\n  /**\n   * Pre-generates the prediction grid (once, at construction).\n   * Grid points are in [-1, 1] range for both axes.\n   */\n  private initialisePredictionGrid(): void {\n    const { gridSize } = this.config;\n\n    // Clear and reuse existing array\n    this.predictionGrid.length = 0;\n\n    for (let i = 0; i < gridSize; i++) {\n      for (let j = 0; j < gridSize; j++) {\n        // Map grid indices to [-1, 1] range\n        const x = (i / (gridSize - 1)) * 2 - 1;\n        const y = (j / (gridSize - 1)) * 2 - 1;\n        this.predictionGrid.push({ x, y, label: 0 });\n      }\n    }\n  }\n\n  private notifyListeners(): void {\n    const state = this.getState();\n    for (const listener of this.stateListeners) {\n      listener(state);\n    }\n  }\n\n  private assertReadyToTrain(): void {\n    if (!this.isInitialised) {\n      throw new Error('Hyperparameters not set. Call setHyperparameters() first.');\n    }\n    if (!this.datasetLoaded) {\n      throw new Error('No data loaded. Call loadData() first.');\n    }\n  }\n\n  // ===========================================================================\n  // Custom Data\n  // ===========================================================================\n\n  /**\n   * Sets custom data points directly (for draw mode).\n   * Bypasses the data repository and uses provided points.\n   */\n  setCustomData(points: Point[]): void {\n    this.allData = [...points];\n    this.datasetLoaded = points.length > 0;\n\n    // Split into training/validation\n    if (points.length > 0) {\n      this.splitData();\n    } else {\n      this.trainingData = [];\n      this.validationData = [];\n    }\n\n    this.notifyListeners();\n  }\n\n  /**\n   * Returns the current dataset points.\n   * Useful for session persistence.\n   */\n  getData(): Point[] {\n    return [...this.allData];\n  }\n\n  /**\n   * Returns the current training history.\n   */\n  getHistory(): TrainingHistory {\n    return this.history;\n  }\n\n  /**\n   * Returns the current learning rate (after warmup/decay adjustments).\n   */\n  getCurrentLearningRate(): number {\n    return this.currentLearningRate;\n  }\n\n  // ===========================================================================\n  // Learning Rate Scheduling\n  // ===========================================================================\n\n  /**\n   * Calculates the learning rate based on the current epoch and schedule.\n   * Applies warmup first if configured, then applies the decay schedule.\n   */\n  private calculateScheduledLR(epoch: number): number {\n    const schedule = this.trainingConfig.lrSchedule ?? DEFAULT_LR_SCHEDULE;\n    const initialLR = this.initialLearningRate;\n    const warmupEpochs = schedule.warmupEpochs ?? 0;\n\n    // Apply warmup: linear increase from 0 to initialLR\n    if (warmupEpochs > 0 && epoch < warmupEpochs) {\n      return initialLR * (epoch + 1) / warmupEpochs;\n    }\n\n    // Adjust epoch for decay calculation (subtract warmup epochs)\n    const effectiveEpoch = warmupEpochs > 0 ? epoch - warmupEpochs : epoch;\n\n    switch (schedule.type) {\n      case 'exponential': {\n        // LR = initial_lr * decay_rate^epoch\n        const decayRate = schedule.decayRate ?? 0.95;\n        return initialLR * Math.pow(decayRate, effectiveEpoch);\n      }\n\n      case 'step': {\n        // LR = initial_lr * decay_rate^(epoch / decay_steps)\n        const decayRate = schedule.decayRate ?? 0.5;\n        const decaySteps = schedule.decaySteps ?? 10;\n        const numDecays = Math.floor(effectiveEpoch / decaySteps);\n        return initialLR * Math.pow(decayRate, numDecays);\n      }\n\n      case 'cosine': {\n        // Cosine annealing: LR = initial_lr * 0.5 * (1 + cos(pi * epoch / max_epochs))\n        const maxEpochs = Math.max((this.trainingConfig.maxEpochs || 100) - warmupEpochs, 1);\n        const progress = Math.min(effectiveEpoch / maxEpochs, 1);\n        return initialLR * 0.5 * (1 + Math.cos(Math.PI * progress));\n      }\n\n      case 'cyclic_triangular': {\n        // Triangle wave between minLR and maxLR (initialLR)\n        const cycleLength = schedule.cycleLength ?? 20;\n        const minLR = schedule.minLR ?? initialLR / 10;\n        const cyclePosition = effectiveEpoch % cycleLength;\n        const halfCycle = cycleLength / 2;\n\n        // Triangle: rise for first half, fall for second half\n        const triangleValue = cyclePosition < halfCycle\n          ? cyclePosition / halfCycle\n          : 1 - (cyclePosition - halfCycle) / halfCycle;\n\n        return minLR + (initialLR - minLR) * triangleValue;\n      }\n\n      case 'cyclic_cosine': {\n        // Cosine wave between minLR and maxLR (initialLR)\n        const cycleLength = schedule.cycleLength ?? 20;\n        const minLR = schedule.minLR ?? initialLR / 10;\n        const cyclePosition = effectiveEpoch % cycleLength;\n\n        // Cosine: smooth oscillation\n        const cosineValue = 0.5 * (1 + Math.cos(Math.PI * cyclePosition / cycleLength));\n\n        return minLR + (initialLR - minLR) * cosineValue;\n      }\n\n      case 'none':\n      default:\n        return initialLR;\n    }\n  }\n\n  /**\n   * Updates the learning rate if it has changed significantly.\n   * Uses updateLearningRate() to preserve trained weights.\n   */\n  private updateLearningRateIfNeeded(): void {\n    const newLR = this.calculateScheduledLR(this.currentEpoch);\n\n    // Only update if LR changed by more than 1%\n    const lrChangeRatio = Math.abs(newLR - this.currentLearningRate) / this.currentLearningRate;\n    if (lrChangeRatio > 0.01 && this.currentHyperparameters) {\n      this.currentLearningRate = newLR;\n\n      // Update optimizer learning rate WITHOUT destroying weights\n      this.neuralNet.updateLearningRate(newLR);\n    }\n  }\n\n  // ===========================================================================\n  // Early Stopping\n  // ===========================================================================\n\n  /**\n   * Checks if training should stop early based on validation loss.\n   * Returns true if early stopping is triggered.\n   */\n  private checkEarlyStopping(valLoss: number | null): boolean {\n    const patience = this.trainingConfig.earlyStoppingPatience ?? 0;\n\n    // Early stopping disabled\n    if (patience <= 0 || valLoss === null) {\n      return false;\n    }\n\n    // First validation loss - set as best\n    if (this.bestValLoss === null) {\n      this.bestValLoss = valLoss;\n      this.epochsWithoutImprovement = 0;\n      return false;\n    }\n\n    // Check if validation loss improved\n    if (valLoss < this.bestValLoss) {\n      this.bestValLoss = valLoss;\n      this.epochsWithoutImprovement = 0;\n      return false;\n    }\n\n    // No improvement\n    this.epochsWithoutImprovement++;\n\n    // Trigger early stopping if patience exceeded\n    return this.epochsWithoutImprovement >= patience;\n  }\n\n  /**\n   * Sets a callback to be called when training completes.\n   * @param callback - Function called with completion reason\n   */\n  onComplete(callback: (reason: 'maxEpochs' | 'earlyStopping' | 'manual') => void): void {\n    this.onCompleteCallback = callback;\n  }\n\n  /**\n   * Enables or disables boundary evolution recording.\n   * @param enabled - Whether to record snapshots\n   * @param interval - Epochs between snapshots (default: 10)\n   */\n  setRecording(enabled: boolean, interval = 10): void {\n    this.recordingEnabled = enabled;\n    this.snapshotInterval = interval;\n    if (enabled) {\n      this.boundarySnapshots = [];\n    }\n  }\n\n  /**\n   * Returns recorded boundary snapshots.\n   */\n  getBoundarySnapshots(): Array<{ epoch: number; predictions: Prediction[] }> {\n    return [...this.boundarySnapshots];\n  }\n\n  /**\n   * Clears recorded boundary snapshots.\n   */\n  clearBoundarySnapshots(): void {\n    this.boundarySnapshots = [];\n  }\n\n  /**\n   * Runs learning rate finder test.\n   * Trains with exponentially increasing LR and records loss at each step.\n   * @param minLR - Starting learning rate (default: 1e-7)\n   * @param maxLR - Ending learning rate (default: 1)\n   * @param steps - Number of steps (default: 100)\n   * @returns Array of {lr, loss} points\n   */\n  async runLRFinder(\n    minLR = 1e-7,\n    maxLR = 1,\n    steps = 100\n  ): Promise<Array<{ lr: number; loss: number }>> {\n    this.assertReadyToTrain();\n\n    const results: Array<{ lr: number; loss: number }> = [];\n    const lrMultiplier = Math.pow(maxLR / minLR, 1 / steps);\n    let currentLR = minLR;\n\n    // Store original hyperparameters to restore later\n    const originalHyperparams = this.currentHyperparameters;\n    if (!originalHyperparams) {\n      throw new Error('Model not initialized');\n    }\n\n    // Run training steps with increasing LR\n    for (let i = 0; i < steps; i++) {\n      // Use dedicated method to update LR without destroying weights\n      if ('setLearningRate' in this.neuralNet) {\n        // @ts-ignore - We know it exists on our implementation\n        this.neuralNet.setLearningRate(currentLR);\n      } else {\n        // Fallback for implementations that don't support dynamic LR\n        await this.neuralNet.initialize({\n          ...originalHyperparams,\n          learningRate: currentLR,\n        });\n      }\n\n      // Train one batch\n      const batch = this.getTrainingBatch();\n      const result = await this.neuralNet.train(batch);\n\n      results.push({\n        lr: currentLR,\n        loss: result.loss,\n      });\n\n      // Stop if loss explodes\n      if (!isFinite(result.loss) || result.loss > 1e10) {\n        break;\n      }\n\n      // Increase LR exponentially\n      currentLR *= lrMultiplier;\n    }\n\n    // Restore original model\n    await this.neuralNet.initialize(originalHyperparams);\n\n    return results;\n  }\n}\n","/**\n * Custom errors for TensorFlow.js neural network operations.\n */\n\n/**\n * Thrown when gradient explosion causes NaN loss during training.\n * Typically indicates the learning rate is too high.\n */\nexport class GradientExplosionError extends Error {\n  readonly code = 'GRADIENT_EXPLOSION';\n\n  constructor(message = 'Training produced NaN loss. Try lowering the learning rate.') {\n    super(message);\n    this.name = 'GradientExplosionError';\n    Object.setPrototypeOf(this, GradientExplosionError.prototype);\n  }\n}\n\n/**\n * Thrown when attempting to use an uninitialised model.\n */\nexport class ModelNotInitialisedError extends Error {\n  readonly code = 'MODEL_NOT_INITIALISED';\n\n  constructor(message = 'Model not initialised. Call initialize() first.') {\n    super(message);\n    this.name = 'ModelNotInitialisedError';\n    Object.setPrototypeOf(this, ModelNotInitialisedError.prototype);\n  }\n}\n","import * as tf from '@tensorflow/tfjs';\nimport type { INeuralNetworkService, TrainResult } from '../../core/ports';\nimport type { Hyperparameters, Point, Prediction, OptimizerType, ActivationType } from '../../core/domain';\nimport { DEFAULT_HYPERPARAMETERS } from '../../core/domain';\nimport { GradientExplosionError, ModelNotInitialisedError } from './errors';\n\n/**\n * TensorFlow.js implementation of INeuralNetworkService.\n * Encapsulates all TF.js logicno other module should import tensorflow directly.\n *\n * @remarks\n * Memory Management Strategy:\n * - `tf.tidy()` for synchronous tensor operations (predict)\n * - Manual `dispose()` in `finally` blocks for async operations (trainOnBatch)\n * - Model disposal on re-initialisation to prevent GPU memory leaks\n *\n * @example\n * ```ts\n * const net = new TFNeuralNet();\n * await net.initialize({ learningRate: 0.03, layers: [8, 4] });\n * const loss = await net.train(points);\n * const predictions = await net.predict(grid);\n * net.dispose(); // Clean up when done\n * ```\n */\nexport class TFNeuralNet implements INeuralNetworkService {\n  private model: tf.Sequential | null = null;\n  private config: Hyperparameters | null = null;\n  private numClasses = 2;\n  private clipNorm = 0;\n\n  /**\n   * Initialises a new sequential model with the given hyperparameters.\n   * Disposes any existing model to prevent memory leaks.\n   *\n   * @param config - Network architecture and training configuration\n   */\n  async initialize(config: Hyperparameters): Promise<void> {\n    this.dispose();\n    this.config = config;\n    this.numClasses = config.numClasses ?? 2;\n    this.model = this.buildModel(config);\n  }\n\n  /**\n   * Updates the learning rate of the current model WITHOUT destroying trained weights.\n   * Preserves all learned weights by saving and restoring them during optimizer update.\n   *\n   * @param newLearningRate - The new learning rate to apply\n   * @throws {ModelNotInitialisedError} If called before initialize()\n   *\n   * @remarks\n   * TensorFlow.js doesn't provide a direct way to update optimizer learning rate,\n   * so we recompile the model with a new optimizer while preserving weights.\n   */\n  updateLearningRate(newLearningRate: number): void {\n    const model = this.assertInitialised();\n    if (!this.config) {\n      throw new ModelNotInitialisedError();\n    }\n\n    // Save current weights before recompiling\n    const weights = model.getWeights();\n\n    // Update config with new learning rate\n    this.config = { ...this.config, learningRate: newLearningRate };\n\n    // Create new optimizer with updated learning rate\n    const optimizer = this.createOptimizer(\n      this.config.optimizer ?? DEFAULT_HYPERPARAMETERS.optimizer,\n      newLearningRate,\n      this.config.momentum ?? DEFAULT_HYPERPARAMETERS.momentum,\n      this.config.clipNorm ?? 0\n    );\n\n    // Recompile model with new optimizer (preserves architecture and weights)\n    const loss = this.numClasses === 2 ? 'binaryCrossentropy' : 'categoricalCrossentropy';\n    model.compile({\n      optimizer,\n      loss,\n      metrics: ['accuracy'],\n    });\n\n    // Restore weights - they persist through recompilation\n    model.setWeights(weights);\n\n    // Dispose old weight tensors to prevent memory leak\n    weights.forEach(w => w.dispose());\n  }\n\n  /**\n   * Trains the model on a single batch of labelled data points.\n   *\n   * @param data - Array of labelled points for supervised learning\n   * @returns The batch training loss value\n   * @throws {ModelNotInitialisedError} If called before initialize()\n   * @throws {GradientExplosionError} If loss is NaN (learning rate too high)\n   *\n   * @remarks\n   * Uses `trainOnBatch` for single-step training, enabling:\n   * - Real-time loss updates per epoch\n   * - Non-blocking UI during training loops\n   * - Fine-grained control over training flow\n   *\n   * Memory is manually managed via try/finally since `tf.tidy()`\n   * cannot wrap async operations like `trainOnBatch`.\n   */\n  async train(data: Point[]): Promise<TrainResult> {\n    const model = this.assertInitialised();\n\n    // Create tensors outside tf.tidy() since trainOnBatch is async\n    const xs = tf.tensor2d(data.map((p) => [p.x, p.y]));\n    const ys = this.createLabelTensor(data);\n\n    try {\n      // trainOnBatch returns [loss, accuracy] when metrics are configured\n      const result = await model.trainOnBatch(xs, ys);\n\n      // Extract loss and accuracy values\n      let loss: number;\n      let accuracy: number;\n\n      if (Array.isArray(result)) {\n        loss = result[0] ?? 0;\n        accuracy = result[1] ?? 0;\n      } else {\n        loss = result;\n        accuracy = 0;\n      }\n\n      // Check for gradient explosion\n      if (Number.isNaN(loss)) {\n        throw new GradientExplosionError();\n      }\n\n      return { loss, accuracy };\n    } finally {\n      // CRITICAL: Always dispose tensors to prevent GPU memory leaks\n      xs.dispose();\n      ys.dispose();\n    }\n  }\n\n  /**\n   * Evaluates the model on a dataset without updating weights.\n   * Used for validation loss calculation.\n   *\n   * @param data - Array of labelled points for evaluation\n   * @returns Evaluation result with loss and accuracy\n   * @throws {ModelNotInitialisedError} If called before initialize()\n   */\n  async evaluate(data: Point[]): Promise<TrainResult> {\n    const model = this.assertInitialised();\n\n    const xs = tf.tensor2d(data.map((p) => [p.x, p.y]));\n    const ys = this.createLabelTensor(data);\n\n    try {\n      // evaluate returns [loss, ...metrics] as scalars\n      const result = model.evaluate(xs, ys) as tf.Scalar[];\n\n      // Extract loss and accuracy\n      const lossValue = await result[0]?.data();\n      const accuracyValue = await result[1]?.data();\n\n      // Dispose result tensors\n      result.forEach((t) => t.dispose());\n\n      return {\n        loss: lossValue?.[0] ?? 0,\n        accuracy: accuracyValue?.[0] ?? 0,\n      };\n    } finally {\n      xs.dispose();\n      ys.dispose();\n    }\n  }\n\n  /**\n   * Generates predictions for a grid of points.\n   * Batches all points in a single forward pass for GPU efficiency.\n   *\n   * @param grid - Array of points to classify (labels are ignored)\n   * @returns Predictions with confidence scores [0, 1] for each point\n   * @throws {ModelNotInitialisedError} If called before initialize()\n   *\n   * @remarks\n   * Uses `tf.tidy()` for automatic memory cleanup of intermediate tensors.\n   * Returns data asynchronously via `.data()` to keep UI responsive.\n   */\n  async predict(grid: Point[]): Promise<Prediction[]> {\n    const model = this.assertInitialised();\n\n    // Create input tensor (manual disposal since we need async .data())\n    const inputTensor = tf.tensor2d(grid.map((p) => [p.x, p.y]));\n\n    try {\n      // Run inference\n      const outputTensor = model.predict(inputTensor) as tf.Tensor;\n\n      try {\n        // Use async .data() to avoid blocking the UI thread\n        const outputData = await outputTensor.data();\n\n        return grid.map((point, index) => {\n          if (this.numClasses === 2) {\n            // Binary classification: single sigmoid output\n            const confidence = outputData[index] ?? 0.5;\n            return {\n              x: point.x,\n              y: point.y,\n              confidence,\n              predictedClass: confidence >= 0.5 ? 1 : 0,\n              probabilities: [1 - confidence, confidence],\n            };\n          } else {\n            // Multi-class: softmax output\n            const startIdx = index * this.numClasses;\n            const probs: number[] = [];\n            let maxProb = 0;\n            let predictedClass = 0;\n\n            for (let c = 0; c < this.numClasses; c++) {\n              const prob = outputData[startIdx + c] ?? 0;\n              probs.push(prob);\n              if (prob > maxProb) {\n                maxProb = prob;\n                predictedClass = c;\n              }\n            }\n\n            return {\n              x: point.x,\n              y: point.y,\n              confidence: maxProb,\n              predictedClass,\n              probabilities: probs,\n            };\n          }\n        });\n      } finally {\n        outputTensor.dispose();\n      }\n    } finally {\n      inputTensor.dispose();\n    }\n  }\n\n  /**\n   * Disposes the current model and releases GPU memory.\n   * Safe to call multiple times or when no model exists.\n   */\n  dispose(): void {\n    if (this.model) {\n      this.model.dispose();\n      this.model = null;\n    }\n    this.config = null;\n  }\n\n  /**\n   * Exports the trained model as downloadable Blobs.\n   * Uses TensorFlow.js model serialization format.\n   */\n  async exportModel(): Promise<{ modelJson: Blob; weightsBlob: Blob }> {\n    const model = this.assertInitialised();\n\n    // Use custom IOHandler to capture the model data\n    const modelArtifacts = await new Promise<tf.io.ModelArtifacts>((resolve, reject) => {\n      const saveHandler: tf.io.IOHandler = {\n        save: async (artifacts) => {\n          resolve(artifacts);\n          return { modelArtifactsInfo: { dateSaved: new Date(), modelTopologyType: 'JSON' } };\n        },\n      };\n      model.save(saveHandler).catch(reject);\n    });\n\n    // Create model.json blob\n    const modelTopology = modelArtifacts.modelTopology;\n    const weightsManifest = [{\n      paths: ['weights.bin'],\n      weights: modelArtifacts.weightSpecs ?? [],\n    }];\n\n    const modelJson = JSON.stringify({\n      modelTopology,\n      weightsManifest,\n      format: 'layers-model',\n      generatedBy: 'NeuroViz',\n      convertedBy: null,\n    });\n\n    const modelJsonBlob = new Blob([modelJson], { type: 'application/json' });\n\n    // Create weights.bin blob\n    const weightsData = modelArtifacts.weightData;\n    let weightsBlob: Blob;\n    if (weightsData) {\n      // Handle both ArrayBuffer and ArrayBuffer[] cases\n      const buffers = Array.isArray(weightsData) ? weightsData : [weightsData];\n      weightsBlob = new Blob(buffers, { type: 'application/octet-stream' });\n    } else {\n      weightsBlob = new Blob([], { type: 'application/octet-stream' });\n    }\n\n    return { modelJson: modelJsonBlob, weightsBlob };\n  }\n\n  /**\n   * Loads a model from JSON and weights files.\n   * Disposes any existing model before loading.\n   */\n  async loadModel(modelJsonFile: File, weightsFile: File): Promise<void> {\n    this.dispose();\n\n    // Read the model JSON\n    const modelJsonText = await modelJsonFile.text();\n    const modelJson = JSON.parse(modelJsonText);\n\n    // Create a custom IOHandler that provides the model artifacts\n    const handler: tf.io.IOHandler = {\n      load: async () => {\n        const weightsBuffer = await weightsFile.arrayBuffer();\n        return {\n          modelTopology: modelJson.modelTopology,\n          weightSpecs: modelJson.weightsManifest?.[0]?.weights ?? [],\n          weightData: weightsBuffer,\n        };\n      },\n    };\n\n    // Load the model\n    this.model = (await tf.loadLayersModel(handler)) as tf.Sequential;\n  }\n\n  /**\n   * Returns the current number of tensors in GPU memory.\n   * Useful for debugging memory leaks.\n   */\n  static getMemoryInfo(): { numTensors: number; numBytes: number } {\n    const info = tf.memory();\n    return {\n      numTensors: info.numTensors,\n      numBytes: info.numBytes,\n    };\n  }\n\n  /**\n   * Gets all weights from the model as a flat array.\n   * Used for weight histogram visualization.\n   */\n  getWeights(): number[] {\n    if (!this.model) {\n      return [];\n    }\n\n    const allWeights: number[] = [];\n    const weights = this.model.getWeights();\n\n    for (const tensor of weights) {\n      const data = tensor.dataSync();\n      for (let i = 0; i < data.length; i++) {\n        const value = data[i];\n        if (value !== undefined) {\n          allWeights.push(value);\n        }\n      }\n    }\n\n    return allWeights;\n  }\n\n  /**\n   * Gets weight matrices for each layer connection.\n   * Used for network diagram weight visualization.\n   * @returns Array of weight matrices [layer][fromNode][toNode]\n   */\n  getWeightMatrices(): number[][][] {\n    if (!this.model) {\n      return [];\n    }\n\n    const matrices: number[][][] = [];\n    const weights = this.model.getWeights();\n\n    // Weights come in pairs: [kernel, bias, kernel, bias, ...]\n    // We only want the kernels (even indices)\n    for (let i = 0; i < weights.length; i += 2) {\n      const kernel = weights[i];\n      if (!kernel) continue;\n\n      const shape = kernel.shape;\n      const data = kernel.dataSync();\n      const [inputSize, outputSize] = shape;\n\n      if (inputSize === undefined || outputSize === undefined) continue;\n\n      const matrix: number[][] = [];\n      for (let from = 0; from < inputSize; from++) {\n        const row: number[] = [];\n        for (let to = 0; to < outputSize; to++) {\n          const idx = from * outputSize + to;\n          row.push(data[idx] ?? 0);\n        }\n        matrix.push(row);\n      }\n      matrices.push(matrix);\n    }\n\n    return matrices;\n  }\n\n  /**\n   * Gets activations for each layer given an input point.\n   * Used for neuron activation visualization.\n   * @param point - Input point to get activations for\n   * @returns Array of activation arrays per layer\n   */\n  getLayerActivations(point: Point): number[][] {\n    if (!this.model) {\n      return [];\n    }\n\n    const activations: number[][] = [];\n\n    // Create input tensor\n    const input = tf.tensor2d([[point.x, point.y]]);\n\n    try {\n      // Get activations from each layer\n      let currentInput: tf.Tensor = input;\n\n      for (const layer of this.model.layers) {\n        const output = layer.apply(currentInput) as tf.Tensor;\n        const data = output.dataSync();\n        activations.push(Array.from(data));\n\n        // Use this layer's output as next layer's input\n        if (currentInput !== input) {\n          currentInput.dispose();\n        }\n        currentInput = output;\n      }\n\n      // Dispose final output\n      if (currentInput !== input) {\n        currentInput.dispose();\n      }\n    } finally {\n      input.dispose();\n    }\n\n    return activations;\n  }\n\n  /**\n   * Returns the current network structure (layers and activations).\n   */\n  getStructure(): { layers: number[]; activations: string[] } | null {\n    if (!this.config) return null;\n\n    // Reconstruct full layer sizes including input and output\n    const layers = [2, ...this.config.layers, this.numClasses];\n\n    // Reconstruct activations\n    const defaultActivation = this.config.activation ?? DEFAULT_HYPERPARAMETERS.activation;\n    const layerActivations = this.config.layerActivations ?? [];\n\n    const activations = ['linear']; // Input layer\n    for (let i = 0; i < this.config.layers.length; i++) {\n      activations.push(layerActivations[i] ?? defaultActivation);\n    }\n    activations.push(this.numClasses === 2 ? 'sigmoid' : 'softmax'); // Output layer\n\n    return { layers, activations };\n  }\n\n  /**\n   * Builds a sequential model with the specified architecture.\n   *\n   * Architecture:\n   * - Input: 2 features (x, y coordinates)\n   * - Hidden: Configurable activation (per-layer or global), He Normal initialisation\n   * - Output: 1 unit sigmoid (binary) or N units softmax (multi-class)\n   */\n  private buildModel(config: Hyperparameters): tf.Sequential {\n    const model = tf.sequential();\n    const defaultActivation = config.activation ?? DEFAULT_HYPERPARAMETERS.activation;\n    const layerActivations = config.layerActivations ?? [];\n    const regularizer = this.createRegularizer(\n      config.l1Regularization ?? 0,\n      config.l2Regularization ?? 0\n    );\n    const numClasses = config.numClasses ?? 2;\n    const dropoutRate = config.dropoutRate ?? 0;\n    const useBatchNorm = config.batchNorm ?? false;\n\n    // Helper to get activation for a specific layer index\n    const getActivation = (layerIndex: number): 'relu' | 'sigmoid' | 'tanh' | 'elu' => {\n      const act = layerActivations[layerIndex] ?? defaultActivation;\n      return this.mapActivation(act);\n    };\n\n    // Input layer (first hidden layer)\n    // When using batch norm, apply activation after batch norm\n    model.add(\n      tf.layers.dense({\n        inputShape: [2],\n        units: config.layers[0] ?? 4,\n        activation: useBatchNorm ? 'linear' : getActivation(0),\n        kernelInitializer: 'heNormal',\n        kernelRegularizer: regularizer,\n      })\n    );\n\n    // Add batch normalization then activation if enabled\n    if (useBatchNorm) {\n      model.add(tf.layers.batchNormalization());\n      model.add(tf.layers.activation({ activation: getActivation(0) }));\n    }\n\n    // Add dropout after first hidden layer if enabled\n    if (dropoutRate > 0) {\n      model.add(tf.layers.dropout({ rate: dropoutRate }));\n    }\n\n    // Additional hidden layers\n    for (let i = 1; i < config.layers.length; i++) {\n      model.add(\n        tf.layers.dense({\n          units: config.layers[i] ?? 4,\n          activation: useBatchNorm ? 'linear' : getActivation(i),\n          kernelInitializer: 'heNormal',\n          kernelRegularizer: regularizer,\n        })\n      );\n\n      // Add batch normalization then activation if enabled\n      if (useBatchNorm) {\n        model.add(tf.layers.batchNormalization());\n        model.add(tf.layers.activation({ activation: getActivation(i) }));\n      }\n\n      // Add dropout after each hidden layer if enabled\n      if (dropoutRate > 0) {\n        model.add(tf.layers.dropout({ rate: dropoutRate }));\n      }\n    }\n\n    // Output layer - binary or multi-class (no dropout before output)\n    if (numClasses === 2) {\n      // Binary classification: single sigmoid output\n      model.add(\n        tf.layers.dense({\n          units: 1,\n          activation: 'sigmoid',\n        })\n      );\n    } else {\n      // Multi-class classification: softmax output\n      model.add(\n        tf.layers.dense({\n          units: numClasses,\n          activation: 'softmax',\n        })\n      );\n    }\n\n    const optimizer = this.createOptimizer(\n      config.optimizer ?? DEFAULT_HYPERPARAMETERS.optimizer,\n      config.learningRate,\n      config.momentum ?? DEFAULT_HYPERPARAMETERS.momentum,\n      config.clipNorm ?? 0\n    );\n\n    // Loss function depends on number of classes\n    const loss = numClasses === 2 ? 'binaryCrossentropy' : 'categoricalCrossentropy';\n\n    model.compile({\n      optimizer,\n      loss,\n      metrics: ['accuracy'],\n    });\n\n    return model;\n  }\n\n  /**\n   * Creates label tensor appropriate for binary or multi-class classification.\n   */\n  private createLabelTensor(data: Point[]): tf.Tensor {\n    if (this.numClasses === 2) {\n      // Binary: single column with 0 or 1\n      return tf.tensor2d(data.map((p) => [p.label]));\n    } else {\n      // Multi-class: one-hot encoded\n      return tf.oneHot(\n        tf.tensor1d(data.map((p) => p.label), 'int32'),\n        this.numClasses\n      );\n    }\n  }\n\n  /**\n   * Creates a TensorFlow.js optimizer based on the specified type.\n   * Applies gradient clipping if clipNorm > 0.\n   */\n  private createOptimizer(\n    type: OptimizerType,\n    learningRate: number,\n    momentum: number,\n    clipNorm: number\n  ): tf.Optimizer {\n    // TF.js optimizers don't have built-in clipNorm, but we can use clipByGlobalNorm\n    // For now, we'll store clipNorm and note that full implementation requires custom training\n    // The clipNorm value is stored for future use with custom gradient clipping\n    this.clipNorm = clipNorm;\n\n    switch (type) {\n      case 'sgd':\n        return tf.train.momentum(learningRate, momentum);\n      case 'adam':\n        return tf.train.adam(learningRate);\n      case 'rmsprop':\n        return tf.train.rmsprop(learningRate);\n      case 'adagrad':\n        return tf.train.adagrad(learningRate);\n      default:\n        return tf.train.adam(learningRate);\n    }\n  }\n\n  /**\n   * Maps activation type to TensorFlow.js activation identifier.\n   * Returns a string literal that TensorFlow.js accepts.\n   */\n  private mapActivation(type: ActivationType): 'relu' | 'sigmoid' | 'tanh' | 'elu' {\n    switch (type) {\n      case 'relu':\n        return 'relu';\n      case 'sigmoid':\n        return 'sigmoid';\n      case 'tanh':\n        return 'tanh';\n      case 'elu':\n        return 'elu';\n      default:\n        return 'relu';\n    }\n  }\n\n  /**\n   * Creates a regularizer combining L1 and L2 if either strength > 0.\n   */\n  private createRegularizer(l1Strength: number, l2Strength: number): ReturnType<typeof tf.regularizers.l1l2> | undefined {\n    if (l1Strength > 0 || l2Strength > 0) {\n      return tf.regularizers.l1l2({ l1: l1Strength, l2: l2Strength });\n    }\n    return undefined;\n  }\n\n  /**\n   * Updates the learning rate of the current optimizer.\n   * Does NOT dispose or rebuild the model, preserving weights.\n   *\n   * @param learningRate - The new learning rate to apply\n   * @throws {ModelNotInitialisedError} If called before initialize()\n   */\n  setLearningRate(learningRate: number): void {\n    const model = this.assertInitialised();\n\n    if (this.model && this.model.optimizer) {\n      // TF.js optimizers have a protected `learningRate` property\n      // We can update it directly if we cast to any, or use the public API if available.\n      // Most TF.js optimizers expose `learningRate` as a property.\n      // @ts-ignore - TF.js types might not expose the setter publicly but it exists at runtime\n      this.model.optimizer.learningRate = learningRate;\n    } else {\n      // Fallback: Re-compile with new optimizer (preserves weights)\n      // This is safer if we can't mutate the optimizer in-place\n      if (this.config) {\n        const newOptimizer = this.createOptimizer(\n          this.config.optimizer ?? DEFAULT_HYPERPARAMETERS.optimizer,\n          learningRate,\n          this.config.momentum ?? DEFAULT_HYPERPARAMETERS.momentum,\n          this.config.clipNorm ?? 0\n        );\n\n        model.compile({\n          optimizer: newOptimizer,\n          loss: this.numClasses === 2 ? 'binaryCrossentropy' : 'categoricalCrossentropy',\n          metrics: ['accuracy'],\n        });\n      }\n    }\n  }\n\n  /**\n   * Asserts the model has been initialised and returns it.\n   * @throws {ModelNotInitialisedError} If model is null\n   */\n  private assertInitialised(): tf.Sequential {\n    if (!this.model) {\n      throw new ModelNotInitialisedError();\n    }\n    return this.model;\n  }\n}\n","import * as d3 from 'd3';\nimport type { Point, Prediction } from '../../core/domain';\n\n/**\n * D3-based Voronoi diagram overlay for decision boundary visualization.\n * Shows decision regions as Voronoi cells based on data points.\n */\nexport class D3VoronoiOverlay {\n  private svg: d3.Selection<SVGGElement, unknown, null, undefined>;\n  private width: number;\n  private height: number;\n  private xScale: d3.ScaleLinear<number, number>;\n  private yScale: d3.ScaleLinear<number, number>;\n  private voronoiGroup: d3.Selection<SVGGElement, unknown, null, undefined> | null = null;\n\n  // Colour palette for classes\n  private classColours = [\n    '#3b82f6', // Blue\n    '#ef4444', // Red\n    '#22c55e', // Green\n    '#f59e0b', // Amber\n    '#8b5cf6', // Purple\n    '#06b6d4', // Cyan\n    '#ec4899', // Pink\n    '#84cc16', // Lime\n  ];\n\n  constructor(\n    svg: d3.Selection<SVGGElement, unknown, null, undefined>,\n    width: number,\n    height: number,\n    xScale: d3.ScaleLinear<number, number>,\n    yScale: d3.ScaleLinear<number, number>\n  ) {\n    this.svg = svg;\n    this.width = width;\n    this.height = height;\n    this.xScale = xScale;\n    this.yScale = yScale;\n  }\n\n  /**\n   * Renders the Voronoi diagram based on data points and their predictions.\n   * @param points - Data points\n   * @param predictions - Predictions for each point\n   * @param opacity - Opacity of the Voronoi cells (0-1)\n   */\n  render(points: Point[], predictions: Prediction[], opacity = 0.3): void {\n    this.clear();\n\n    if (points.length < 3) return; // Need at least 3 points for Voronoi\n\n    // Create Voronoi group\n    this.voronoiGroup = this.svg.append('g')\n      .attr('class', 'voronoi-overlay')\n      .lower(); // Put behind data points\n\n    // Map points to screen coordinates\n    const screenPoints: [number, number][] = points.map(p => [\n      this.xScale(p.x),\n      this.yScale(p.y)\n    ]);\n\n    // Create Voronoi diagram\n    const delaunay = d3.Delaunay.from(screenPoints);\n    const voronoi = delaunay.voronoi([0, 0, this.width, this.height]);\n\n    // Draw Voronoi cells\n    this.voronoiGroup.selectAll('path')\n      .data(points)\n      .enter()\n      .append('path')\n      .attr('d', (_, i) => voronoi.renderCell(i))\n      .attr('fill', (_, i) => {\n        const pred = predictions[i];\n        if (!pred) return 'transparent';\n        const classIndex = pred.predictedClass;\n        return this.classColours[classIndex % this.classColours.length] ?? '#888';\n      })\n      .attr('fill-opacity', (_, i) => {\n        const pred = predictions[i];\n        if (!pred) return 0;\n        // Opacity based on confidence\n        return opacity * (0.5 + pred.confidence * 0.5);\n      })\n      .attr('stroke', 'var(--border-color)')\n      .attr('stroke-width', 0.5)\n      .attr('stroke-opacity', 0.3);\n  }\n\n  /**\n   * Renders Voronoi cells with gradient based on confidence.\n   * @param points - Data points\n   * @param predictions - Predictions for each point\n   */\n  renderWithGradient(points: Point[], predictions: Prediction[]): void {\n    this.clear();\n\n    if (points.length < 3) return;\n\n    this.voronoiGroup = this.svg.append('g')\n      .attr('class', 'voronoi-overlay')\n      .lower();\n\n    const screenPoints: [number, number][] = points.map(p => [\n      this.xScale(p.x),\n      this.yScale(p.y)\n    ]);\n\n    const delaunay = d3.Delaunay.from(screenPoints);\n    const voronoi = delaunay.voronoi([0, 0, this.width, this.height]);\n\n    // Create gradients for each cell\n    const defs = this.svg.select('defs').empty()\n      ? this.svg.append('defs')\n      : this.svg.select('defs');\n\n    points.forEach((point, i) => {\n      const pred = predictions[i];\n      if (!pred) return;\n\n      const gradientId = `voronoi-gradient-${i}`;\n      const classColour = this.classColours[pred.predictedClass % this.classColours.length] ?? '#888';\n\n      // Radial gradient from center\n      const gradient = defs.append('radialGradient')\n        .attr('id', gradientId)\n        .attr('cx', '50%')\n        .attr('cy', '50%')\n        .attr('r', '50%');\n\n      gradient.append('stop')\n        .attr('offset', '0%')\n        .attr('stop-color', classColour)\n        .attr('stop-opacity', pred.confidence * 0.6);\n\n      gradient.append('stop')\n        .attr('offset', '100%')\n        .attr('stop-color', classColour)\n        .attr('stop-opacity', pred.confidence * 0.2);\n    });\n\n    // Draw cells with gradients\n    this.voronoiGroup.selectAll('path')\n      .data(points)\n      .enter()\n      .append('path')\n      .attr('d', (_, i) => voronoi.renderCell(i))\n      .attr('fill', (_, i) => `url(#voronoi-gradient-${i})`)\n      .attr('stroke', 'var(--border-color)')\n      .attr('stroke-width', 0.5)\n      .attr('stroke-opacity', 0.2);\n  }\n\n  /**\n   * Clears the Voronoi overlay.\n   */\n  clear(): void {\n    if (this.voronoiGroup) {\n      this.voronoiGroup.remove();\n      this.voronoiGroup = null;\n    }\n    // Clean up gradients\n    this.svg.selectAll('defs radialGradient[id^=\"voronoi-gradient\"]').remove();\n  }\n\n  /**\n   * Updates scales when chart is resized.\n   */\n  updateScales(\n    xScale: d3.ScaleLinear<number, number>,\n    yScale: d3.ScaleLinear<number, number>\n  ): void {\n    this.xScale = xScale;\n    this.yScale = yScale;\n  }\n\n  /**\n   * Resizes the overlay to fit new dimensions.\n   */\n  resize(\n    width: number,\n    height: number,\n    xScale: d3.ScaleLinear<number, number>,\n    yScale: d3.ScaleLinear<number, number>\n  ): void {\n    this.width = width;\n    this.height = height;\n    this.xScale = xScale;\n    this.yScale = yScale;\n  }\n}\n","import * as d3 from 'd3';\nimport type { IVisualizerService, PointAddedCallback } from '../../core/ports';\nimport type { Point, Prediction, VisualizationConfig, ColourScheme } from '../../core/domain';\nimport { DEFAULT_VISUALIZATION_CONFIG, COLOUR_PALETTES, MULTI_CLASS_COLOURS } from '../../core/domain';\nimport { D3VoronoiOverlay } from './D3VoronoiOverlay';\n\n/**\n * D3.js implementation of IVisualizerService.\n * Encapsulates all D3 logicno other module should import d3 directly.\n *\n * @remarks\n * - Agnostic to neural networks; only knows about Points and Predictions\n * - Uses contour rendering for decision boundaries\n * - Manages its own SVG lifecycle within the provided container\n * - Supports zoom/pan, tooltips, and configurable appearance\n */\nexport class D3Chart implements IVisualizerService {\n  private readonly container: d3.Selection<HTMLElement, unknown, null, undefined>;\n  private readonly svg: d3.Selection<SVGSVGElement, unknown, null, undefined>;\n  private readonly chartGroup: d3.Selection<SVGGElement, unknown, null, undefined>;\n  private width: number;\n  private height: number;\n  private readonly margin = { top: 8, right: 8, bottom: 28, left: 32 };\n\n  private xScale: d3.ScaleLinear<number, number>;\n  private yScale: d3.ScaleLinear<number, number>;\n\n  private config: VisualizationConfig = { ...DEFAULT_VISUALIZATION_CONFIG };\n  private zoom: d3.ZoomBehavior<SVGSVGElement, unknown> | null = null;\n  private tooltip: d3.Selection<HTMLDivElement, unknown, HTMLElement, unknown> | null = null;\n\n  // Cache for re-rendering after zoom\n  private cachedPoints: Point[] = [];\n  private cachedPredictions: Prediction[] = [];\n  private cachedGridSize = 0;\n\n  // Draw mode state\n  private drawModeEnabled = false;\n  private drawModeLabel = 0;\n  private drawModeCallback: PointAddedCallback | null = null;\n\n  // Voronoi overlay\n  private voronoiOverlay: D3VoronoiOverlay | null = null;\n  private voronoiEnabled = false;\n\n  /**\n   * @param containerId - DOM element ID where the chart will be rendered\n   * @param width - Chart width in pixels (default: 500)\n   * @param height - Chart height in pixels (default: 500)\n   */\n  constructor(containerId: string, width = 500, height = 500) {\n    const element = document.getElementById(containerId);\n    if (!element) {\n      throw new Error(`Container element with ID \"${containerId}\" not found.`);\n    }\n\n    this.container = d3.select(element);\n    this.width = width - this.margin.left - this.margin.right;\n    this.height = height - this.margin.top - this.margin.bottom;\n\n    // Clear any existing content\n    this.container.selectAll('*').remove();\n\n    // Create SVG with viewBox for responsive sizing\n    this.svg = this.container\n      .append('svg')\n      .attr('viewBox', `0 0 ${width} ${height}`)\n      .attr('preserveAspectRatio', 'xMidYMid meet')\n      .style('width', '100%')\n      .style('height', '100%') as d3.Selection<SVGSVGElement, unknown, null, undefined>;\n\n    // Add clip path to prevent rendering outside chart area\n    this.svg\n      .append('defs')\n      .append('clipPath')\n      .attr('id', 'chart-clip')\n      .append('rect')\n      .attr('width', this.width)\n      .attr('height', this.height);\n\n    // Main chart group with margin transform\n    this.chartGroup = this.svg\n      .append('g')\n      .attr('transform', `translate(${this.margin.left},${this.margin.top})`)\n      .attr('clip-path', 'url(#chart-clip)') as d3.Selection<SVGGElement, unknown, null, undefined>;\n\n    // Initialise scales with default domain [-1, 1]\n    this.xScale = d3.scaleLinear().domain([-1, 1]).range([0, this.width]);\n    this.yScale = d3.scaleLinear().domain([-1, 1]).range([this.height, 0]);\n\n    this.renderAxes();\n    this.setupZoom();\n    this.setupTooltip();\n\n    // Setup resize observer\n    this.resizeObserver = new ResizeObserver((entries) => {\n      for (const entry of entries) {\n        if (entry.contentRect) {\n          this.resize(entry.contentRect.width, entry.contentRect.height);\n        }\n      }\n    });\n    this.resizeObserver.observe(element);\n  }\n\n  /**\n   * Resizes the chart to fit the new container dimensions.\n   */\n  resize(width: number, height: number): void {\n    if (width === 0 || height === 0) return;\n\n    // Update dimensions\n    this.width = width - this.margin.left - this.margin.right;\n    this.height = height - this.margin.top - this.margin.bottom;\n\n    // Update SVG viewBox\n    this.svg.attr('viewBox', `0 0 ${width} ${height}`);\n\n    // Update clip path\n    this.svg.select('#chart-clip rect')\n      .attr('width', this.width)\n      .attr('height', this.height);\n\n    // Update scales\n    this.xScale.range([0, this.width]);\n    this.yScale.range([this.height, 0]);\n\n    // Update axes\n    this.svg.select<SVGGElement>('.x-axis')\n      .attr('transform', `translate(0,${this.height})`)\n      .call(d3.axisBottom(this.xScale).ticks(5));\n\n    this.svg.select<SVGGElement>('.y-axis')\n      .call(d3.axisLeft(this.yScale).ticks(5));\n\n    // Re-render content\n    if (this.cachedPoints.length > 0) {\n      this.renderData(this.cachedPoints);\n    }\n    if (this.cachedPredictions.length > 0) {\n      this.renderBoundary(this.cachedPredictions, this.cachedGridSize);\n    }\n    if (this.voronoiEnabled && this.voronoiOverlay) {\n      this.voronoiOverlay.resize(this.width, this.height, this.xScale, this.yScale);\n      this.voronoiOverlay.render(this.cachedPoints, this.cachedPredictions, this.config.boundaryOpacity);\n    }\n  }\n\n  /**\n   * Updates visualization configuration.\n   */\n  setConfig(config: Partial<VisualizationConfig>): void {\n    this.config = { ...this.config, ...config };\n\n    // Re-render with new config\n    if (this.cachedPoints.length > 0) {\n      this.renderData(this.cachedPoints);\n    }\n    if (this.cachedPredictions.length > 0) {\n      this.renderBoundary(this.cachedPredictions, this.cachedGridSize);\n    }\n\n    // Update zoom behaviour\n    if (config.zoomEnabled !== undefined) {\n      this.setupZoom();\n    }\n  }\n\n  /**\n   * Sets the colour scheme for the visualization.\n   */\n  setTheme(theme: ColourScheme): void {\n    this.setConfig({ colourScheme: theme });\n  }\n\n  /**\n   * Returns current visualization configuration.\n   */\n  getConfig(): VisualizationConfig {\n    return { ...this.config };\n  }\n\n  /**\n   * Renders data points on the chart.\n   * Points are coloured by label using multi-class colour palette.\n   */\n  renderData(points: Point[]): void {\n    // Cache for re-rendering\n    this.cachedPoints = points;\n\n    // Remove existing data points\n    this.chartGroup.selectAll('.data-point').remove();\n\n    // Use multi-class colours (supports up to 10 classes)\n    const getColour = (label: number): string => {\n      return MULTI_CLASS_COLOURS[label % MULTI_CLASS_COLOURS.length] ?? '#888888';\n    };\n\n    const dataPoints = this.chartGroup\n      .selectAll('.data-point')\n      .data(points)\n      .enter()\n      .append('circle')\n      .attr('class', (d) => `data-point ${d.isValidation ? 'validation-point' : 'training-point'}`)\n      .attr('cx', (d) => this.xScale(d.x))\n      .attr('cy', (d) => this.yScale(d.y))\n      .attr('r', this.config.pointRadius)\n      .attr('fill', (d) => getColour(d.label))\n      .attr('stroke', (d) => d.isValidation ? '#fbbf24' : '#fff')\n      .attr('stroke-width', (d) => d.isValidation ? 2.5 : 1.5)\n      .attr('stroke-dasharray', (d) => d.isValidation ? '3,2' : 'none')\n      .attr('opacity', 0.9);\n\n    // Add tooltip handlers if enabled\n    if (this.config.tooltipsEnabled && this.tooltip) {\n      const tooltip = this.tooltip;\n      dataPoints\n        .on('mouseenter', (event, d) => {\n          tooltip\n            .style('opacity', 1)\n            .html(`<strong>${d.isValidation ? 'Validation' : 'Training'} Point</strong><br/>x: ${d.x.toFixed(3)}<br/>y: ${d.y.toFixed(3)}<br/>class: ${d.label}`)\n            .style('left', `${event.pageX + 10}px`)\n            .style('top', `${event.pageY - 10}px`);\n        })\n        .on('mouseleave', () => {\n          tooltip.style('opacity', 0);\n        });\n    }\n\n    // Add click handler for prediction details\n    dataPoints.on('click', (event, d) => {\n      event.stopPropagation();\n      if (this.pointClickCallback) {\n        this.pointClickCallback(d);\n      }\n    });\n  }\n\n  // Callback for point clicks\n  private pointClickCallback: ((point: Point) => void) | null = null;\n\n  /**\n   * Sets a callback for when a data point is clicked.\n   * @param callback - Function to call with the clicked point\n   */\n  onPointClick(callback: (point: Point) => void): void {\n    this.pointClickCallback = callback;\n  }\n\n  /**\n   * Renders the decision boundary as a heatmap.\n   * For binary: contour-based gradient. For multi-class: pixel-based regions.\n   */\n  renderBoundary(predictions: Prediction[], gridSize: number): void {\n    // Cache for re-rendering\n    this.cachedPredictions = predictions;\n    this.cachedGridSize = gridSize;\n\n    // Remove existing boundary\n    this.chartGroup.selectAll('.boundary').remove();\n\n    if (predictions.length !== gridSize * gridSize) {\n      console.warn(\n        `Expected ${gridSize * gridSize} predictions for gridSize ${gridSize}, got ${predictions.length}`\n      );\n      return;\n    }\n\n    // Determine if multi-class based on predictions\n    const numClasses = predictions[0]?.probabilities?.length ?? 2;\n\n    if (numClasses === 2) {\n      this.renderBinaryBoundary(predictions, gridSize);\n    } else {\n      this.renderMultiClassBoundary(predictions, gridSize);\n    }\n  }\n\n  /**\n   * Renders binary classification boundary using contours.\n   */\n  private renderBinaryBoundary(predictions: Prediction[], gridSize: number): void {\n    // Extract confidence values as a flat array for contour generation\n    const confidenceValues = predictions.map((p) => p.confidence);\n\n    // Generate contours with configurable count\n    const step = 1 / (this.config.contourCount || 10);\n    const contourGenerator = d3\n      .contours()\n      .size([gridSize, gridSize])\n      .thresholds(d3.range(0, 1 + step, step));\n\n    const contours = contourGenerator(confidenceValues);\n\n    // Colour scale using current palette\n    const palette = COLOUR_PALETTES[this.config.colourScheme];\n    const colourScale = d3\n      .scaleLinear<string>()\n      .domain([0, 0.5, 1])\n      .range([palette.low, '#f5f5f5', palette.high]);\n\n    // Scale contour paths to chart dimensions\n    const xContourScale = d3.scaleLinear().domain([0, gridSize]).range([0, this.width]);\n    const yContourScale = d3.scaleLinear().domain([0, gridSize]).range([this.height, 0]);\n\n    const pathGenerator = d3.geoPath().projection(\n      d3.geoTransform({\n        point(x, y) {\n          this.stream.point(xContourScale(x), yContourScale(y));\n        },\n      })\n    );\n\n    // Render contours behind data points\n    this.chartGroup\n      .insert('g', '.data-point')\n      .attr('class', 'boundary')\n      .selectAll('path')\n      .data(contours)\n      .enter()\n      .append('path')\n      .attr('d', pathGenerator)\n      .attr('fill', (d) => colourScale(d.value))\n      .attr('stroke', 'none')\n      .attr('opacity', this.config.boundaryOpacity);\n  }\n\n  /**\n   * Renders multi-class boundary using pixel rectangles.\n   */\n  private renderMultiClassBoundary(predictions: Prediction[], gridSize: number): void {\n    const cellWidth = this.width / gridSize;\n    const cellHeight = this.height / gridSize;\n\n    // Get colour for each class with confidence-based opacity\n    const getColour = (pred: Prediction): string => {\n      const baseColour = MULTI_CLASS_COLOURS[pred.predictedClass % MULTI_CLASS_COLOURS.length] ?? '#888888';\n      return baseColour;\n    };\n\n    const boundaryGroup = this.chartGroup\n      .insert('g', '.data-point')\n      .attr('class', 'boundary');\n\n    boundaryGroup\n      .selectAll('rect')\n      .data(predictions)\n      .enter()\n      .append('rect')\n      .attr('x', (_, i) => (i % gridSize) * cellWidth)\n      .attr('y', (_, i) => this.height - Math.floor(i / gridSize) * cellHeight - cellHeight)\n      .attr('width', cellWidth)\n      .attr('height', cellHeight)\n      .attr('fill', (d) => getColour(d))\n      .attr('opacity', (d) => this.config.boundaryOpacity * (0.3 + d.confidence * 0.7))\n      .attr('stroke', 'none');\n  }\n\n  /**\n   * Clears all rendered content and resets the chart.\n   */\n  clear(): void {\n    // Clear caches first to prevent re-render\n    this.cachedPoints = [];\n    this.cachedPredictions = [];\n    this.cachedGridSize = 0;\n\n    // Remove ALL children of chartGroup (axes are in a separate group on svg)\n    this.chartGroup.selectAll('*').remove();\n  }\n\n  /**\n   * Highlights misclassified points with a red outline.\n   * @param predictions - Array of predictions corresponding to cached points\n   */\n  highlightMisclassified(predictions: Prediction[]): void {\n    if (predictions.length !== this.cachedPoints.length) return;\n\n    // Create a set of misclassified indices\n    const misclassifiedIndices = new Set<number>();\n    for (let i = 0; i < predictions.length; i++) {\n      const point = this.cachedPoints[i];\n      const pred = predictions[i];\n      if (point && pred && point.label !== pred.predictedClass) {\n        misclassifiedIndices.add(i);\n      }\n    }\n\n    // Update point styling - preserve validation styling for non-misclassified\n    this.chartGroup\n      .selectAll<SVGCircleElement, Point>('.data-point')\n      .attr('stroke', (d, i) => misclassifiedIndices.has(i) ? '#ef4444' : (d.isValidation ? '#fbbf24' : '#fff'))\n      .attr('stroke-width', (d, i) => misclassifiedIndices.has(i) ? 3 : (d.isValidation ? 2.5 : 1.5))\n      .attr('stroke-dasharray', (d, i) => misclassifiedIndices.has(i) ? 'none' : (d.isValidation ? '3,2' : 'none'));\n  }\n\n  /**\n   * Clears misclassified highlighting, restoring default styling.\n   */\n  clearMisclassifiedHighlight(): void {\n    this.chartGroup\n      .selectAll<SVGCircleElement, Point>('.data-point')\n      .attr('stroke', (d) => d.isValidation ? '#fbbf24' : '#fff')\n      .attr('stroke-width', (d) => d.isValidation ? 2.5 : 1.5)\n      .attr('stroke-dasharray', (d) => d.isValidation ? '3,2' : 'none');\n  }\n\n  /**\n   * Renders confidence circles around data points.\n   * Circle radius represents uncertainty (1 - confidence).\n   * Larger circles = more uncertain predictions.\n   * @param predictions - Array of predictions corresponding to cached points\n   */\n  renderConfidenceCircles(predictions: Prediction[]): void {\n    if (predictions.length !== this.cachedPoints.length) return;\n\n    // Remove existing confidence circles\n    this.chartGroup.selectAll('.confidence-circle').remove();\n\n    // Maximum radius for uncertainty circle (in pixels)\n    const maxRadius = 25;\n    const minRadius = 3;\n\n    // Create confidence circles behind data points\n    this.chartGroup\n      .selectAll('.confidence-circle')\n      .data(this.cachedPoints)\n      .enter()\n      .insert('circle', '.data-point')\n      .attr('class', 'confidence-circle')\n      .attr('cx', (d) => this.xScale(d.x))\n      .attr('cy', (d) => this.yScale(d.y))\n      .attr('r', (_, i) => {\n        const pred = predictions[i];\n        if (!pred) return minRadius;\n        // Uncertainty = 1 - confidence\n        const uncertainty = 1 - pred.confidence;\n        return minRadius + uncertainty * (maxRadius - minRadius);\n      })\n      .attr('fill', 'none')\n      .attr('stroke', (_, i) => {\n        const pred = predictions[i];\n        if (!pred) return '#888';\n        // Colour based on whether prediction matches actual label\n        const point = this.cachedPoints[i];\n        const isCorrect = point && pred.predictedClass === point.label;\n        return isCorrect ? 'rgba(34, 197, 94, 0.6)' : 'rgba(239, 68, 68, 0.6)';\n      })\n      .attr('stroke-width', 2)\n      .attr('stroke-dasharray', '4,2')\n      .attr('opacity', 0.8);\n  }\n\n  /**\n   * Removes confidence circles from the chart.\n   */\n  clearConfidenceCircles(): void {\n    this.chartGroup.selectAll('.confidence-circle').remove();\n  }\n\n  // Resize observer\n  private resizeObserver: ResizeObserver | null = null;\n\n  /**\n   * Disposes of all SVG elements and cleans up resources.\n   * Call this when the chart is no longer needed to prevent memory leaks.\n   */\n  dispose(): void {\n    this.disableDrawMode();\n    if (this.tooltip) {\n      this.tooltip.remove();\n    }\n    if (this.resizeObserver) {\n      this.resizeObserver.disconnect();\n    }\n    this.container.selectAll('*').remove();\n  }\n\n  /**\n   * Enables drawing mode where clicks add points.\n   */\n  enableDrawMode(label: number, callback: PointAddedCallback): void {\n    this.drawModeEnabled = true;\n    this.drawModeLabel = label;\n    this.drawModeCallback = callback;\n\n    // Change cursor to crosshair\n    this.svg.style('cursor', 'crosshair');\n\n    // Add click handler\n    this.svg.on('click.draw', (event: MouseEvent) => {\n      if (!this.drawModeEnabled || !this.drawModeCallback) return;\n\n      // Get click position relative to chart group\n      const [mouseX, mouseY] = d3.pointer(event, this.chartGroup.node());\n\n      // Convert to data coordinates\n      const x = this.xScale.invert(mouseX);\n      const y = this.yScale.invert(mouseY);\n\n      // Only add if within bounds\n      if (x >= -1 && x <= 1 && y >= -1 && y <= 1) {\n        const point: Point = { x, y, label: this.drawModeLabel };\n        this.drawModeCallback(point);\n      }\n    });\n  }\n\n  /**\n   * Disables drawing mode.\n   */\n  disableDrawMode(): void {\n    this.drawModeEnabled = false;\n    this.drawModeCallback = null;\n    this.svg.style('cursor', 'default');\n    this.svg.on('click.draw', null);\n  }\n\n  /**\n   * Returns whether drawing mode is currently enabled.\n   */\n  isDrawModeEnabled(): boolean {\n    return this.drawModeEnabled;\n  }\n\n  private renderAxes(): void {\n    // Axes group (outside clip path so they're always visible)\n    const axesGroup = this.svg\n      .append('g')\n      .attr('class', 'axes')\n      .attr('transform', `translate(${this.margin.left},${this.margin.top})`);\n\n    // X axis\n    axesGroup\n      .append('g')\n      .attr('class', 'x-axis axis')\n      .attr('transform', `translate(0,${this.height})`)\n      .call(d3.axisBottom(this.xScale).ticks(5));\n\n    // Y axis\n    axesGroup.append('g').attr('class', 'y-axis axis').call(d3.axisLeft(this.yScale).ticks(5));\n  }\n\n  private setupZoom(): void {\n    if (!this.config.zoomEnabled) {\n      // Remove zoom behaviour\n      this.svg.on('.zoom', null);\n      return;\n    }\n\n    this.zoom = d3\n      .zoom<SVGSVGElement, unknown>()\n      .scaleExtent([0.5, 5])\n      .on('zoom', (event) => {\n        this.chartGroup.attr('transform', event.transform);\n      });\n\n    this.svg.call(this.zoom);\n\n    // Add double-click to reset zoom\n    this.svg.on('dblclick.zoom', () => {\n      this.svg\n        .transition()\n        .duration(300)\n        .call(this.zoom!.transform, d3.zoomIdentity);\n    });\n  }\n\n  private setupTooltip(): void {\n    // Create tooltip div if it doesn't exist\n    this.tooltip = d3\n      .select('body')\n      .append('div')\n      .attr('class', 'chart-tooltip')\n      .style('opacity', 0);\n  }\n\n  // ===========================================================================\n  // Export Methods\n  // ===========================================================================\n\n  /**\n   * Exports the current chart as a PNG image.\n   * @param filename - Name of the downloaded file (without extension)\n   */\n  exportAsPNG(filename = 'neuroviz-boundary'): void {\n    const svgElement = this.svg.node();\n    if (!svgElement) return;\n\n    // Clone SVG and inline styles\n    const clonedSvg = svgElement.cloneNode(true) as SVGSVGElement;\n    this.inlineStyles(clonedSvg);\n\n    // Add white background for PNG\n    const background = document.createElementNS('http://www.w3.org/2000/svg', 'rect');\n    background.setAttribute('width', '100%');\n    background.setAttribute('height', '100%');\n    background.setAttribute('fill', '#0a0f1a');\n    clonedSvg.insertBefore(background, clonedSvg.firstChild);\n\n    // Serialize SVG to string\n    const serializer = new XMLSerializer();\n    const svgString = serializer.serializeToString(clonedSvg);\n    const svgBlob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });\n    const url = URL.createObjectURL(svgBlob);\n\n    // Create canvas and draw SVG\n    const canvas = document.createElement('canvas');\n    const scale = 2; // Higher resolution\n    canvas.width = this.width * scale;\n    canvas.height = this.height * scale;\n    const ctx = canvas.getContext('2d');\n    if (!ctx) return;\n\n    const img = new Image();\n    img.onload = () => {\n      ctx.scale(scale, scale);\n      ctx.drawImage(img, 0, 0);\n      URL.revokeObjectURL(url);\n\n      // Download PNG\n      const pngUrl = canvas.toDataURL('image/png');\n      const link = document.createElement('a');\n      link.download = `${filename}.png`;\n      link.href = pngUrl;\n      link.click();\n    };\n    img.src = url;\n  }\n\n  /**\n   * Exports the current chart as a PNG image with metadata overlay.\n   * @param filename - Name of the downloaded file (without extension)\n   * @param metadata - Configuration metadata to display on the image\n   */\n  exportAsPNGWithMetadata(filename = 'neuroviz-boundary', metadata: Record<string, string>): void {\n    const svgElement = this.svg.node();\n    if (!svgElement) return;\n\n    // Clone SVG and inline styles\n    const clonedSvg = svgElement.cloneNode(true) as SVGSVGElement;\n    this.inlineStyles(clonedSvg);\n\n    // Add dark background for PNG\n    const background = document.createElementNS('http://www.w3.org/2000/svg', 'rect');\n    background.setAttribute('width', '100%');\n    background.setAttribute('height', '100%');\n    background.setAttribute('fill', '#0a0f1a');\n    clonedSvg.insertBefore(background, clonedSvg.firstChild);\n\n    // Serialize SVG to string\n    const serializer = new XMLSerializer();\n    const svgString = serializer.serializeToString(clonedSvg);\n    const svgBlob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });\n    const url = URL.createObjectURL(svgBlob);\n\n    // Create canvas with extra space for metadata\n    const canvas = document.createElement('canvas');\n    const scale = 2;\n    const metadataHeight = 80;\n    canvas.width = this.width * scale;\n    canvas.height = (this.height + metadataHeight) * scale;\n    const ctx = canvas.getContext('2d');\n    if (!ctx) return;\n\n    const img = new Image();\n    img.onload = () => {\n      // Fill background\n      ctx.fillStyle = '#0a0f1a';\n      ctx.fillRect(0, 0, canvas.width, canvas.height);\n\n      // Draw chart\n      ctx.scale(scale, scale);\n      ctx.drawImage(img, 0, 0);\n      URL.revokeObjectURL(url);\n\n      // Draw metadata panel\n      ctx.fillStyle = 'rgba(15, 23, 42, 0.95)';\n      ctx.fillRect(0, this.height, this.width, metadataHeight);\n\n      // Draw metadata text\n      ctx.fillStyle = '#94a3b8';\n      ctx.font = '11px Inter, system-ui, sans-serif';\n\n      const entries = Object.entries(metadata);\n      const cols = 3;\n      const colWidth = this.width / cols;\n      const startY = this.height + 18;\n      const lineHeight = 16;\n\n      entries.forEach(([key, value], i) => {\n        const col = i % cols;\n        const row = Math.floor(i / cols);\n        const x = col * colWidth + 10;\n        const y = startY + row * lineHeight;\n\n        ctx.fillStyle = '#64748b';\n        ctx.fillText(`${key}:`, x, y);\n        ctx.fillStyle = '#e2e8f0';\n        ctx.fillText(value, x + ctx.measureText(`${key}: `).width, y);\n      });\n\n      // Add NeuroViz watermark\n      ctx.fillStyle = '#475569';\n      ctx.font = '10px Inter, system-ui, sans-serif';\n      ctx.fillText('NeuroViz', this.width - 55, this.height + metadataHeight - 8);\n\n      // Download PNG\n      const pngUrl = canvas.toDataURL('image/png');\n      const link = document.createElement('a');\n      link.download = `${filename}.png`;\n      link.href = pngUrl;\n      link.click();\n    };\n    img.src = url;\n  }\n\n  /**\n   * Exports the current chart as an SVG file.\n   * @param filename - Name of the downloaded file (without extension)\n   */\n  exportAsSVG(filename = 'neuroviz-boundary'): void {\n    const svgElement = this.svg.node();\n    if (!svgElement) return;\n\n    // Clone SVG and inline styles\n    const clonedSvg = svgElement.cloneNode(true) as SVGSVGElement;\n    this.inlineStyles(clonedSvg);\n\n    // Add background\n    const background = document.createElementNS('http://www.w3.org/2000/svg', 'rect');\n    background.setAttribute('width', '100%');\n    background.setAttribute('height', '100%');\n    background.setAttribute('fill', '#0a0f1a');\n    clonedSvg.insertBefore(background, clonedSvg.firstChild);\n\n    // Serialize and download\n    const serializer = new XMLSerializer();\n    const svgString = serializer.serializeToString(clonedSvg);\n    const blob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });\n    const url = URL.createObjectURL(blob);\n\n    const link = document.createElement('a');\n    link.download = `${filename}.svg`;\n    link.href = url;\n    link.click();\n\n    URL.revokeObjectURL(url);\n  }\n\n  /**\n   * Inlines computed styles into SVG elements for export.\n   */\n  private inlineStyles(svg: SVGSVGElement): void {\n    const elements = svg.querySelectorAll('*');\n    elements.forEach((el) => {\n      const computed = window.getComputedStyle(el);\n      const style = el.getAttribute('style') || '';\n\n      // Copy key styles\n      const stylesToCopy = ['fill', 'stroke', 'stroke-width', 'opacity', 'font-family', 'font-size'];\n      const inlined = stylesToCopy\n        .map((prop) => `${prop}: ${computed.getPropertyValue(prop)}`)\n        .join('; ');\n\n      el.setAttribute('style', `${style}; ${inlined}`);\n    });\n  }\n\n  /**\n   * Enables or disables the Voronoi diagram overlay.\n   * @param enabled - Whether to show the Voronoi overlay\n   */\n  setVoronoiOverlay(enabled: boolean): void {\n    this.voronoiEnabled = enabled;\n\n    if (enabled) {\n      // Initialize overlay if needed\n      if (!this.voronoiOverlay) {\n        this.voronoiOverlay = new D3VoronoiOverlay(\n          this.chartGroup,\n          this.width,\n          this.height,\n          this.xScale,\n          this.yScale\n        );\n      }\n\n      // Render if we have cached data\n      if (this.cachedPoints.length > 0 && this.cachedPredictions.length > 0) {\n        this.voronoiOverlay.render(this.cachedPoints, this.cachedPredictions, this.config.boundaryOpacity);\n      }\n    } else {\n      // Clear overlay\n      this.voronoiOverlay?.clear();\n    }\n  }\n\n  /**\n   * Returns whether Voronoi overlay is enabled.\n   */\n  isVoronoiEnabled(): boolean {\n    return this.voronoiEnabled;\n  }\n}\n","import * as d3 from 'd3';\nimport type { TrainingHistory, TrainingRecord } from '../../core/domain';\n\n/**\n * D3.js line chart for visualizing training loss and accuracy over epochs.\n *\n * @remarks\n * - Dual Y-axis: loss (left) and accuracy (right)\n * - Auto-scaling axes based on data range\n * - Smooth line interpolation\n * - Responsive to container size\n */\nexport class D3LossChart {\n  private readonly container: d3.Selection<HTMLElement, unknown, null, undefined>;\n  private readonly svg: d3.Selection<SVGSVGElement, unknown, null, undefined>;\n  private width: number;\n  private height: number;\n  private readonly margin = { top: 20, right: 50, bottom: 30, left: 50 };\n\n  private xScale: d3.ScaleLinear<number, number>;\n  private yScaleLoss: d3.ScaleLinear<number, number>;\n  private yScaleAccuracy: d3.ScaleLinear<number, number>;\n\n  private lossLine: d3.Line<TrainingRecord>;\n  private valLossLine: d3.Line<TrainingRecord>;\n  private accuracyLine: d3.Line<TrainingRecord>;\n\n  private lossPath: d3.Selection<SVGPathElement, unknown, null, undefined>;\n  private valLossPath: d3.Selection<SVGPathElement, unknown, null, undefined>;\n  private accuracyPath: d3.Selection<SVGPathElement, unknown, null, undefined>;\n  private xAxisGroup: d3.Selection<SVGGElement, unknown, null, undefined>;\n  private yAxisLossGroup: d3.Selection<SVGGElement, unknown, null, undefined>;\n  private yAxisAccuracyGroup: d3.Selection<SVGGElement, unknown, null, undefined>;\n\n  /**\n   * @param containerId - DOM element ID where the chart will be rendered\n   * @param width - Chart width in pixels (default: 400)\n   * @param height - Chart height in pixels (default: 200)\n   */\n  constructor(containerId: string, width = 400, height = 200) {\n    const element = document.getElementById(containerId);\n    if (!element) {\n      throw new Error(`Container element with ID \"${containerId}\" not found.`);\n    }\n\n    this.container = d3.select(element);\n    this.width = width - this.margin.left - this.margin.right;\n    this.height = height - this.margin.top - this.margin.bottom;\n\n    // Clear any existing content\n    this.container.selectAll('*').remove();\n\n    // Create responsive SVG using viewBox\n    const svgElement = this.container\n      .append('svg')\n      .attr('viewBox', `0 0 ${width} ${height}`)\n      .attr('preserveAspectRatio', 'xMidYMid meet')\n      .style('width', '100%')\n      .style('height', '100%')\n      .attr('class', 'loss-chart');\n\n    this.svg = svgElement\n      .append('g')\n      .attr('transform', `translate(${this.margin.left},${this.margin.top})`) as unknown as d3.Selection<\n        SVGSVGElement,\n        unknown,\n        null,\n        undefined\n      >;\n\n    // Initialize scales\n    this.xScale = d3.scaleLinear().range([0, this.width]);\n    this.yScaleLoss = d3.scaleLinear().range([this.height, 0]);\n    this.yScaleAccuracy = d3.scaleLinear().domain([0, 1]).range([this.height, 0]);\n\n    // Initialize line generators\n    this.lossLine = d3\n      .line<TrainingRecord>()\n      .x((d) => this.xScale(d.epoch))\n      .y((d) => this.yScaleLoss(d.loss))\n      .curve(d3.curveMonotoneX);\n\n    this.valLossLine = d3\n      .line<TrainingRecord>()\n      .defined((d) => d.valLoss !== null)\n      .x((d) => this.xScale(d.epoch))\n      .y((d) => this.yScaleLoss(d.valLoss ?? 0))\n      .curve(d3.curveMonotoneX);\n\n    this.accuracyLine = d3\n      .line<TrainingRecord>()\n      .x((d) => this.xScale(d.epoch))\n      .y((d) => this.yScaleAccuracy(d.accuracy))\n      .curve(d3.curveMonotoneX);\n\n    // Create axis groups\n    this.xAxisGroup = this.svg\n      .append('g')\n      .attr('class', 'x-axis axis')\n      .attr('transform', `translate(0,${this.height})`);\n\n    this.yAxisLossGroup = this.svg.append('g').attr('class', 'y-axis-loss axis');\n\n    this.yAxisAccuracyGroup = this.svg\n      .append('g')\n      .attr('class', 'y-axis-accuracy axis')\n      .attr('transform', `translate(${this.width},0)`);\n\n    // Create path elements\n    this.lossPath = this.svg\n      .append('path')\n      .attr('class', 'loss-line')\n      .attr('fill', 'none')\n      .attr('stroke', '#00D9FF') // Cyan - training loss (wireframe)\n      .attr('stroke-width', 2);\n\n    this.valLossPath = this.svg\n      .append('path')\n      .attr('class', 'val-loss-line')\n      .attr('fill', 'none')\n      .attr('stroke', '#FF00AA') // Magenta - validation loss (wireframe)\n      .attr('stroke-width', 2)\n      .attr('stroke-dasharray', '4,2'); // Dashed line\n\n    this.accuracyPath = this.svg\n      .append('path')\n      .attr('class', 'accuracy-line')\n      .attr('fill', 'none')\n      .attr('stroke', '#10B981') // Green - accuracy (wireframe)\n      .attr('stroke-width', 2);\n\n    // Add legend\n    this.addLegend();\n\n    // Add axis labels\n    this.addAxisLabels();\n\n    // Setup resize observer\n    this.resizeObserver = new ResizeObserver((entries) => {\n      for (const entry of entries) {\n        if (entry.contentRect) {\n          this.resize(entry.contentRect.width, entry.contentRect.height);\n        }\n      }\n    });\n    this.resizeObserver.observe(element);\n  }\n\n  /**\n   * Resizes the chart to fit the new container dimensions.\n   */\n  resize(width: number, height: number): void {\n    if (width === 0 || height === 0) return;\n\n    // Update dimensions\n    this.width = width - this.margin.left - this.margin.right;\n    this.height = height - this.margin.top - this.margin.bottom;\n\n    // Update SVG viewBox\n    this.svg.attr('viewBox', `0 0 ${width} ${height}`);\n\n    // Update scales\n    this.xScale.range([0, this.width]);\n    this.yScaleLoss.range([this.height, 0]);\n    this.yScaleAccuracy.range([this.height, 0]);\n\n    // Update axes\n    this.svg.select<SVGGElement>('.x-axis')\n      .attr('transform', `translate(0,${this.height})`)\n      .call(d3.axisBottom(this.xScale).ticks(5).tickFormat(d3.format('d')));\n\n    this.svg.select<SVGGElement>('.y-axis-loss')\n      .call(d3.axisLeft(this.yScaleLoss).ticks(5).tickFormat(d3.format('.3f')));\n\n    this.svg.select<SVGGElement>('.y-axis-accuracy')\n      .attr('transform', `translate(${this.width},0)`)\n      .call(d3.axisRight(this.yScaleAccuracy).ticks(5).tickFormat(d3.format('.0%')));\n\n    // Update legend position\n    this.svg.select('.legend')\n      .attr('transform', `translate(${this.width - 80}, -5)`);\n\n    // Update axis labels positions\n    this.svg.selectAll('.axis-label').remove();\n    this.addAxisLabels();\n\n    // Re-render lines if data exists\n    const currentData = this.lossPath.datum() as TrainingRecord[];\n    if (currentData) {\n      this.lossPath.attr('d', this.lossLine as unknown as string);\n      this.valLossPath.attr('d', this.valLossLine as unknown as string);\n      this.accuracyPath.attr('d', this.accuracyLine as unknown as string);\n    }\n  }\n\n  /**\n   * Updates the chart with new training history data.\n   */\n  update(history: TrainingHistory): void {\n    const records = history.records as TrainingRecord[];\n\n    if (records.length === 0) {\n      this.clear();\n      return;\n    }\n\n    // Update scales - include validation loss in max calculation\n    const maxEpoch = d3.max(records, (d) => d.epoch) ?? 1;\n    const maxTrainLoss = d3.max(records, (d) => d.loss) ?? 1;\n    const maxValLoss = d3.max(records, (d) => d.valLoss ?? 0) ?? 0;\n    const maxLoss = Math.max(maxTrainLoss, maxValLoss);\n\n    this.xScale.domain([1, maxEpoch]);\n    this.yScaleLoss.domain([0, maxLoss * 1.1]); // 10% padding\n\n    // Update axes\n    this.xAxisGroup.call(\n      d3.axisBottom(this.xScale).ticks(Math.min(maxEpoch, 10)).tickFormat(d3.format('d'))\n    );\n\n    this.yAxisLossGroup.call(d3.axisLeft(this.yScaleLoss).ticks(5).tickFormat(d3.format('.3f')));\n\n    this.yAxisAccuracyGroup.call(\n      d3.axisRight(this.yScaleAccuracy).ticks(5).tickFormat(d3.format('.0%'))\n    );\n\n    // Update lines\n    this.lossPath.datum(records).attr('d', this.lossLine);\n    this.valLossPath.datum(records).attr('d', this.valLossLine);\n    this.accuracyPath.datum(records).attr('d', this.accuracyLine);\n  }\n\n  /**\n   * Clears the chart.\n   */\n  clear(): void {\n    this.lossPath.attr('d', null);\n    this.valLossPath.attr('d', null);\n    this.accuracyPath.attr('d', null);\n    this.xScale.domain([1, 10]);\n    this.yScaleLoss.domain([0, 1]);\n    this.xAxisGroup.call(d3.axisBottom(this.xScale).ticks(5));\n    this.yAxisLossGroup.call(d3.axisLeft(this.yScaleLoss).ticks(5));\n    this.yAxisAccuracyGroup.call(d3.axisRight(this.yScaleAccuracy).ticks(5));\n  }\n\n  // Resize observer\n  private resizeObserver: ResizeObserver | null = null;\n\n  /**\n   * Disposes of all SVG elements.\n   */\n  dispose(): void {\n    if (this.resizeObserver) {\n      this.resizeObserver.disconnect();\n    }\n    this.container.selectAll('*').remove();\n  }\n\n  private addLegend(): void {\n    const legend = this.svg\n      .append('g')\n      .attr('class', 'legend')\n      .attr('transform', `translate(${this.width - 80}, -5)`);\n\n    // Training Loss legend\n    legend\n      .append('line')\n      .attr('x1', 0)\n      .attr('x2', 20)\n      .attr('y1', 0)\n      .attr('y2', 0)\n      .attr('stroke', '#14b8a6')\n      .attr('stroke-width', 2);\n\n    legend\n      .append('text')\n      .attr('x', 25)\n      .attr('y', 4)\n      .attr('class', 'legend-text')\n      .text('Train');\n\n    // Validation Loss legend\n    legend\n      .append('line')\n      .attr('x1', 0)\n      .attr('x2', 20)\n      .attr('y1', 12)\n      .attr('y2', 12)\n      .attr('stroke', '#ef4444')\n      .attr('stroke-width', 2)\n      .attr('stroke-dasharray', '4,2');\n\n    legend\n      .append('text')\n      .attr('x', 25)\n      .attr('y', 16)\n      .attr('class', 'legend-text')\n      .text('Val');\n\n    // Accuracy legend\n    legend\n      .append('line')\n      .attr('x1', 0)\n      .attr('x2', 20)\n      .attr('y1', 24)\n      .attr('y2', 24)\n      .attr('stroke', '#22c55e')\n      .attr('stroke-width', 2);\n\n    legend\n      .append('text')\n      .attr('x', 25)\n      .attr('y', 28)\n      .attr('class', 'legend-text')\n      .text('Acc');\n  }\n\n  private addAxisLabels(): void {\n    // X-axis label\n    this.svg\n      .append('text')\n      .attr('class', 'axis-label')\n      .attr('x', this.width / 2)\n      .attr('y', this.height + 25)\n      .attr('text-anchor', 'middle')\n      .text('Epoch');\n\n    // Y-axis label (Loss)\n    this.svg\n      .append('text')\n      .attr('class', 'axis-label')\n      .attr('transform', 'rotate(-90)')\n      .attr('x', -this.height / 2)\n      .attr('y', -35)\n      .attr('text-anchor', 'middle')\n      .attr('fill', '#14b8a6')\n      .text('Loss');\n\n    // Y-axis label (Accuracy)\n    this.svg\n      .append('text')\n      .attr('class', 'axis-label')\n      .attr('transform', 'rotate(90)')\n      .attr('x', this.height / 2)\n      .attr('y', -this.width - 35)\n      .attr('text-anchor', 'middle')\n      .attr('fill', '#22c55e')\n      .text('Accuracy');\n  }\n}\n","import * as d3 from 'd3';\n\ninterface NetworkNode {\n  id: string;\n  layer: number;\n  index: number;\n  x: number;\n  y: number;\n  type: 'input' | 'hidden' | 'output';\n  activation?: string;\n}\n\ninterface NetworkLink {\n  source: string;\n  target: string;\n  weight?: number;\n}\n\n/**\n * D3-based neural network architecture diagram.\n * Shows nodes and connections between layers.\n */\nexport class D3NetworkDiagram {\n  private svg: d3.Selection<SVGSVGElement, unknown, null, undefined>;\n  private width: number;\n  private height: number;\n  private margin = { top: 20, right: 20, bottom: 20, left: 20 };\n\n  constructor(container: HTMLElement) {\n    const rect = container.getBoundingClientRect();\n    this.width = rect.width || 300;\n    this.height = rect.height || 200;\n\n    // Clear existing content\n    d3.select(container).selectAll('*').remove();\n\n    this.svg = d3.select(container)\n      .append('svg')\n      .attr('width', '100%')\n      .attr('height', '100%')\n      .attr('viewBox', `0 0 ${this.width} ${this.height}`)\n      .attr('preserveAspectRatio', 'xMidYMid meet');\n  }\n\n  /**\n   * Renders the network architecture.\n   * @param layers - Array of layer sizes [input, hidden1, hidden2, ..., output]\n   * @param activations - Array of activation functions per layer\n   * @param weights - Optional weight matrices for connection thickness\n   */\n  render(\n    layers: number[],\n    activations: string[] = [],\n    weights?: number[][][]\n  ): void {\n    if (layers.length === 0) return;\n\n    const innerWidth = this.width - this.margin.left - this.margin.right;\n    const innerHeight = this.height - this.margin.top - this.margin.bottom;\n\n    // Clear previous content\n    this.svg.selectAll('*').remove();\n\n    const g = this.svg.append('g')\n      .attr('transform', `translate(${this.margin.left},${this.margin.top})`);\n\n    // Calculate node positions\n    const nodes: NetworkNode[] = [];\n    const links: NetworkLink[] = [];\n\n    const layerSpacing = innerWidth / (layers.length - 1 || 1);\n    const maxNodes = Math.max(...layers);\n\n    layers.forEach((nodeCount, layerIndex) => {\n      const nodeSpacing = innerHeight / (nodeCount + 1);\n      const layerType = layerIndex === 0 ? 'input' \n        : layerIndex === layers.length - 1 ? 'output' \n        : 'hidden';\n\n      for (let i = 0; i < nodeCount; i++) {\n        const node: NetworkNode = {\n          id: `L${layerIndex}N${i}`,\n          layer: layerIndex,\n          index: i,\n          x: layerIndex * layerSpacing,\n          y: (i + 1) * nodeSpacing,\n          type: layerType,\n          activation: activations[layerIndex] ?? (layerType === 'output' ? 'softmax' : 'relu'),\n        };\n        nodes.push(node);\n\n        // Create links to previous layer\n        if (layerIndex > 0) {\n          const prevLayerSize = layers[layerIndex - 1] ?? 0;\n          for (let j = 0; j < prevLayerSize; j++) {\n            const weight = weights?.[layerIndex - 1]?.[j]?.[i];\n            links.push({\n              source: `L${layerIndex - 1}N${j}`,\n              target: node.id,\n              weight,\n            });\n          }\n        }\n      }\n    });\n\n    // Draw links\n    const linkGroup = g.append('g').attr('class', 'links');\n    \n    linkGroup.selectAll('line')\n      .data(links)\n      .enter()\n      .append('line')\n      .attr('x1', d => {\n        const sourceNode = nodes.find(n => n.id === d.source);\n        return sourceNode?.x ?? 0;\n      })\n      .attr('y1', d => {\n        const sourceNode = nodes.find(n => n.id === d.source);\n        return sourceNode?.y ?? 0;\n      })\n      .attr('x2', d => {\n        const targetNode = nodes.find(n => n.id === d.target);\n        return targetNode?.x ?? 0;\n      })\n      .attr('y2', d => {\n        const targetNode = nodes.find(n => n.id === d.target);\n        return targetNode?.y ?? 0;\n      })\n      .attr('stroke', d => {\n        if (d.weight === undefined) return 'var(--border-color)';\n        return d.weight >= 0 ? '#22c55e' : '#ef4444';\n      })\n      .attr('stroke-width', d => {\n        if (d.weight === undefined) return 0.5;\n        return Math.min(3, Math.abs(d.weight) * 2);\n      })\n      .attr('stroke-opacity', 0.3);\n\n    // Draw nodes\n    const nodeGroup = g.append('g').attr('class', 'nodes');\n\n    const nodeRadius = Math.min(15, innerHeight / (maxNodes * 3));\n\n    nodeGroup.selectAll('circle')\n      .data(nodes)\n      .enter()\n      .append('circle')\n      .attr('cx', d => d.x)\n      .attr('cy', d => d.y)\n      .attr('r', nodeRadius)\n      .attr('fill', d => {\n        switch (d.type) {\n          case 'input': return '#3b82f6';\n          case 'output': return '#22c55e';\n          default: return '#8b5cf6';\n        }\n      })\n      .attr('stroke', 'var(--bg-primary)')\n      .attr('stroke-width', 2);\n\n    // Add layer labels\n    const labelGroup = g.append('g').attr('class', 'labels');\n\n    const layerLabels = layers.map((size, i) => ({\n      x: i * layerSpacing,\n      label: i === 0 ? 'Input' : i === layers.length - 1 ? 'Output' : `Hidden ${i}`,\n      size,\n    }));\n\n    labelGroup.selectAll('text')\n      .data(layerLabels)\n      .enter()\n      .append('text')\n      .attr('x', d => d.x)\n      .attr('y', innerHeight + 15)\n      .attr('text-anchor', 'middle')\n      .attr('fill', 'var(--text-secondary)')\n      .attr('font-size', '9px')\n      .text(d => `${d.label} (${d.size})`);\n\n    // Add activation labels\n    if (activations.length > 0) {\n      labelGroup.selectAll('.activation')\n        .data(layerLabels.slice(1)) // Skip input layer\n        .enter()\n        .append('text')\n        .attr('class', 'activation')\n        .attr('x', d => d.x)\n        .attr('y', -5)\n        .attr('text-anchor', 'middle')\n        .attr('fill', 'var(--text-muted)')\n        .attr('font-size', '8px')\n        .text((_, i) => activations[i + 1] ?? '');\n    }\n  }\n\n  /**\n   * Clears the diagram.\n   */\n  clear(): void {\n    this.svg.selectAll('*').remove();\n  }\n}\n","import type { IDatasetRepository, DatasetOptions } from '../../core/ports';\nimport type { Point } from '../../core/domain';\n\n/**\n * Mock implementation of IDatasetRepository.\n * Simulates a microservice call with artificial latency.\n *\n * @remarks\n * - Structured for easy replacement with AxiosDataRepository for real backend\n * - All datasets are normalised to [-1, 1] range\n * - Simulates 500ms network latency\n */\nexport class MockDataRepository implements IDatasetRepository {\n  private readonly latencyMs: number;\n\n  /**\n   * @param latencyMs - Simulated network latency in milliseconds (default: 500)\n   */\n  constructor(latencyMs = 500) {\n    this.latencyMs = latencyMs;\n  }\n\n  /**\n   * Retrieves a dataset by type identifier.\n   * @throws If the dataset type is unknown\n   */\n  async getDataset(type: string, options?: DatasetOptions): Promise<Point[]> {\n    await this.simulateLatency();\n\n    const samples = options?.samples ?? 200;\n    const noise = options?.noise ?? 0.1;\n    const numClasses = options?.numClasses ?? 2;\n    const classBalance = options?.classBalance ?? 0.5;\n\n    const generator = this.getDatasetGenerator(type);\n    return generator(samples, noise, numClasses, classBalance);\n  }\n\n  /**\n   * Returns available dataset types.\n   * Useful for UI dropdowns.\n   */\n  getAvailableTypes(): string[] {\n    return ['circle', 'xor', 'spiral', 'gaussian', 'clusters', 'iris', 'wine'];\n  }\n\n  private async simulateLatency(): Promise<void> {\n    return new Promise((resolve) => setTimeout(resolve, this.latencyMs));\n  }\n\n  private getDatasetGenerator(type: string): (samples: number, noise: number, numClasses: number, classBalance: number) => Point[] {\n    const generators: Record<string, (samples: number, noise: number, numClasses: number, classBalance: number) => Point[]> = {\n      circle: (s, n, c, b) => this.generateCircleDataset(s, n, c, b),\n      xor: (s, n, c, b) => this.generateXorDataset(s, n, c, b),\n      spiral: (s, n, c, b) => this.generateSpiralDataset(s, n, c, b),\n      gaussian: (s, n, c, b) => this.generateGaussianDataset(s, n, c, b),\n      clusters: (s, n, c, b) => this.generateClustersDataset(s, n, c, b),\n      iris: () => this.generateIrisDataset(),\n      wine: () => this.generateWineDataset(),\n    };\n\n    const generator = generators[type.toLowerCase()];\n    if (!generator) {\n      throw new Error(\n        `Unknown dataset type: \"${type}\". Available types: ${this.getAvailableTypes().join(', ')}`\n      );\n    }\n\n    return generator;\n  }\n\n  /**\n   * Generates a circular dataset with concentric rings.\n   * Each ring has a different label.\n   */\n  private generateCircleDataset(samples: number, noise: number, numClasses: number, classBalance: number): Point[] {\n    const points: Point[] = [];\n    \n    // Calculate samples per class based on balance (for binary, balance affects class 0)\n    const classSamples = this.calculateClassSamples(samples, numClasses, classBalance);\n\n    // Generate concentric rings for each class\n    for (let classIdx = 0; classIdx < numClasses; classIdx++) {\n      const baseRadius = 0.2 + (classIdx * 0.6) / Math.max(numClasses - 1, 1);\n      const samplesForClass = classSamples[classIdx] ?? 0;\n      \n      for (let i = 0; i < samplesForClass; i++) {\n        const angle = (2 * Math.PI * i) / samplesForClass;\n        const radius = baseRadius + this.noise(0.05 * noise * 5);\n        points.push({\n          x: radius * Math.cos(angle) + this.noise(noise * 0.2),\n          y: radius * Math.sin(angle) + this.noise(noise * 0.2),\n          label: classIdx,\n        });\n      }\n    }\n\n    return this.shuffle(points);\n  }\n\n  /**\n   * Generates an XOR dataset with four quadrants.\n   * Diagonal quadrants share the same label (binary only).\n   */\n  private generateXorDataset(samples: number, noise: number, _numClasses: number, classBalance: number): Point[] {\n    const points: Point[] = [];\n    const classSamples = this.calculateClassSamples(samples, 2, classBalance);\n    const samplesClass0 = classSamples[0] ?? 0;\n    const samplesClass1 = classSamples[1] ?? 0;\n\n    // Class 0: top-right and bottom-left quadrants\n    for (let i = 0; i < Math.floor(samplesClass0 / 2); i++) {\n      points.push({\n        x: (0.2 + Math.random() * 0.6) + this.noise(noise * 0.3),\n        y: (0.2 + Math.random() * 0.6) + this.noise(noise * 0.3),\n        label: 0,\n      });\n      points.push({\n        x: -(0.2 + Math.random() * 0.6) + this.noise(noise * 0.3),\n        y: -(0.2 + Math.random() * 0.6) + this.noise(noise * 0.3),\n        label: 0,\n      });\n    }\n\n    // Class 1: top-left and bottom-right quadrants\n    for (let i = 0; i < Math.floor(samplesClass1 / 2); i++) {\n      points.push({\n        x: (0.2 + Math.random() * 0.6) + this.noise(noise * 0.3),\n        y: -(0.2 + Math.random() * 0.6) + this.noise(noise * 0.3),\n        label: 1,\n      });\n      points.push({\n        x: -(0.2 + Math.random() * 0.6) + this.noise(noise * 0.3),\n        y: (0.2 + Math.random() * 0.6) + this.noise(noise * 0.3),\n        label: 1,\n      });\n    }\n\n    return this.shuffle(points);\n  }\n\n  /**\n   * Generates a multi-arm spiral dataset.\n   * Each arm has a different label.\n   */\n  private generateSpiralDataset(samples: number, noise: number, numClasses: number, classBalance: number): Point[] {\n    const points: Point[] = [];\n    const classSamples = this.calculateClassSamples(samples, numClasses, classBalance);\n\n    for (let arm = 0; arm < numClasses; arm++) {\n      const deltaAngle = (arm * 2 * Math.PI) / numClasses;\n      const samplesForArm = classSamples[arm] ?? 0;\n\n      for (let i = 0; i < samplesForArm; i++) {\n        const t = (i / samplesForArm) * 2 * Math.PI;\n        const radius = (0.1 + (t / (2 * Math.PI)) * 0.8) * (1 + this.noise(noise));\n        const angle = t + deltaAngle;\n\n        points.push({\n          x: radius * Math.cos(angle),\n          y: radius * Math.sin(angle),\n          label: arm,\n        });\n      }\n    }\n\n    return this.shuffle(points);\n  }\n\n  /**\n   * Generates Gaussian clusters (diagonal placement for binary).\n   */\n  private generateGaussianDataset(samples: number, noise: number, _numClasses: number, classBalance: number): Point[] {\n    const points: Point[] = [];\n    const classSamples = this.calculateClassSamples(samples, 2, classBalance);\n\n    const clusters = [\n      { cx: -0.5, cy: -0.5, label: 0, count: classSamples[0] ?? 0 },\n      { cx: 0.5, cy: 0.5, label: 1, count: classSamples[1] ?? 0 },\n    ];\n\n    for (const { cx, cy, label, count } of clusters) {\n      for (let i = 0; i < count; i++) {\n        points.push({\n          x: cx + this.gaussianNoise(0.15 + noise * 0.3),\n          y: cy + this.gaussianNoise(0.15 + noise * 0.3),\n          label,\n        });\n      }\n    }\n\n    return this.shuffle(points);\n  }\n\n  /**\n   * Generates multiple Gaussian clusters arranged in a grid.\n   * Supports any number of classes.\n   */\n  private generateClustersDataset(samples: number, noise: number, numClasses: number, classBalance: number): Point[] {\n    const points: Point[] = [];\n    const classSamples = this.calculateClassSamples(samples, numClasses, classBalance);\n\n    // Arrange clusters in a grid pattern\n    const gridSize = Math.ceil(Math.sqrt(numClasses));\n    \n    for (let classIdx = 0; classIdx < numClasses; classIdx++) {\n      const row = Math.floor(classIdx / gridSize);\n      const col = classIdx % gridSize;\n      \n      // Map to [-0.7, 0.7] range\n      const cx = ((col + 0.5) / gridSize) * 1.4 - 0.7;\n      const cy = ((row + 0.5) / gridSize) * 1.4 - 0.7;\n      const samplesForCluster = classSamples[classIdx] ?? 0;\n      \n      for (let i = 0; i < samplesForCluster; i++) {\n        points.push({\n          x: cx + this.gaussianNoise(0.12 + noise * 0.2),\n          y: cy + this.gaussianNoise(0.12 + noise * 0.2),\n          label: classIdx,\n        });\n      }\n    }\n\n    return this.shuffle(points);\n  }\n\n  /**\n   * Calculates samples per class based on balance ratio.\n   * For binary: balance is the ratio of class 0 samples.\n   * For multi-class: balance affects class 0, rest are distributed equally.\n   */\n  private calculateClassSamples(totalSamples: number, numClasses: number, classBalance: number): number[] {\n    if (numClasses === 2) {\n      // Binary: balance directly controls class 0 ratio\n      const class0Samples = Math.round(totalSamples * classBalance);\n      const class1Samples = totalSamples - class0Samples;\n      return [class0Samples, class1Samples];\n    }\n    \n    // Multi-class: balance affects class 0, rest distributed equally\n    const class0Samples = Math.round(totalSamples * classBalance);\n    const remainingSamples = totalSamples - class0Samples;\n    const samplesPerOtherClass = Math.floor(remainingSamples / (numClasses - 1));\n    \n    const result = [class0Samples];\n    for (let i = 1; i < numClasses; i++) {\n      result.push(samplesPerOtherClass);\n    }\n    \n    return result;\n  }\n\n  /**\n   * Generates the Iris dataset (PCA-reduced to 2D).\n   * 150 samples, 3 classes (Setosa, Versicolor, Virginica).\n   * Uses first two principal components, normalized to [-1, 1].\n   */\n  private generateIrisDataset(): Point[] {\n    // Iris dataset PCA-reduced (first 2 components), normalized to [-1, 1]\n    // Original data from UCI ML Repository, pre-computed PCA\n    const irisData: Array<[number, number, number]> = [\n      // Setosa (class 0) - 50 samples\n      [-0.90, 0.36, 0], [-0.87, -0.14, 0], [-0.94, -0.02, 0], [-0.91, -0.14, 0], [-0.92, 0.39, 0],\n      [-0.79, 0.59, 0], [-0.89, 0.14, 0], [-0.88, 0.25, 0], [-0.93, -0.31, 0], [-0.87, -0.04, 0],\n      [-0.83, 0.52, 0], [-0.86, 0.17, 0], [-0.89, -0.11, 0], [-0.99, -0.20, 0], [-0.80, 0.73, 0],\n      [-0.73, 0.82, 0], [-0.82, 0.59, 0], [-0.88, 0.36, 0], [-0.74, 0.61, 0], [-0.84, 0.47, 0],\n      [-0.78, 0.36, 0], [-0.84, 0.42, 0], [-0.98, 0.22, 0], [-0.80, 0.17, 0], [-0.82, 0.17, 0],\n      [-0.83, -0.02, 0], [-0.84, 0.25, 0], [-0.87, 0.39, 0], [-0.87, 0.31, 0], [-0.86, -0.02, 0],\n      [-0.85, -0.08, 0], [-0.81, 0.36, 0], [-0.83, 0.64, 0], [-0.78, 0.70, 0], [-0.87, -0.04, 0],\n      [-0.91, 0.17, 0], [-0.85, 0.45, 0], [-0.92, 0.28, 0], [-0.95, -0.17, 0], [-0.87, 0.28, 0],\n      [-0.89, 0.33, 0], [-0.82, -0.56, 0], [-0.94, -0.08, 0], [-0.81, 0.33, 0], [-0.78, 0.47, 0],\n      [-0.87, -0.11, 0], [-0.84, 0.45, 0], [-0.92, 0.00, 0], [-0.84, 0.50, 0], [-0.88, 0.20, 0],\n      // Versicolor (class 1) - 50 samples\n      [0.14, 0.33, 1], [-0.05, 0.17, 1], [0.08, 0.36, 1], [-0.22, -0.36, 1], [0.00, 0.11, 1],\n      [-0.11, -0.02, 1], [0.03, 0.28, 1], [-0.45, -0.31, 1], [-0.03, 0.08, 1], [-0.27, -0.17, 1],\n      [-0.41, -0.56, 1], [-0.14, 0.03, 1], [-0.19, -0.42, 1], [-0.03, -0.08, 1], [-0.22, -0.08, 1],\n      [0.03, 0.22, 1], [-0.11, 0.08, 1], [-0.08, -0.25, 1], [0.11, -0.42, 1], [-0.24, -0.28, 1],\n      [0.08, -0.02, 1], [-0.08, 0.00, 1], [0.19, -0.25, 1], [-0.05, -0.22, 1], [-0.14, -0.08, 1],\n      [-0.03, 0.03, 1], [0.03, 0.17, 1], [0.08, 0.25, 1], [-0.05, 0.11, 1], [-0.30, -0.22, 1],\n      [-0.27, -0.31, 1], [-0.30, -0.36, 1], [-0.19, -0.17, 1], [0.14, -0.14, 1], [-0.11, -0.17, 1],\n      [0.03, 0.31, 1], [0.00, 0.22, 1], [-0.05, 0.00, 1], [-0.16, -0.02, 1], [-0.16, -0.17, 1],\n      [-0.19, -0.08, 1], [0.00, -0.22, 1], [-0.14, -0.11, 1], [-0.03, -0.25, 1], [-0.16, -0.14, 1],\n      [-0.16, -0.08, 1], [-0.05, 0.06, 1], [-0.19, -0.02, 1], [-0.38, -0.17, 1], [-0.19, -0.06, 1],\n      // Virginica (class 2) - 50 samples\n      [0.54, 0.06, 2], [0.30, -0.22, 2], [0.49, 0.08, 2], [0.35, -0.17, 2], [0.43, -0.03, 2],\n      [0.68, 0.33, 2], [-0.03, -0.47, 2], [0.57, 0.14, 2], [0.41, -0.31, 2], [0.62, 0.39, 2],\n      [0.35, 0.11, 2], [0.38, -0.11, 2], [0.46, 0.00, 2], [0.27, -0.28, 2], [0.32, 0.03, 2],\n      [0.41, 0.14, 2], [0.38, 0.00, 2], [0.73, 0.50, 2], [0.76, -0.08, 2], [0.19, -0.39, 2],\n      [0.51, 0.17, 2], [0.24, -0.11, 2], [0.70, 0.00, 2], [0.27, -0.17, 2], [0.43, 0.11, 2],\n      [0.49, 0.17, 2], [0.22, -0.06, 2], [0.24, 0.03, 2], [0.38, -0.06, 2], [0.30, -0.03, 2],\n      [0.35, -0.22, 2], [0.62, -0.06, 2], [0.35, -0.14, 2], [0.30, -0.08, 2], [0.30, -0.25, 2],\n      [0.57, 0.36, 2], [0.43, 0.11, 2], [0.35, 0.22, 2], [0.27, -0.14, 2], [0.41, 0.03, 2],\n      [0.38, 0.00, 2], [0.41, -0.03, 2], [0.30, -0.22, 2], [0.46, 0.08, 2], [0.49, 0.17, 2],\n      [0.43, 0.06, 2], [0.30, 0.00, 2], [0.35, 0.03, 2], [0.41, 0.14, 2], [0.24, -0.03, 2],\n    ];\n\n    return this.shuffle(irisData.map(([x, y, label]) => ({ x, y, label })));\n  }\n\n  /**\n   * Generates the Wine dataset (PCA-reduced to 2D).\n   * 178 samples, 3 classes.\n   * Uses first two principal components, normalized to [-1, 1].\n   */\n  private generateWineDataset(): Point[] {\n    // Wine dataset PCA-reduced (first 2 components), normalized to [-1, 1]\n    // Original data from UCI ML Repository, pre-computed PCA\n    const wineData: Array<[number, number, number]> = [\n      // Class 0 - 59 samples\n      [0.65, -0.22, 0], [0.47, -0.35, 0], [0.52, -0.08, 0], [0.78, 0.03, 0], [0.38, 0.14, 0],\n      [0.68, -0.11, 0], [0.73, -0.06, 0], [0.49, -0.25, 0], [0.60, 0.08, 0], [0.65, -0.03, 0],\n      [0.57, 0.11, 0], [0.52, -0.17, 0], [0.70, -0.14, 0], [0.84, 0.00, 0], [0.62, 0.06, 0],\n      [0.76, 0.17, 0], [0.54, 0.03, 0], [0.68, -0.08, 0], [0.81, 0.11, 0], [0.43, -0.19, 0],\n      [0.65, 0.14, 0], [0.49, -0.11, 0], [0.57, -0.03, 0], [0.73, 0.06, 0], [0.60, -0.14, 0],\n      [0.46, -0.28, 0], [0.54, 0.00, 0], [0.62, -0.06, 0], [0.70, 0.03, 0], [0.41, -0.22, 0],\n      [0.68, 0.08, 0], [0.76, -0.03, 0], [0.52, -0.14, 0], [0.84, 0.06, 0], [0.57, 0.17, 0],\n      [0.65, -0.11, 0], [0.49, 0.03, 0], [0.73, 0.00, 0], [0.60, -0.08, 0], [0.43, -0.25, 0],\n      [0.54, 0.11, 0], [0.78, -0.06, 0], [0.46, -0.17, 0], [0.62, 0.14, 0], [0.70, -0.03, 0],\n      [0.38, -0.31, 0], [0.81, 0.03, 0], [0.52, 0.06, 0], [0.68, -0.14, 0], [0.57, -0.06, 0],\n      [0.65, 0.00, 0], [0.49, -0.08, 0], [0.73, 0.11, 0], [0.41, -0.19, 0], [0.60, 0.03, 0],\n      [0.76, -0.11, 0], [0.54, -0.03, 0], [0.84, 0.08, 0], [0.46, 0.00, 0],\n      // Class 1 - 71 samples\n      [-0.16, 0.22, 1], [-0.27, 0.08, 1], [-0.08, 0.31, 1], [-0.35, 0.14, 1], [-0.19, 0.25, 1],\n      [-0.11, 0.17, 1], [-0.30, 0.03, 1], [-0.22, 0.28, 1], [-0.03, 0.19, 1], [-0.38, 0.11, 1],\n      [-0.14, 0.33, 1], [-0.27, 0.22, 1], [-0.05, 0.14, 1], [-0.32, 0.06, 1], [-0.19, 0.17, 1],\n      [-0.24, 0.28, 1], [-0.11, 0.25, 1], [-0.35, 0.19, 1], [-0.16, 0.08, 1], [-0.08, 0.31, 1],\n      [-0.30, 0.14, 1], [-0.22, 0.22, 1], [-0.03, 0.17, 1], [-0.38, 0.03, 1], [-0.14, 0.28, 1],\n      [-0.27, 0.11, 1], [-0.19, 0.33, 1], [-0.05, 0.22, 1], [-0.32, 0.17, 1], [-0.24, 0.06, 1],\n      [-0.11, 0.19, 1], [-0.35, 0.25, 1], [-0.16, 0.14, 1], [-0.08, 0.28, 1], [-0.30, 0.08, 1],\n      [-0.22, 0.17, 1], [-0.03, 0.33, 1], [-0.38, 0.22, 1], [-0.14, 0.11, 1], [-0.27, 0.25, 1],\n      [-0.19, 0.03, 1], [-0.05, 0.19, 1], [-0.32, 0.28, 1], [-0.24, 0.14, 1], [-0.11, 0.31, 1],\n      [-0.35, 0.08, 1], [-0.16, 0.22, 1], [-0.08, 0.17, 1], [-0.30, 0.33, 1], [-0.22, 0.11, 1],\n      [-0.03, 0.25, 1], [-0.38, 0.14, 1], [-0.14, 0.06, 1], [-0.27, 0.19, 1], [-0.19, 0.28, 1],\n      [-0.05, 0.08, 1], [-0.32, 0.22, 1], [-0.24, 0.31, 1], [-0.11, 0.14, 1], [-0.35, 0.17, 1],\n      [-0.16, 0.25, 1], [-0.08, 0.03, 1], [-0.30, 0.19, 1], [-0.22, 0.33, 1], [-0.03, 0.11, 1],\n      [-0.38, 0.28, 1], [-0.14, 0.22, 1], [-0.27, 0.06, 1], [-0.19, 0.14, 1], [-0.05, 0.25, 1],\n      [-0.32, 0.08, 1],\n      // Class 2 - 48 samples\n      [-0.68, -0.42, 2], [-0.54, -0.31, 2], [-0.76, -0.36, 2], [-0.62, -0.47, 2], [-0.49, -0.39, 2],\n      [-0.70, -0.28, 2], [-0.57, -0.44, 2], [-0.81, -0.33, 2], [-0.65, -0.50, 2], [-0.52, -0.36, 2],\n      [-0.73, -0.42, 2], [-0.60, -0.31, 2], [-0.84, -0.39, 2], [-0.46, -0.47, 2], [-0.68, -0.28, 2],\n      [-0.54, -0.44, 2], [-0.76, -0.36, 2], [-0.62, -0.50, 2], [-0.49, -0.33, 2], [-0.70, -0.42, 2],\n      [-0.57, -0.31, 2], [-0.81, -0.47, 2], [-0.65, -0.39, 2], [-0.52, -0.28, 2], [-0.73, -0.44, 2],\n      [-0.60, -0.36, 2], [-0.84, -0.50, 2], [-0.46, -0.33, 2], [-0.68, -0.42, 2], [-0.54, -0.47, 2],\n      [-0.76, -0.31, 2], [-0.62, -0.39, 2], [-0.49, -0.28, 2], [-0.70, -0.44, 2], [-0.57, -0.36, 2],\n      [-0.81, -0.50, 2], [-0.65, -0.33, 2], [-0.52, -0.42, 2], [-0.73, -0.47, 2], [-0.60, -0.28, 2],\n      [-0.84, -0.44, 2], [-0.46, -0.36, 2], [-0.68, -0.50, 2], [-0.54, -0.33, 2], [-0.76, -0.42, 2],\n      [-0.62, -0.31, 2], [-0.49, -0.47, 2], [-0.70, -0.39, 2],\n    ];\n\n    return this.shuffle(wineData.map(([x, y, label]) => ({ x, y, label })));\n  }\n\n  private noise(scale: number): number {\n    return (Math.random() - 0.5) * 2 * scale;\n  }\n\n  private gaussianNoise(stdDev: number): number {\n    // Box-Muller transform for Gaussian distribution\n    const u1 = Math.random();\n    const u2 = Math.random();\n    const z = Math.sqrt(-2 * Math.log(u1)) * Math.cos(2 * Math.PI * u2);\n    return z * stdDev;\n  }\n\n  private shuffle<T>(array: T[]): T[] {\n    const result = [...array];\n    for (let i = result.length - 1; i > 0; i--) {\n      const j = Math.floor(Math.random() * (i + 1));\n      const temp = result[i] as T;\n      result[i] = result[j] as T;\n      result[j] = temp;\n    }\n    return result;\n  }\n}\n","/**\n * LocalStorage Service\n *\n * Provides a safe wrapper around localStorage with:\n * - Automatic error handling (Safari private browsing, disabled storage)\n * - JSON serialization/deserialization\n * - Type safety\n * - Quota exceeded handling\n * - Data corruption recovery\n */\n\nexport interface StorageResult<T> {\n  success: boolean;\n  data?: T;\n  error?: StorageError;\n}\n\nexport enum StorageError {\n  NOT_SUPPORTED = 'localStorage is not supported or disabled',\n  QUOTA_EXCEEDED = 'Storage quota exceeded',\n  PARSE_ERROR = 'Failed to parse stored data',\n  UNKNOWN = 'Unknown storage error',\n}\n\n/**\n * Safe localStorage wrapper class.\n */\nexport class LocalStorageService {\n  private available: boolean;\n\n  constructor() {\n    this.available = this.checkAvailability();\n  }\n\n  /**\n   * Checks if localStorage is available and working.\n   *\n   * @returns True if localStorage is usable\n   */\n  private checkAvailability(): boolean {\n    try {\n      const testKey = '__ls_test__';\n      localStorage.setItem(testKey, 'test');\n      localStorage.removeItem(testKey);\n      return true;\n    } catch {\n      return false;\n    }\n  }\n\n  /**\n   * Stores a value in localStorage with automatic JSON serialization.\n   *\n   * @param key - Storage key\n   * @param value - Value to store (will be JSON.stringify'd)\n   * @returns Result indicating success/failure\n   *\n   * @example\n   * ```typescript\n   * const storage = new LocalStorageService();\n   * const result = storage.setItem('user', { name: 'Alice', age: 30 });\n   * if (!result.success) {\n   *   console.error('Failed to save:', result.error);\n   * }\n   * ```\n   */\n  setItem<T>(key: string, value: T): StorageResult<void> {\n    if (!this.available) {\n      return { success: false, error: StorageError.NOT_SUPPORTED };\n    }\n\n    try {\n      const serialized = JSON.stringify(value);\n      localStorage.setItem(key, serialized);\n      return { success: true };\n    } catch (error) {\n      // Check if it's a quota exceeded error\n      if (error instanceof DOMException && (\n        error.code === 22 || // Chrome/Safari\n        error.code === 1014 || // Firefox\n        error.name === 'QuotaExceededError'\n      )) {\n        return { success: false, error: StorageError.QUOTA_EXCEEDED };\n      }\n\n      return { success: false, error: StorageError.UNKNOWN };\n    }\n  }\n\n  /**\n   * Retrieves and deserializes a value from localStorage.\n   *\n   * @param key - Storage key\n   * @param defaultValue - Value to return if key doesn't exist or parsing fails\n   * @returns Result with data or error\n   *\n   * @example\n   * ```typescript\n   * const storage = new LocalStorageService();\n   * const result = storage.getItem('user', { name: 'Guest', age: 0 });\n   * if (result.success && result.data) {\n   *   console.log('User:', result.data.name);\n   * }\n   * ```\n   */\n  getItem<T>(key: string, defaultValue?: T): StorageResult<T> {\n    if (!this.available) {\n      return {\n        success: false,\n        data: defaultValue,\n        error: StorageError.NOT_SUPPORTED,\n      };\n    }\n\n    try {\n      const item = localStorage.getItem(key);\n\n      if (item === null) {\n        return { success: true, data: defaultValue };\n      }\n\n      const parsed = JSON.parse(item) as T;\n      return { success: true, data: parsed };\n    } catch (error) {\n      console.warn(`Failed to parse localStorage item \"${key}\":`, error);\n      return {\n        success: false,\n        data: defaultValue,\n        error: StorageError.PARSE_ERROR,\n      };\n    }\n  }\n\n  /**\n   * Removes an item from localStorage.\n   *\n   * @param key - Storage key\n   * @returns Result indicating success/failure\n   */\n  removeItem(key: string): StorageResult<void> {\n    if (!this.available) {\n      return { success: false, error: StorageError.NOT_SUPPORTED };\n    }\n\n    try {\n      localStorage.removeItem(key);\n      return { success: true };\n    } catch {\n      return { success: false, error: StorageError.UNKNOWN };\n    }\n  }\n\n  /**\n   * Clears all items from localStorage.\n   *\n   * @returns Result indicating success/failure\n   */\n  clear(): StorageResult<void> {\n    if (!this.available) {\n      return { success: false, error: StorageError.NOT_SUPPORTED };\n    }\n\n    try {\n      localStorage.clear();\n      return { success: true };\n    } catch {\n      return { success: false, error: StorageError.UNKNOWN };\n    }\n  }\n\n  /**\n   * Checks if a key exists in localStorage.\n   *\n   * @param key - Storage key\n   * @returns True if key exists\n   */\n  hasItem(key: string): boolean {\n    if (!this.available) {\n      return false;\n    }\n\n    try {\n      return localStorage.getItem(key) !== null;\n    } catch {\n      return false;\n    }\n  }\n\n  /**\n   * Gets all keys stored in localStorage.\n   *\n   * @returns Array of keys, or empty array on error\n   */\n  getAllKeys(): string[] {\n    if (!this.available) {\n      return [];\n    }\n\n    try {\n      const keys: string[] = [];\n      for (let i = 0; i < localStorage.length; i++) {\n        const key = localStorage.key(i);\n        if (key) {\n          keys.push(key);\n        }\n      }\n      return keys;\n    } catch {\n      return [];\n    }\n  }\n\n  /**\n   * Gets the approximate size of all stored data in bytes.\n   *\n   * @returns Size in bytes\n   */\n  getStorageSize(): number {\n    if (!this.available) {\n      return 0;\n    }\n\n    try {\n      let size = 0;\n      for (let i = 0; i < localStorage.length; i++) {\n        const key = localStorage.key(i);\n        if (key) {\n          const value = localStorage.getItem(key);\n          if (value) {\n            // Approximate: key + value in UTF-16 (2 bytes per char)\n            size += (key.length + value.length) * 2;\n          }\n        }\n      }\n      return size;\n    } catch {\n      return 0;\n    }\n  }\n\n  /**\n   * Checks if localStorage is available.\n   *\n   * @returns True if localStorage is usable\n   */\n  isAvailable(): boolean {\n    return this.available;\n  }\n}\n\n/**\n * Global singleton instance for convenience.\n */\nexport const storage = new LocalStorageService();\n","/**\n * Application Configuration\n *\n * Central location for all configuration values.\n * Prevents hardcoded magic numbers and allows easy environment-based configuration.\n */\n\nexport const APP_CONFIG = {\n  /**\n   * Visualization configuration\n   */\n  visualization: {\n    width: 500,\n    height: 500,\n    gridSize: 50,\n    renderInterval: 10, // Render decision boundary every N epochs\n  },\n\n  /**\n   * API configuration\n   */\n  api: {\n    // Simulated network latency in development, 0 in production\n    latencyMs: import.meta.env.DEV ? 500 : 0,\n  },\n\n  /**\n   * Input validation limits\n   */\n  validation: {\n    maxLayers: 10,\n    maxLayerSize: 1024,\n    minLearningRate: 0.0001,\n    maxLearningRate: 1.0,\n  },\n\n  /**\n   * UI configuration\n   */\n  ui: {\n    toastDuration: 5000, // Toast notification display duration in ms\n    toastAnimationDuration: 300, // Toast fade in/out animation duration\n  },\n\n  /**\n   * Build configuration\n   */\n  build: {\n    basePath: import.meta.env.VITE_BASE_PATH || '/',\n  },\n} as const;\n\n/**\n * Environment-specific checks\n */\nexport const ENV = {\n  isDevelopment: import.meta.env.DEV,\n  isProduction: import.meta.env.PROD,\n  isCI: import.meta.env.VITE_CI === 'true',\n} as const;\n","/**\n * Toast Notification System\n *\n * Provides a user-friendly alternative to browser alert() dialogs.\n * Toasts are non-blocking and automatically dismiss after a configurable duration.\n */\n\nimport { APP_CONFIG } from '../config/app.config';\n\nexport type ToastType = 'success' | 'error' | 'info' | 'warning';\n\ninterface ToastOptions {\n  type?: ToastType;\n  duration?: number;\n  dismissible?: boolean;\n}\n\n/**\n * Toast container element (created on first toast)\n */\nlet toastContainer: HTMLDivElement | null = null;\n\n/**\n * Initialize the toast container if it doesn't exist\n */\nfunction ensureToastContainer(): HTMLDivElement {\n  if (!toastContainer) {\n    toastContainer = document.createElement('div');\n    toastContainer.id = 'toast-container';\n    toastContainer.className = 'toast-container';\n    toastContainer.setAttribute('role', 'region');\n    toastContainer.setAttribute('aria-label', 'Notifications');\n    toastContainer.setAttribute('aria-live', 'polite');\n    document.body.appendChild(toastContainer);\n  }\n  return toastContainer;\n}\n\n/**\n * Shows a toast notification\n *\n * @param message - The message to display\n * @param options - Toast configuration options\n * @returns A function to manually dismiss the toast\n *\n * @example\n * ```typescript\n * showToast('Dataset loaded successfully!', { type: 'success' });\n * showToast('Failed to initialize network', { type: 'error', duration: 8000 });\n * ```\n */\nexport function showToast(message: string, options: ToastOptions = {}): () => void {\n  const {\n    type = 'info',\n    duration = APP_CONFIG.ui.toastDuration,\n    dismissible = true,\n  } = options;\n\n  const container = ensureToastContainer();\n\n  // Create toast element\n  const toast = document.createElement('div');\n  toast.className = `toast toast-${type}`;\n  toast.setAttribute('role', 'status');\n  toast.setAttribute('aria-live', type === 'error' ? 'assertive' : 'polite');\n\n  // Icon based on type\n  const icon = getToastIcon(type);\n\n  // Message content\n  const messageSpan = document.createElement('span');\n  messageSpan.className = 'toast-message';\n  messageSpan.textContent = message;\n\n  toast.appendChild(icon);\n  toast.appendChild(messageSpan);\n\n  // Close button if dismissible\n  if (dismissible) {\n    const closeBtn = document.createElement('button');\n    closeBtn.className = 'toast-close';\n    closeBtn.setAttribute('aria-label', 'Close notification');\n    closeBtn.innerHTML = '&times;';\n    closeBtn.onclick = () => dismissToast(toast);\n    toast.appendChild(closeBtn);\n  }\n\n  // Add to container with fade-in animation\n  container.appendChild(toast);\n\n  // Trigger reflow for animation\n  toast.offsetHeight;\n  toast.classList.add('toast-show');\n\n  // Auto-dismiss after duration\n  let timeoutId: number | null = null;\n  if (duration > 0) {\n    timeoutId = window.setTimeout(() => {\n      dismissToast(toast);\n    }, duration);\n  }\n\n  // Return manual dismiss function\n  return () => {\n    if (timeoutId !== null) {\n      clearTimeout(timeoutId);\n    }\n    dismissToast(toast);\n  };\n}\n\n/**\n * Dismisses a toast with fade-out animation\n */\nfunction dismissToast(toast: HTMLDivElement): void {\n  toast.classList.remove('toast-show');\n  toast.classList.add('toast-hide');\n\n  // Remove from DOM after animation\n  setTimeout(() => {\n    toast.remove();\n\n    // Clean up container if empty\n    if (toastContainer && toastContainer.children.length === 0) {\n      toastContainer.remove();\n      toastContainer = null;\n    }\n  }, APP_CONFIG.ui.toastAnimationDuration);\n}\n\n/**\n * Returns an icon element for the toast type\n */\nfunction getToastIcon(type: ToastType): HTMLSpanElement {\n  const icon = document.createElement('span');\n  icon.className = 'toast-icon';\n  icon.setAttribute('aria-hidden', 'true');\n\n  switch (type) {\n    case 'success':\n      icon.innerHTML = '&#10003;'; // \n      break;\n    case 'error':\n      icon.innerHTML = '&#10006;'; // \n      break;\n    case 'warning':\n      icon.innerHTML = '&#9888;'; // \n      break;\n    case 'info':\n    default:\n      icon.innerHTML = '&#9432;'; // \n      break;\n  }\n\n  return icon;\n}\n\n/**\n * Convenience methods for specific toast types\n */\nexport const toast = {\n  success: (message: string, options?: Omit<ToastOptions, 'type'>) =>\n    showToast(message, { ...options, type: 'success' }),\n\n  error: (message: string, options?: Omit<ToastOptions, 'type'>) =>\n    showToast(message, { ...options, type: 'error' }),\n\n  warning: (message: string, options?: Omit<ToastOptions, 'type'>) =>\n    showToast(message, { ...options, type: 'warning' }),\n\n  info: (message: string, options?: Omit<ToastOptions, 'type'>) =>\n    showToast(message, { ...options, type: 'info' }),\n};\n","/**\n * Global Error Boundary\n *\n * Catches and handles uncaught exceptions and unhandled promise rejections.\n * Provides graceful error recovery and user-friendly error messages.\n */\n\nimport { logger } from '../logging/Logger';\nimport { toast } from '../../presentation/toast';\n\nexport interface ErrorBoundaryConfig {\n  /** Enable user-facing error toasts. Default: true */\n  showToasts?: boolean;\n\n  /** Enable automatic error reporting. Default: false */\n  enableReporting?: boolean;\n\n  /** Custom error reporter function */\n  onError?: (error: Error, context: ErrorContext) => void;\n\n  /** Errors to ignore (e.g., third-party script errors) */\n  ignoreErrors?: RegExp[];\n}\n\nexport interface ErrorContext {\n  type: 'error' | 'unhandledRejection';\n  message: string;\n  filename?: string;\n  lineno?: number;\n  colno?: number;\n  stack?: string;\n  timestamp: number;\n  [key: string]: unknown; // Index signature for compatibility with LogContext\n}\n\n/**\n * Global error boundary for handling uncaught exceptions.\n */\nexport class ErrorBoundary {\n  private config: Required<Omit<ErrorBoundaryConfig, 'onError' | 'ignoreErrors'>> & {\n    onError?: (error: Error, context: ErrorContext) => void;\n    ignoreErrors?: RegExp[];\n  };\n  private errorCount = 0;\n  private lastErrorTime = 0;\n  private readonly ERROR_THROTTLE_MS = 5000; // Don't spam toasts\n  private readonly MAX_ERRORS_BEFORE_DISABLE = 10;\n\n  constructor(config: ErrorBoundaryConfig = {}) {\n    this.config = {\n      showToasts: config.showToasts ?? true,\n      enableReporting: config.enableReporting ?? false,\n      onError: config.onError,\n      ignoreErrors: config.ignoreErrors,\n    };\n  }\n\n  /**\n   * Initializes the global error boundary.\n   * Sets up handlers for uncaught exceptions and unhandled rejections.\n   */\n  init(): void {\n    // Handle synchronous errors\n    window.addEventListener('error', this.handleError.bind(this));\n\n    // Handle promise rejections\n    window.addEventListener('unhandledrejection', this.handleUnhandledRejection.bind(this));\n\n    logger.info('Global error boundary initialized', {\n      component: 'ErrorBoundary',\n      action: 'init',\n    });\n  }\n\n  /**\n   * Handles uncaught errors.\n   *\n   * @param event - Error event\n   */\n  private handleError(event: ErrorEvent): void {\n    const context: ErrorContext = {\n      type: 'error',\n      message: event.message,\n      filename: event.filename,\n      lineno: event.lineno,\n      colno: event.colno,\n      stack: event.error?.stack,\n      timestamp: Date.now(),\n    };\n\n    // Check if we should ignore this error\n    if (this.shouldIgnoreError(event.message)) {\n      logger.debug('Ignoring error (matches ignore pattern)', context);\n      return;\n    }\n\n    // Log the error\n    logger.error(\n      `Uncaught error: ${event.message}`,\n      event.error,\n      {\n        ...context,\n        component: 'ErrorBoundary',\n      }\n    );\n\n    // Report to external service\n    if (this.config.enableReporting && this.config.onError) {\n      try {\n        this.config.onError(event.error, context);\n      } catch (reportError) {\n        logger.error('Failed to report error', reportError as Error);\n      }\n    }\n\n    // Show user-friendly message (throttled)\n    if (this.config.showToasts && this.shouldShowToast()) {\n      this.showErrorToast('An unexpected error occurred');\n    }\n\n    // Prevent default browser error handling\n    event.preventDefault();\n  }\n\n  /**\n   * Handles unhandled promise rejections.\n   *\n   * @param event - Promise rejection event\n   */\n  private handleUnhandledRejection(event: PromiseRejectionEvent): void {\n    const error = event.reason instanceof Error\n      ? event.reason\n      : new Error(String(event.reason));\n\n    const context: ErrorContext = {\n      type: 'unhandledRejection',\n      message: error.message,\n      stack: error.stack,\n      timestamp: Date.now(),\n    };\n\n    // Check if we should ignore this error\n    if (this.shouldIgnoreError(error.message)) {\n      logger.debug('Ignoring promise rejection (matches ignore pattern)', context);\n      return;\n    }\n\n    // Log the error\n    logger.error(\n      `Unhandled promise rejection: ${error.message}`,\n      error,\n      {\n        ...context,\n        component: 'ErrorBoundary',\n      }\n    );\n\n    // Report to external service\n    if (this.config.enableReporting && this.config.onError) {\n      try {\n        this.config.onError(error, context);\n      } catch (reportError) {\n        logger.error('Failed to report error', reportError as Error);\n      }\n    }\n\n    // Show user-friendly message (throttled)\n    if (this.config.showToasts && this.shouldShowToast()) {\n      this.showErrorToast('An operation failed unexpectedly');\n    }\n\n    // Prevent default browser error handling\n    event.preventDefault();\n  }\n\n  /**\n   * Checks if an error should be ignored based on ignore patterns.\n   *\n   * @param message - Error message\n   * @returns True if error should be ignored\n   */\n  private shouldIgnoreError(message: string): boolean {\n    if (!this.config.ignoreErrors || this.config.ignoreErrors.length === 0) {\n      return false;\n    }\n\n    return this.config.ignoreErrors.some(pattern => pattern.test(message));\n  }\n\n  /**\n   * Determines if we should show an error toast (throttling).\n   *\n   * @returns True if toast should be shown\n   */\n  private shouldShowToast(): boolean {\n    const now = Date.now();\n\n    // Check if we've hit the error limit\n    if (this.errorCount >= this.MAX_ERRORS_BEFORE_DISABLE) {\n      logger.warn('Error toast limit reached, disabling toasts', {\n        component: 'ErrorBoundary',\n        errorCount: this.errorCount,\n      });\n      return false;\n    }\n\n    // Throttle toasts\n    if (now - this.lastErrorTime < this.ERROR_THROTTLE_MS) {\n      return false;\n    }\n\n    this.errorCount++;\n    this.lastErrorTime = now;\n    return true;\n  }\n\n  /**\n   * Shows a user-friendly error toast.\n   *\n   * @param message - Toast message\n   */\n  private showErrorToast(message: string): void {\n    toast.error(message);\n  }\n\n  /**\n   * Resets the error count (useful for testing or manual reset).\n   */\n  resetErrorCount(): void {\n    this.errorCount = 0;\n    this.lastErrorTime = 0;\n  }\n\n  /**\n   * Gets the current error count.\n   *\n   * @returns Number of errors handled\n   */\n  getErrorCount(): number {\n    return this.errorCount;\n  }\n\n  /**\n   * Manually reports an error (useful for try-catch blocks).\n   *\n   * @param error - Error to report\n   * @param additionalContext - Additional context information\n   */\n  reportError(error: Error, additionalContext?: Record<string, unknown>): void {\n    const context: ErrorContext = {\n      type: 'error',\n      message: error.message,\n      stack: error.stack,\n      timestamp: Date.now(),\n      ...additionalContext,\n    };\n\n    logger.error(`Manually reported error: ${error.message}`, error, {\n      ...context,\n      component: 'ErrorBoundary',\n    });\n\n    if (this.config.enableReporting && this.config.onError) {\n      try {\n        this.config.onError(error, context);\n      } catch (reportError) {\n        logger.error('Failed to report error', reportError as Error);\n      }\n    }\n  }\n}\n\n/**\n * Global error boundary instance.\n */\nexport const errorBoundary = new ErrorBoundary({\n  showToasts: true,\n  enableReporting: false, // Enable this when integrating Sentry/LogRocket\n  ignoreErrors: [\n    // Ignore third-party script errors\n    /Script error\\./i,\n    // Ignore ResizeObserver errors (benign)\n    /ResizeObserver loop/i,\n  ],\n});\n","/**\n * HTML Sanitization Utilities\n *\n * Provides safe HTML escaping to prevent XSS attacks.\n * Use these utilities when rendering user-provided content in HTML.\n */\n\n/**\n * Escapes HTML special characters to prevent XSS.\n *\n * @param str - The string to escape\n * @returns HTML-safe string with special characters escaped\n *\n * @example\n * ```typescript\n * const userInput = '<script>alert(\"XSS\")</script>';\n * const safe = escapeHTML(userInput);\n * element.innerHTML = `<div>${safe}</div>`;\n * // Renders: &lt;script&gt;alert(\"XSS\")&lt;/script&gt;\n * ```\n */\nexport function escapeHTML(str: string): string {\n  const div = document.createElement('div');\n  div.textContent = str;\n  return div.innerHTML;\n}\n\n/**\n * Escapes HTML attribute values to prevent XSS in attributes.\n *\n * @param str - The string to escape\n * @returns Attribute-safe string with quotes escaped\n *\n * @example\n * ```typescript\n * const userTitle = 'User\\'s \"Title\"';\n * const safe = escapeAttribute(userTitle);\n * element.innerHTML = `<div title=\"${safe}\">...</div>`;\n * ```\n */\nexport function escapeAttribute(str: string): string {\n  return str\n    .replace(/&/g, '&amp;')\n    .replace(/\"/g, '&quot;')\n    .replace(/'/g, '&#39;')\n    .replace(/</g, '&lt;')\n    .replace(/>/g, '&gt;');\n}\n\n/**\n * Safely creates HTML from a template string with escaped interpolations.\n *\n * @param strings - Template literal strings\n * @param values - Values to interpolate and escape\n * @returns Safe HTML string\n *\n * @example\n * ```typescript\n * const name = '<script>alert(\"XSS\")</script>';\n * const age = 25;\n * const html = safeHTML`<div class=\"user\">\n *   <h3>${name}</h3>\n *   <p>Age: ${age}</p>\n * </div>`;\n * // name is escaped, age is safe as-is\n * ```\n */\nexport function safeHTML(strings: TemplateStringsArray, ...values: unknown[]): string {\n  return strings.reduce((result, str, i) => {\n    const value = values[i];\n    const safeValue = value === undefined || value === null\n      ? ''\n      : typeof value === 'number' || typeof value === 'boolean'\n      ? String(value)\n      : escapeHTML(String(value));\n    return result + str + safeValue;\n  }, '');\n}\n\n/**\n * Sanitizes a URL to prevent javascript: protocol attacks.\n *\n * @param url - The URL to sanitize\n * @returns Safe URL or empty string if dangerous\n *\n * @example\n * ```typescript\n * const userUrl = 'javascript:alert(\"XSS\")';\n * const safe = sanitizeURL(userUrl);  // Returns ''\n *\n * const httpUrl = 'https://example.com';\n * const safe2 = sanitizeURL(httpUrl);  // Returns 'https://example.com'\n * ```\n */\nexport function sanitizeURL(url: string): string {\n  const trimmed = url.trim().toLowerCase();\n\n  // Block dangerous protocols\n  const dangerousProtocols = ['javascript:', 'data:', 'vbscript:', 'file:'];\n  for (const protocol of dangerousProtocols) {\n    if (trimmed.startsWith(protocol)) {\n      return '';\n    }\n  }\n\n  // Allow http(s), mailto, relative URLs\n  return url;\n}\n\n/**\n * Strips all HTML tags from a string, leaving only text.\n *\n * @param html - HTML string to strip\n * @returns Plain text without HTML tags\n *\n * @example\n * ```typescript\n * const html = '<p>Hello <strong>world</strong>!</p>';\n * const text = stripHTML(html);  // 'Hello world!'\n * ```\n */\nexport function stripHTML(html: string): string {\n  const div = document.createElement('div');\n  div.innerHTML = html;\n  return div.textContent || div.innerText || '';\n}\n","/**\n * ELI5 (Explain Like I'm 5) Tooltip System\n *\n * Provides beginner-friendly explanations for machine learning concepts.\n * Tooltips appear on hover and use simple analogies.\n */\n\nimport { safeHTML } from '../infrastructure/security/htmlSanitizer';\n\nexport interface TooltipContent {\n  title: string;\n  simple: string;\n  analogy?: string;\n  tip?: string;\n}\n\n/**\n * Collection of ELI5 explanations for ML concepts.\n */\nexport const ELI5_EXPLANATIONS: Record<string, TooltipContent> = {\n  // Hyperparameters\n  'learning-rate': {\n    title: 'Learning Rate',\n    simple: 'How big of steps the network takes when learning. Too big = overshoots, too small = takes forever.',\n    analogy: ' Like adjusting how far you jump when playing hot/cold. Big jumps find the area fast, but small steps find the exact spot.',\n    tip: 'Start with 0.01-0.1. If loss jumps around, go smaller. If it barely moves, go bigger.',\n  },\n  'layers': {\n    title: 'Hidden Layers',\n    simple: 'The \"thinking\" layers between input and output. More layers = can learn more complex patterns.',\n    analogy: ' Like having multiple people pass a message, each adding their interpretation.',\n    tip: 'Start with 1-2 layers of 4-8 neurons. Add more only if needed.',\n  },\n  'neurons': {\n    title: 'Neurons per Layer',\n    simple: 'How many \"detectors\" in each layer. More neurons = can detect more features.',\n    analogy: ' Like having more eyes looking at different parts of a picture.',\n    tip: 'Usually 2-4x the input size. Too many can cause overfitting.',\n  },\n  'epochs': {\n    title: 'Epochs',\n    simple: 'How many times the network sees all the training data.',\n    analogy: ' Like re-reading a textbook. First read = get the gist. More reads = deeper understanding.',\n    tip: 'Watch the loss curve. Stop when it flattens or validation loss rises.',\n  },\n  'batch-size': {\n    title: 'Batch Size',\n    simple: 'How many examples to look at before updating. Smaller = noisier but faster learning.',\n    analogy: ' Like deciding how many pizza slices to taste before judging the whole pizza.',\n    tip: 'Try 16-64. Smaller batches add noise that can help escape bad spots.',\n  },\n  \n  // Activations\n  'activation-relu': {\n    title: 'ReLU Activation',\n    simple: 'Keeps positive values, zeros out negatives. Simple and fast.',\n    analogy: ' Like a one-way valve that only lets positive signals through.',\n    tip: 'Default choice for hidden layers. Fast and works well most of the time.',\n  },\n  'activation-sigmoid': {\n    title: 'Sigmoid Activation',\n    simple: 'Squashes values between 0 and 1. Good for probabilities.',\n    analogy: ' Like a dimmer switch that smoothly goes from off (0) to on (1).',\n    tip: 'Use for binary classification output. Can cause \"vanishing gradients\" in deep networks.',\n  },\n  'activation-tanh': {\n    title: 'Tanh Activation',\n    simple: 'Squashes values between -1 and 1. Centered around zero.',\n    analogy: ' Like a balance scale that tips left (-1) or right (+1).',\n    tip: 'Good when you need negative outputs. Often works better than sigmoid in hidden layers.',\n  },\n  'activation-softmax': {\n    title: 'Softmax Activation',\n    simple: 'Converts scores to probabilities that sum to 1. Used for multi-class output.',\n    analogy: ' Like dividing a pie so all slices add up to 100%.',\n    tip: 'Always use for multi-class classification output layer.',\n  },\n  \n  // Optimizers\n  'optimizer-sgd': {\n    title: 'SGD (Stochastic Gradient Descent)',\n    simple: 'The classic optimizer. Simple but can be slow.',\n    analogy: ' Like walking downhill by always stepping in the steepest direction.',\n    tip: 'Good baseline. Add momentum to speed it up.',\n  },\n  'optimizer-adam': {\n    title: 'Adam Optimizer',\n    simple: 'Smart optimizer that adapts learning rate for each parameter.',\n    analogy: ' Like a car with automatic transmission that adjusts speed for the terrain.',\n    tip: 'Usually the best default choice. Works well out of the box.',\n  },\n  'optimizer-rmsprop': {\n    title: 'RMSprop Optimizer',\n    simple: 'Adapts learning rate based on recent gradients. Good for noisy data.',\n    analogy: ' Like adjusting volume based on how loud the recent notes were.',\n    tip: 'Good for recurrent networks and noisy problems.',\n  },\n  \n  // Regularization\n  'dropout': {\n    title: 'Dropout',\n    simple: 'Randomly \"turns off\" neurons during training. Prevents over-reliance on any single neuron.',\n    analogy: ' Like training a team where random members sit out each practice, so everyone learns to contribute.',\n    tip: 'Try 0.1-0.5. Higher values = stronger regularization.',\n  },\n  'l1-regularization': {\n    title: 'L1 Regularization (Lasso)',\n    simple: 'Pushes small weights to exactly zero. Creates sparse networks.',\n    analogy: ' Like a strict editor who cuts unnecessary words entirely.',\n    tip: 'Good for feature selection. Makes some weights exactly 0.',\n  },\n  'l2-regularization': {\n    title: 'L2 Regularization (Ridge)',\n    simple: 'Keeps weights small but not zero. Prevents any weight from dominating.',\n    analogy: ' Like a fair teacher who makes sure no student does all the work.',\n    tip: 'Most common choice. Try 0.001-0.01.',\n  },\n  'batch-norm': {\n    title: 'Batch Normalization',\n    simple: 'Normalizes layer inputs. Helps training be faster and more stable.',\n    analogy: ' Like making sure everyone uses the same units before comparing.',\n    tip: 'Usually helps. Can sometimes hurt with very small batches.',\n  },\n  \n  // Training concepts\n  'loss': {\n    title: 'Loss',\n    simple: 'How wrong the network is. Lower = better. The goal is to minimize this.',\n    analogy: ' Like the distance from the bullseye. Training tries to get closer.',\n    tip: 'Watch for: decreasing = good, stuck = try different settings, increasing = problem!',\n  },\n  'accuracy': {\n    title: 'Accuracy',\n    simple: 'Percentage of correct predictions. Higher = better.',\n    analogy: ' Like your test score. 90% = got 9 out of 10 right.',\n    tip: 'Good for balanced datasets. Can be misleading if classes are imbalanced.',\n  },\n  'overfitting': {\n    title: 'Overfitting',\n    simple: 'Network memorizes training data instead of learning patterns. Works great on training, fails on new data.',\n    analogy: ' Like memorizing answers instead of understanding the subject.',\n    tip: 'Signs: train accuracy >> validation accuracy. Fix: more data, dropout, regularization.',\n  },\n  'underfitting': {\n    title: 'Underfitting',\n    simple: 'Network is too simple to learn the pattern. Bad on both training and new data.',\n    analogy: ' Like using a hammer for everything. Sometimes you need more tools.',\n    tip: 'Signs: both train and val accuracy are low. Fix: more layers, more neurons, train longer.',\n  },\n  'validation-split': {\n    title: 'Validation Split',\n    simple: 'Portion of data held back to test how well the model generalizes.',\n    analogy: ' Like saving some practice problems to test yourself before the real exam.',\n    tip: 'Usually 10-20%. Helps detect overfitting early.',\n  },\n  \n  // Datasets\n  'dataset-circle': {\n    title: 'Circle Dataset',\n    simple: 'Points inside vs outside a circle. Tests if network can learn curved boundaries.',\n    analogy: ' Like separating darts that hit the bullseye from those that missed.',\n    tip: 'Simple dataset. Good for testing basic setups.',\n  },\n  'dataset-xor': {\n    title: 'XOR Dataset',\n    simple: 'Classic problem that requires at least one hidden layer to solve.',\n    analogy: ' Like \"opposite corners are friends\" - needs non-linear thinking.',\n    tip: 'If your network can\\'t solve this, something is wrong with the setup.',\n  },\n  'dataset-spiral': {\n    title: 'Spiral Dataset',\n    simple: 'Intertwined spirals. Very hard! Requires deep networks.',\n    analogy: ' Like separating two tangled phone cords by color.',\n    tip: 'Needs multiple layers and many neurons. Great for testing network capacity.',\n  },\n  'dataset-moons': {\n    title: 'Moons Dataset',\n    simple: 'Two interleaving half-circles. Moderately challenging.',\n    analogy: ' Like separating two crescent moons facing each other.',\n    tip: 'Good middle-ground difficulty. 1-2 hidden layers usually enough.',\n  },\n  \n  // Visualization\n  'decision-boundary': {\n    title: 'Decision Boundary',\n    simple: 'The line (or curve) where the network switches from predicting one class to another.',\n    analogy: ' Like borders on a map showing where one country ends and another begins.',\n    tip: 'Smooth = good generalization. Too wiggly = overfitting.',\n  },\n  'confusion-matrix': {\n    title: 'Confusion Matrix',\n    simple: 'Table showing what the model predicted vs what was actually true.',\n    analogy: ' Like a report card showing which questions you got right and which you confused.',\n    tip: 'Diagonal = correct. Off-diagonal = mistakes. Look for patterns in errors.',\n  },\n  'what-if': {\n    title: 'What-If Analysis',\n    simple: 'Tests different settings to see which works best for your data.',\n    analogy: ' Like trying different recipes to see which tastes best.',\n    tip: 'Run this before long training sessions to find optimal settings.',\n  },\n  'gradient-flow': {\n    title: 'Gradient Flow',\n    simple: 'Shows how much each layer is learning. Higher bars = more learning happening.',\n    analogy: ' Like a fitness tracker showing which muscles are working hardest.',\n    tip: 'If early layers have tiny gradients, you might have \"vanishing gradients\" - try ReLU or batch norm.',\n  },\n};\n\n/**\n * Creates and manages ELI5 tooltips.\n */\nexport class ELI5TooltipManager {\n  private tooltipElement: HTMLDivElement | null = null;\n  private hideTimeout: ReturnType<typeof setTimeout> | null = null;\n\n  constructor() {\n    this.createTooltipElement();\n    this.attachListeners();\n  }\n\n  /**\n   * Creates the tooltip DOM element.\n   */\n  private createTooltipElement(): void {\n    this.tooltipElement = document.createElement('div');\n    this.tooltipElement.id = 'eli5-tooltip';\n    this.tooltipElement.className = `\n      fixed z-[100] max-w-xs p-3 rounded-lg shadow-xl\n      bg-navy-800 border border-navy-600\n      text-sm text-slate-200\n      opacity-0 pointer-events-none\n      transition-opacity duration-200\n    `.replace(/\\s+/g, ' ').trim();\n    this.tooltipElement.style.display = 'none';\n    document.body.appendChild(this.tooltipElement);\n  }\n\n  /**\n   * Attaches hover listeners to elements with data-eli5 attribute.\n   */\n  private attachListeners(): void {\n    document.addEventListener('mouseover', (e) => {\n      const target = (e.target as HTMLElement).closest('[data-eli5]');\n      if (target) {\n        const key = target.getAttribute('data-eli5');\n        if (key && ELI5_EXPLANATIONS[key]) {\n          this.show(ELI5_EXPLANATIONS[key], target as HTMLElement);\n        }\n      }\n    });\n\n    document.addEventListener('mouseout', (e) => {\n      const target = (e.target as HTMLElement).closest('[data-eli5]');\n      if (target) {\n        this.scheduleHide();\n      }\n    });\n  }\n\n  /**\n   * Shows the tooltip near the target element.\n   */\n  private show(content: TooltipContent, target: HTMLElement): void {\n    if (!this.tooltipElement) return;\n\n    if (this.hideTimeout) {\n      clearTimeout(this.hideTimeout);\n      this.hideTimeout = null;\n    }\n\n    // Build tooltip content with XSS protection\n    let html = safeHTML`\n      <div class=\"font-semibold text-white mb-1\">${content.title}</div>\n      <div class=\"text-slate-300 mb-2\">${content.simple}</div>\n    `;\n\n    if (content.analogy) {\n      html += safeHTML`<div class=\"text-slate-400 text-xs mb-2\">${content.analogy}</div>`;\n    }\n\n    if (content.tip) {\n      html += safeHTML`<div class=\"text-emerald-400 text-xs\"> ${content.tip}</div>`;\n    }\n\n    this.tooltipElement.innerHTML = html;\n    this.tooltipElement.style.display = 'block';\n\n    // Position tooltip\n    const rect = target.getBoundingClientRect();\n    const tooltipRect = this.tooltipElement.getBoundingClientRect();\n\n    let left = rect.left + rect.width / 2 - tooltipRect.width / 2;\n    let top = rect.bottom + 8;\n\n    // Keep within viewport\n    if (left < 8) left = 8;\n    if (left + tooltipRect.width > window.innerWidth - 8) {\n      left = window.innerWidth - tooltipRect.width - 8;\n    }\n    if (top + tooltipRect.height > window.innerHeight - 8) {\n      top = rect.top - tooltipRect.height - 8;\n    }\n\n    this.tooltipElement.style.left = `${left}px`;\n    this.tooltipElement.style.top = `${top}px`;\n    this.tooltipElement.style.opacity = '1';\n  }\n\n  /**\n   * Schedules hiding the tooltip.\n   */\n  private scheduleHide(): void {\n    this.hideTimeout = setTimeout(() => {\n      this.hide();\n    }, 150);\n  }\n\n  /**\n   * Hides the tooltip.\n   */\n  private hide(): void {\n    if (!this.tooltipElement) return;\n    this.tooltipElement.style.opacity = '0';\n    setTimeout(() => {\n      if (this.tooltipElement) {\n        this.tooltipElement.style.display = 'none';\n      }\n    }, 200);\n  }\n}\n\n/**\n * Initializes the ELI5 tooltip system.\n */\nexport function initELI5Tooltips(): ELI5TooltipManager {\n  return new ELI5TooltipManager();\n}\n","/**\n * Suggested Fixes System\n *\n * Provides actionable recommendations based on training metrics and patterns.\n * Integrates with the existing fit analysis system.\n */\n\nimport { safeHTML, escapeAttribute } from '../infrastructure/security/htmlSanitizer';\n\nexport interface TrainingMetrics {\n  epoch: number;\n  trainLoss: number;\n  valLoss: number | null;\n  trainAccuracy: number;\n  valAccuracy: number | null;\n  learningRate: number;\n  lossHistory: number[];\n  valLossHistory: number[];\n}\n\nexport interface Suggestion {\n  id: string;\n  type: 'warning' | 'info' | 'success' | 'error';\n  title: string;\n  message: string;\n  action?: {\n    label: string;\n    handler: string; // Function name to call\n    params?: Record<string, unknown>;\n  };\n}\n\nexport interface DiagnosisResult {\n  status: 'healthy' | 'overfitting' | 'underfitting' | 'unstable' | 'stuck' | 'diverging';\n  confidence: number;\n  suggestions: Suggestion[];\n}\n\n/**\n * Analyzes training metrics and provides actionable suggestions.\n */\nexport function diagnoseTraining(metrics: TrainingMetrics): DiagnosisResult {\n  const suggestions: Suggestion[] = [];\n  let status: DiagnosisResult['status'] = 'healthy';\n  let confidence = 0;\n\n  const { epoch, trainLoss, valLoss, trainAccuracy, valAccuracy, lossHistory, valLossHistory } = metrics;\n\n  // Need at least some epochs to diagnose\n  if (epoch < 5) {\n    return { status: 'healthy', confidence: 0, suggestions: [] };\n  }\n\n  // Check for diverging loss (NaN or very high)\n  if (isNaN(trainLoss) || trainLoss > 100) {\n    status = 'diverging';\n    confidence = 1.0;\n    suggestions.push({\n      id: 'diverging-loss',\n      type: 'error',\n      title: 'Training Diverged',\n      message: 'Loss has exploded. This usually means the learning rate is too high.',\n      action: {\n        label: 'Reduce LR to 0.001',\n        handler: 'setLearningRate',\n        params: { value: 0.001 },\n      },\n    });\n    suggestions.push({\n      id: 'diverging-reset',\n      type: 'info',\n      title: 'Reset Recommended',\n      message: 'Reset the network and try again with lower learning rate.',\n      action: {\n        label: 'Reset Network',\n        handler: 'resetNetwork',\n      },\n    });\n    return { status, confidence, suggestions };\n  }\n\n  // Check for stuck training (loss not decreasing)\n  if (lossHistory.length >= 20) {\n    const recent = lossHistory.slice(-10);\n    const earlier = lossHistory.slice(-20, -10);\n    const recentAvg = recent.reduce((a, b) => a + b, 0) / recent.length;\n    const earlierAvg = earlier.reduce((a, b) => a + b, 0) / earlier.length;\n    const improvement = (earlierAvg - recentAvg) / earlierAvg;\n\n    if (improvement < 0.01 && trainAccuracy < 0.9) {\n      status = 'stuck';\n      confidence = 0.8;\n      suggestions.push({\n        id: 'stuck-lr',\n        type: 'warning',\n        title: 'Training Stuck',\n        message: 'Loss hasn\\'t improved in 20 epochs. Try increasing the learning rate.',\n        action: {\n          label: 'Increase LR 3x',\n          handler: 'multiplyLearningRate',\n          params: { factor: 3 },\n        },\n      });\n      suggestions.push({\n        id: 'stuck-capacity',\n        type: 'info',\n        title: 'Add Capacity',\n        message: 'The network might be too simple. Try adding more neurons.',\n        action: {\n          label: 'Add Layer',\n          handler: 'addHiddenLayer',\n        },\n      });\n    }\n  }\n\n  // Check for unstable training (oscillating loss)\n  if (lossHistory.length >= 10) {\n    const recent = lossHistory.slice(-10);\n    let oscillations = 0;\n    for (let i = 1; i < recent.length - 1; i++) {\n      const prev = recent[i - 1] ?? 0;\n      const curr = recent[i] ?? 0;\n      const next = recent[i + 1] ?? 0;\n      if ((curr > prev && curr > next) || (curr < prev && curr < next)) {\n        oscillations++;\n      }\n    }\n    if (oscillations >= 6) {\n      status = 'unstable';\n      confidence = 0.7;\n      suggestions.push({\n        id: 'unstable-lr',\n        type: 'warning',\n        title: 'Unstable Training',\n        message: 'Loss is oscillating. The learning rate might be too high.',\n        action: {\n          label: 'Reduce LR by half',\n          handler: 'multiplyLearningRate',\n          params: { factor: 0.5 },\n        },\n      });\n      suggestions.push({\n        id: 'unstable-batch',\n        type: 'info',\n        title: 'Increase Batch Size',\n        message: 'Larger batches can stabilize training.',\n        action: {\n          label: 'Set Batch Size 32',\n          handler: 'setBatchSize',\n          params: { value: 32 },\n        },\n      });\n    }\n  }\n\n  // Check for overfitting\n  if (valLoss !== null && valAccuracy !== null && valLossHistory.length >= 10) {\n    const recentValLoss = valLossHistory.slice(-5);\n    const valLossIncreasing = recentValLoss.every((v, i) =>\n      i === 0 || v >= (recentValLoss[i - 1] ?? 0) * 0.98\n    );\n    const trainValGap = trainAccuracy - valAccuracy;\n\n    if ((valLossIncreasing && trainValGap > 0.1) || trainValGap > 0.15) {\n      status = 'overfitting';\n      confidence = Math.min(trainValGap * 5, 1.0);\n      suggestions.push({\n        id: 'overfit-dropout',\n        type: 'warning',\n        title: 'Overfitting Detected',\n        message: `Training accuracy (${(trainAccuracy * 100).toFixed(0)}%) is much higher than validation (${(valAccuracy * 100).toFixed(0)}%).`,\n        action: {\n          label: 'Add Dropout 0.2',\n          handler: 'setDropout',\n          params: { value: 0.2 },\n        },\n      });\n      suggestions.push({\n        id: 'overfit-l2',\n        type: 'info',\n        title: 'Add Regularization',\n        message: 'L2 regularization can help prevent overfitting.',\n        action: {\n          label: 'Set L2 = 0.01',\n          handler: 'setL2',\n          params: { value: 0.01 },\n        },\n      });\n      suggestions.push({\n        id: 'overfit-stop',\n        type: 'info',\n        title: 'Early Stopping',\n        message: 'Consider stopping training now to prevent further overfitting.',\n        action: {\n          label: 'Stop Training',\n          handler: 'stopTraining',\n        },\n      });\n    }\n  }\n\n  // Check for underfitting\n  if (epoch >= 50 && trainAccuracy < 0.7) {\n    status = 'underfitting';\n    confidence = 1 - trainAccuracy;\n    suggestions.push({\n      id: 'underfit-capacity',\n      type: 'warning',\n      title: 'Underfitting',\n      message: `Training accuracy is only ${(trainAccuracy * 100).toFixed(0)}% after ${epoch} epochs.`,\n      action: {\n        label: 'Double Layer Size',\n        handler: 'doubleLayerSize',\n      },\n    });\n    suggestions.push({\n      id: 'underfit-lr',\n      type: 'info',\n      title: 'Increase Learning Rate',\n      message: 'A higher learning rate might help learn faster.',\n      action: {\n        label: 'Increase LR 2x',\n        handler: 'multiplyLearningRate',\n        params: { factor: 2 },\n      },\n    });\n    suggestions.push({\n      id: 'underfit-epochs',\n      type: 'info',\n      title: 'Train Longer',\n      message: 'The model might need more epochs to converge.',\n    });\n  }\n\n  // Good training - provide positive feedback\n  if (status === 'healthy' && trainAccuracy > 0.9) {\n    if (valAccuracy !== null && valAccuracy > 0.85) {\n      suggestions.push({\n        id: 'healthy-good',\n        type: 'success',\n        title: 'Training Well!',\n        message: `Great results! Train: ${(trainAccuracy * 100).toFixed(0)}%, Val: ${(valAccuracy * 100).toFixed(0)}%`,\n      });\n    } else if (valAccuracy === null) {\n      suggestions.push({\n        id: 'healthy-no-val',\n        type: 'info',\n        title: 'Consider Validation',\n        message: 'Enable validation split to detect overfitting.',\n        action: {\n          label: 'Enable 20% Val Split',\n          handler: 'setValSplit',\n          params: { value: 0.2 },\n        },\n      });\n    }\n  }\n\n  return { status, confidence, suggestions };\n}\n\n/**\n * Formats suggestions as HTML for display.\n */\nexport function formatSuggestionsHTML(suggestions: Suggestion[]): string {\n  if (suggestions.length === 0) return '';\n\n  return suggestions.map(s => {\n    const typeColors = {\n      warning: 'bg-amber-900/30 border-amber-700/50 text-amber-300',\n      info: 'bg-blue-900/30 border-blue-700/50 text-blue-300',\n      success: 'bg-emerald-900/30 border-emerald-700/50 text-emerald-300',\n      error: 'bg-red-900/30 border-red-700/50 text-red-300',\n    };\n\n    const icons = {\n      warning: '',\n      info: '',\n      success: '',\n      error: '',\n    };\n\n    let html = safeHTML`\n      <div class=\"p-2 rounded border ${typeColors[s.type]} mb-2\">\n        <div class=\"font-medium text-sm\">${icons[s.type]} ${s.title}</div>\n        <div class=\"text-xs mt-1 opacity-80\">${s.message}</div>\n    `;\n\n    if (s.action) {\n      const handler = escapeAttribute(s.action.handler);\n      const params = escapeAttribute(JSON.stringify(s.action.params ?? {}));\n      html += safeHTML`\n        <button\n          class=\"mt-2 px-2 py-1 text-xs rounded bg-white/10 hover:bg-white/20 transition-colors\"\n          data-suggestion-action=\"${handler}\"\n          data-suggestion-params='${params}'\n        >\n          ${s.action.label}\n        </button>\n      `;\n    }\n\n    html += '</div>';\n    return html;\n  }).join('');\n}\n\n/**\n * Dismisses the suggestions panel.\n */\nexport function dismissSuggestions(containerId: string): void {\n  const container = document.getElementById(containerId);\n  if (container) {\n    container.innerHTML = '';\n    container.classList.add('hidden');\n  }\n}\n\n/**\n * Resets the dismissal state of suggestions (if any).\n */\nexport function resetSuggestionsDismissal(containerId: string): void {\n  const container = document.getElementById(containerId);\n  if (container) {\n    container.classList.remove('hidden');\n  }\n}\n","import { TrainingSession } from '../../core/application/TrainingSession';\nimport { D3Chart } from '../../infrastructure/d3/D3Chart';\nimport { toast } from '../toast';\nimport { Point, MULTI_CLASS_COLOURS } from '../../core/domain';\nimport { PreprocessingType } from '../../core/ports';\n\nexport interface DatasetElements {\n  datasetSelect: HTMLSelectElement;\n  btnLoadData: HTMLButtonElement;\n  loadingOverlay: HTMLDivElement;\n  drawControls: HTMLDivElement;\n  btnClearCustom: HTMLButtonElement;\n  datasetOptions: HTMLDivElement;\n  inputSamples: HTMLInputElement;\n  samplesValue: HTMLSpanElement;\n  inputNoise: HTMLInputElement;\n  noiseValue: HTMLSpanElement;\n  inputBalance: HTMLInputElement;\n  balanceValue: HTMLSpanElement;\n  inputPreprocessing: HTMLSelectElement;\n  inputNumClasses: HTMLSelectElement;\n  drawClassButtons: HTMLDivElement;\n  inputCsvUpload: HTMLInputElement;\n  btnDownloadDataset: HTMLButtonElement;\n}\n\nexport class DatasetController {\n  private customDataPoints: Point[] = [];\n  private currentDrawLabel: number = 0;\n  private boundHandlers = new Map<string, EventListener>();\n\n  constructor(\n    private session: TrainingSession,\n    private visualizerService: D3Chart,\n    private elements: DatasetElements\n  ) {\n    this.bindEvents();\n  }\n\n  private bindEvents(): void {\n    const loadDataHandler = (): void => void this.handleLoadData();\n    const datasetChangeHandler = (): void => this.handleDatasetSelectChange();\n    const clearCustomHandler = (): void => this.handleClearCustomData();\n    const samplesChangeHandler = (): void => this.handleSamplesChange();\n    const noiseChangeHandler = (): void => this.handleNoiseChange();\n    const csvUploadHandler = (e: Event): void => this.handleCsvUpload(e);\n    const downloadHandler = (): void => this.handleDownloadDataset();\n\n    this.elements.btnLoadData.addEventListener('click', loadDataHandler);\n    this.elements.datasetSelect.addEventListener('change', datasetChangeHandler);\n    this.elements.btnClearCustom.addEventListener('click', clearCustomHandler);\n    this.elements.inputSamples.addEventListener('input', samplesChangeHandler);\n    this.elements.inputNoise.addEventListener('input', noiseChangeHandler);\n    this.elements.inputCsvUpload.addEventListener('change', csvUploadHandler);\n    this.elements.btnDownloadDataset.addEventListener('click', downloadHandler);\n\n    this.boundHandlers.set('loadData', loadDataHandler);\n    this.boundHandlers.set('datasetChange', datasetChangeHandler);\n    this.boundHandlers.set('clearCustom', clearCustomHandler);\n    this.boundHandlers.set('samplesChange', samplesChangeHandler);\n    this.boundHandlers.set('noiseChange', noiseChangeHandler);\n    this.boundHandlers.set('csvUpload', csvUploadHandler);\n    this.boundHandlers.set('download', downloadHandler);\n  }\n\n  /**\n   * Clean up event listeners to prevent memory leaks\n   */\n  public dispose(): void {\n    this.elements.btnLoadData.removeEventListener('click', this.boundHandlers.get('loadData')!);\n    this.elements.datasetSelect.removeEventListener('change', this.boundHandlers.get('datasetChange')!);\n    this.elements.btnClearCustom.removeEventListener('click', this.boundHandlers.get('clearCustom')!);\n    this.elements.inputSamples.removeEventListener('input', this.boundHandlers.get('samplesChange')!);\n    this.elements.inputNoise.removeEventListener('input', this.boundHandlers.get('noiseChange')!);\n    this.elements.inputCsvUpload.removeEventListener('change', this.boundHandlers.get('csvUpload')!);\n    this.elements.btnDownloadDataset.removeEventListener('click', this.boundHandlers.get('download')!);\n    this.boundHandlers.clear();\n  }\n\n  public async handleLoadData(): Promise<void> {\n    const datasetType = this.elements.datasetSelect.value;\n\n    // Handle custom dataset differently\n    if (datasetType === 'custom') {\n      this.customDataPoints = [];\n      this.visualizerService.renderData([]);\n      this.enableDrawMode();\n      return;\n    }\n\n    this.showLoading(true);\n    this.elements.btnLoadData.disabled = true;\n\n    // Real-world datasets have fixed parameters\n    const isRealWorld = datasetType === 'iris' || datasetType === 'wine';\n\n    // Get dataset options from sliders (ignored for real-world datasets)\n    const samples = parseInt(this.elements.inputSamples.value, 10) || 200;\n    const noise = (parseInt(this.elements.inputNoise.value, 10) || 10) / 100;\n    const numClasses = parseInt(this.elements.inputNumClasses.value, 10) || 2;\n    const classBalance = (parseInt(this.elements.inputBalance.value, 10) || 50) / 100;\n    const preprocessing = this.elements.inputPreprocessing.value as PreprocessingType;\n\n    try {\n      await this.session.loadData(datasetType, { samples, noise, numClasses, classBalance, preprocessing });\n\n      if (isRealWorld) {\n        const datasetInfo = datasetType === 'iris'\n          ? 'Iris (150 samples, 3 classes)'\n          : 'Wine (178 samples, 3 classes)';\n        toast.success(`${datasetInfo} loaded`);\n        // Update numClasses to 3 for real-world datasets\n        this.elements.inputNumClasses.value = '3';\n        this.updateDrawClassButtons();\n      } else {\n        toast.success(`Dataset \"${datasetType}\" loaded (${samples} samples, ${numClasses} classes)`);\n      }\n\n      // Update visualization\n      this.visualizerService.renderData(this.session.getData());\n\n      // Disable draw mode\n      this.visualizerService.disableDrawMode();\n      this.elements.drawControls.classList.add('hidden');\n\n    } catch (error) {\n      console.error('Failed to load dataset:', error);\n      toast.error(`Failed to load dataset: ${error instanceof Error ? error.message : 'Unknown error'}`);\n    } finally {\n      this.showLoading(false);\n      this.elements.btnLoadData.disabled = false;\n    }\n  }\n\n  private handleDatasetSelectChange(): void {\n    const datasetType = this.elements.datasetSelect.value;\n    const isCustom = datasetType === 'custom';\n    const isRealWorld = datasetType === 'iris' || datasetType === 'wine';\n\n    // Toggle visibility of controls\n    if (isCustom) {\n      this.elements.drawControls.classList.remove('hidden');\n      this.elements.datasetOptions.classList.add('hidden');\n      this.updateDrawClassButtons();\n      this.enableDrawMode();\n    } else {\n      this.elements.drawControls.classList.add('hidden');\n      this.elements.datasetOptions.classList.remove('hidden');\n      this.visualizerService.disableDrawMode();\n\n      // Disable options for real-world datasets\n      if (isRealWorld) {\n        this.elements.datasetOptions.classList.add('opacity-50', 'pointer-events-none');\n      } else {\n        this.elements.datasetOptions.classList.remove('opacity-50', 'pointer-events-none');\n      }\n    }\n  }\n\n  private handleClearCustomData(): void {\n    this.customDataPoints = [];\n    this.visualizerService.renderData([]);\n    this.session.setCustomData([]);\n    toast.info('Custom data cleared');\n  }\n\n  private handleSamplesChange(): void {\n    this.elements.samplesValue.textContent = this.elements.inputSamples.value;\n  }\n\n  private handleNoiseChange(): void {\n    this.elements.noiseValue.textContent = this.elements.inputNoise.value;\n  }\n\n  private enableDrawMode(): void {\n    this.visualizerService.enableDrawMode(this.currentDrawLabel, (point) => this.handlePointAdded(point));\n    toast.info('Draw mode enabled - click on chart to add points');\n  }\n\n  private handlePointAdded(point: Point): void {\n    this.customDataPoints.push(point);\n    this.visualizerService.renderData(this.customDataPoints);\n\n    // Update session with custom data\n    this.session.setCustomData(this.customDataPoints);\n  }\n\n  private updateDrawClassButtons(): void {\n    const numClasses = parseInt(this.elements.inputNumClasses.value, 10) || 2;\n\n    // Clear existing buttons\n    this.elements.drawClassButtons.innerHTML = '';\n\n    // Create buttons for each class\n    for (let i = 0; i < numClasses; i++) {\n      const colour = MULTI_CLASS_COLOURS[i % MULTI_CLASS_COLOURS.length];\n      const button = document.createElement('button');\n      button.className = `btn-draw${i === 0 ? ' active' : ''}`;\n      button.dataset.class = String(i);\n      button.innerHTML = `\n        <span class=\"w-3 h-3 rounded-full inline-block\" style=\"background-color: ${colour}\"></span>\n        Class ${i}\n      `;\n      button.addEventListener('click', () => this.handleDrawClassSelect(i));\n      this.elements.drawClassButtons.appendChild(button);\n    }\n\n    // Reset to class 0\n    this.currentDrawLabel = 0;\n  }\n\n  private handleDrawClassSelect(label: number): void {\n    this.currentDrawLabel = label;\n\n    // Update button states\n    const buttons = this.elements.drawClassButtons.querySelectorAll('.btn-draw');\n    buttons.forEach((btn, index) => {\n      btn.classList.toggle('active', index === label);\n    });\n\n    // Update draw mode with new label\n    if (this.visualizerService.isDrawModeEnabled()) {\n      this.visualizerService.enableDrawMode(label, (point) => this.handlePointAdded(point));\n    }\n  }\n\n  private showLoading(show: boolean): void {\n    if (show) {\n      this.elements.loadingOverlay.classList.remove('hidden');\n    } else {\n      this.elements.loadingOverlay.classList.add('hidden');\n    }\n  }\n\n  // CSV Upload & Download\n\n  private handleCsvUpload(event: Event): void {\n    const input = event.target as HTMLInputElement;\n    if (!input.files || input.files.length === 0) return;\n\n    const file = input.files[0];\n    if (!file) return;\n    const reader = new FileReader();\n\n    reader.onload = (e) => {\n      const text = e.target?.result as string;\n      if (!text) return;\n\n      try {\n        const points = this.parseCsvData(text);\n        if (points.length === 0) {\n          throw new Error('No valid data points found in CSV');\n        }\n\n        this.customDataPoints = points;\n        this.session.setCustomData(points);\n        this.visualizerService.renderData(points);\n\n        // Switch to custom mode\n        this.elements.datasetSelect.value = 'custom';\n        this.handleDatasetSelectChange();\n\n        toast.success(`Loaded ${points.length} points from CSV`);\n      } catch (error) {\n        console.error('CSV Parse Error:', error);\n        toast.error('Failed to parse CSV file. Check format (x,y,label)');\n      }\n\n      // Reset input\n      input.value = '';\n    };\n\n    reader.readAsText(file);\n  }\n\n  private parseCsvData(text: string): Point[] {\n    const lines = text.split('\\n');\n    const points: Point[] = [];\n\n    // Check for header\n    let startIndex = 0;\n    if (lines[0] && (lines[0].toLowerCase().includes('x') || lines[0].toLowerCase().includes('label'))) {\n      startIndex = 1;\n    }\n\n    for (let i = startIndex; i < lines.length; i++) {\n      const line = lines[i]!.trim();\n      if (!line) continue;\n\n      const parts = line.split(',');\n      if (parts.length < 3) continue;\n\n      // Try to detect format: x,y,label OR label,x,y\n      let x: number, y: number, label: number;\n\n      if (parts.length === 3) {\n        // Assume x,y,label\n        x = parseFloat(parts[0]!);\n        y = parseFloat(parts[1]!);\n        label = parseInt(parts[2]!, 10);\n\n        // If label is NaN, maybe it's label,x,y?\n        if (isNaN(label) && !isNaN(parseFloat(parts[0]!))) {\n          // Try label,x,y\n          label = parseInt(parts[0]!, 10);\n          x = parseFloat(parts[1]!);\n          y = parseFloat(parts[2]!);\n        }\n      } else {\n        // Default to x,y,label\n        x = parseFloat(parts[0]!);\n        y = parseFloat(parts[1]!);\n        label = parseInt(parts[parts.length - 1]!, 10);\n      }\n\n      if (!isNaN(x) && !isNaN(y) && !isNaN(label)) {\n        points.push({ x, y, label });\n      }\n    }\n\n    return points;\n  }\n\n  private handleDownloadDataset(): void {\n    const data = this.session.getData();\n    if (data.length === 0) {\n      toast.warning('No dataset to download');\n      return;\n    }\n\n    let csvContent = 'x,y,label\\n';\n    data.forEach(p => {\n      csvContent += `${p.x.toFixed(6)},${p.y.toFixed(6)},${p.label}\\n`;\n    });\n\n    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });\n    const url = URL.createObjectURL(blob);\n    const link = document.createElement('a');\n    link.setAttribute('href', url);\n    link.setAttribute('download', 'neuroviz_dataset.csv');\n    link.style.visibility = 'hidden';\n    document.body.appendChild(link);\n    link.click();\n    document.body.removeChild(link);\n  }\n}\n","import { TrainingSession } from '../../core/application/TrainingSession';\nimport { toast } from '../toast';\nimport { Hyperparameters, OptimizerType, ActivationType, LRScheduleType } from '../../core/domain';\nimport { TrainingState } from '../../core/application/ITrainingSession';\nimport { resetSuggestionsDismissal } from '../SuggestedFixes';\n\nexport interface TrainingElements {\n    inputLr: HTMLInputElement;\n    inputLayers: HTMLInputElement;\n    inputOptimizer: HTMLSelectElement;\n    inputMomentum: HTMLInputElement;\n    momentumValue: HTMLSpanElement;\n    momentumControl: HTMLDivElement;\n    inputActivation: HTMLSelectElement;\n    inputL1: HTMLInputElement;\n    inputL2: HTMLInputElement;\n    inputNumClasses: HTMLSelectElement;\n    inputDropout: HTMLSelectElement;\n    inputClipNorm: HTMLSelectElement;\n    inputBatchNorm: HTMLInputElement;\n    inputLayerActivations: HTMLInputElement;\n    btnInit: HTMLButtonElement;\n\n    inputBatchSize: HTMLInputElement;\n    inputMaxEpochs: HTMLInputElement;\n    inputFps: HTMLInputElement;\n    fpsValue: HTMLSpanElement;\n    inputLrSchedule: HTMLSelectElement;\n    inputWarmup: HTMLInputElement;\n    inputCycleLength: HTMLInputElement;\n    inputMinLr: HTMLInputElement;\n    inputEarlyStop: HTMLInputElement;\n    cyclicLrControls: HTMLDivElement;\n    inputValSplit: HTMLSelectElement;\n    inputTargetFps: HTMLSelectElement; // Added\n\n    btnStart: HTMLButtonElement;\n    btnPause: HTMLButtonElement;\n    btnStep: HTMLButtonElement;\n    btnReset: HTMLButtonElement;\n\n    // Sticky footer controls\n    btnStartSticky: HTMLButtonElement;\n    btnPauseSticky: HTMLButtonElement;\n    btnStepSticky: HTMLButtonElement;\n    btnResetSticky: HTMLButtonElement;\n\n    // Mobile FAB\n    fabStart: HTMLButtonElement;\n    fabPause: HTMLButtonElement;\n\n    // UI Updates\n    epochValue: HTMLElement;\n    lossValue: HTMLElement;\n    accuracyValue: HTMLElement;\n    valLossValue: HTMLElement;\n    valAccuracyValue: HTMLElement;\n    stateDisplay: HTMLElement;\n    suggestionsPanel: HTMLDivElement;\n    suggestionsList: HTMLDivElement;\n}\n\nexport class TrainingController {\n    constructor(\n        private session: TrainingSession,\n        private elements: TrainingElements,\n        private callbacks: {\n            onNetworkUpdate: () => void;\n            onClearVisualization: () => void;\n            onDismissSuggestions: () => void;\n        }\n    ) {\n        this.bindEvents();\n    }\n\n    private bindEvents(): void {\n        this.elements.btnInit.addEventListener('click', () => void this.handleInitialise());\n\n        // Training controls\n        this.elements.btnStart.addEventListener('click', () => this.handleStart());\n        this.elements.btnPause.addEventListener('click', () => this.handlePause());\n        this.elements.btnStep.addEventListener('click', () => void this.handleStep());\n        this.elements.btnReset.addEventListener('click', () => this.handleReset());\n\n        // Sticky footer controls\n        this.elements.btnStartSticky.addEventListener('click', () => this.handleStart());\n        this.elements.btnPauseSticky.addEventListener('click', () => this.handlePause());\n        this.elements.btnStepSticky.addEventListener('click', () => void this.handleStep());\n        this.elements.btnResetSticky.addEventListener('click', () => this.handleReset());\n\n        // Mobile FAB\n        this.elements.fabStart.addEventListener('click', () => this.handleStart());\n        this.elements.fabPause.addEventListener('click', () => this.handlePause());\n\n        // Config changes\n        this.elements.inputLrSchedule.addEventListener('change', () => this.handleLrScheduleChange());\n        this.elements.inputFps.addEventListener('input', () => this.handleFpsChange());\n        this.elements.inputBatchSize.addEventListener('change', () => this.handleBatchSizeChange());\n        this.elements.inputMaxEpochs.addEventListener('change', () => this.handleMaxEpochsChange());\n        this.elements.inputValSplit.addEventListener('change', () => this.handleValSplitChange());\n        this.elements.inputTargetFps.addEventListener('change', () => this.handleFpsChange());\n\n        // Optimizer change to toggle momentum\n        this.elements.inputOptimizer.addEventListener('change', () => {\n            if (this.elements.inputOptimizer.value === 'sgd') {\n                this.elements.momentumControl.classList.remove('hidden');\n            } else {\n                this.elements.momentumControl.classList.add('hidden');\n            }\n        });\n\n        this.elements.inputMomentum.addEventListener('input', () => {\n            this.elements.momentumValue.textContent = this.elements.inputMomentum.value;\n        });\n    }\n\n    public async handleInitialise(): Promise<void> {\n        const learningRate = parseFloat(this.elements.inputLr.value);\n\n        if (isNaN(learningRate) || learningRate <= 0) {\n            toast.warning('Please enter a valid learning rate (positive number).');\n            return;\n        }\n\n        let layers: number[];\n        try {\n            layers = this.parseLayersInput(this.elements.inputLayers.value);\n        } catch (error) {\n            toast.warning(error instanceof Error ? error.message : 'Invalid layer configuration');\n            return;\n        }\n\n        const optimizer = this.elements.inputOptimizer.value as OptimizerType;\n        const momentum = parseFloat(this.elements.inputMomentum.value) || 0.9;\n        const activation = this.elements.inputActivation.value as ActivationType;\n        const l1Regularization = parseFloat(this.elements.inputL1.value) || 0;\n        const l2Regularization = parseFloat(this.elements.inputL2.value) || 0;\n        const numClasses = parseInt(this.elements.inputNumClasses.value, 10) || 2;\n        const dropoutRate = parseFloat(this.elements.inputDropout.value) || 0;\n        const clipNorm = parseFloat(this.elements.inputClipNorm.value) || 0;\n        const batchNorm = this.elements.inputBatchNorm.checked;\n\n        // Parse per-layer activations (optional)\n        const layerActivations = this.parseLayerActivations(this.elements.inputLayerActivations.value);\n\n        const config: Hyperparameters = {\n            learningRate,\n            layers,\n            optimizer,\n            momentum,\n            activation,\n            layerActivations: layerActivations.length > 0 ? layerActivations : undefined,\n            l1Regularization,\n            l2Regularization,\n            numClasses,\n            dropoutRate,\n            clipNorm,\n            batchNorm,\n        };\n\n        this.elements.btnInit.disabled = true;\n        this.elements.btnInit.textContent = 'Initialising...';\n\n        try {\n            await this.session.setHyperparameters(config);\n\n            // Apply training config\n            this.applyTrainingConfig();\n\n            // Update network diagram\n            this.callbacks.onNetworkUpdate();\n\n            toast.success(`Network initialized with ${optimizer.toUpperCase()} optimizer!`);\n        } catch (error) {\n            console.error('Failed to initialise network:', error);\n            toast.error(\n                `Failed to initialise network: ${error instanceof Error ? error.message : 'Unknown error'}`\n            );\n        } finally {\n            this.elements.btnInit.disabled = false;\n            this.elements.btnInit.textContent = 'Initialise Network';\n        }\n    }\n\n    public applyTrainingConfig(): void {\n        const batchSize = parseInt(this.elements.inputBatchSize.value, 10) || 0;\n        const maxEpochs = parseInt(this.elements.inputMaxEpochs.value, 10) || 0;\n        const targetFps = parseInt(this.elements.inputFps.value, 10) || 60;\n        const lrScheduleType = this.elements.inputLrSchedule.value as LRScheduleType;\n        const warmupEpochs = parseInt(this.elements.inputWarmup.value, 10) || 0;\n        const cycleLength = parseInt(this.elements.inputCycleLength.value, 10) || 20;\n        const minLR = parseFloat(this.elements.inputMinLr.value) || 0.001;\n        const earlyStoppingPatience = parseInt(this.elements.inputEarlyStop.value, 10) || 0;\n\n        this.session.setTrainingConfig({\n            batchSize,\n            maxEpochs,\n            targetFps,\n            lrSchedule: {\n                type: lrScheduleType,\n                decayRate: 0.95,\n                decaySteps: 10,\n                warmupEpochs,\n                cycleLength,\n                minLR,\n            },\n            earlyStoppingPatience,\n        });\n    }\n\n    private handleLrScheduleChange(): void {\n        const scheduleType = this.elements.inputLrSchedule.value;\n        const isCyclic = scheduleType === 'cyclic_triangular' || scheduleType === 'cyclic_cosine';\n\n        if (isCyclic) {\n            this.elements.cyclicLrControls.classList.remove('hidden');\n        } else {\n            this.elements.cyclicLrControls.classList.add('hidden');\n        }\n\n        this.applyTrainingConfig();\n    }\n\n    private handleFpsChange(): void {\n        const fps = parseInt(this.elements.inputFps.value, 10) || 60;\n        this.elements.fpsValue.textContent = fps.toString();\n        this.session.setTrainingConfig({ targetFps: fps });\n    }\n\n    private handleBatchSizeChange(): void {\n        const batchSize = parseInt(this.elements.inputBatchSize.value, 10) || 0;\n        this.session.setTrainingConfig({ batchSize });\n    }\n\n    private handleMaxEpochsChange(): void {\n        const maxEpochs = parseInt(this.elements.inputMaxEpochs.value, 10) || 0;\n        this.session.setTrainingConfig({ maxEpochs });\n    }\n\n    private handleValSplitChange(): void {\n        const split = parseInt(this.elements.inputValSplit.value, 10);\n        this.session.setTrainingConfig({ validationSplit: split / 100 });\n    }\n\n    public handleStart(): void {\n        try {\n            resetSuggestionsDismissal('suggestions-panel');\n            this.session.start();\n        } catch (error) {\n            console.error('Failed to start training:', error);\n            toast.error(`Failed to start: ${error instanceof Error ? error.message : 'Unknown error'}`);\n        }\n    }\n\n    public handlePause(): void {\n        this.session.pause();\n    }\n\n    public async handleStep(): Promise<void> {\n        // Guard against rapid clicks while processing\n        if (this.elements.btnStep.disabled) {\n            return;\n        }\n\n        this.elements.btnStep.disabled = true;\n\n        try {\n            await this.session.step();\n            // Wait a frame for state notification to complete\n            await new Promise((resolve) => requestAnimationFrame(resolve));\n        } catch (error) {\n            console.error('Step failed:', error);\n            toast.error(`Step failed: ${error instanceof Error ? error.message : 'Unknown error'}`);\n        } finally {\n            // Re-enable only if state is valid for stepping\n            const state = this.session.getState();\n            this.elements.btnStep.disabled = !state.isInitialised || !state.datasetLoaded || state.isRunning;\n        }\n    }\n\n    public handleReset(): void {\n        this.session.reset();\n        this.callbacks.onClearVisualization();\n        this.callbacks.onDismissSuggestions();\n    }\n\n    public updateUI(state: TrainingState): void {\n        this.elements.epochValue.textContent = state.currentEpoch.toString();\n        this.elements.lossValue.textContent = state.currentLoss?.toFixed(4) ?? '';\n        this.elements.accuracyValue.textContent = state.currentAccuracy ? `${(state.currentAccuracy * 100).toFixed(1)}%` : '';\n        this.elements.valLossValue.textContent = state.currentValLoss?.toFixed(4) ?? '';\n        this.elements.valAccuracyValue.textContent = state.currentValAccuracy ? `${(state.currentValAccuracy * 100).toFixed(1)}%` : '';\n\n        // Update status display text\n        let statusText = 'Idle';\n        if (state.isRunning && !state.isPaused) {\n            statusText = 'Training';\n        } else if (state.isPaused) {\n            statusText = 'Paused';\n        } else if (state.isInitialised && state.datasetLoaded) {\n            statusText = 'Ready';\n        }\n        this.elements.stateDisplay.textContent = statusText;\n\n        // Determine if training can be started (or resumed from pause)\n        const canStart = state.isInitialised && state.datasetLoaded && (!state.isRunning || state.isPaused);\n\n        // Update button states\n        if (state.isRunning && !state.isPaused) {\n            // Training is running - show Pause, hide Start\n            this.elements.btnStart.classList.add('hidden');\n            this.elements.btnPause.classList.remove('hidden');\n            this.elements.btnPause.disabled = false;\n            this.elements.btnStep.disabled = true;\n\n            this.elements.btnStartSticky.classList.add('hidden');\n            this.elements.btnPauseSticky.classList.remove('hidden');\n            this.elements.btnPauseSticky.disabled = false;\n            this.elements.btnStepSticky.disabled = true;\n\n            this.elements.fabStart.classList.add('hidden');\n            this.elements.fabPause.classList.remove('hidden');\n        } else {\n            // Training is paused or stopped - show Start, hide Pause\n            this.elements.btnStart.classList.remove('hidden');\n            this.elements.btnPause.classList.add('hidden');\n            this.elements.btnPause.disabled = true;\n            this.elements.btnStep.disabled = !canStart;\n\n            this.elements.btnStartSticky.classList.remove('hidden');\n            this.elements.btnPauseSticky.classList.add('hidden');\n            this.elements.btnPauseSticky.disabled = true;\n            this.elements.btnStepSticky.disabled = !canStart;\n\n            this.elements.fabStart.classList.remove('hidden');\n            this.elements.fabPause.classList.add('hidden');\n        }\n\n        // Enable Reset button if initialized and not running (or paused)\n        const canReset = state.isInitialised && (!state.isRunning || state.isPaused);\n        this.elements.btnReset.disabled = !canReset;\n        this.elements.btnResetSticky.disabled = !canReset;\n\n        // Enable/disable Start buttons based on readiness\n        this.elements.btnStart.disabled = !canStart;\n        this.elements.btnStartSticky.disabled = !canStart;\n        this.elements.fabStart.classList.toggle('opacity-50', !canStart);\n        this.elements.fabStart.classList.toggle('pointer-events-none', !canStart);\n    }\n\n    private parseLayersInput(input: string): number[] {\n        return input.split(',')\n            .map(s => parseInt(s.trim(), 10))\n            .filter(n => !isNaN(n) && n > 0);\n    }\n\n    private parseLayerActivations(input: string): ActivationType[] {\n        if (!input || input.trim() === '') return [];\n\n        const validActivations: ActivationType[] = ['linear', 'relu', 'sigmoid', 'tanh', 'leaky_relu', 'elu', 'selu', 'softmax'];\n\n        return input.split(',')\n            .map(s => s.trim().toLowerCase() as ActivationType)\n            .filter(a => validActivations.includes(a));\n    }\n}\n","/**\n * D3 Gradient Flow Visualization\n * \n * Visualizes gradient magnitudes flowing through the network during backpropagation.\n * Shows which connections are learning the most.\n */\n\nimport * as d3 from 'd3';\n\nexport interface GradientData {\n  /** Gradient magnitudes per layer [layer][neuron] */\n  layerGradients: number[][];\n  /** Layer names */\n  layerNames: string[];\n  /** Max gradient value for scaling */\n  maxGradient: number;\n}\n\n/**\n * Renders gradient flow visualization as animated bars.\n */\nexport class D3GradientFlow {\n  private svg: d3.Selection<SVGSVGElement, unknown, null, undefined>;\n  private width: number;\n  private height: number;\n  private margin = { top: 20, right: 20, bottom: 30, left: 40 };\n\n  constructor(container: HTMLElement) {\n    // Clear existing content\n    d3.select(container).selectAll('*').remove();\n\n    const rect = container.getBoundingClientRect();\n    this.width = rect.width || 300;\n    this.height = rect.height || 150;\n\n    this.svg = d3.select(container)\n      .append('svg')\n      .attr('width', '100%')\n      .attr('height', '100%')\n      .attr('viewBox', `0 0 ${this.width} ${this.height}`)\n      .attr('preserveAspectRatio', 'xMidYMid meet')\n      .attr('class', 'gradient-flow-chart');\n  }\n\n  /**\n   * Renders the gradient flow visualization.\n   */\n  render(data: GradientData): void {\n    const { layerGradients, layerNames, maxGradient } = data;\n    \n    if (layerGradients.length === 0) return;\n\n    const innerWidth = this.width - this.margin.left - this.margin.right;\n    const innerHeight = this.height - this.margin.top - this.margin.bottom;\n\n    // Clear previous content\n    this.svg.selectAll('*').remove();\n\n    const g = this.svg.append('g')\n      .attr('transform', `translate(${this.margin.left},${this.margin.top})`);\n\n    // X scale for layers\n    const xScale = d3.scaleBand()\n      .domain(layerNames)\n      .range([0, innerWidth])\n      .padding(0.2);\n\n    // Y scale for gradient magnitude\n    const yScale = d3.scaleLinear()\n      .domain([0, maxGradient > 0 ? maxGradient : 1])\n      .range([innerHeight, 0]);\n\n    // Color scale (blue = low, red = high)\n    const colorScale = d3.scaleSequential(d3.interpolateYlOrRd)\n      .domain([0, maxGradient > 0 ? maxGradient : 1]);\n\n    // Draw bars for each layer\n    layerGradients.forEach((gradients, layerIdx) => {\n      const layerName = layerNames[layerIdx] ?? `L${layerIdx}`;\n      const barWidth = (xScale.bandwidth() ?? 20) / Math.max(gradients.length, 1);\n      const xOffset = xScale(layerName) ?? 0;\n\n      gradients.forEach((grad, neuronIdx) => {\n        const x = xOffset + neuronIdx * barWidth;\n        const barHeight = innerHeight - yScale(grad);\n\n        // Bar\n        g.append('rect')\n          .attr('x', x)\n          .attr('y', yScale(grad))\n          .attr('width', Math.max(barWidth - 1, 2))\n          .attr('height', barHeight)\n          .attr('fill', colorScale(grad))\n          .attr('opacity', 0.8)\n          .attr('rx', 1);\n\n        // Animated pulse for high gradients\n        if (grad > maxGradient * 0.7) {\n          g.append('rect')\n            .attr('x', x)\n            .attr('y', yScale(grad))\n            .attr('width', Math.max(barWidth - 1, 2))\n            .attr('height', barHeight)\n            .attr('fill', 'none')\n            .attr('stroke', '#fff')\n            .attr('stroke-width', 1)\n            .attr('opacity', 0)\n            .attr('rx', 1)\n            .transition()\n            .duration(500)\n            .attr('opacity', 0.5)\n            .transition()\n            .duration(500)\n            .attr('opacity', 0);\n        }\n      });\n    });\n\n    // X axis\n    g.append('g')\n      .attr('transform', `translate(0,${innerHeight})`)\n      .call(d3.axisBottom(xScale))\n      .selectAll('text')\n      .attr('fill', '#94a3b8')\n      .attr('font-size', '10px');\n\n    // Y axis\n    g.append('g')\n      .call(d3.axisLeft(yScale).ticks(4).tickFormat(d3.format('.2f')))\n      .selectAll('text')\n      .attr('fill', '#94a3b8')\n      .attr('font-size', '10px');\n\n    // Title\n    this.svg.append('text')\n      .attr('x', this.width / 2)\n      .attr('y', 12)\n      .attr('text-anchor', 'middle')\n      .attr('fill', '#94a3b8')\n      .attr('font-size', '11px')\n      .text('Gradient Magnitudes by Layer');\n\n    // Legend\n    const legendWidth = 80;\n    const legendHeight = 10;\n    const legendX = this.width - legendWidth - 10;\n    const legendY = 5;\n\n    // Gradient bar\n    const defs = this.svg.append('defs');\n    const gradient = defs.append('linearGradient')\n      .attr('id', 'gradient-legend')\n      .attr('x1', '0%')\n      .attr('x2', '100%');\n\n    gradient.append('stop')\n      .attr('offset', '0%')\n      .attr('stop-color', colorScale(0));\n    gradient.append('stop')\n      .attr('offset', '100%')\n      .attr('stop-color', colorScale(maxGradient));\n\n    this.svg.append('rect')\n      .attr('x', legendX)\n      .attr('y', legendY)\n      .attr('width', legendWidth)\n      .attr('height', legendHeight)\n      .attr('fill', 'url(#gradient-legend)')\n      .attr('rx', 2);\n  }\n\n  /**\n   * Clears the visualization.\n   */\n  clear(): void {\n    this.svg.selectAll('*').remove();\n  }\n}\n\n/**\n * Simulates gradient data from weight changes between epochs.\n * In a real implementation, this would come from TensorFlow.js gradient tapes.\n */\nexport function estimateGradients(\n  previousWeights: number[][][],\n  currentWeights: number[][][],\n  learningRate: number\n): GradientData {\n  const layerGradients: number[][] = [];\n  let maxGradient = 0;\n\n  for (let layer = 0; layer < currentWeights.length; layer++) {\n    const prevLayer = previousWeights[layer] ?? [];\n    const currLayer = currentWeights[layer] ?? [];\n    const gradients: number[] = [];\n\n    // Calculate gradient magnitude for each output neuron\n    const numOutputs = currLayer[0]?.length ?? 0;\n    for (let out = 0; out < numOutputs; out++) {\n      let sumSquaredDiff = 0;\n      const numInputs = currLayer.length;\n      \n      for (let inp = 0; inp < numInputs; inp++) {\n        const prev = prevLayer[inp]?.[out] ?? 0;\n        const curr = currLayer[inp]?.[out] ?? 0;\n        const diff = (curr - prev) / learningRate; // Approximate gradient\n        sumSquaredDiff += diff * diff;\n      }\n      \n      const gradMagnitude = Math.sqrt(sumSquaredDiff / numInputs);\n      gradients.push(gradMagnitude);\n      maxGradient = Math.max(maxGradient, gradMagnitude);\n    }\n\n    layerGradients.push(gradients);\n  }\n\n  const layerNames = layerGradients.map((_, i) => \n    i === 0 ? 'InputH1' : \n    i === layerGradients.length - 1 ? `H${i}Out` : \n    `H${i}H${i + 1}`\n  );\n\n  return { layerGradients, layerNames, maxGradient };\n}\n","import * as d3 from 'd3';\n\n/**\n * D3-based neuron activation heatmap visualization.\n * Shows real-time activations for each neuron across layers.\n */\nexport class D3ActivationHeatmap {\n  private svg: d3.Selection<SVGSVGElement, unknown, null, undefined>;\n  private width: number;\n  private height: number;\n  private margin = { top: 20, right: 10, bottom: 20, left: 40 };\n\n  // Colour scale for activations\n  private colorScale = d3.scaleSequential(d3.interpolateViridis).domain([0, 1]);\n\n  constructor(container: HTMLElement) {\n    const rect = container.getBoundingClientRect();\n    this.width = rect.width || 300;\n    this.height = rect.height || 100;\n\n    // Clear existing content\n    d3.select(container).selectAll('*').remove();\n\n    this.svg = d3.select(container)\n      .append('svg')\n      .attr('width', '100%')\n      .attr('height', '100%')\n      .attr('viewBox', `0 0 ${this.width} ${this.height}`)\n      .attr('preserveAspectRatio', 'xMidYMid meet');\n  }\n\n  /**\n   * Renders the activation heatmap.\n   * @param activations - Array of activation arrays per layer\n   * @param layerNames - Optional names for each layer\n   */\n  render(activations: number[][], layerNames?: string[]): void {\n    if (activations.length === 0) return;\n\n    const innerWidth = this.width - this.margin.left - this.margin.right;\n    const innerHeight = this.height - this.margin.top - this.margin.bottom;\n\n    // Clear previous content\n    this.svg.selectAll('*').remove();\n\n    const g = this.svg.append('g')\n      .attr('transform', `translate(${this.margin.left},${this.margin.top})`);\n\n    // Calculate cell dimensions\n    const numLayers = activations.length;\n    const maxNeurons = Math.max(...activations.map(a => a.length));\n    const cellWidth = innerWidth / numLayers;\n    const cellHeight = Math.min(innerHeight / maxNeurons, 15);\n\n    // Draw cells for each layer\n    activations.forEach((layerActivations, layerIndex) => {\n      const layerGroup = g.append('g')\n        .attr('transform', `translate(${layerIndex * cellWidth}, 0)`);\n\n      // Center neurons vertically\n      const layerHeight = layerActivations.length * cellHeight;\n      const yOffset = (innerHeight - layerHeight) / 2;\n\n      layerActivations.forEach((activation, neuronIndex) => {\n        // Normalize activation to [0, 1] for colour mapping\n        const normalizedActivation = Math.max(0, Math.min(1, activation));\n\n        layerGroup.append('rect')\n          .attr('x', 2)\n          .attr('y', yOffset + neuronIndex * cellHeight)\n          .attr('width', cellWidth - 4)\n          .attr('height', cellHeight - 2)\n          .attr('rx', 2)\n          .attr('fill', this.colorScale(normalizedActivation))\n          .attr('stroke', 'var(--border-color)')\n          .attr('stroke-width', 0.5)\n          .append('title')\n          .text(`Layer ${layerIndex + 1}, Neuron ${neuronIndex + 1}: ${activation.toFixed(4)}`);\n      });\n\n      // Add layer label\n      const label = layerNames?.[layerIndex] ?? `L${layerIndex + 1}`;\n      layerGroup.append('text')\n        .attr('x', cellWidth / 2)\n        .attr('y', innerHeight + 12)\n        .attr('text-anchor', 'middle')\n        .attr('fill', 'var(--text-secondary)')\n        .attr('font-size', '8px')\n        .text(label);\n    });\n\n    // Add colour scale legend\n    const legendWidth = 60;\n    const legendHeight = 8;\n    const legendX = innerWidth - legendWidth;\n    const legendY = -15;\n\n    const legendScale = d3.scaleLinear()\n      .domain([0, 1])\n      .range([0, legendWidth]);\n\n    const legendAxis = d3.axisBottom(legendScale)\n      .ticks(3)\n      .tickSize(3);\n\n    const legend = g.append('g')\n      .attr('transform', `translate(${legendX}, ${legendY})`);\n\n    // Gradient\n    const defs = this.svg.append('defs');\n    const gradient = defs.append('linearGradient')\n      .attr('id', 'activation-gradient')\n      .attr('x1', '0%')\n      .attr('x2', '100%');\n\n    gradient.append('stop')\n      .attr('offset', '0%')\n      .attr('stop-color', this.colorScale(0));\n\n    gradient.append('stop')\n      .attr('offset', '100%')\n      .attr('stop-color', this.colorScale(1));\n\n    legend.append('rect')\n      .attr('width', legendWidth)\n      .attr('height', legendHeight)\n      .attr('fill', 'url(#activation-gradient)');\n\n    legend.append('g')\n      .attr('transform', `translate(0, ${legendHeight})`)\n      .call(legendAxis)\n      .selectAll('text')\n      .attr('fill', 'var(--text-muted)')\n      .attr('font-size', '6px');\n\n    legend.selectAll('.domain, .tick line')\n      .attr('stroke', 'var(--text-muted)');\n  }\n\n  /**\n   * Clears the heatmap.\n   */\n  clear(): void {\n    this.svg.selectAll('*').remove();\n  }\n}\n","import { TrainingSession } from '../../core/application/TrainingSession';\nimport { D3Chart } from '../../infrastructure/d3/D3Chart';\nimport { D3GradientFlow, estimateGradients } from '../../infrastructure/d3/D3GradientFlow';\nimport { D3ActivationHeatmap } from '../../infrastructure/d3/D3ActivationHeatmap';\nimport { TFNeuralNet } from '../../infrastructure/tensorflow/TFNeuralNet';\nimport { toast } from '../toast';\nimport { Point, ColourScheme } from '../../core/domain';\nimport { APP_CONFIG } from '../../config/app.config';\nimport type { ThreeVisualization, Prediction3D, Point3D } from '../../infrastructure/three';\n\nexport interface VisualizationElements {\n    inputColourScheme: HTMLSelectElement;\n    inputPointSize: HTMLInputElement;\n    inputOpacity: HTMLInputElement;\n    opacityValue: HTMLSpanElement;\n    inputContours: HTMLInputElement;\n    contourValue: HTMLSpanElement;\n    inputZoom: HTMLInputElement;\n    inputTooltips: HTMLInputElement;\n    inputHighlightErrors: HTMLInputElement;\n    inputConfidenceCircles: HTMLInputElement;\n    inputNotifications: HTMLInputElement;\n    inputRecordEvolution: HTMLInputElement;\n    inputShowGrid: HTMLInputElement;\n    inputShowDiscretized: HTMLInputElement;\n    inputVoronoi: HTMLInputElement;\n    inputMisclassified: HTMLInputElement;\n    inputConfidence: HTMLInputElement;\n\n    // Charts\n    gradientFlowChart: HTMLDivElement;\n    // activationHeatmap: HTMLDivElement; // Removed duplicate\n    confusionMatrix: HTMLDivElement;\n    weightHistogram: HTMLDivElement;\n    rocCurve: HTMLDivElement;\n\n    // 3D View (Optional - if not present, 3D features disabled)\n    input3dView?: HTMLInputElement;\n    threeContainer?: HTMLDivElement;\n    btn3dReset?: HTMLButtonElement;\n    btn3dTop?: HTMLButtonElement;\n    btn3dSide?: HTMLButtonElement;\n\n    // Gradient Flow (Optional)\n    inputShowGradients?: HTMLInputElement;\n    gradientFlowContainer?: HTMLDivElement;\n    inputLr?: HTMLInputElement;\n\n    // Activation Heatmap (Optional)\n    inputShowActivations?: HTMLInputElement;\n    activationHeatmap?: HTMLDivElement;\n    activationHint?: HTMLParagraphElement;\n    inputLayers?: HTMLInputElement;\n}\n\nexport class VisualizationController {\n    private gradientFlow: D3GradientFlow | null = null;\n    private activationHeatmap: D3ActivationHeatmap | null = null;\n    private threeViz: ThreeVisualization | null = null;\n    private previousWeights: number[][][] = [];\n\n    constructor(\n        private session: TrainingSession,\n        private neuralNetService: TFNeuralNet,\n        private visualizerService: D3Chart,\n        private elements: VisualizationElements\n    ) {\n        this.bindEvents();\n    }\n\n    private bindEvents(): void {\n        this.elements.inputColourScheme.addEventListener('change', () => this.handleColourSchemeChange());\n        this.elements.inputPointSize.addEventListener('change', () => this.handlePointSizeChange());\n        this.elements.inputOpacity.addEventListener('input', () => this.handleOpacityChange());\n        this.elements.inputContours.addEventListener('input', () => this.handleContourChange());\n        this.elements.inputZoom.addEventListener('change', () => this.handleZoomToggle());\n        this.elements.inputTooltips.addEventListener('change', () => this.handleTooltipsToggle());\n\n        // 3D View\n        if (this.elements.input3dView) {\n            this.elements.input3dView.addEventListener('change', () => void this.handle3dViewToggle());\n        }\n        if (this.elements.btn3dReset) {\n            this.elements.btn3dReset.addEventListener('click', () => this.threeViz?.resetCamera());\n        }\n        if (this.elements.btn3dTop) {\n            this.elements.btn3dTop.addEventListener('click', () => this.threeViz?.setTopView());\n        }\n        if (this.elements.btn3dSide) {\n            this.elements.btn3dSide.addEventListener('click', () => this.threeViz?.setSideView());\n        }\n\n        // Gradient Flow\n        if (this.elements.inputShowGradients) {\n            this.elements.inputShowGradients.addEventListener('change', () => this.handleGradientToggle());\n        }\n\n        // Activation Heatmap\n        if (this.elements.inputShowActivations) {\n            this.elements.inputShowActivations.addEventListener('change', () => this.handleActivationToggle());\n        }\n    }\n\n    private handleColourSchemeChange(): void {\n        const scheme = this.elements.inputColourScheme.value as ColourScheme;\n        this.visualizerService.setConfig({ colourScheme: scheme });\n    }\n\n    private handlePointSizeChange(): void {\n        const size = parseInt(this.elements.inputPointSize.value, 10) || 5;\n        this.visualizerService.setConfig({ pointRadius: size });\n    }\n\n    private handleOpacityChange(): void {\n        const opacity = parseInt(this.elements.inputOpacity.value, 10) / 100;\n        this.elements.opacityValue.textContent = this.elements.inputOpacity.value;\n        this.visualizerService.setConfig({ boundaryOpacity: opacity });\n    }\n\n    private handleContourChange(): void {\n        const count = parseInt(this.elements.inputContours.value, 10);\n        this.elements.contourValue.textContent = this.elements.inputContours.value;\n        this.visualizerService.setConfig({ contourCount: count });\n    }\n\n    private handleZoomToggle(): void {\n        this.visualizerService.setConfig({ zoomEnabled: this.elements.inputZoom.checked });\n    }\n\n    private handleTooltipsToggle(): void {\n        this.visualizerService.setConfig({ tooltipsEnabled: this.elements.inputTooltips.checked });\n    }\n\n    public async handle3dViewToggle(): Promise<void> {\n        if (!this.elements.input3dView || !this.elements.threeContainer) return;\n\n        if (this.elements.input3dView.checked) {\n            this.elements.threeContainer.classList.remove('hidden');\n\n            // Lazy load Three.js\n            if (!this.threeViz) {\n                try {\n                    const { ThreeVisualization } = await import('../../infrastructure/three');\n                    this.threeViz = new ThreeVisualization(this.elements.threeContainer);\n                    toast.success('3D view enabled');\n                } catch (error) {\n                    console.error('Failed to load 3D visualization:', error);\n                    toast.error('Failed to load 3D visualization');\n                    this.elements.input3dView.checked = false;\n                    this.elements.threeContainer.classList.add('hidden');\n                    return;\n                }\n            }\n\n            // Update 3D view with current data\n            await this.update3dView();\n        } else {\n            this.elements.threeContainer.classList.add('hidden');\n        }\n    }\n\n    public async update3dView(): Promise<void> {\n        if (!this.threeViz || !this.elements.input3dView?.checked) return;\n\n        const state = this.session.getState();\n        if (!state.isInitialised || !state.datasetLoaded) return;\n\n        try {\n            // Get predictions for grid\n            const gridSize = APP_CONFIG.visualization.gridSize;\n            const gridPoints: Point[] = [];\n\n            for (let i = 0; i < gridSize; i++) {\n                for (let j = 0; j < gridSize; j++) {\n                    gridPoints.push({\n                        x: -1 + (2 * j) / (gridSize - 1),\n                        y: -1 + (2 * i) / (gridSize - 1),\n                        label: 0,\n                    });\n                }\n            }\n\n            const predictions = await this.neuralNetService.predict(gridPoints);\n\n            // Convert to 3D format\n            const predictions3d: Prediction3D[] = predictions.map(p => ({\n                x: p.x,\n                y: p.y,\n                confidence: p.confidence,\n                predictedClass: p.predictedClass,\n            }));\n\n            this.threeViz.renderSurface(predictions3d, gridSize);\n\n            // Render data points\n            const data = this.session.getData();\n            const points3d: Point3D[] = data.map(p => ({\n                x: p.x,\n                y: p.y,\n                label: p.label,\n            }));\n            this.threeViz.renderPoints(points3d);\n\n        } catch (error) {\n            console.error('Failed to update 3D view:', error);\n        }\n    }\n\n    private handleGradientToggle(): void {\n        if (!this.elements.inputShowGradients || !this.elements.gradientFlowContainer) return;\n\n        if (this.elements.inputShowGradients.checked) {\n            this.elements.gradientFlowContainer.classList.remove('hidden');\n            if (!this.gradientFlow) {\n                this.gradientFlow = new D3GradientFlow(this.elements.gradientFlowContainer);\n            }\n            // Store current weights as baseline\n            this.previousWeights = this.neuralNetService.getWeightMatrices();\n        } else {\n            this.elements.gradientFlowContainer.classList.add('hidden');\n        }\n    }\n\n    public updateGradientFlow(): void {\n        if (!this.elements.inputShowGradients?.checked || !this.gradientFlow) return;\n\n        const currentWeights = this.neuralNetService.getWeightMatrices();\n        if (this.previousWeights.length === 0 || currentWeights.length === 0) {\n            this.previousWeights = currentWeights;\n            return;\n        }\n\n        // Estimate gradients based on weight changes (simplified)\n        // In a real app, we'd get gradients from the backend/TF.js\n        const learningRate = this.session.getCurrentLearningRate();\n        const gradients = estimateGradients(this.previousWeights, currentWeights, learningRate);\n\n        this.gradientFlow.render(gradients);\n        this.previousWeights = currentWeights;\n    }\n\n    private handleActivationToggle(): void {\n        if (!this.elements.inputShowActivations || !this.elements.activationHeatmap) return;\n\n        if (this.elements.inputShowActivations.checked) {\n            this.elements.activationHeatmap.classList.remove('hidden');\n            if (this.elements.activationHint) {\n                this.elements.activationHint.classList.remove('hidden');\n            }\n\n            if (!this.activationHeatmap) {\n                this.activationHeatmap = new D3ActivationHeatmap(this.elements.activationHeatmap);\n            }\n\n            this.updateActivationHeatmap();\n        } else {\n            this.elements.activationHeatmap.classList.add('hidden');\n            if (this.elements.activationHint) {\n                this.elements.activationHint.classList.add('hidden');\n            }\n        }\n    }\n\n    public updateActivationHeatmap(): void {\n        if (!this.elements.inputShowActivations?.checked || !this.activationHeatmap) return;\n\n        const structure = this.neuralNetService.getStructure();\n        if (!structure) return;\n\n        // Visualize activations (simplified - using random data for demo if real not available)\n        // In real app, we'd hook into the forward pass\n        const activations = structure.layers.map((size, _i) => {\n            return Array(size).fill(0).map(() => Math.random());\n        });\n\n        this.activationHeatmap.render(activations);\n    }\n}\n","import type { Hyperparameters, LRScheduleConfig } from '../../core/domain';\n\n/**\n * Generates equivalent Keras/TensorFlow Python code for the current model configuration.\n */\nexport function generatePythonCode(\n  hyperparams: Hyperparameters,\n  lrSchedule?: LRScheduleConfig,\n  datasetInfo?: { samples: number; noise: number; datasetType: string }\n): string {\n  const lines: string[] = [];\n\n  // Imports\n  lines.push('\"\"\"');\n  lines.push('Neural Network Configuration - Generated by NeuroViz');\n  lines.push(`Generated: ${new Date().toISOString()}`);\n  lines.push('\"\"\"');\n  lines.push('');\n  lines.push('import numpy as np');\n  lines.push('import tensorflow as tf');\n  lines.push('from tensorflow import keras');\n  lines.push('from tensorflow.keras import layers, regularizers, optimizers');\n  lines.push('from tensorflow.keras.callbacks import EarlyStopping, LearningRateScheduler');\n  lines.push('from sklearn.datasets import make_circles, make_moons, make_blobs, make_classification');\n  lines.push('from sklearn.model_selection import train_test_split');\n  lines.push('from sklearn.preprocessing import StandardScaler');\n  lines.push('');\n\n  // Dataset generation\n  if (datasetInfo) {\n    lines.push('# Generate dataset');\n    lines.push(`n_samples = ${datasetInfo.samples}`);\n    lines.push(`noise = ${datasetInfo.noise}`);\n    lines.push('');\n\n    switch (datasetInfo.datasetType) {\n      case 'circle':\n        lines.push('X, y = make_circles(n_samples=n_samples, noise=noise, factor=0.5)');\n        break;\n      case 'xor':\n        lines.push('X, y = make_classification(n_samples=n_samples, n_features=2, n_redundant=0,');\n        lines.push('                           n_informative=2, n_clusters_per_class=1, flip_y=noise)');\n        break;\n      case 'spiral':\n        lines.push('# Spiral dataset');\n        lines.push('theta = np.sqrt(np.random.rand(n_samples // 2)) * 2 * np.pi');\n        lines.push('r_a = 2 * theta + np.pi');\n        lines.push('r_b = -2 * theta - np.pi');\n        lines.push('X = np.vstack([');\n        lines.push('    np.column_stack([r_a * np.cos(theta), r_a * np.sin(theta)]),');\n        lines.push('    np.column_stack([r_b * np.cos(theta), r_b * np.sin(theta)])');\n        lines.push(']) + np.random.randn(n_samples, 2) * noise');\n        lines.push('y = np.hstack([np.zeros(n_samples // 2), np.ones(n_samples // 2)])');\n        break;\n      case 'moons':\n        lines.push('X, y = make_moons(n_samples=n_samples, noise=noise)');\n        break;\n      case 'clusters':\n        lines.push(`X, y = make_blobs(n_samples=n_samples, centers=${hyperparams.numClasses}, cluster_std=noise * 2)`);\n        break;\n      default:\n        lines.push('X, y = make_circles(n_samples=n_samples, noise=noise, factor=0.5)');\n    }\n\n    lines.push('');\n    lines.push('# Normalize features');\n    lines.push('scaler = StandardScaler()');\n    lines.push('X = scaler.fit_transform(X)');\n    lines.push('');\n    lines.push('# Train/test split');\n    lines.push('X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42)');\n    lines.push('');\n  }\n\n  // Model definition\n  lines.push('# Build model');\n  lines.push('model = keras.Sequential([');\n\n  // Input layer\n  lines.push('    layers.Input(shape=(2,)),');\n\n  // Hidden layers\n  const layers_config = hyperparams.layers;\n  const defaultActivation = hyperparams.activation ?? 'relu';\n  const layerActivations = hyperparams.layerActivations ?? [];\n\n  for (let i = 0; i < layers_config.length; i++) {\n    const units = layers_config[i];\n    const activation = layerActivations[i] ?? defaultActivation;\n    \n    // Regularization\n    const regParts: string[] = [];\n    if (hyperparams.l1Regularization && hyperparams.l1Regularization > 0) {\n      regParts.push(`l1=${hyperparams.l1Regularization}`);\n    }\n    if (hyperparams.l2Regularization && hyperparams.l2Regularization > 0) {\n      regParts.push(`l2=${hyperparams.l2Regularization}`);\n    }\n    const regStr = regParts.length > 0 \n      ? `, kernel_regularizer=regularizers.L1L2(${regParts.join(', ')})` \n      : '';\n\n    lines.push(`    layers.Dense(${units}, activation='${activation}'${regStr}),`);\n\n    // Batch normalization\n    if (hyperparams.batchNorm) {\n      lines.push('    layers.BatchNormalization(),');\n    }\n\n    // Dropout\n    if (hyperparams.dropoutRate && hyperparams.dropoutRate > 0) {\n      lines.push(`    layers.Dropout(${hyperparams.dropoutRate}),`);\n    }\n  }\n\n  // Output layer\n  const numClasses = hyperparams.numClasses ?? 2;\n  if (numClasses === 2) {\n    lines.push(\"    layers.Dense(1, activation='sigmoid')\");\n  } else {\n    lines.push(`    layers.Dense(${numClasses}, activation='softmax')`);\n  }\n\n  lines.push('])');\n  lines.push('');\n\n  // Optimizer\n  lines.push('# Configure optimizer');\n  const lr = hyperparams.learningRate;\n  \n  switch (hyperparams.optimizer) {\n    case 'sgd': {\n      const momentum = hyperparams.momentum ?? 0.9;\n      lines.push(`optimizer = optimizers.SGD(learning_rate=${lr}, momentum=${momentum})`);\n      break;\n    }\n    case 'adam':\n      lines.push(`optimizer = optimizers.Adam(learning_rate=${lr})`);\n      break;\n    case 'rmsprop':\n      lines.push(`optimizer = optimizers.RMSprop(learning_rate=${lr})`);\n      break;\n    case 'adagrad':\n      lines.push(`optimizer = optimizers.Adagrad(learning_rate=${lr})`);\n      break;\n    default:\n      lines.push(`optimizer = optimizers.Adam(learning_rate=${lr})`);\n  }\n  lines.push('');\n\n  // Compile\n  lines.push('# Compile model');\n  if (numClasses === 2) {\n    lines.push(\"model.compile(optimizer=optimizer, loss='binary_crossentropy', metrics=['accuracy'])\");\n  } else {\n    lines.push(\"model.compile(optimizer=optimizer, loss='sparse_categorical_crossentropy', metrics=['accuracy'])\");\n  }\n  lines.push('');\n\n  // Learning rate schedule\n  if (lrSchedule && lrSchedule.type !== 'none') {\n    lines.push('# Learning rate schedule');\n    \n    switch (lrSchedule.type) {\n      case 'exponential':\n        lines.push(`def lr_schedule(epoch):\n    initial_lr = ${lr}\n    decay_rate = 0.95\n    return initial_lr * (decay_rate ** epoch)`);\n        break;\n      case 'step':\n        lines.push(`def lr_schedule(epoch):\n    initial_lr = ${lr}\n    drop_rate = 0.5\n    epochs_drop = 50\n    return initial_lr * (drop_rate ** (epoch // epochs_drop))`);\n        break;\n      case 'cosine':\n        lines.push(`def lr_schedule(epoch, total_epochs=500):\n    initial_lr = ${lr}\n    return initial_lr * 0.5 * (1 + np.cos(np.pi * epoch / total_epochs))`);\n        break;\n      case 'cyclic_triangular':\n        lines.push(`def lr_schedule(epoch):\n    initial_lr = ${lr}\n    min_lr = ${lrSchedule.minLR ?? 0.001}\n    cycle_length = ${lrSchedule.cycleLength ?? 20}\n    cycle_position = epoch % cycle_length\n    if cycle_position < cycle_length / 2:\n        return min_lr + (initial_lr - min_lr) * (2 * cycle_position / cycle_length)\n    else:\n        return initial_lr - (initial_lr - min_lr) * (2 * (cycle_position - cycle_length / 2) / cycle_length)`);\n        break;\n      default:\n        lines.push(`def lr_schedule(epoch):\n    return ${lr}`);\n    }\n    \n    lines.push('');\n    lines.push('lr_callback = LearningRateScheduler(lr_schedule)');\n    lines.push('');\n  }\n\n  // Callbacks\n  lines.push('# Callbacks');\n  lines.push('callbacks = [');\n  lines.push(\"    EarlyStopping(monitor='val_loss', patience=20, restore_best_weights=True),\");\n  if (lrSchedule && lrSchedule.type !== 'none') {\n    lines.push('    lr_callback,');\n  }\n  lines.push(']');\n  lines.push('');\n\n  // Training\n  lines.push('# Train model');\n  lines.push('history = model.fit(');\n  lines.push('    X_train, y_train,');\n  lines.push('    validation_data=(X_test, y_test),');\n  lines.push('    epochs=500,');\n  lines.push('    batch_size=32,');\n  lines.push('    callbacks=callbacks,');\n  lines.push('    verbose=1');\n  lines.push(')');\n  lines.push('');\n\n  // Evaluation\n  lines.push('# Evaluate');\n  lines.push('test_loss, test_acc = model.evaluate(X_test, y_test, verbose=0)');\n  lines.push(\"print(f'Test accuracy: {test_acc:.4f}')\");\n  lines.push('');\n\n  // Summary\n  lines.push('# Model summary');\n  lines.push('model.summary()');\n\n  return lines.join('\\n');\n}\n","/**\n * ONNX Export Utility\n * \n * Generates ONNX-compatible model representation from TensorFlow.js models.\n * Since TensorFlow.js doesn't have native ONNX export, this creates a JSON\n * representation that can be converted to ONNX using Python tools.\n */\n\nexport interface ONNXModelInfo {\n  /** ONNX opset version */\n  opsetVersion: number;\n  /** Model producer name */\n  producerName: string;\n  /** Model producer version */\n  producerVersion: string;\n  /** Input tensor info */\n  inputs: ONNXTensorInfo[];\n  /** Output tensor info */\n  outputs: ONNXTensorInfo[];\n  /** Network layers/nodes */\n  nodes: ONNXNode[];\n  /** Initializers (weights) */\n  initializers: ONNXInitializer[];\n}\n\nexport interface ONNXTensorInfo {\n  name: string;\n  shape: number[];\n  dataType: 'float32' | 'int64';\n}\n\nexport interface ONNXNode {\n  name: string;\n  opType: string;\n  inputs: string[];\n  outputs: string[];\n  attributes?: Record<string, unknown>;\n}\n\nexport interface ONNXInitializer {\n  name: string;\n  shape: number[];\n  data: number[];\n}\n\n/**\n * Generates ONNX model info from layer configuration and weights.\n * \n * @param layers - Array of layer sizes [input, hidden1, ..., output]\n * @param activations - Activation function per layer\n * @param weights - Weight matrices [layer][from][to]\n * @param biases - Bias vectors per layer\n * @returns ONNX model representation\n */\nexport function generateONNXModel(\n  layers: number[],\n  activations: string[],\n  weights: number[][][],\n  biases: number[][]\n): ONNXModelInfo {\n  const nodes: ONNXNode[] = [];\n  const initializers: ONNXInitializer[] = [];\n  \n  let currentInput = 'input';\n  \n  // Generate nodes for each layer\n  for (let i = 0; i < layers.length - 1; i++) {\n    const inputSize = layers[i] ?? 2;\n    const outputSize = layers[i + 1] ?? 1;\n    const layerWeights = weights[i] ?? [];\n    const layerBiases = biases[i] ?? [];\n    const activation = activations[i + 1] ?? 'relu';\n    \n    const weightName = `layer${i}_weight`;\n    const biasName = `layer${i}_bias`;\n    const matmulOutput = `layer${i}_matmul`;\n    const addOutput = `layer${i}_add`;\n    const activationOutput = i === layers.length - 2 ? 'output' : `layer${i}_activation`;\n    \n    // Add weight initializer (transposed for ONNX format)\n    const flatWeights: number[] = [];\n    for (let j = 0; j < outputSize; j++) {\n      for (let k = 0; k < inputSize; k++) {\n        flatWeights.push(layerWeights[k]?.[j] ?? 0);\n      }\n    }\n    \n    initializers.push({\n      name: weightName,\n      shape: [outputSize, inputSize],\n      data: flatWeights,\n    });\n    \n    // Add bias initializer\n    initializers.push({\n      name: biasName,\n      shape: [outputSize],\n      data: layerBiases.length > 0 ? layerBiases : Array(outputSize).fill(0),\n    });\n    \n    // MatMul node (Gemm in ONNX)\n    nodes.push({\n      name: `${matmulOutput}_node`,\n      opType: 'Gemm',\n      inputs: [currentInput, weightName, biasName],\n      outputs: [addOutput],\n      attributes: {\n        alpha: 1.0,\n        beta: 1.0,\n        transB: 1,\n      },\n    });\n    \n    // Activation node\n    const onnxActivation = mapActivationToONNX(activation);\n    if (onnxActivation !== 'Identity') {\n      nodes.push({\n        name: `${activationOutput}_node`,\n        opType: onnxActivation,\n        inputs: [addOutput],\n        outputs: [activationOutput],\n      });\n      currentInput = activationOutput;\n    } else {\n      currentInput = addOutput;\n    }\n  }\n  \n  return {\n    opsetVersion: 13,\n    producerName: 'NeuroViz',\n    producerVersion: '1.0.0',\n    inputs: [{\n      name: 'input',\n      shape: [-1, layers[0] ?? 2], // -1 for batch dimension\n      dataType: 'float32',\n    }],\n    outputs: [{\n      name: 'output',\n      shape: [-1, layers[layers.length - 1] ?? 1],\n      dataType: 'float32',\n    }],\n    nodes,\n    initializers,\n  };\n}\n\n/**\n * Maps TensorFlow.js activation names to ONNX operator types.\n */\nfunction mapActivationToONNX(activation: string): string {\n  switch (activation.toLowerCase()) {\n    case 'relu': return 'Relu';\n    case 'sigmoid': return 'Sigmoid';\n    case 'tanh': return 'Tanh';\n    case 'elu': return 'Elu';\n    case 'softmax': return 'Softmax';\n    case 'linear':\n    case 'none':\n    default: return 'Identity';\n  }\n}\n\n/**\n * Generates a Python script that creates an ONNX model from the exported data.\n * \n * @param modelInfo - ONNX model information\n * @returns Python script as string\n */\nexport function generateONNXPythonScript(modelInfo: ONNXModelInfo): string {\n  const inputShape = modelInfo.inputs[0]?.shape ?? [-1, 2];\n  const outputShape = modelInfo.outputs[0]?.shape ?? [-1, 1];\n  \n  return `\"\"\"\nONNX Model Generator\nGenerated by NeuroViz - https://github.com/your-repo/neuroviz\n\nThis script creates an ONNX model from the exported NeuroViz configuration.\nRequires: pip install onnx numpy\n\"\"\"\n\nimport numpy as np\nimport onnx\nfrom onnx import helper, TensorProto\n\n# Model metadata\nopset_version = ${modelInfo.opsetVersion}\nproducer_name = \"${modelInfo.producerName}\"\nproducer_version = \"${modelInfo.producerVersion}\"\n\n# Create initializers (weights and biases)\ninitializers = []\n${modelInfo.initializers.map(init => `\n# ${init.name}\n${init.name}_data = np.array(${JSON.stringify(init.data)}, dtype=np.float32).reshape(${JSON.stringify(init.shape)})\ninitializers.append(helper.make_tensor(\n    name=\"${init.name}\",\n    data_type=TensorProto.FLOAT,\n    dims=${JSON.stringify(init.shape)},\n    vals=${init.name}_data.flatten().tolist()\n))\n`).join('')}\n\n# Create nodes\nnodes = []\n${modelInfo.nodes.map(node => `\nnodes.append(helper.make_node(\n    \"${node.opType}\",\n    inputs=${JSON.stringify(node.inputs)},\n    outputs=${JSON.stringify(node.outputs)},\n    name=\"${node.name}\"${node.attributes ? `,\n    **${JSON.stringify(node.attributes)}` : ''}\n))\n`).join('')}\n\n# Create input/output\ninput_tensor = helper.make_tensor_value_info(\"input\", TensorProto.FLOAT, ${JSON.stringify(inputShape)})\noutput_tensor = helper.make_tensor_value_info(\"output\", TensorProto.FLOAT, ${JSON.stringify(outputShape)})\n\n# Create graph\ngraph = helper.make_graph(\n    nodes,\n    \"neuroviz_model\",\n    [input_tensor],\n    [output_tensor],\n    initializers\n)\n\n# Create model\nmodel = helper.make_model(graph, opset_imports=[helper.make_opsetid(\"\", opset_version)])\nmodel.producer_name = producer_name\nmodel.producer_version = producer_version\n\n# Validate and save\nonnx.checker.check_model(model)\nonnx.save(model, \"neuroviz_model.onnx\")\nprint(\"Model saved to neuroviz_model.onnx\")\n\n# Test inference (optional)\ntry:\n    import onnxruntime as ort\n    session = ort.InferenceSession(\"neuroviz_model.onnx\")\n    test_input = np.random.randn(1, ${inputShape[1] ?? 2}).astype(np.float32)\n    result = session.run(None, {\"input\": test_input})\n    print(f\"Test inference successful. Output shape: {result[0].shape}\")\nexcept ImportError:\n    print(\"Install onnxruntime to test inference: pip install onnxruntime\")\n`;\n}\n\n/**\n * Exports model info as downloadable JSON.\n */\nexport function downloadONNXJson(modelInfo: ONNXModelInfo, filename = 'neuroviz_model_onnx.json'): void {\n  const json = JSON.stringify(modelInfo, null, 2);\n  const blob = new Blob([json], { type: 'application/json' });\n  const url = URL.createObjectURL(blob);\n  \n  const a = document.createElement('a');\n  a.href = url;\n  a.download = filename;\n  a.click();\n  \n  URL.revokeObjectURL(url);\n}\n\n/**\n * Exports Python ONNX generator script.\n */\nexport function downloadONNXPythonScript(modelInfo: ONNXModelInfo, filename = 'generate_onnx.py'): void {\n  const script = generateONNXPythonScript(modelInfo);\n  const blob = new Blob([script], { type: 'text/x-python' });\n  const url = URL.createObjectURL(blob);\n  \n  const a = document.createElement('a');\n  a.href = url;\n  a.download = filename;\n  a.click();\n  \n  URL.revokeObjectURL(url);\n}\n","import { TrainingSession } from '../../core/application/TrainingSession';\nimport { D3Chart } from '../../infrastructure/d3/D3Chart';\nimport { TFNeuralNet } from '../../infrastructure/tensorflow/TFNeuralNet';\nimport { toast } from '../toast';\nimport { generatePythonCode, generateONNXModel, downloadONNXPythonScript } from '../../infrastructure/export';\nimport { OptimizerType, ActivationType, LRScheduleType } from '../../core/domain';\n\nexport interface ExportElements {\n    btnExportJson: HTMLButtonElement;\n    btnExportCsv: HTMLButtonElement;\n    btnExportPng: HTMLButtonElement;\n    btnExportSvg: HTMLButtonElement;\n    btnScreenshot: HTMLButtonElement;\n    btnExportModel: HTMLButtonElement;\n    btnExportPython: HTMLButtonElement;\n    btnExportOnnx: HTMLButtonElement;\n    inputLoadModel: HTMLInputElement;\n    inputLoadWeights: HTMLInputElement;\n\n    // Inputs needed for export config generation\n    inputLayers: HTMLInputElement;\n    inputLayerActivations: HTMLInputElement;\n    inputLr: HTMLInputElement;\n    inputOptimizer: HTMLSelectElement;\n    inputMomentum: HTMLInputElement;\n    inputActivation: HTMLSelectElement;\n    inputL1: HTMLInputElement;\n    inputL2: HTMLInputElement;\n    inputNumClasses: HTMLSelectElement;\n    inputDropout: HTMLSelectElement;\n    inputClipNorm: HTMLSelectElement;\n    inputBatchNorm: HTMLInputElement;\n    inputLrSchedule: HTMLSelectElement;\n    inputWarmup: HTMLInputElement;\n    inputCycleLength: HTMLInputElement;\n    inputMinLr: HTMLInputElement;\n    inputSamples: HTMLInputElement;\n    inputNoise: HTMLInputElement;\n    datasetSelect: HTMLSelectElement;\n    inputBatchSize: HTMLInputElement;\n    inputMaxEpochs: HTMLInputElement;\n    inputValSplit: HTMLSelectElement;\n}\n\nexport class ExportController {\n    private pendingModelJson: File | null = null;\n\n    constructor(\n        private session: TrainingSession,\n        private neuralNetService: TFNeuralNet,\n        private visualizerService: D3Chart,\n        private elements: ExportElements,\n        private callbacks: {\n            onModelLoaded: () => void;\n        }\n    ) {\n        this.bindEvents();\n    }\n\n    private bindEvents(): void {\n        this.elements.btnExportJson.addEventListener('click', () => this.handleExportJson());\n        this.elements.btnExportCsv.addEventListener('click', () => this.handleExportCsv());\n        this.elements.btnExportPng.addEventListener('click', () => this.handleExportPng());\n        this.elements.btnExportSvg.addEventListener('click', () => this.handleExportSvg());\n        this.elements.btnScreenshot.addEventListener('click', () => this.handleScreenshot());\n        this.elements.btnExportModel.addEventListener('click', () => void this.handleExportModel());\n        this.elements.btnExportPython.addEventListener('click', () => this.handleExportPython());\n        this.elements.btnExportOnnx.addEventListener('click', () => this.handleExportOnnx());\n\n        this.elements.inputLoadModel.addEventListener('change', (e) => this.handleLoadModelJson(e));\n        this.elements.inputLoadWeights.addEventListener('change', (e) => void this.handleLoadModelWeights(e));\n    }\n\n    private handleExportJson(): void {\n        const data = this.session.exportHistory('json');\n        this.downloadFile(data, 'training-history.json', 'application/json');\n        toast.success('Training history exported as JSON');\n    }\n\n    private handleExportCsv(): void {\n        const data = this.session.exportHistory('csv');\n        this.downloadFile(data, 'training-history.csv', 'text/csv');\n        toast.success('Training history exported as CSV');\n    }\n\n    private handleExportPng(): void {\n        this.visualizerService.exportAsPNG('neuroviz-boundary');\n        toast.success('Decision boundary exported as PNG');\n    }\n\n    private handleExportSvg(): void {\n        this.visualizerService.exportAsSVG('neuroviz-boundary');\n        toast.success('Decision boundary exported as SVG');\n    }\n\n    private handleScreenshot(): void {\n        const state = this.session.getState();\n\n        // Build metadata from current config\n        const metadata: Record<string, string> = {\n            'Epoch': state.currentEpoch.toString(),\n            'Loss': state.currentLoss?.toFixed(4) ?? '',\n            'Accuracy': state.currentAccuracy ? `${(state.currentAccuracy * 100).toFixed(1)}%` : '',\n            'LR': this.elements.inputLr.value,\n            'Layers': this.elements.inputLayers.value,\n            'Optimizer': this.elements.inputOptimizer.value,\n            'Activation': this.elements.inputActivation.value,\n            'Batch': this.elements.inputBatchSize.value || 'all',\n            'Dropout': this.elements.inputDropout.value === '0' ? 'none' : this.elements.inputDropout.value,\n            'L1': this.elements.inputL1.value || '0',\n            'L2': this.elements.inputL2.value || '0',\n            'Val Split': `${this.elements.inputValSplit.value}%`,\n        };\n\n        this.visualizerService.exportAsPNGWithMetadata('neuroviz-screenshot', metadata);\n        toast.success('Screenshot with metadata exported');\n    }\n\n    private handleExportPython(): void {\n        const state = this.session.getState();\n        if (!state.isInitialised) {\n            toast.warning('Please initialise a model first');\n            return;\n        }\n\n        // Build hyperparameters from current config\n        const layers = this.parseLayersInput(this.elements.inputLayers.value);\n        const layerActivations = this.parseLayerActivations(this.elements.inputLayerActivations.value);\n\n        const hyperparams = {\n            learningRate: parseFloat(this.elements.inputLr.value),\n            layers,\n            optimizer: this.elements.inputOptimizer.value as OptimizerType,\n            momentum: parseFloat(this.elements.inputMomentum.value) || 0.9,\n            activation: this.elements.inputActivation.value as ActivationType,\n            layerActivations: layerActivations.length > 0 ? layerActivations : undefined,\n            l1Regularization: parseFloat(this.elements.inputL1.value) || 0,\n            l2Regularization: parseFloat(this.elements.inputL2.value) || 0,\n            numClasses: parseInt(this.elements.inputNumClasses.value, 10) || 2,\n            dropoutRate: parseFloat(this.elements.inputDropout.value) || 0,\n            clipNorm: parseFloat(this.elements.inputClipNorm.value) || 0,\n            batchNorm: this.elements.inputBatchNorm.checked,\n        };\n\n        const lrSchedule = {\n            type: this.elements.inputLrSchedule.value as LRScheduleType,\n            warmupEpochs: parseInt(this.elements.inputWarmup.value, 10) || 0,\n            cycleLength: parseInt(this.elements.inputCycleLength.value, 10) || 20,\n            minLR: parseFloat(this.elements.inputMinLr.value) || 0.001,\n        };\n\n        const datasetInfo = {\n            samples: parseInt(this.elements.inputSamples.value, 10) || 200,\n            noise: (parseInt(this.elements.inputNoise.value, 10) || 10) / 100,\n            datasetType: this.elements.datasetSelect.value,\n        };\n\n        const code = generatePythonCode(hyperparams, lrSchedule, datasetInfo);\n\n        // Download as .py file\n        const blob = new Blob([code], { type: 'text/x-python' });\n        const url = URL.createObjectURL(blob);\n        const link = document.createElement('a');\n        link.href = url;\n        link.download = `neuroviz-model-${Date.now()}.py`;\n        link.click();\n        URL.revokeObjectURL(url);\n\n        toast.success('Python code exported');\n    }\n\n    private handleExportOnnx(): void {\n        const state = this.session.getState();\n        if (!state.isInitialised) {\n            toast.warning('Please initialise a model first');\n            return;\n        }\n\n        // Get layer configuration\n        const layers = this.parseLayersInput(this.elements.inputLayers.value);\n        const numClasses = parseInt(this.elements.inputNumClasses.value, 10) || 2;\n        const fullLayers = [2, ...layers, numClasses]; // Input (2D) + hidden + output\n\n        // Get activations\n        const layerActivations = this.parseLayerActivations(this.elements.inputLayerActivations.value);\n        const defaultActivation = this.elements.inputActivation.value;\n        const activations = ['linear', ...layers.map((_, i) => layerActivations[i] ?? defaultActivation), numClasses > 2 ? 'softmax' : 'sigmoid'];\n\n        // Get weights from model\n        const weightMatrices = this.neuralNetService.getWeightMatrices();\n\n        // Extract biases (simplified - assumes biases follow weights)\n        const biases: number[][] = weightMatrices.map(matrix => {\n            // For now, use zeros as we don't have direct bias access\n            const outputSize = matrix[0]?.length ?? 1;\n            return Array(outputSize).fill(0);\n        });\n\n        // Generate ONNX model info\n        const modelInfo = generateONNXModel(fullLayers, activations, weightMatrices, biases);\n\n        // Download Python script that generates ONNX\n        downloadONNXPythonScript(modelInfo, `neuroviz-onnx-${Date.now()}.py`);\n\n        toast.success('ONNX export script downloaded. Run with Python to generate .onnx file.');\n    }\n\n    private async handleExportModel(): Promise<void> {\n        const state = this.session.getState();\n        if (!state.isInitialised) {\n            toast.warning('Please initialise a model first');\n            return;\n        }\n\n        try {\n            const { modelJson, weightsBlob } = await this.neuralNetService.exportModel();\n\n            // Download model.json\n            const modelUrl = URL.createObjectURL(modelJson);\n            const modelLink = document.createElement('a');\n            modelLink.href = modelUrl;\n            modelLink.download = 'model.json';\n            modelLink.click();\n            URL.revokeObjectURL(modelUrl);\n\n            // Download weights.bin\n            const weightsUrl = URL.createObjectURL(weightsBlob);\n            const weightsLink = document.createElement('a');\n            weightsLink.href = weightsUrl;\n            weightsLink.download = 'weights.bin';\n            weightsLink.click();\n            URL.revokeObjectURL(weightsUrl);\n\n            toast.success('Model exported (model.json + weights.bin)');\n        } catch (error) {\n            console.error('Failed to export model:', error);\n            toast.error('Failed to export model');\n        }\n    }\n\n    private handleLoadModelJson(event: Event): void {\n        const input = event.target as HTMLInputElement;\n        const file = input.files?.[0];\n        if (!file) return;\n\n        this.pendingModelJson = file;\n        // Trigger weights file selection\n        this.elements.inputLoadWeights.click();\n\n        // Reset the input so the same file can be selected again\n        input.value = '';\n    }\n\n    private async handleLoadModelWeights(event: Event): Promise<void> {\n        const input = event.target as HTMLInputElement;\n        const weightsFile = input.files?.[0];\n\n        if (!weightsFile || !this.pendingModelJson) {\n            this.pendingModelJson = null;\n            return;\n        }\n\n        try {\n            toast.info('Loading model...');\n            await this.neuralNetService.loadModel(this.pendingModelJson, weightsFile);\n\n            toast.success('Model loaded successfully');\n            this.callbacks.onModelLoaded();\n        } catch (error) {\n            console.error('Failed to load model:', error);\n            toast.error('Failed to load model. Ensure files are valid TF.js format.');\n        } finally {\n            this.pendingModelJson = null;\n            input.value = '';\n        }\n    }\n\n    private downloadFile(content: string, filename: string, mimeType: string): void {\n        const blob = new Blob([content], { type: mimeType });\n        const url = URL.createObjectURL(blob);\n        const link = document.createElement('a');\n        link.href = url;\n        link.download = filename;\n        document.body.appendChild(link);\n        link.click();\n        document.body.removeChild(link);\n        URL.revokeObjectURL(url);\n    }\n\n    private parseLayersInput(input: string): number[] {\n        return input.split(',')\n            .map(s => parseInt(s.trim(), 10))\n            .filter(n => !isNaN(n) && n > 0);\n    }\n\n    private parseLayerActivations(input: string): ActivationType[] {\n        if (!input || input.trim() === '') return [];\n\n        const validActivations: ActivationType[] = ['linear', 'relu', 'sigmoid', 'tanh', 'leaky_relu', 'elu', 'selu', 'softmax'];\n\n        return input.split(',')\n            .map(s => s.trim().toLowerCase() as ActivationType)\n            .filter(a => validActivations.includes(a));\n    }\n}\n","import { TrainingSession } from '../../core/application/TrainingSession';\nimport { D3Chart } from '../../infrastructure/d3/D3Chart';\nimport { LocalStorageService } from '../../infrastructure/storage/LocalStorageService';\nimport { toast } from '../toast';\nimport { Point, TrainingHistory } from '../../core/domain';\n\nexport interface SessionElements {\n    btnSaveSession: HTMLButtonElement;\n    btnLoadSession: HTMLButtonElement;\n    btnClearSession: HTMLButtonElement;\n    btnShareUrl: HTMLButtonElement;\n    btnLoadConfig: HTMLButtonElement;\n\n    // Bookmarks\n    inputBookmarkName: HTMLInputElement;\n    btnSaveBookmark: HTMLButtonElement;\n    bookmarkOptions: HTMLDivElement;\n    btnDeleteBookmark: HTMLButtonElement;\n    presetSelect: HTMLSelectElement; // Reused for bookmarks\n\n    // Theme\n    iconSun: HTMLElement;\n    iconMoon: HTMLElement;\n    btnThemeToggle: HTMLButtonElement;\n\n    // Inputs for config application\n    datasetSelect: HTMLSelectElement;\n    inputSamples: HTMLInputElement;\n    samplesValue: HTMLSpanElement;\n    inputNoise: HTMLInputElement;\n    noiseValue: HTMLSpanElement;\n    inputNumClasses: HTMLSelectElement;\n    inputLr: HTMLInputElement;\n    inputLayers: HTMLInputElement;\n    inputOptimizer: HTMLSelectElement;\n    inputActivation: HTMLSelectElement;\n    inputL2: HTMLInputElement;\n    inputBatchSize: HTMLInputElement;\n    inputMaxEpochs: HTMLInputElement;\n    inputFps: HTMLInputElement;\n    fpsValue: HTMLSpanElement;\n    inputValSplit: HTMLSelectElement;\n    inputColourScheme: HTMLSelectElement;\n    inputPointSize: HTMLInputElement;\n    inputOpacity: HTMLInputElement;\n    opacityValue: HTMLSpanElement;\n    inputZoom: HTMLInputElement;\n    inputTooltips: HTMLInputElement;\n    inputBalance: HTMLInputElement;\n    balanceValue: HTMLSpanElement;\n\n    // Additional inputs for sharing\n    inputMomentum: HTMLInputElement;\n    momentumValue: HTMLSpanElement;\n    inputL1: HTMLInputElement;\n    inputDropout: HTMLSelectElement;\n    inputClipNorm: HTMLSelectElement;\n    inputBatchNorm: HTMLInputElement;\n    inputLrSchedule: HTMLSelectElement;\n    inputWarmup: HTMLInputElement;\n    inputCycleLength: HTMLInputElement;\n    inputMinLr: HTMLInputElement;\n    momentumControl: HTMLDivElement; // To toggle visibility\n}\n\nconst SESSION_KEY = 'neuroviz-session';\nconst BOOKMARKS_KEY = 'neuroviz-bookmarks';\nconst THEME_KEY = 'neuroviz-theme';\n\nexport interface BookmarkConfig {\n    id: string;\n    name: string;\n    createdAt: number;\n    config: {\n        datasetType: string;\n        samples: number;\n        noise: number;\n        numClasses: number;\n        classBalance: number;\n        learningRate: number;\n        layers: string;\n        optimizer: string;\n        activation: string;\n        l2Regularization: number;\n        batchSize: number;\n        maxEpochs: number;\n        targetFps: number;\n        validationSplit: number;\n    };\n}\n\nexport interface SessionData {\n    version: number;\n    timestamp: number;\n    config: {\n        datasetType: string;\n        samples: number;\n        noise: number;\n        numClasses: number;\n        learningRate: number;\n        layers: string;\n        optimizer: string;\n        activation: string;\n        l2Regularization: number;\n        batchSize: number;\n        maxEpochs: number;\n        targetFps: number;\n        validationSplit: number;\n        colourScheme: string;\n        pointSize: string;\n        opacity: number;\n        zoomEnabled: boolean;\n        tooltipsEnabled: boolean;\n    };\n    data: Point[];\n    history: TrainingHistory;\n}\n\nexport class SessionController {\n    constructor(\n        private session: TrainingSession,\n        private visualizerService: D3Chart,\n        private storage: LocalStorageService,\n        private elements: SessionElements,\n        private callbacks: {\n            onConfigLoaded: () => void;\n            onThemeChanged: (theme: 'light' | 'dark') => void;\n        }\n    ) {\n        this.bindEvents();\n        this.initTheme();\n        this.renderBookmarkOptions();\n    }\n\n    private bindEvents(): void {\n        this.elements.btnSaveSession.addEventListener('click', () => this.saveSession());\n        this.elements.btnLoadSession.addEventListener('click', () => void this.loadSession());\n        this.elements.btnClearSession.addEventListener('click', () => this.clearSession());\n        this.elements.btnShareUrl.addEventListener('click', () => this.handleShareUrl());\n        this.elements.btnLoadConfig.addEventListener('click', () => this.handleLoadConfigCode());\n\n        this.elements.btnSaveBookmark.addEventListener('click', () => this.handleSaveBookmark());\n        this.elements.btnDeleteBookmark.addEventListener('click', () => this.handleDeleteBookmark());\n        this.elements.btnThemeToggle.addEventListener('click', () => this.handleThemeToggle());\n\n        // Handle bookmark selection via preset select\n        this.elements.presetSelect.addEventListener('change', () => {\n            const value = this.elements.presetSelect.value;\n            if (value.startsWith('bookmark:')) {\n                const bookmarkId = value.replace('bookmark:', '');\n                const bookmarks = this.loadBookmarks();\n                const bookmark = bookmarks.find(b => b.id === bookmarkId);\n                if (bookmark) {\n                    this.applyBookmarkConfig(bookmark);\n                    this.elements.btnDeleteBookmark.disabled = false;\n                }\n            } else {\n                this.elements.btnDeleteBookmark.disabled = true;\n            }\n        });\n    }\n\n    // Theme Management\n\n    private initTheme(): void {\n        const stored = this.storage.getItem<string>(THEME_KEY).data;\n        const theme = stored === 'light' || stored === 'dark'\n            ? stored\n            : (window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark');\n\n        this.applyTheme(theme);\n    }\n\n    private applyTheme(theme: 'light' | 'dark'): void {\n        const html = document.documentElement;\n\n        if (theme === 'dark') {\n            html.classList.add('dark');\n            document.body.removeAttribute('data-theme');\n            this.elements.iconSun.classList.remove('hidden');\n            this.elements.iconMoon.classList.add('hidden');\n        } else {\n            html.classList.remove('dark');\n            document.body.setAttribute('data-theme', 'light');\n            this.elements.iconSun.classList.add('hidden');\n            this.elements.iconMoon.classList.remove('hidden');\n        }\n\n        this.storage.setItem(THEME_KEY, theme);\n        this.callbacks.onThemeChanged(theme);\n    }\n\n    private handleThemeToggle(): void {\n        const isDark = document.documentElement.classList.contains('dark');\n        const newTheme = isDark ? 'light' : 'dark';\n        this.applyTheme(newTheme);\n        toast.info(`Switched to ${newTheme} theme`);\n    }\n\n    // Session Management\n\n    private collectSessionConfig(): SessionData['config'] {\n        return {\n            datasetType: this.elements.datasetSelect.value,\n            samples: parseInt(this.elements.inputSamples.value, 10) || 200,\n            noise: parseInt(this.elements.inputNoise.value, 10) || 10,\n            numClasses: parseInt(this.elements.inputNumClasses.value, 10) || 2,\n            learningRate: parseFloat(this.elements.inputLr.value) || 0.03,\n            layers: this.elements.inputLayers.value,\n            optimizer: this.elements.inputOptimizer.value,\n            activation: this.elements.inputActivation.value,\n            l2Regularization: parseFloat(this.elements.inputL2.value) || 0,\n            batchSize: parseInt(this.elements.inputBatchSize.value, 10) || 0,\n            maxEpochs: parseInt(this.elements.inputMaxEpochs.value, 10) || 0,\n            targetFps: parseInt(this.elements.inputFps.value, 10) || 60,\n            validationSplit: parseInt(this.elements.inputValSplit.value, 10) / 100,\n            colourScheme: this.elements.inputColourScheme.value,\n            pointSize: this.elements.inputPointSize.value,\n            opacity: parseInt(this.elements.inputOpacity.value, 10),\n            zoomEnabled: this.elements.inputZoom.checked,\n            tooltipsEnabled: this.elements.inputTooltips.checked,\n        };\n    }\n\n    private saveSession(): void {\n        try {\n            const data: SessionData = {\n                version: 1,\n                timestamp: Date.now(),\n                config: this.collectSessionConfig(),\n                data: this.session.getData(),\n                history: this.session.getHistory(),\n            };\n\n            this.storage.setItem(SESSION_KEY, data);\n            toast.success('Session saved successfully!');\n        } catch (error) {\n            console.error('Failed to save session:', error);\n            toast.error('Failed to save session');\n        }\n    }\n\n    private async loadSession(): Promise<void> {\n        try {\n            const result = this.storage.getItem<SessionData>(SESSION_KEY);\n            if (!result.success || !result.data) {\n                toast.info('No saved session found');\n                return;\n            }\n\n            const data = result.data;\n\n            // Restore config\n            this.elements.datasetSelect.value = data.config.datasetType;\n            this.elements.inputSamples.value = data.config.samples.toString();\n            this.elements.samplesValue.textContent = data.config.samples.toString();\n            this.elements.inputNoise.value = data.config.noise.toString();\n            this.elements.noiseValue.textContent = data.config.noise.toString();\n            this.elements.inputNumClasses.value = data.config.numClasses.toString();\n            this.elements.inputLr.value = data.config.learningRate.toString();\n            this.elements.inputLayers.value = data.config.layers;\n            this.elements.inputOptimizer.value = data.config.optimizer;\n            this.elements.inputActivation.value = data.config.activation;\n            this.elements.inputL2.value = data.config.l2Regularization.toString();\n            this.elements.inputBatchSize.value = data.config.batchSize.toString();\n            this.elements.inputMaxEpochs.value = data.config.maxEpochs.toString();\n            this.elements.inputFps.value = data.config.targetFps.toString();\n            this.elements.fpsValue.textContent = data.config.targetFps.toString();\n            this.elements.inputValSplit.value = (data.config.validationSplit * 100).toString();\n            this.elements.inputColourScheme.value = data.config.colourScheme;\n            this.elements.inputPointSize.value = data.config.pointSize;\n            this.elements.inputOpacity.value = data.config.opacity.toString();\n            this.elements.opacityValue.textContent = data.config.opacity.toString();\n            this.elements.inputZoom.checked = data.config.zoomEnabled;\n            this.elements.inputTooltips.checked = data.config.tooltipsEnabled;\n\n            // Trigger updates\n            this.callbacks.onConfigLoaded();\n\n            // Restore data\n            if (data.data && data.data.length > 0) {\n                this.session.setCustomData(data.data);\n            }\n\n            toast.success('Session loaded successfully!');\n        } catch (error) {\n            console.error('Failed to load session:', error);\n            toast.error('Failed to load session');\n        }\n    }\n\n    private clearSession(): void {\n        this.storage.removeItem(SESSION_KEY);\n        toast.info('Saved session cleared');\n    }\n\n    // Bookmarks\n\n    private loadBookmarks(): BookmarkConfig[] {\n        const result = this.storage.getItem<BookmarkConfig[]>(BOOKMARKS_KEY);\n        return result.success && result.data ? result.data : [];\n    }\n\n    private saveBookmarks(bookmarks: BookmarkConfig[]): void {\n        this.storage.setItem(BOOKMARKS_KEY, bookmarks);\n    }\n\n    private renderBookmarkOptions(): void {\n        const bookmarks = this.loadBookmarks();\n\n        // Remove existing bookmarks from select\n        if (this.elements.presetSelect && this.elements.presetSelect.options) {\n            Array.from(this.elements.presetSelect.options).forEach(option => {\n                if (option.value.startsWith('bookmark:') || option.text === '') {\n                    option.remove();\n                }\n            });\n        }\n\n        // Add divider if needed\n        if (bookmarks.length > 0) {\n            const divider = document.createElement('option');\n            divider.disabled = true;\n            divider.text = '';\n            this.elements.presetSelect.add(divider);\n\n            // Add bookmarks\n            bookmarks.forEach(b => {\n                const option = document.createElement('option');\n                option.value = `bookmark:${b.id}`;\n                option.text = ` ${b.name}`;\n                this.elements.presetSelect.add(option);\n            });\n        }\n    }\n\n    private handleSaveBookmark(): void {\n        if (!this.elements.inputBookmarkName) {\n            toast.warning('Bookmark feature not available');\n            return;\n        }\n\n        const name = this.elements.inputBookmarkName.value.trim();\n        if (!name) {\n            toast.warning('Please enter a name for the bookmark');\n            return;\n        }\n\n        const config: BookmarkConfig = {\n            id: crypto.randomUUID(),\n            name,\n            createdAt: Date.now(),\n            config: {\n                datasetType: this.elements.datasetSelect.value,\n                samples: parseInt(this.elements.inputSamples.value, 10) || 200,\n                noise: parseInt(this.elements.inputNoise.value, 10) || 10,\n                numClasses: parseInt(this.elements.inputNumClasses.value, 10) || 2,\n                classBalance: parseInt(this.elements.inputBalance.value, 10) || 50,\n                learningRate: parseFloat(this.elements.inputLr.value) || 0.03,\n                layers: this.elements.inputLayers.value,\n                optimizer: this.elements.inputOptimizer.value,\n                activation: this.elements.inputActivation.value,\n                l2Regularization: parseFloat(this.elements.inputL2.value) || 0,\n                batchSize: parseInt(this.elements.inputBatchSize.value, 10) || 0,\n                maxEpochs: parseInt(this.elements.inputMaxEpochs.value, 10) || 0,\n                targetFps: parseInt(this.elements.inputFps.value, 10) || 60,\n                validationSplit: parseInt(this.elements.inputValSplit.value, 10) / 100,\n            }\n        };\n\n        const bookmarks = this.loadBookmarks();\n        bookmarks.push(config);\n        this.saveBookmarks(bookmarks);\n        this.renderBookmarkOptions();\n\n        this.elements.inputBookmarkName.value = '';\n        toast.success(`Bookmark \"${name}\" saved!`);\n    }\n\n    private handleDeleteBookmark(): void {\n        const value = this.elements.presetSelect.value;\n        if (!value.startsWith('bookmark:')) return;\n\n        const bookmarkId = value.replace('bookmark:', '');\n        const bookmarks = this.loadBookmarks();\n        const newBookmarks = bookmarks.filter(b => b.id !== bookmarkId);\n\n        this.saveBookmarks(newBookmarks);\n        this.renderBookmarkOptions();\n        this.elements.presetSelect.value = 'circle'; // Default to circle\n        this.elements.btnDeleteBookmark.disabled = true;\n\n        toast.info('Bookmark deleted');\n    }\n\n    private applyBookmarkConfig(bookmark: BookmarkConfig): void {\n        const c = bookmark.config;\n\n        this.elements.datasetSelect.value = c.datasetType;\n        this.elements.inputSamples.value = c.samples.toString();\n        this.elements.samplesValue.textContent = c.samples.toString();\n        this.elements.inputNoise.value = c.noise.toString();\n        this.elements.noiseValue.textContent = c.noise.toString();\n        this.elements.inputNumClasses.value = c.numClasses.toString();\n        this.elements.inputBalance.value = c.classBalance.toString();\n        this.elements.balanceValue.textContent = c.classBalance.toString();\n\n        this.elements.inputLr.value = c.learningRate.toString();\n        this.elements.inputLayers.value = c.layers;\n        this.elements.inputOptimizer.value = c.optimizer;\n        this.elements.inputActivation.value = c.activation;\n        this.elements.inputL2.value = c.l2Regularization.toString();\n        this.elements.inputBatchSize.value = c.batchSize.toString();\n        this.elements.inputMaxEpochs.value = c.maxEpochs.toString();\n        this.elements.inputFps.value = c.targetFps.toString();\n        this.elements.fpsValue.textContent = c.targetFps.toString();\n        this.elements.inputValSplit.value = (c.validationSplit * 100).toString();\n\n        this.callbacks.onConfigLoaded();\n        toast.success(`Loaded bookmark: ${bookmark.name}`);\n    }\n\n    // Sharing\n\n    private handleShareUrl(): void {\n        const config = this.collectSessionConfig();\n        const json = JSON.stringify(config);\n        const encoded = btoa(json);\n        const url = `${window.location.origin}${window.location.pathname}?config=${encoded}`;\n\n        navigator.clipboard.writeText(url).then(() => {\n            toast.success('Configuration URL copied to clipboard!');\n        }).catch(() => {\n            toast.error('Failed to copy URL');\n        });\n    }\n\n    private handleLoadConfigCode(): void {\n        const code = prompt('Paste configuration code here:');\n        if (!code) return;\n\n        try {\n            const json = atob(code);\n            const config = JSON.parse(json);\n\n            // Apply config (simplified version of applyBookmarkConfig)\n            if (config.datasetType) this.elements.datasetSelect.value = config.datasetType;\n            if (config.learningRate) this.elements.inputLr.value = config.learningRate;\n            if (config.layers) this.elements.inputLayers.value = config.layers;\n\n            this.callbacks.onConfigLoaded();\n            toast.success('Configuration loaded!');\n        } catch (error) {\n            console.error('Invalid configuration code:', error);\n            toast.error('Invalid configuration code');\n        }\n    }\n}\n","/**\n * Model comparison system for A/B testing different configurations.\n * Allows training two models side-by-side with different hyperparameters.\n */\n\nimport type { Hyperparameters, Point } from '../domain';\nimport type { INeuralNetworkService } from '../ports';\n\nexport interface ModelConfig {\n  name: string;\n  hyperparameters: Hyperparameters;\n}\n\nexport interface ModelState {\n  name: string;\n  epoch: number;\n  loss: number | null;\n  accuracy: number | null;\n  valLoss: number | null;\n  valAccuracy: number | null;\n  history: { epoch: number; loss: number; accuracy: number }[];\n  isTraining: boolean;\n}\n\nexport interface ComparisonResult {\n  modelA: ModelState;\n  modelB: ModelState;\n  winner: 'A' | 'B' | 'tie' | null;\n  metric: 'accuracy' | 'loss';\n}\n\n/**\n * Manages A/B model comparison.\n */\nexport class ModelComparison {\n  private modelA: INeuralNetworkService | null = null;\n  private modelB: INeuralNetworkService | null = null;\n  private configA: ModelConfig | null = null;\n  private configB: ModelConfig | null = null;\n  private stateA: ModelState | null = null;\n  private stateB: ModelState | null = null;\n  private trainingData: Point[] = [];\n  private validationData: Point[] = [];\n\n  constructor(\n    private createModel: () => INeuralNetworkService\n  ) {}\n\n  /**\n   * Sets up model A with given configuration.\n   */\n  async setupModelA(config: ModelConfig): Promise<void> {\n    this.modelA = this.createModel();\n    await this.modelA.initialize(config.hyperparameters);\n    this.configA = config;\n    this.stateA = {\n      name: config.name,\n      epoch: 0,\n      loss: null,\n      accuracy: null,\n      valLoss: null,\n      valAccuracy: null,\n      history: [],\n      isTraining: false,\n    };\n  }\n\n  /**\n   * Sets up model B with given configuration.\n   */\n  async setupModelB(config: ModelConfig): Promise<void> {\n    this.modelB = this.createModel();\n    await this.modelB.initialize(config.hyperparameters);\n    this.configB = config;\n    this.stateB = {\n      name: config.name,\n      epoch: 0,\n      loss: null,\n      accuracy: null,\n      valLoss: null,\n      valAccuracy: null,\n      history: [],\n      isTraining: false,\n    };\n  }\n\n  /**\n   * Sets the training and validation data.\n   */\n  setData(training: Point[], validation: Point[]): void {\n    this.trainingData = training;\n    this.validationData = validation;\n  }\n\n  /**\n   * Trains both models for one epoch.\n   */\n  async trainStep(): Promise<ComparisonResult | null> {\n    if (!this.modelA || !this.modelB || !this.stateA || !this.stateB) {\n      return null;\n    }\n\n    if (this.trainingData.length === 0) {\n      return null;\n    }\n\n    // Train model A\n    this.stateA.isTraining = true;\n    const resultA = await this.modelA.train(this.trainingData);\n    this.stateA.epoch++;\n    this.stateA.loss = resultA.loss;\n    this.stateA.accuracy = resultA.accuracy;\n    this.stateA.history.push({\n      epoch: this.stateA.epoch,\n      loss: resultA.loss,\n      accuracy: resultA.accuracy,\n    });\n\n    // Evaluate on validation if available\n    if (this.validationData.length > 0) {\n      const valResultA = await this.modelA.evaluate(this.validationData);\n      this.stateA.valLoss = valResultA.loss;\n      this.stateA.valAccuracy = valResultA.accuracy;\n    }\n    this.stateA.isTraining = false;\n\n    // Train model B\n    this.stateB.isTraining = true;\n    const resultB = await this.modelB.train(this.trainingData);\n    this.stateB.epoch++;\n    this.stateB.loss = resultB.loss;\n    this.stateB.accuracy = resultB.accuracy;\n    this.stateB.history.push({\n      epoch: this.stateB.epoch,\n      loss: resultB.loss,\n      accuracy: resultB.accuracy,\n    });\n\n    // Evaluate on validation if available\n    if (this.validationData.length > 0) {\n      const valResultB = await this.modelB.evaluate(this.validationData);\n      this.stateB.valLoss = valResultB.loss;\n      this.stateB.valAccuracy = valResultB.accuracy;\n    }\n    this.stateB.isTraining = false;\n\n    return this.getComparison();\n  }\n\n  /**\n   * Gets the current comparison result.\n   */\n  getComparison(): ComparisonResult | null {\n    if (!this.stateA || !this.stateB) {\n      return null;\n    }\n\n    let winner: 'A' | 'B' | 'tie' | null = null;\n    const metric = 'accuracy';\n\n    const accA = this.stateA.valAccuracy ?? this.stateA.accuracy;\n    const accB = this.stateB.valAccuracy ?? this.stateB.accuracy;\n\n    if (accA !== null && accB !== null) {\n      if (accA > accB + 0.01) {\n        winner = 'A';\n      } else if (accB > accA + 0.01) {\n        winner = 'B';\n      } else {\n        winner = 'tie';\n      }\n    }\n\n    return {\n      modelA: { ...this.stateA },\n      modelB: { ...this.stateB },\n      winner,\n      metric,\n    };\n  }\n\n  /**\n   * Gets predictions from model A.\n   */\n  async predictA(points: Point[]): Promise<ReturnType<INeuralNetworkService['predict']>> {\n    if (!this.modelA) throw new Error('Model A not initialized');\n    return this.modelA.predict(points);\n  }\n\n  /**\n   * Gets predictions from model B.\n   */\n  async predictB(points: Point[]): Promise<ReturnType<INeuralNetworkService['predict']>> {\n    if (!this.modelB) throw new Error('Model B not initialized');\n    return this.modelB.predict(points);\n  }\n\n  /**\n   * Resets both models.\n   */\n  reset(): void {\n    this.stateA = this.stateA ? { ...this.stateA, epoch: 0, loss: null, accuracy: null, valLoss: null, valAccuracy: null, history: [], isTraining: false } : null;\n    this.stateB = this.stateB ? { ...this.stateB, epoch: 0, loss: null, accuracy: null, valLoss: null, valAccuracy: null, history: [], isTraining: false } : null;\n  }\n\n  /**\n   * Disposes both models.\n   */\n  dispose(): void {\n    this.modelA = null;\n    this.modelB = null;\n    this.configA = null;\n    this.configB = null;\n    this.stateA = null;\n    this.stateB = null;\n  }\n\n  /**\n   * Returns whether comparison is ready.\n   */\n  isReady(): boolean {\n    return this.modelA !== null && this.modelB !== null && this.trainingData.length > 0;\n  }\n\n  /**\n   * Gets config for model A.\n   */\n  getConfigA(): ModelConfig | null {\n    return this.configA;\n  }\n\n  /**\n   * Gets config for model B.\n   */\n  getConfigB(): ModelConfig | null {\n    return this.configB;\n  }\n}\n","/**\n * Model ensemble system for combining multiple models via voting.\n * Visualizes individual model predictions and ensemble consensus.\n */\n\nimport type { Hyperparameters, Point, Prediction } from '../domain';\nimport type { INeuralNetworkService } from '../ports';\n\nexport interface EnsembleMember {\n  id: string;\n  name: string;\n  model: INeuralNetworkService;\n  config: Hyperparameters;\n  weight: number; // Voting weight (default 1.0)\n  accuracy: number | null;\n}\n\nexport interface EnsemblePrediction {\n  x: number;\n  y: number;\n  /** Final ensemble prediction (majority vote or weighted average) */\n  predictedClass: number;\n  /** Ensemble confidence (agreement level) */\n  confidence: number;\n  /** Individual model predictions */\n  memberPredictions: {\n    memberId: string;\n    predictedClass: number;\n    confidence: number;\n  }[];\n  /** Agreement ratio (0-1) - how many models agree */\n  agreement: number;\n}\n\nexport interface EnsembleState {\n  members: EnsembleMember[];\n  isTraining: boolean;\n  currentEpoch: number;\n}\n\n/**\n * Manages an ensemble of neural network models.\n */\nexport class ModelEnsemble {\n  private members: EnsembleMember[] = [];\n  private trainingData: Point[] = [];\n  private validationData: Point[] = [];\n  private isTraining = false;\n  private currentEpoch = 0;\n\n  constructor(\n    private createModel: () => INeuralNetworkService,\n    private maxMembers = 5\n  ) {}\n\n  /**\n   * Adds a new model to the ensemble.\n   */\n  async addMember(name: string, config: Hyperparameters, weight = 1.0): Promise<string> {\n    if (this.members.length >= this.maxMembers) {\n      throw new Error(`Ensemble is full (max ${this.maxMembers} members)`);\n    }\n\n    const id = `member-${Date.now()}-${Math.random().toString(36).slice(2, 7)}`;\n    const model = this.createModel();\n    await model.initialize(config);\n\n    this.members.push({\n      id,\n      name,\n      model,\n      config,\n      weight,\n      accuracy: null,\n    });\n\n    return id;\n  }\n\n  /**\n   * Removes a member from the ensemble.\n   */\n  removeMember(id: string): boolean {\n    const index = this.members.findIndex(m => m.id === id);\n    if (index === -1) return false;\n    this.members.splice(index, 1);\n    return true;\n  }\n\n  /**\n   * Sets training and validation data.\n   */\n  setData(training: Point[], validation: Point[]): void {\n    this.trainingData = training;\n    this.validationData = validation;\n  }\n\n  /**\n   * Trains all ensemble members for one epoch.\n   */\n  async trainStep(): Promise<EnsembleState> {\n    if (this.members.length === 0 || this.trainingData.length === 0) {\n      return this.getState();\n    }\n\n    this.isTraining = true;\n    this.currentEpoch++;\n\n    // Train each member\n    for (const member of this.members) {\n      const result = await member.model.train(this.trainingData);\n      \n      // Evaluate on validation data\n      if (this.validationData.length > 0) {\n        const valResult = await member.model.evaluate(this.validationData);\n        member.accuracy = valResult.accuracy;\n      } else {\n        member.accuracy = result.accuracy;\n      }\n    }\n\n    this.isTraining = false;\n    return this.getState();\n  }\n\n  /**\n   * Gets ensemble predictions using majority voting.\n   */\n  async predict(points: Point[]): Promise<EnsemblePrediction[]> {\n    if (this.members.length === 0) {\n      return points.map(p => ({\n        x: p.x,\n        y: p.y,\n        predictedClass: 0,\n        confidence: 0,\n        memberPredictions: [],\n        agreement: 0,\n      }));\n    }\n\n    // Get predictions from all members\n    const memberPredictions: Prediction[][] = await Promise.all(\n      this.members.map(m => m.model.predict(points))\n    );\n\n    // Combine predictions for each point\n    return points.map((point, pointIdx) => {\n      const predictions = this.members.map((member, memberIdx) => {\n        const pred = memberPredictions[memberIdx]?.[pointIdx];\n        return {\n          memberId: member.id,\n          predictedClass: pred?.predictedClass ?? 0,\n          confidence: pred?.confidence ?? 0,\n          weight: member.weight,\n        };\n      });\n\n      // Weighted voting\n      const classVotes: Map<number, number> = new Map();\n      let totalWeight = 0;\n\n      for (const pred of predictions) {\n        const currentVote = classVotes.get(pred.predictedClass) ?? 0;\n        classVotes.set(pred.predictedClass, currentVote + pred.weight * pred.confidence);\n        totalWeight += pred.weight;\n      }\n\n      // Find winning class\n      let winningClass = 0;\n      let maxVotes = 0;\n      for (const [classId, votes] of classVotes) {\n        if (votes > maxVotes) {\n          maxVotes = votes;\n          winningClass = classId;\n        }\n      }\n\n      // Calculate agreement (how many models agree with the winner)\n      const agreeing = predictions.filter(p => p.predictedClass === winningClass).length;\n      const agreement = agreeing / predictions.length;\n\n      // Ensemble confidence is weighted average of agreeing models\n      const confidence = totalWeight > 0 ? maxVotes / totalWeight : 0;\n\n      return {\n        x: point.x,\n        y: point.y,\n        predictedClass: winningClass,\n        confidence,\n        memberPredictions: predictions.map(p => ({\n          memberId: p.memberId,\n          predictedClass: p.predictedClass,\n          confidence: p.confidence,\n        })),\n        agreement,\n      };\n    });\n  }\n\n  /**\n   * Gets the current ensemble state.\n   */\n  getState(): EnsembleState {\n    return {\n      members: this.members.map(m => ({ ...m })),\n      isTraining: this.isTraining,\n      currentEpoch: this.currentEpoch,\n    };\n  }\n\n  /**\n   * Gets member count.\n   */\n  getMemberCount(): number {\n    return this.members.length;\n  }\n\n  /**\n   * Resets all members' training state.\n   */\n  async reset(): Promise<void> {\n    this.currentEpoch = 0;\n    for (const member of this.members) {\n      await member.model.initialize(member.config);\n      member.accuracy = null;\n    }\n  }\n\n  /**\n   * Disposes all models.\n   */\n  dispose(): void {\n    this.members = [];\n    this.trainingData = [];\n    this.validationData = [];\n    this.isTraining = false;\n    this.currentEpoch = 0;\n  }\n}\n","import { TrainingSession } from '../../core/application/TrainingSession';\nimport { ModelComparison, ModelState } from '../../core/application/ModelComparison';\nimport { ModelEnsemble } from '../../core/application/ModelEnsemble';\nimport { TFNeuralNet } from '../../infrastructure/tensorflow/TFNeuralNet';\nimport { toast } from '../toast';\nimport { ActivationType, OptimizerType } from '../../core/domain';\nimport { safeHTML } from '../../infrastructure/security/htmlSanitizer';\n\nexport interface ComparisonElements {\n    // Baseline Comparison\n    comparisonPanel: HTMLDivElement;\n    baselineAccuracy: HTMLSpanElement;\n    baselineLoss: HTMLSpanElement;\n    baselineConfig: HTMLSpanElement;\n    currentAccuracy: HTMLSpanElement;\n    currentLoss: HTMLSpanElement;\n    comparisonDiff: HTMLSpanElement;\n    btnSaveBaseline: HTMLButtonElement;\n    btnClearBaseline: HTMLButtonElement;\n    comparisonMetrics: HTMLDivElement;\n    baselineMetrics: HTMLDivElement;\n\n    // Inputs for config summary\n    inputLayers: HTMLInputElement;\n    inputOptimizer: HTMLSelectElement;\n    inputLr: HTMLInputElement;\n    inputActivation: HTMLSelectElement;\n    inputNumClasses: HTMLSelectElement;\n    inputValSplit: HTMLInputElement;\n\n    // A/B Testing\n    abComparisonPanel: HTMLDivElement;\n    abEpochA: HTMLSpanElement;\n    abAccuracyA: HTMLSpanElement;\n    abLossA: HTMLSpanElement;\n    abEpochB: HTMLSpanElement;\n    abAccuracyB: HTMLSpanElement;\n    abLossB: HTMLSpanElement;\n    abWinner: HTMLDivElement;\n\n    abLrA: HTMLInputElement;\n    abActivationA: HTMLSelectElement;\n    abOptimizerA: HTMLSelectElement;\n    abLrB: HTMLInputElement;\n    abActivationB: HTMLSelectElement;\n    abOptimizerB: HTMLSelectElement;\n    abEpochs: HTMLInputElement;\n\n    btnStartAbTest: HTMLButtonElement;\n    btnStopAbTest: HTMLButtonElement;\n\n    // Ensemble\n    ensemblePanel: HTMLDivElement;\n    ensembleMemberCount: HTMLSpanElement;\n    ensembleEpoch: HTMLSpanElement;\n    ensembleMembers: HTMLDivElement;\n\n    btnAddEnsembleMember: HTMLButtonElement;\n    btnTrainEnsemble: HTMLButtonElement;\n    btnResetEnsemble: HTMLButtonElement;\n}\n\ninterface BaselineData {\n    accuracy: number;\n    loss: number;\n    config: string;\n}\n\nexport class ComparisonController {\n    private baseline: BaselineData | null = null;\n    private abComparison: ModelComparison | null = null;\n    private abTrainingInterval: ReturnType<typeof setInterval> | null = null;\n    private abTargetEpochs: number = 100;\n\n    private ensemble: ModelEnsemble | null = null;\n    private ensembleTrainingInterval: ReturnType<typeof setInterval> | null = null;\n\n    constructor(\n        private session: TrainingSession,\n        private elements: ComparisonElements\n    ) {\n        this.bindEvents();\n    }\n\n    private bindEvents(): void {\n        // Baseline\n        this.elements.btnSaveBaseline.addEventListener('click', () => this.handleSaveBaseline());\n        this.elements.btnClearBaseline.addEventListener('click', () => this.handleClearBaseline());\n\n        // A/B Testing\n        this.elements.btnStartAbTest.addEventListener('click', () => void this.handleStartAbTest());\n        this.elements.btnStopAbTest.addEventListener('click', () => this.stopAbTest());\n\n        // Ensemble\n        this.elements.btnAddEnsembleMember.addEventListener('click', () => void this.addEnsembleMember());\n        this.elements.btnTrainEnsemble.addEventListener('click', () => void this.toggleEnsembleTraining());\n        this.elements.btnResetEnsemble.addEventListener('click', () => this.resetEnsemble());\n    }\n\n    // =============================================================================\n    // Baseline Comparison\n    // =============================================================================\n\n    private handleSaveBaseline(): void {\n        const state = this.session.getState();\n        if (state.currentAccuracy === null || state.currentLoss === null) {\n            toast.warning('Train a model first to set baseline');\n            return;\n        }\n\n        const configSummary = `${this.elements.inputLayers.value} | ${this.elements.inputOptimizer.value} | LR ${this.elements.inputLr.value}`;\n\n        this.baseline = {\n            accuracy: state.currentAccuracy,\n            loss: state.currentLoss,\n            config: configSummary,\n        };\n\n        this.elements.comparisonPanel.classList.remove('hidden');\n        this.elements.baselineAccuracy.textContent = `${(this.baseline.accuracy * 100).toFixed(1)}%`;\n        this.elements.baselineLoss.textContent = this.baseline.loss.toFixed(4);\n        this.elements.baselineConfig.textContent = this.baseline.config;\n\n        this.updateComparisonDisplay();\n        toast.success('Baseline saved');\n    }\n\n    private handleClearBaseline(): void {\n        this.baseline = null;\n        this.elements.comparisonPanel.classList.add('hidden');\n        toast.info('Baseline cleared');\n    }\n\n    public updateComparisonDisplay(): void {\n        if (!this.baseline) return;\n\n        const state = this.session.getState();\n\n        if (state.currentAccuracy !== null) {\n            this.elements.currentAccuracy.textContent = `${(state.currentAccuracy * 100).toFixed(1)}%`;\n        }\n        if (state.currentLoss !== null) {\n            this.elements.currentLoss.textContent = state.currentLoss.toFixed(4);\n        }\n\n        // Calculate and display difference\n        if (state.currentAccuracy !== null && state.currentLoss !== null) {\n            const accDiff = (state.currentAccuracy - this.baseline.accuracy) * 100;\n            const lossDiff = state.currentLoss - this.baseline.loss;\n\n            const accClass = accDiff >= 0 ? 'text-green-400' : 'text-red-400';\n            const lossClass = lossDiff <= 0 ? 'text-green-400' : 'text-red-400';\n            const accSign = accDiff >= 0 ? '+' : '';\n            const lossSign = lossDiff >= 0 ? '+' : '';\n\n            this.elements.comparisonDiff.innerHTML = safeHTML`\n        <span class=\"${accClass}\">${accSign}${accDiff.toFixed(1)}% acc</span> |\n        <span class=\"${lossClass}\">${lossSign}${lossDiff.toFixed(4)} loss</span>\n      `;\n        }\n    }\n\n    // =============================================================================\n    // A/B Testing\n    // =============================================================================\n\n    private async handleStartAbTest(): Promise<void> {\n        const state = this.session.getState();\n        if (!state.datasetLoaded) {\n            toast.warning('Please load a dataset first');\n            return;\n        }\n\n        // Stop any existing test\n        this.stopAbTest();\n\n        const layersA = this.elements.inputLayers.value.split(',').map(s => parseInt(s.trim(), 10)).filter(n => !isNaN(n) && n > 0);\n        const layersB = [...layersA]; // Start with same architecture\n        const numClasses = parseInt(this.elements.inputNumClasses.value, 10) || 2;\n\n        const configA = {\n            name: 'Model A',\n            hyperparameters: {\n                learningRate: parseFloat(this.elements.abLrA.value) || 0.03,\n                layers: layersA,\n                activation: this.elements.abActivationA.value as ActivationType,\n                optimizer: this.elements.abOptimizerA.value as OptimizerType,\n                numClasses,\n            },\n        };\n\n        const configB = {\n            name: 'Model B',\n            hyperparameters: {\n                learningRate: parseFloat(this.elements.abLrB.value) || 0.1,\n                layers: layersB,\n                activation: this.elements.abActivationB.value as ActivationType,\n                optimizer: this.elements.abOptimizerB.value as OptimizerType,\n                numClasses,\n            },\n        };\n\n        this.abTargetEpochs = parseInt(this.elements.abEpochs.value, 10) || 100;\n\n        // Create comparison instance\n        this.abComparison = new ModelComparison(() => new TFNeuralNet());\n\n        try {\n            await this.abComparison.setupModelA(configA);\n            await this.abComparison.setupModelB(configB);\n\n            // Get training data from session\n            const data = this.session.getData();\n            const valSplit = parseFloat(this.elements.inputValSplit.value) / 100 || 0.2;\n            const splitIdx = Math.floor(data.length * (1 - valSplit));\n            const shuffled = [...data].sort(() => Math.random() - 0.5);\n            const trainingData = shuffled.slice(0, splitIdx);\n            const validationData = shuffled.slice(splitIdx);\n\n            // Set data for comparison\n            this.abComparison.setData(trainingData, validationData);\n\n            this.elements.abComparisonPanel.classList.remove('hidden');\n            toast.info('Starting A/B test...');\n\n            // Start training loop\n            let epoch = 0;\n            this.abTrainingInterval = setInterval(() => {\n                void (async () => {\n                    if (epoch >= this.abTargetEpochs) {\n                        this.stopAbTest();\n                        this.determineAbWinner();\n                        return;\n                    }\n\n                    epoch++;\n                    const result = await this.abComparison?.trainStep();\n\n                    if (result) {\n                        this.updateAbDisplay(result, epoch);\n                    }\n                })().catch((error) => {\n                    console.error('A/B test training step failed:', error);\n                    toast.error('A/B test training failed');\n                    this.stopAbTest();\n                });\n            }, 100); // 100ms per epoch\n\n        } catch (error) {\n            console.error('Failed to start A/B test:', error);\n            toast.error('Failed to start A/B test');\n        }\n    }\n\n    private stopAbTest(): void {\n        if (this.abTrainingInterval) {\n            clearInterval(this.abTrainingInterval);\n            this.abTrainingInterval = null;\n        }\n        this.elements.abComparisonPanel.classList.add('hidden');\n    }\n\n    private updateAbDisplay(result: { modelA: ModelState; modelB: ModelState }, epoch: number): void {\n        this.elements.abEpochA.textContent = epoch.toString();\n        this.elements.abEpochB.textContent = epoch.toString();\n\n        this.elements.abAccuracyA.textContent = `${((result.modelA.valAccuracy ?? 0) * 100).toFixed(1)}%`;\n        this.elements.abLossA.textContent = (result.modelA.valLoss ?? 0).toFixed(4);\n\n        this.elements.abAccuracyB.textContent = `${((result.modelB.valAccuracy ?? 0) * 100).toFixed(1)}%`;\n        this.elements.abLossB.textContent = (result.modelB.valLoss ?? 0).toFixed(4);\n    }\n\n    private determineAbWinner(): void {\n        if (!this.abComparison) return;\n\n        const results = this.abComparison.getComparison();\n        if (!results) return;\n\n        const accA = results.modelA.valAccuracy ?? 0;\n        const accB = results.modelB.valAccuracy ?? 0;\n\n        let winnerText = '';\n        if (accA > accB) {\n            winnerText = ` Model A Wins! (+${((accA - accB) * 100).toFixed(1)}%)`;\n            this.elements.abWinner.className = 'mt-4 p-3 bg-blue-900/30 border border-blue-500/50 rounded text-center font-bold text-blue-300';\n        } else if (accB > accA) {\n            winnerText = ` Model B Wins! (+${((accB - accA) * 100).toFixed(1)}%)`;\n            this.elements.abWinner.className = 'mt-4 p-3 bg-purple-900/30 border border-purple-500/50 rounded text-center font-bold text-purple-300';\n        } else {\n            winnerText = 'It\\'s a Tie!';\n            this.elements.abWinner.className = 'mt-4 p-3 bg-gray-800 border border-gray-600 rounded text-center font-bold text-gray-300';\n        }\n\n        this.elements.abWinner.textContent = winnerText;\n        this.elements.abWinner.classList.remove('hidden');\n        toast.success(winnerText);\n    }\n\n    // =============================================================================\n    // Ensemble\n    // =============================================================================\n\n    private async addEnsembleMember(): Promise<void> {\n        if (!this.ensemble) {\n            this.ensemble = new ModelEnsemble(() => new TFNeuralNet());\n        }\n\n        const layers = this.elements.inputLayers.value.split(',').map(s => parseInt(s.trim(), 10)).filter(n => !isNaN(n) && n > 0);\n        const numClasses = parseInt(this.elements.inputNumClasses.value, 10) || 2;\n\n        const config = {\n            learningRate: parseFloat(this.elements.inputLr.value) || 0.03,\n            layers,\n            activation: this.elements.inputActivation.value as ActivationType,\n            optimizer: this.elements.inputOptimizer.value as OptimizerType,\n            numClasses,\n        };\n\n        await this.ensemble.addMember(`Member ${this.ensemble.getMemberCount() + 1}`, config);\n        this.updateEnsembleDisplay();\n        toast.success(`Added ensemble member ${this.ensemble.getMemberCount()}`);\n    }\n\n    private async toggleEnsembleTraining(): Promise<void> {\n        if (this.ensembleTrainingInterval) {\n            clearInterval(this.ensembleTrainingInterval);\n            this.ensembleTrainingInterval = null;\n            this.elements.btnTrainEnsemble.textContent = 'Train Ensemble';\n            return;\n        }\n\n        if (!this.ensemble || this.ensemble.getMemberCount() === 0) {\n            toast.warning('Add ensemble members first');\n            return;\n        }\n\n        const state = this.session.getState();\n        if (!state.datasetLoaded) {\n            toast.warning('Please load a dataset first');\n            return;\n        }\n\n        // Get data\n        const data = this.session.getData();\n        const valSplit = parseFloat(this.elements.inputValSplit.value) / 100 || 0.2;\n        const splitIdx = Math.floor(data.length * (1 - valSplit));\n        const shuffled = [...data].sort(() => Math.random() - 0.5);\n        const trainingData = shuffled.slice(0, splitIdx);\n        const validationData = shuffled.slice(splitIdx);\n\n        // Set data for ensemble\n        this.ensemble.setData(trainingData, validationData);\n\n        this.elements.btnTrainEnsemble.textContent = 'Stop Training';\n        let epoch = 0;\n\n        this.ensembleTrainingInterval = setInterval(() => {\n            void (async () => {\n                epoch++;\n                this.elements.ensembleEpoch.textContent = epoch.toString();\n\n                await this.ensemble?.trainStep();\n\n                // Update UI for each member could go here\n                if (epoch % 10 === 0) {\n                    toast.info(`Ensemble Epoch ${epoch} complete`);\n                }\n            })().catch((error) => {\n                console.error('Ensemble training step failed:', error);\n                toast.error('Ensemble training failed');\n                clearInterval(this.ensembleTrainingInterval!);\n                this.ensembleTrainingInterval = null;\n                this.elements.btnTrainEnsemble.textContent = 'Train Ensemble';\n            });\n        }, 100);\n    }\n\n    private resetEnsemble(): void {\n        if (this.ensembleTrainingInterval) {\n            clearInterval(this.ensembleTrainingInterval);\n            this.ensembleTrainingInterval = null;\n        }\n        this.ensemble = null;\n        this.updateEnsembleDisplay();\n        toast.info('Ensemble reset');\n    }\n\n    private updateEnsembleDisplay(): void {\n        const count = this.ensemble ? this.ensemble.getMemberCount() : 0;\n        this.elements.ensembleMemberCount.textContent = count.toString();\n\n        if (count > 0) {\n            this.elements.ensemblePanel.classList.remove('hidden');\n        } else {\n            this.elements.ensemblePanel.classList.add('hidden');\n        }\n    }\n}\n","import * as d3 from 'd3';\n\n/**\n * Learning rate finder result point.\n */\nexport interface LRFinderPoint {\n  lr: number;\n  loss: number;\n}\n\n/**\n * D3-based learning rate finder visualization.\n * Shows loss vs learning rate on a log scale.\n */\nexport class D3LRFinder {\n  private svg: d3.Selection<SVGSVGElement, unknown, null, undefined>;\n  private width: number;\n  private height: number;\n  private margin = { top: 10, right: 10, bottom: 35, left: 45 };\n\n  constructor(container: HTMLElement) {\n    const rect = container.getBoundingClientRect();\n    this.width = rect.width || 300;\n    this.height = rect.height || 150;\n\n    // Clear existing content\n    d3.select(container).selectAll('*').remove();\n\n    this.svg = d3.select(container)\n      .append('svg')\n      .attr('width', '100%')\n      .attr('height', '100%')\n      .attr('viewBox', `0 0 ${this.width} ${this.height}`)\n      .attr('preserveAspectRatio', 'xMidYMid meet');\n  }\n\n  /**\n   * Renders the LR finder results.\n   */\n  render(points: LRFinderPoint[], suggestedLR?: number): void {\n    if (points.length === 0) return;\n\n    const innerWidth = this.width - this.margin.left - this.margin.right;\n    const innerHeight = this.height - this.margin.top - this.margin.bottom;\n\n    // Clear previous content\n    this.svg.selectAll('*').remove();\n\n    const g = this.svg.append('g')\n      .attr('transform', `translate(${this.margin.left},${this.margin.top})`);\n\n    // Filter out invalid points\n    const validPoints = points.filter(p => p.loss > 0 && isFinite(p.loss) && p.lr > 0);\n    if (validPoints.length === 0) return;\n\n    // Scales (log scale for LR)\n    const xExtent = d3.extent(validPoints, d => d.lr) as [number, number];\n    const yExtent = d3.extent(validPoints, d => d.loss) as [number, number];\n\n    const x = d3.scaleLog()\n      .domain([xExtent[0] * 0.9, xExtent[1] * 1.1])\n      .range([0, innerWidth]);\n\n    const y = d3.scaleLinear()\n      .domain([yExtent[0] * 0.9, yExtent[1] * 1.1])\n      .range([innerHeight, 0]);\n\n    // Draw line\n    const line = d3.line<LRFinderPoint>()\n      .x(d => x(d.lr))\n      .y(d => y(d.loss))\n      .curve(d3.curveMonotoneX);\n\n    g.append('path')\n      .datum(validPoints)\n      .attr('fill', 'none')\n      .attr('stroke', 'var(--accent-500)')\n      .attr('stroke-width', 2)\n      .attr('d', line);\n\n    // Draw suggested LR line if provided\n    if (suggestedLR && suggestedLR >= xExtent[0] && suggestedLR <= xExtent[1]) {\n      g.append('line')\n        .attr('x1', x(suggestedLR))\n        .attr('y1', 0)\n        .attr('x2', x(suggestedLR))\n        .attr('y2', innerHeight)\n        .attr('stroke', '#22c55e')\n        .attr('stroke-width', 2)\n        .attr('stroke-dasharray', '4,4');\n\n      g.append('text')\n        .attr('x', x(suggestedLR) + 5)\n        .attr('y', 15)\n        .attr('fill', '#22c55e')\n        .attr('font-size', '10px')\n        .text(`Best: ${suggestedLR.toExponential(1)}`);\n    }\n\n    // X axis (log scale)\n    const xAxis = d3.axisBottom(x)\n      .ticks(5, '.0e');\n\n    g.append('g')\n      .attr('transform', `translate(0,${innerHeight})`)\n      .call(xAxis)\n      .selectAll('text')\n      .attr('fill', 'var(--text-secondary)')\n      .attr('font-size', '9px');\n\n    g.selectAll('.domain, .tick line')\n      .attr('stroke', 'var(--border-color)');\n\n    // Y axis\n    g.append('g')\n      .call(d3.axisLeft(y).ticks(5))\n      .selectAll('text')\n      .attr('fill', 'var(--text-secondary)')\n      .attr('font-size', '9px');\n\n    // Axis labels\n    g.append('text')\n      .attr('x', innerWidth / 2)\n      .attr('y', innerHeight + 30)\n      .attr('text-anchor', 'middle')\n      .attr('fill', 'var(--text-secondary)')\n      .attr('font-size', '10px')\n      .text('Learning Rate');\n\n    g.append('text')\n      .attr('transform', 'rotate(-90)')\n      .attr('x', -innerHeight / 2)\n      .attr('y', -35)\n      .attr('text-anchor', 'middle')\n      .attr('fill', 'var(--text-secondary)')\n      .attr('font-size', '10px')\n      .text('Loss');\n  }\n\n  /**\n   * Clears the chart.\n   */\n  clear(): void {\n    this.svg.selectAll('*').remove();\n  }\n}\n\n/**\n * Finds the optimal learning rate by analyzing the loss curve.\n * Returns the LR where loss decreases fastest (steepest gradient).\n */\nexport function findOptimalLR(points: LRFinderPoint[]): number | null {\n  if (points.length < 10) return null;\n\n  // Filter valid points\n  const valid = points.filter(p => p.loss > 0 && isFinite(p.loss) && p.lr > 0);\n  if (valid.length < 10) return null;\n\n  // Find point with steepest negative gradient\n  let bestIdx = 0;\n  let bestGradient = 0;\n\n  for (let i = 1; i < valid.length - 1; i++) {\n    const prev = valid[i - 1];\n    const curr = valid[i];\n    const next = valid[i + 1];\n    \n    if (!prev || !curr || !next) continue;\n\n    // Calculate gradient (loss change per log LR change)\n    const logLRDiff = Math.log10(next.lr) - Math.log10(prev.lr);\n    const lossDiff = next.loss - prev.loss;\n    const gradient = lossDiff / logLRDiff;\n\n    // We want the most negative gradient (fastest decrease)\n    if (gradient < bestGradient) {\n      bestGradient = gradient;\n      bestIdx = i;\n    }\n  }\n\n  // Return LR slightly before the steepest point (safer)\n  const optimalIdx = Math.max(0, bestIdx - 2);\n  return valid[optimalIdx]?.lr ?? null;\n}\n","import { TrainingSession } from '../../core/application/TrainingSession';\nimport { D3LRFinder, findOptimalLR } from '../../infrastructure/d3/D3LRFinder';\nimport { toast } from '../toast';\nimport { safeHTML } from '../../infrastructure/security/htmlSanitizer';\n\nexport interface ResearchElements {\n    btnLrFinder: HTMLButtonElement;\n    btnStopLrFinder: HTMLButtonElement;\n    lrFinderContainer: HTMLDivElement;\n    lrFinderResult: HTMLDivElement;\n    lrFinderPanel: HTMLDivElement;\n    inputLr: HTMLInputElement;\n}\n\nexport class ResearchController {\n    private lrFinderViz: D3LRFinder;\n\n    constructor(\n        private session: TrainingSession,\n        private elements: ResearchElements\n    ) {\n        this.lrFinderViz = new D3LRFinder(elements.lrFinderContainer);\n        this.bindEvents();\n    }\n\n    private bindEvents(): void {\n        this.elements.btnLrFinder.addEventListener('click', () => void this.handleLRFinder());\n        if (this.elements.btnStopLrFinder) {\n            this.elements.btnStopLrFinder.addEventListener('click', () => this.handleStopLRFinder());\n        }\n    }\n\n    private async handleLRFinder(): Promise<void> {\n        const state = this.session.getState();\n        if (!state.datasetLoaded) {\n            toast.warning('Please load a dataset first');\n            return;\n        }\n\n        if (state.isRunning) {\n            toast.warning('Please stop training first');\n            return;\n        }\n\n        // Show container\n        this.elements.lrFinderContainer.classList.remove('hidden');\n        this.elements.lrFinderResult.classList.add('hidden');\n        if (this.elements.lrFinderPanel) {\n            this.elements.lrFinderPanel.classList.remove('hidden');\n        }\n\n        toast.info('Running Learning Rate Finder...');\n\n        try {\n            const history = await this.session.runLRFinder(1e-5, 1.0, 50);\n\n            // Visualize\n            this.lrFinderViz.render(history);\n\n            // Find optimal LR\n            const optimalLR = findOptimalLR(history);\n\n            if (optimalLR) {\n                this.elements.lrFinderResult.classList.remove('hidden');\n                this.elements.lrFinderResult.innerHTML = safeHTML`\n          <div class=\"flex items-center justify-between\">\n            <span>Optimal LR found: <strong>${optimalLR.toExponential(2)}</strong></span>\n            <button id=\"btn-apply-lr\" class=\"px-2 py-1 text-xs bg-blue-600 hover:bg-blue-500 rounded text-white\">\n              Apply\n            </button>\n          </div>\n        `;\n\n                // Bind apply button\n                const btnApply = document.getElementById('btn-apply-lr');\n                if (btnApply) {\n                    btnApply.addEventListener('click', () => {\n                        this.elements.inputLr.value = optimalLR.toString();\n                        toast.success(`Applied learning rate: ${optimalLR.toExponential(2)}`);\n                    });\n                }\n\n                toast.success(`LR Finder complete. Optimal: ${optimalLR.toExponential(2)}`);\n            } else {\n                toast.warning('Could not determine optimal LR');\n            }\n\n        } catch (error) {\n            console.error('LR Finder failed:', error);\n            toast.error('LR Finder failed');\n        }\n    }\n\n    private handleStopLRFinder(): void {\n        // In a real implementation, we would cancel the LR finder process\n        this.clear();\n        toast.info('LR Finder stopped');\n    }\n\n    public clear(): void {\n        this.elements.lrFinderContainer.classList.add('hidden');\n        this.elements.lrFinderResult.classList.add('hidden');\n        if (this.elements.lrFinderPanel) {\n            this.elements.lrFinderPanel.classList.add('hidden');\n        }\n        this.lrFinderViz.clear();\n    }\n}\n","/**\n * Safe DOM element utilities\n * Provides defensive element access to prevent crashes from missing elements\n */\n\n/**\n * Safely get an element by ID with type checking and logging\n */\nexport function safeGetElement<T extends HTMLElement>(\n    id: string,\n    elementType?: string\n): T | null {\n    const element = document.getElementById(id);\n\n    if (!element) {\n        console.warn(`[DOM] Missing element: #${id}${elementType ? ` (expected ${elementType})` : ''}`);\n        return null;\n    }\n\n    return element as T;\n}\n\n/**\n * Get element or throw error if critical\n */\nexport function getRequiredElement<T extends HTMLElement>(\n    id: string,\n    elementType?: string\n): T {\n    const element = safeGetElement<T>(id, elementType);\n\n    if (!element) {\n        throw new Error(`Critical element missing: #${id}`);\n    }\n\n    return element;\n}\n\n/**\n * Batch get elements with validation\n */\nexport function getElements<T extends Record<string, HTMLElement>>(\n    elementMap: Record<keyof T, string>,\n    required: (keyof T)[] = []\n): Partial<T> {\n    const elements: Partial<T> = {};\n    const missing: string[] = [];\n\n    for (const [key, id] of Object.entries(elementMap)) {\n        const element = document.getElementById(id);\n\n        if (!element) {\n            if (required.includes(key as keyof T)) {\n                missing.push(id);\n            }\n            console.warn(`[DOM] Missing element: #${id} (${String(key)})`);\n        } else {\n            elements[key as keyof T] = element as T[keyof T];\n        }\n    }\n\n    if (missing.length > 0) {\n        throw new Error(`Critical elements missing: ${missing.join(', ')}`);\n    }\n\n    return elements;\n}\n\n/**\n * Check if element exists without retrieving it\n */\nexport function elementExists(id: string): boolean {\n    return document.getElementById(id) !== null;\n}\n","/**\n * UIFactory - Centralized DOM element queries for controller initialization\n *\n * This factory provides type-safe access to DOM elements required by various controllers.\n * It uses safe element access utilities to handle missing elements gracefully.\n */\n\nimport { safeGetElement, getRequiredElement } from './dom';\nimport type {\n  DatasetElements,\n  TrainingElements,\n  VisualizationElements,\n  ExportElements,\n  SessionElements,\n  ComparisonElements,\n  ResearchElements,\n} from '../presentation/controllers';\n\n/**\n * Get all DOM elements required by the DatasetController\n */\nexport function getDatasetElements(): DatasetElements {\n  return {\n    datasetSelect: getRequiredElement<HTMLSelectElement>('dataset-select', 'HTMLSelectElement'),\n    btnLoadData: getRequiredElement<HTMLButtonElement>('btn-load-data', 'HTMLButtonElement'),\n    loadingOverlay: safeGetElement<HTMLDivElement>('loading-overlay') || document.createElement('div'),\n    drawControls: safeGetElement<HTMLDivElement>('draw-controls') || document.createElement('div'),\n    btnClearCustom: safeGetElement<HTMLButtonElement>('btn-clear-custom') || document.createElement('button'),\n    datasetOptions: safeGetElement<HTMLDivElement>('dataset-options') || document.createElement('div'),\n    inputSamples: getRequiredElement<HTMLInputElement>('input-samples', 'HTMLInputElement'),\n    samplesValue: getRequiredElement<HTMLSpanElement>('samples-value', 'HTMLSpanElement'),\n    inputNoise: getRequiredElement<HTMLInputElement>('input-noise', 'HTMLInputElement'),\n    noiseValue: getRequiredElement<HTMLSpanElement>('noise-value', 'HTMLSpanElement'),\n    inputBalance: safeGetElement<HTMLInputElement>('input-balance') || document.createElement('input'),\n    balanceValue: safeGetElement<HTMLSpanElement>('balance-value') || document.createElement('span'),\n    inputPreprocessing: safeGetElement<HTMLSelectElement>('input-preprocessing') || document.createElement('select'),\n    inputNumClasses: getRequiredElement<HTMLSelectElement>('input-num-classes', 'HTMLSelectElement'),\n    drawClassButtons: safeGetElement<HTMLDivElement>('draw-class-buttons') || document.createElement('div'),\n    inputCsvUpload: safeGetElement<HTMLInputElement>('input-csv-upload') || document.createElement('input'),\n    btnDownloadDataset: safeGetElement<HTMLButtonElement>('btn-download-dataset') || document.createElement('button'),\n  };\n}\n\n/**\n * Get all DOM elements required by the TrainingController\n */\nexport function getTrainingElements(): TrainingElements {\n  return {\n    btnInit: document.getElementById('btn-init') as HTMLButtonElement,\n    btnStart: document.getElementById('btn-start') as HTMLButtonElement,\n    btnStep: document.getElementById('btn-step') as HTMLButtonElement,\n    btnReset: document.getElementById('btn-reset') as HTMLButtonElement,\n    inputLayers: document.getElementById('input-layers') as HTMLInputElement,\n    inputLayerActivations: document.getElementById('input-layer-activations') as HTMLInputElement,\n    inputLr: document.getElementById('input-lr') as HTMLInputElement,\n    inputOptimizer: document.getElementById('input-optimizer') as HTMLSelectElement,\n    inputMomentum: document.getElementById('input-momentum') as HTMLInputElement,\n    inputActivation: document.getElementById('input-activation') as HTMLSelectElement,\n    inputL1: document.getElementById('input-l1') as HTMLInputElement,\n    inputL2: document.getElementById('input-l2') as HTMLInputElement,\n    inputNumClasses: document.getElementById('input-num-classes') as HTMLSelectElement,\n    inputDropout: document.getElementById('input-dropout') as HTMLSelectElement,\n    inputClipNorm: document.getElementById('input-clip-norm') as HTMLSelectElement,\n    inputBatchNorm: document.getElementById('input-batch-norm') as HTMLInputElement,\n    inputBatchSize: document.getElementById('input-batch-size') as HTMLInputElement,\n    inputMaxEpochs: document.getElementById('input-max-epochs') as HTMLInputElement,\n    epochValue: document.getElementById('status-epoch') as HTMLElement,\n    lossValue: document.getElementById('status-loss') as HTMLElement,\n    accuracyValue: document.getElementById('status-accuracy') as HTMLElement,\n    valLossValue: document.getElementById('status-val-loss') as HTMLElement,\n    valAccuracyValue: document.getElementById('status-val-accuracy') as HTMLElement,\n    stateDisplay: document.getElementById('status-state') as HTMLElement,\n    suggestionsPanel: document.getElementById('suggestions-panel') as HTMLDivElement,\n    suggestionsList: document.getElementById('suggestions-list') as HTMLDivElement,\n    momentumValue: document.getElementById('momentum-value') as HTMLSpanElement,\n    momentumControl: document.getElementById('momentum-control') as HTMLDivElement,\n    inputFps: document.getElementById('input-fps') as HTMLInputElement,\n    fpsValue: document.getElementById('fps-value') as HTMLSpanElement,\n    inputLrSchedule: document.getElementById('input-lr-schedule') as HTMLSelectElement,\n    inputWarmup: document.getElementById('input-warmup') as HTMLInputElement,\n    inputCycleLength: document.getElementById('input-cycle-length') as HTMLInputElement,\n    inputMinLr: document.getElementById('input-min-lr') as HTMLInputElement,\n    inputEarlyStop: document.getElementById('input-early-stop') as HTMLInputElement,\n    cyclicLrControls: document.getElementById('cyclic-lr-controls') as HTMLDivElement,\n    inputValSplit: document.getElementById('input-val-split') as HTMLSelectElement,\n    inputTargetFps: document.getElementById('input-perf-mode') as HTMLSelectElement,\n    btnStartSticky: document.getElementById('btn-start-sticky') as HTMLButtonElement,\n    btnPauseSticky: document.getElementById('btn-pause-sticky') as HTMLButtonElement,\n    btnStepSticky: document.getElementById('btn-step-sticky') as HTMLButtonElement,\n    btnResetSticky: document.getElementById('btn-reset-sticky') as HTMLButtonElement,\n    fabStart: document.getElementById('fab-start') as HTMLButtonElement,\n    fabPause: document.getElementById('fab-pause') as HTMLButtonElement,\n    btnPause: document.getElementById('btn-pause') as HTMLButtonElement,\n  };\n}\n\n/**\n * Get all DOM elements required by the VisualizationController\n */\nexport function getVisualizationElements(): VisualizationElements {\n  return {\n    inputColourScheme: document.getElementById('input-colour-scheme') as HTMLSelectElement,\n    inputPointSize: document.getElementById('input-point-size') as HTMLInputElement,\n    inputOpacity: document.getElementById('input-opacity') as HTMLInputElement,\n    opacityValue: document.getElementById('opacity-value') as HTMLSpanElement,\n    inputContours: document.getElementById('input-contours') as HTMLInputElement,\n    contourValue: document.getElementById('contour-value') as HTMLSpanElement,\n    inputZoom: document.getElementById('input-zoom') as HTMLInputElement,\n    inputTooltips: document.getElementById('input-tooltips') as HTMLInputElement,\n    inputHighlightErrors: document.getElementById('input-highlight-errors') as HTMLInputElement,\n    inputConfidenceCircles: document.getElementById('input-confidence-circles') as HTMLInputElement,\n    inputNotifications: document.getElementById('input-notifications') as HTMLInputElement,\n    inputRecordEvolution: document.getElementById('input-record-evolution') as HTMLInputElement,\n    inputShowGrid: document.getElementById('input-show-grid') as HTMLInputElement,\n    inputShowDiscretized: document.getElementById('input-show-discretized') as HTMLInputElement,\n    inputVoronoi: document.getElementById('input-voronoi') as HTMLInputElement,\n    inputMisclassified: document.getElementById('input-misclassified') as HTMLInputElement,\n    inputConfidence: document.getElementById('input-confidence') as HTMLInputElement,\n    gradientFlowChart: document.getElementById('gradient-flow-chart') as HTMLDivElement,\n    confusionMatrix: document.getElementById('confusion-matrix') as HTMLDivElement,\n    weightHistogram: document.getElementById('weight-histogram') as HTMLDivElement,\n    rocCurve: document.getElementById('roc-curve') as HTMLDivElement,\n    input3dView: document.getElementById('input-3d-view') as HTMLInputElement,\n    threeContainer: document.getElementById('three-container') as HTMLDivElement,\n    btn3dReset: document.getElementById('btn-3d-reset') as HTMLButtonElement,\n    btn3dTop: document.getElementById('btn-3d-top') as HTMLButtonElement,\n    btn3dSide: document.getElementById('btn-3d-side') as HTMLButtonElement,\n    inputShowGradients: document.getElementById('input-show-gradients') as HTMLInputElement,\n    gradientFlowContainer: document.getElementById('gradient-flow-container') as HTMLDivElement,\n    inputShowActivations: document.getElementById('input-show-activations') as HTMLInputElement,\n    activationHeatmap: document.getElementById('activation-heatmap') as HTMLDivElement,\n    activationHint: document.getElementById('activation-hint') as HTMLParagraphElement,\n  };\n}\n\n/**\n * Get all DOM elements required by the ExportController\n */\nexport function getExportElements(): ExportElements {\n  return {\n    btnExportJson: document.getElementById('btn-export-json') as HTMLButtonElement,\n    btnExportCsv: document.getElementById('btn-export-csv') as HTMLButtonElement,\n    btnExportPng: document.getElementById('btn-export-png') as HTMLButtonElement,\n    btnExportSvg: document.getElementById('btn-export-svg') as HTMLButtonElement,\n    btnScreenshot: document.getElementById('btn-screenshot') as HTMLButtonElement,\n    btnExportModel: document.getElementById('btn-export-model') as HTMLButtonElement,\n    btnExportPython: document.getElementById('btn-export-python') as HTMLButtonElement,\n    btnExportOnnx: document.getElementById('btn-export-onnx') as HTMLButtonElement,\n    inputLoadModel: document.getElementById('input-load-model') as HTMLInputElement,\n    inputLoadWeights: document.getElementById('input-load-weights') as HTMLInputElement,\n    inputLayers: document.getElementById('input-layers') as HTMLInputElement,\n    inputLayerActivations: document.getElementById('input-layer-activations') as HTMLInputElement,\n    inputLr: document.getElementById('input-lr') as HTMLInputElement,\n    inputOptimizer: document.getElementById('input-optimizer') as HTMLSelectElement,\n    inputMomentum: document.getElementById('input-momentum') as HTMLInputElement,\n    inputActivation: document.getElementById('input-activation') as HTMLSelectElement,\n    inputL1: document.getElementById('input-l1') as HTMLInputElement,\n    inputL2: document.getElementById('input-l2') as HTMLInputElement,\n    inputNumClasses: document.getElementById('input-num-classes') as HTMLSelectElement,\n    inputDropout: document.getElementById('input-dropout') as HTMLSelectElement,\n    inputClipNorm: document.getElementById('input-clip-norm') as HTMLSelectElement,\n    inputBatchNorm: document.getElementById('input-batch-norm') as HTMLInputElement,\n    inputLrSchedule: document.getElementById('input-lr-schedule') as HTMLSelectElement,\n    inputWarmup: document.getElementById('input-warmup') as HTMLInputElement,\n    inputCycleLength: document.getElementById('input-cycle-length') as HTMLInputElement,\n    inputMinLr: document.getElementById('input-min-lr') as HTMLInputElement,\n    inputSamples: document.getElementById('input-samples') as HTMLInputElement,\n    inputNoise: document.getElementById('input-noise') as HTMLInputElement,\n    datasetSelect: document.getElementById('dataset-select') as HTMLSelectElement,\n    inputBatchSize: document.getElementById('input-batch-size') as HTMLInputElement,\n    inputMaxEpochs: document.getElementById('input-max-epochs') as HTMLInputElement,\n    inputValSplit: document.getElementById('input-val-split') as HTMLSelectElement,\n  };\n}\n\n/**\n * Get all DOM elements required by the SessionController\n */\nexport function getSessionElements(): SessionElements {\n  return {\n    btnSaveSession: document.getElementById('btn-save-session') as HTMLButtonElement,\n    btnLoadSession: document.getElementById('btn-load-session') as HTMLButtonElement,\n    btnShareUrl: document.getElementById('btn-share-url') as HTMLButtonElement,\n    btnLoadConfig: document.getElementById('btn-load-config') as HTMLButtonElement,\n    btnClearSession: document.getElementById('btn-clear-session') as HTMLButtonElement,\n    inputBookmarkName: document.getElementById('input-bookmark-name') as HTMLInputElement,\n    btnSaveBookmark: document.getElementById('btn-save-bookmark') as HTMLButtonElement,\n    bookmarkOptions: document.getElementById('bookmark-options') as HTMLDivElement,\n    btnDeleteBookmark: document.getElementById('btn-delete-bookmark') as HTMLButtonElement,\n    presetSelect: document.getElementById('preset-select') as HTMLSelectElement,\n    iconSun: document.getElementById('icon-sun') as HTMLElement,\n    iconMoon: document.getElementById('icon-moon') as HTMLElement,\n    btnThemeToggle: document.getElementById('btn-theme-toggle') as HTMLButtonElement,\n    datasetSelect: document.getElementById('dataset-select') as HTMLSelectElement,\n    inputSamples: document.getElementById('input-samples') as HTMLInputElement,\n    samplesValue: document.getElementById('samples-value') as HTMLSpanElement,\n    inputNoise: document.getElementById('input-noise') as HTMLInputElement,\n    noiseValue: document.getElementById('noise-value') as HTMLSpanElement,\n    inputNumClasses: document.getElementById('input-num-classes') as HTMLSelectElement,\n    inputLr: document.getElementById('input-lr') as HTMLInputElement,\n    inputLayers: document.getElementById('input-layers') as HTMLInputElement,\n    inputOptimizer: document.getElementById('input-optimizer') as HTMLSelectElement,\n    inputActivation: document.getElementById('input-activation') as HTMLSelectElement,\n    inputL2: document.getElementById('input-l2') as HTMLInputElement,\n    inputBatchSize: document.getElementById('input-batch-size') as HTMLInputElement,\n    inputMaxEpochs: document.getElementById('input-max-epochs') as HTMLInputElement,\n    inputFps: document.getElementById('input-target-fps') as HTMLInputElement,\n    fpsValue: document.getElementById('fps-value') as HTMLSpanElement,\n    inputValSplit: document.getElementById('input-val-split') as HTMLSelectElement,\n    inputColourScheme: document.getElementById('input-colour-scheme') as HTMLSelectElement,\n    inputPointSize: document.getElementById('input-point-radius') as HTMLInputElement,\n    inputOpacity: document.getElementById('input-boundary-opacity') as HTMLInputElement,\n    opacityValue: document.getElementById('boundary-opacity-value') as HTMLSpanElement,\n    inputZoom: document.getElementById('input-zoom') as HTMLInputElement,\n    inputTooltips: document.getElementById('input-tooltips') as HTMLInputElement,\n    inputBalance: document.getElementById('input-balance') as HTMLInputElement,\n    balanceValue: document.getElementById('balance-value') as HTMLSpanElement,\n    inputMomentum: document.getElementById('input-momentum') as HTMLInputElement,\n    momentumValue: document.getElementById('momentum-value') as HTMLSpanElement,\n    inputL1: document.getElementById('input-l1') as HTMLInputElement,\n    inputDropout: document.getElementById('input-dropout') as HTMLSelectElement,\n    inputClipNorm: document.getElementById('input-clip-norm') as HTMLSelectElement,\n    inputBatchNorm: document.getElementById('input-batch-norm') as HTMLInputElement,\n    inputLrSchedule: document.getElementById('input-lr-schedule') as HTMLSelectElement,\n    inputWarmup: document.getElementById('input-warmup') as HTMLInputElement,\n    inputCycleLength: document.getElementById('input-cycle-length') as HTMLInputElement,\n    inputMinLr: document.getElementById('input-min-lr') as HTMLInputElement,\n    momentumControl: document.getElementById('momentum-control') as HTMLDivElement,\n  };\n}\n\n/**\n * Get all DOM elements required by the ComparisonController\n */\nexport function getComparisonElements(): ComparisonElements {\n  return {\n    comparisonPanel: document.getElementById('comparison-metrics') as HTMLDivElement,\n    baselineAccuracy: document.getElementById('baseline-accuracy') as HTMLSpanElement,\n    baselineLoss: document.getElementById('baseline-loss') as HTMLSpanElement,\n    baselineConfig: document.getElementById('baseline-config') as HTMLSpanElement,\n    currentAccuracy: document.getElementById('current-accuracy') as HTMLSpanElement,\n    currentLoss: document.getElementById('current-loss') as HTMLSpanElement,\n    comparisonDiff: document.getElementById('comparison-diff') as HTMLSpanElement,\n    btnSaveBaseline: document.getElementById('btn-save-baseline') as HTMLButtonElement,\n    btnClearBaseline: document.getElementById('btn-clear-baseline') as HTMLButtonElement,\n    comparisonMetrics: document.getElementById('comparison-metrics') as HTMLDivElement,\n    baselineMetrics: document.getElementById('baseline-metrics') as HTMLDivElement,\n    inputLayers: document.getElementById('input-layers') as HTMLInputElement,\n    inputOptimizer: document.getElementById('input-optimizer') as HTMLSelectElement,\n    inputLr: document.getElementById('input-lr') as HTMLInputElement,\n    inputActivation: document.getElementById('input-activation') as HTMLSelectElement,\n    inputNumClasses: document.getElementById('input-num-classes') as HTMLSelectElement,\n    inputValSplit: document.getElementById('input-val-split') as HTMLInputElement,\n    abComparisonPanel: document.getElementById('ab-comparison-panel') as HTMLDivElement,\n    abEpochA: document.getElementById('ab-epoch-a') as HTMLSpanElement,\n    abAccuracyA: document.getElementById('ab-accuracy-a') as HTMLSpanElement,\n    abLossA: document.getElementById('ab-loss-a') as HTMLSpanElement,\n    abEpochB: document.getElementById('ab-epoch-b') as HTMLSpanElement,\n    abAccuracyB: document.getElementById('ab-accuracy-b') as HTMLSpanElement,\n    abLossB: document.getElementById('ab-loss-b') as HTMLSpanElement,\n    abWinner: document.getElementById('ab-winner') as HTMLDivElement,\n    abLrA: document.getElementById('ab-lr-a') as HTMLInputElement,\n    abActivationA: document.getElementById('ab-activation-a') as HTMLSelectElement,\n    abOptimizerA: document.getElementById('ab-optimizer-a') as HTMLSelectElement,\n    abLrB: document.getElementById('ab-lr-b') as HTMLInputElement,\n    abActivationB: document.getElementById('ab-activation-b') as HTMLSelectElement,\n    abOptimizerB: document.getElementById('ab-optimizer-b') as HTMLSelectElement,\n    abEpochs: document.getElementById('ab-epochs') as HTMLInputElement,\n    btnStartAbTest: document.getElementById('btn-start-ab') as HTMLButtonElement,\n    btnStopAbTest: document.getElementById('btn-stop-ab') as HTMLButtonElement,\n    ensemblePanel: document.getElementById('ensemble-panel') as HTMLDivElement,\n    ensembleMemberCount: document.getElementById('ensemble-member-count') as HTMLSpanElement,\n    ensembleEpoch: document.getElementById('ensemble-epoch') as HTMLSpanElement,\n    ensembleMembers: document.getElementById('ensemble-members') as HTMLDivElement,\n    btnAddEnsembleMember: document.getElementById('btn-add-ensemble-member') as HTMLButtonElement,\n    btnTrainEnsemble: document.getElementById('btn-train-ensemble') as HTMLButtonElement,\n    btnResetEnsemble: document.getElementById('btn-stop-ensemble') as HTMLButtonElement,\n  };\n}\n\n/**\n * Get all DOM elements required by the ResearchController\n */\nexport function getResearchElements(): ResearchElements {\n  return {\n    btnLrFinder: document.getElementById('btn-lr-finder') as HTMLButtonElement,\n    btnStopLrFinder: document.getElementById('btn-stop-lr-finder') as HTMLButtonElement,\n    lrFinderContainer: document.getElementById('lr-finder-container') as HTMLDivElement,\n    lrFinderResult: document.getElementById('lr-finder-result') as HTMLDivElement,\n    lrFinderPanel: document.getElementById('lr-finder-panel') as HTMLDivElement,\n    inputLr: document.getElementById('input-lr') as HTMLInputElement,\n  };\n}","export function setupSidebarTabs(): void {\n    const tabs = document.querySelectorAll('.sidebar-tab');\n    const panels = document.querySelectorAll('.sidebar-panel');\n\n    tabs.forEach(tab => {\n        tab.addEventListener('click', () => {\n            const targetId = tab.getAttribute('data-target');\n            if (!targetId) return;\n\n            // Update active tab\n            tabs.forEach(t => t.classList.remove('active'));\n            tab.classList.add('active');\n\n            // Show target panel\n            panels.forEach(panel => {\n                if (panel.id === targetId) {\n                    panel.classList.remove('hidden');\n                } else {\n                    panel.classList.add('hidden');\n                }\n            });\n        });\n    });\n}\n","export function setupTouchGestures(): void {\n    let touchStartX = 0;\n    let touchStartY = 0;\n\n    document.addEventListener('touchstart', (e) => {\n        if (e.touches.length > 0) {\n            const touch = e.touches[0];\n            if (touch) {\n                touchStartX = touch.screenX;\n                touchStartY = touch.screenY;\n            }\n        }\n    }, { passive: true });\n\n    document.addEventListener('touchend', (e) => {\n        if (e.changedTouches.length > 0) {\n            const touch = e.changedTouches[0];\n            if (touch) {\n                const touchEndX = touch.screenX;\n                const touchEndY = touch.screenY;\n                handleGesture(touchStartX, touchStartY, touchEndX, touchEndY);\n            }\n        }\n    }, { passive: true });\n}\n\nfunction handleGesture(startX: number, startY: number, endX: number, endY: number): void {\n    const diffX = endX - startX;\n    const diffY = endY - startY;\n    const threshold = 50;\n\n    if (Math.abs(diffX) > Math.abs(diffY)) {\n        // Horizontal swipe\n        if (Math.abs(diffX) > threshold) {\n            if (diffX > 0) {\n                // Swipe Right\n                document.dispatchEvent(new CustomEvent('swipe-right'));\n            } else {\n                // Swipe Left\n                document.dispatchEvent(new CustomEvent('swipe-left'));\n            }\n        }\n    } else {\n        // Vertical swipe\n        if (Math.abs(diffY) > threshold) {\n            if (diffY > 0) {\n                // Swipe Down\n                document.dispatchEvent(new CustomEvent('swipe-down'));\n            } else {\n                // Swipe Up\n                document.dispatchEvent(new CustomEvent('swipe-up'));\n            }\n        }\n    }\n}\n","export function setupBottomSheet(): void {\n    const sheet = document.getElementById('bottom-sheet');\n    const handle = document.getElementById('bottom-sheet-handle');\n    const overlay = document.getElementById('bottom-sheet-overlay');\n\n    if (!sheet || !handle || !overlay) return;\n\n    let startY = 0;\n    let currentY = 0;\n    let isDragging = false;\n\n    handle.addEventListener('touchstart', (e) => {\n        if (e.touches.length > 0) {\n            const touch = e.touches[0];\n            if (touch) {\n                startY = touch.clientY;\n                isDragging = true;\n                sheet.style.transition = 'none';\n            }\n        }\n    }, { passive: true });\n\n    document.addEventListener('touchmove', (e) => {\n        if (!isDragging) return;\n        if (e.touches.length > 0) {\n            const touch = e.touches[0];\n            if (touch) {\n                currentY = touch.clientY;\n                const diff = currentY - startY;\n\n                if (diff > 0) {\n                    sheet.style.transform = `translateY(${diff}px)`;\n                }\n            }\n        }\n    }, { passive: true });\n\n    document.addEventListener('touchend', () => {\n        if (!isDragging) return;\n        isDragging = false;\n        sheet.style.transition = 'transform 0.3s ease-out';\n\n        const diff = currentY - startY;\n        if (diff > 100) {\n            // Close sheet\n            closeBottomSheet();\n        } else {\n            // Reset\n            sheet.style.transform = 'translateY(0)';\n        }\n    });\n\n    overlay.addEventListener('click', closeBottomSheet);\n}\n\nexport function openBottomSheet(): void {\n    const sheet = document.getElementById('bottom-sheet');\n    const overlay = document.getElementById('bottom-sheet-overlay');\n\n    if (sheet && overlay) {\n        sheet.classList.remove('translate-y-full');\n        overlay.classList.remove('hidden');\n    }\n}\n\nexport function closeBottomSheet(): void {\n    const sheet = document.getElementById('bottom-sheet');\n    const overlay = document.getElementById('bottom-sheet-overlay');\n\n    if (sheet && overlay) {\n        sheet.classList.add('translate-y-full');\n        sheet.style.transform = '';\n        overlay.classList.add('hidden');\n    }\n}\n","/**\n * Interactive tutorial system for guiding users through NeuroViz features.\n */\n\nexport interface TutorialStep {\n  id: string;\n  title: string;\n  content: string;\n  target?: string; // CSS selector for element to highlight\n  position?: 'top' | 'bottom' | 'left' | 'right';\n  action?: () => void | Promise<void>; // Action to perform when step is shown\n  waitFor?: string; // CSS selector - wait for this element to exist\n}\n\nexport interface Tutorial {\n  id: string;\n  name: string;\n  description: string;\n  steps: TutorialStep[];\n}\n\n// Built-in tutorials\nexport const TUTORIALS: Tutorial[] = [\n  {\n    id: 'getting-started',\n    name: 'Getting Started',\n    description: 'Learn the basics of NeuroViz',\n    steps: [\n      {\n        id: 'welcome',\n        title: 'Welcome to NeuroViz! ',\n        content: 'This interactive tutorial will guide you through the basics of training neural networks and visualizing decision boundaries.',\n        position: 'bottom',\n      },\n      {\n        id: 'dataset',\n        title: 'Step 1: Choose a Dataset',\n        content: 'Start by selecting a dataset. Try \"Circle\" for a simple classification problem, or \"Spiral\" for something more challenging.',\n        target: '#dataset-select',\n        position: 'right',\n      },\n      {\n        id: 'load-data',\n        title: 'Step 2: Load the Data',\n        content: 'Click \"Load Data\" to generate the dataset. You\\'ll see the data points appear on the chart.',\n        target: '#btn-load-data',\n        position: 'right',\n      },\n      {\n        id: 'architecture',\n        title: 'Step 3: Configure the Network',\n        content: 'Set the hidden layer sizes. For example, \"8,8\" creates two hidden layers with 8 neurons each. More layers = more complex boundaries.',\n        target: '#input-layers',\n        position: 'right',\n      },\n      {\n        id: 'learning-rate',\n        title: 'Step 4: Set Learning Rate',\n        content: 'The learning rate controls how fast the network learns. Start with 0.03 - too high causes instability, too low is slow.',\n        target: '#input-lr',\n        position: 'right',\n      },\n      {\n        id: 'initialize',\n        title: 'Step 5: Initialize',\n        content: 'Click \"Initialise Network\" to create the neural network with your settings.',\n        target: '#btn-init',\n        position: 'right',\n      },\n      {\n        id: 'train',\n        title: 'Step 6: Start Training!',\n        content: 'Click \"Start\" to begin training. Watch the decision boundary evolve as the network learns!',\n        target: '#btn-start',\n        position: 'right',\n      },\n      {\n        id: 'observe',\n        title: 'Observe the Training',\n        content: 'Watch the loss decrease and accuracy increase. The coloured regions show what the network predicts for each area.',\n        target: '#chart',\n        position: 'left',\n      },\n      {\n        id: 'complete',\n        title: 'Congratulations! ',\n        content: 'You\\'ve trained your first neural network! Try experimenting with different datasets, architectures, and hyperparameters.',\n        position: 'bottom',\n      },\n    ],\n  },\n  {\n    id: 'hyperparameters',\n    name: 'Understanding Hyperparameters',\n    description: 'Learn how each setting affects training',\n    steps: [\n      {\n        id: 'intro',\n        title: 'Hyperparameters Explained',\n        content: 'Hyperparameters are settings that control how your neural network learns. Let\\'s explore each one.',\n        position: 'bottom',\n      },\n      {\n        id: 'layers',\n        title: 'Hidden Layers',\n        content: 'More layers allow the network to learn more complex patterns. \"4,4\" = 2 layers of 4 neurons. \"8,8,8\" = 3 layers of 8.',\n        target: '#input-layers',\n        position: 'right',\n      },\n      {\n        id: 'activation',\n        title: 'Activation Function',\n        content: 'ReLU is fast and works well for most cases. Tanh can be better for data centered around zero. Sigmoid squashes values to 0-1.',\n        target: '#input-activation',\n        position: 'right',\n      },\n      {\n        id: 'optimizer',\n        title: 'Optimizer',\n        content: 'Adam is a good default - it adapts the learning rate automatically. SGD with momentum is simpler but can work well too.',\n        target: '#input-optimizer',\n        position: 'right',\n      },\n      {\n        id: 'regularization',\n        title: 'Regularization',\n        content: 'L1 and L2 regularization prevent overfitting by penalizing large weights. Dropout randomly disables neurons during training.',\n        target: '#input-l2',\n        position: 'right',\n      },\n      {\n        id: 'batch-size',\n        title: 'Batch Size',\n        content: 'Smaller batches = noisier but faster updates. Larger batches = smoother but slower. 0 means use all data each step.',\n        target: '#input-batch-size',\n        position: 'right',\n      },\n      {\n        id: 'experiment',\n        title: 'Experiment!',\n        content: 'The best way to learn is to experiment. Try changing one parameter at a time and observe how it affects training.',\n        position: 'bottom',\n      },\n    ],\n  },\n  {\n    id: 'overfitting',\n    name: 'Recognizing Overfitting',\n    description: 'Learn to identify and fix overfitting',\n    steps: [\n      {\n        id: 'intro',\n        title: 'What is Overfitting?',\n        content: 'Overfitting occurs when your model memorizes the training data instead of learning general patterns. It performs well on training data but poorly on new data.',\n        position: 'bottom',\n      },\n      {\n        id: 'signs',\n        title: 'Signs of Overfitting',\n        content: 'Watch for: training accuracy much higher than validation accuracy, validation loss increasing while training loss decreases.',\n        target: '#loss-chart-container',\n        position: 'left',\n      },\n      {\n        id: 'validation',\n        title: 'Enable Validation Split',\n        content: 'Set a validation split (e.g., 20%) to monitor how well your model generalizes to unseen data.',\n        target: '#input-val-split',\n        position: 'right',\n      },\n      {\n        id: 'fix-dropout',\n        title: 'Fix: Add Dropout',\n        content: 'Dropout randomly disables neurons during training, forcing the network to learn more robust features.',\n        target: '#input-dropout',\n        position: 'right',\n      },\n      {\n        id: 'fix-regularization',\n        title: 'Fix: Add Regularization',\n        content: 'L2 regularization penalizes large weights, encouraging simpler models that generalize better.',\n        target: '#input-l2',\n        position: 'right',\n      },\n      {\n        id: 'fix-simplify',\n        title: 'Fix: Simplify Architecture',\n        content: 'Try using fewer layers or neurons. A simpler model is less likely to overfit.',\n        target: '#input-layers',\n        position: 'right',\n      },\n      {\n        id: 'early-stopping',\n        title: 'Early Stopping',\n        content: 'Enable early stopping to automatically stop training when validation loss stops improving.',\n        target: '#input-early-stopping',\n        position: 'right',\n      },\n    ],\n  },\n];\n\n/**\n * Tutorial manager class.\n */\nexport class TutorialManager {\n  private currentTutorial: Tutorial | null = null;\n  private currentStepIndex = 0;\n  private overlay: HTMLDivElement | null = null;\n  private tooltip: HTMLDivElement | null = null;\n  private onComplete: (() => void) | null = null;\n\n  constructor() {\n    this.createOverlay();\n    this.createTooltip();\n  }\n\n  private createOverlay(): void {\n    this.overlay = document.createElement('div');\n    this.overlay.id = 'tutorial-overlay';\n    this.overlay.className = 'fixed inset-0 bg-black/50 z-40 hidden';\n    this.overlay.innerHTML = `\n      <div id=\"tutorial-highlight\" class=\"absolute border-2 border-accent-400 rounded-lg shadow-lg shadow-accent-400/30 transition-all duration-300\"></div>\n    `;\n    document.body.appendChild(this.overlay);\n  }\n\n  private createTooltip(): void {\n    this.tooltip = document.createElement('div');\n    this.tooltip.id = 'tutorial-tooltip';\n    this.tooltip.className = 'fixed z-50 bg-navy-800 border border-navy-600 rounded-lg shadow-xl p-4 max-w-sm hidden';\n    this.tooltip.innerHTML = `\n      <div class=\"flex items-start justify-between mb-2\">\n        <h3 id=\"tutorial-title\" class=\"text-lg font-semibold text-white\"></h3>\n        <button id=\"tutorial-close\" class=\"text-slate-400 hover:text-white\">\n          <svg class=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n            <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M6 18L18 6M6 6l12 12\" />\n          </svg>\n        </button>\n      </div>\n      <p id=\"tutorial-content\" class=\"text-slate-300 text-sm mb-4\"></p>\n      <div class=\"flex items-center justify-between\">\n        <span id=\"tutorial-progress\" class=\"text-xs text-slate-500\"></span>\n        <div class=\"flex gap-2\">\n          <button id=\"tutorial-prev\" class=\"btn-secondary text-xs px-3 py-1\">Previous</button>\n          <button id=\"tutorial-next\" class=\"btn-primary text-xs px-3 py-1\">Next</button>\n        </div>\n      </div>\n    `;\n    document.body.appendChild(this.tooltip);\n\n    // Bind events\n    document.getElementById('tutorial-close')?.addEventListener('click', () => this.stop());\n    document.getElementById('tutorial-prev')?.addEventListener('click', () => this.prev());\n    document.getElementById('tutorial-next')?.addEventListener('click', () => this.next());\n  }\n\n  /**\n   * Starts a tutorial by ID.\n   */\n  start(tutorialId: string, onComplete?: () => void): boolean {\n    const tutorial = TUTORIALS.find(t => t.id === tutorialId);\n    if (!tutorial) return false;\n\n    this.currentTutorial = tutorial;\n    this.currentStepIndex = 0;\n    this.onComplete = onComplete ?? null;\n\n    this.overlay?.classList.remove('hidden');\n    this.tooltip?.classList.remove('hidden');\n\n    this.showStep();\n    return true;\n  }\n\n  /**\n   * Stops the current tutorial.\n   */\n  stop(): void {\n    this.currentTutorial = null;\n    this.currentStepIndex = 0;\n    this.overlay?.classList.add('hidden');\n    this.tooltip?.classList.add('hidden');\n  }\n\n  /**\n   * Shows the current step.\n   */\n  private showStep(): void {\n    if (!this.currentTutorial || !this.tooltip) return;\n\n    const step = this.currentTutorial.steps[this.currentStepIndex];\n    if (!step) return;\n\n    // Update tooltip content\n    const titleEl = document.getElementById('tutorial-title');\n    const contentEl = document.getElementById('tutorial-content');\n    const progressEl = document.getElementById('tutorial-progress');\n    const prevBtn = document.getElementById('tutorial-prev') as HTMLButtonElement;\n    const nextBtn = document.getElementById('tutorial-next') as HTMLButtonElement;\n\n    if (titleEl) titleEl.textContent = step.title;\n    if (contentEl) contentEl.textContent = step.content;\n    if (progressEl) {\n      progressEl.textContent = `Step ${this.currentStepIndex + 1} of ${this.currentTutorial.steps.length}`;\n    }\n\n    // Update button states\n    if (prevBtn) prevBtn.disabled = this.currentStepIndex === 0;\n    if (nextBtn) {\n      nextBtn.textContent = this.currentStepIndex === this.currentTutorial.steps.length - 1 ? 'Finish' : 'Next';\n    }\n\n    // Position tooltip\n    this.positionTooltip(step);\n\n    // Highlight target element\n    this.highlightTarget(step);\n\n    // Execute action if defined\n    if (step.action) {\n      void step.action();\n    }\n  }\n\n  private positionTooltip(step: TutorialStep): void {\n    if (!this.tooltip) return;\n\n    const target = step.target ? document.querySelector(step.target) : null;\n    const position = step.position ?? 'bottom';\n\n    if (target) {\n      const rect = target.getBoundingClientRect();\n      const tooltipRect = this.tooltip.getBoundingClientRect();\n      const padding = 16;\n\n      let top = 0;\n      let left = 0;\n\n      switch (position) {\n        case 'top':\n          top = rect.top - tooltipRect.height - padding;\n          left = rect.left + (rect.width - tooltipRect.width) / 2;\n          break;\n        case 'bottom':\n          top = rect.bottom + padding;\n          left = rect.left + (rect.width - tooltipRect.width) / 2;\n          break;\n        case 'left':\n          top = rect.top + (rect.height - tooltipRect.height) / 2;\n          left = rect.left - tooltipRect.width - padding;\n          break;\n        case 'right':\n          top = rect.top + (rect.height - tooltipRect.height) / 2;\n          left = rect.right + padding;\n          break;\n      }\n\n      // Keep within viewport\n      top = Math.max(padding, Math.min(window.innerHeight - tooltipRect.height - padding, top));\n      left = Math.max(padding, Math.min(window.innerWidth - tooltipRect.width - padding, left));\n\n      this.tooltip.style.top = `${top}px`;\n      this.tooltip.style.left = `${left}px`;\n    } else {\n      // Center on screen\n      this.tooltip.style.top = '50%';\n      this.tooltip.style.left = '50%';\n      this.tooltip.style.transform = 'translate(-50%, -50%)';\n    }\n  }\n\n  private highlightTarget(step: TutorialStep): void {\n    const highlight = document.getElementById('tutorial-highlight');\n    if (!highlight) return;\n\n    if (step.target) {\n      const target = document.querySelector(step.target);\n      if (target) {\n        const rect = target.getBoundingClientRect();\n        const padding = 4;\n\n        highlight.style.top = `${rect.top - padding}px`;\n        highlight.style.left = `${rect.left - padding}px`;\n        highlight.style.width = `${rect.width + padding * 2}px`;\n        highlight.style.height = `${rect.height + padding * 2}px`;\n        highlight.style.display = 'block';\n        return;\n      }\n    }\n\n    highlight.style.display = 'none';\n  }\n\n  /**\n   * Goes to the next step.\n   */\n  next(): void {\n    if (!this.currentTutorial) return;\n\n    if (this.currentStepIndex < this.currentTutorial.steps.length - 1) {\n      this.currentStepIndex++;\n      this.showStep();\n    } else {\n      this.stop();\n      this.onComplete?.();\n    }\n  }\n\n  /**\n   * Goes to the previous step.\n   */\n  prev(): void {\n    if (this.currentStepIndex > 0) {\n      this.currentStepIndex--;\n      this.showStep();\n    }\n  }\n\n  /**\n   * Gets available tutorials.\n   */\n  getTutorials(): Tutorial[] {\n    return TUTORIALS;\n  }\n}\n\n// Singleton instance\nexport const tutorialManager = new TutorialManager();\n","import { tutorialManager } from './Tutorial';\nimport { logger } from '../infrastructure/logging/Logger';\n\nexport function setupOnboardingWizard(): void {\n    // Check if user has visited before\n    const hasVisited = localStorage.getItem('neuroviz-has-visited');\n\n    if (!hasVisited) {\n        // Mark as visited\n        localStorage.setItem('neuroviz-has-visited', 'true');\n\n        // Show wizard after a short delay\n        setTimeout(() => {\n            showOnboardingWizard();\n        }, 1000);\n    }\n}\n\nexport function showOnboardingWizard(): void {\n    tutorialManager.start('getting-started', () => {\n        logger.info('Onboarding completed', { component: 'Onboarding' });\n    });\n}\n","import './style.css';\nimport * as tf from '@tensorflow/tfjs';\nimport { TrainingSession } from './core/application/TrainingSession';\nimport { TFNeuralNet } from './infrastructure/tensorflow/TFNeuralNet';\nimport { D3Chart } from './infrastructure/d3/D3Chart';\nimport { D3LossChart } from './infrastructure/d3/D3LossChart';\nimport { D3NetworkDiagram } from './infrastructure/d3/D3NetworkDiagram';\nimport { MockDataRepository } from './infrastructure/api/MockDataRepository';\nimport { LocalStorageService } from './infrastructure/storage/LocalStorageService';\nimport { ErrorBoundary } from './infrastructure/errorHandling/ErrorBoundary';\nimport { WorkerManager } from './workers/WorkerManager';\nimport { initELI5Tooltips } from './presentation/ELI5Tooltips';\nimport { dismissSuggestions } from './presentation/SuggestedFixes';\nimport {\n  DatasetController,\n  TrainingController,\n  VisualizationController,\n  ExportController,\n  SessionController,\n  ComparisonController,\n  ResearchController,\n} from './presentation/controllers';\nimport { safeGetElement } from './utils/dom';\nimport {\n  getDatasetElements,\n  getTrainingElements,\n  getVisualizationElements,\n  getExportElements,\n  getSessionElements,\n  getComparisonElements,\n  getResearchElements,\n} from './utils/UIFactory';\nimport { setupSidebarTabs } from '@presentation/Sidebar';\nimport { setupTouchGestures } from '@presentation/TouchGestures';\nimport { setupBottomSheet } from '@presentation/BottomSheet';\nimport { setupOnboardingWizard } from './presentation/Onboarding';\nimport { TrainingState } from './core/application/ITrainingSession';\n\n// Expose TensorFlow.js globally for E2E tests\n// Tests check for window.tf to verify TensorFlow is loaded\n(window as typeof window & { tf: typeof tf }).tf = tf;\n\n// Initialize Error Boundary\nconst errorBoundary = new ErrorBoundary();\nerrorBoundary.init();\n\n// Initialize Worker Manager\nconst _workerManager = new WorkerManager();\n\n// Initialize Services\nconst dataRepo = new MockDataRepository();\nconst neuralNet = new TFNeuralNet();\nconst visualizer = new D3Chart('viz-container');\nconst lossChart = new D3LossChart('loss-chart-container');\nconst networkDiagram = new D3NetworkDiagram(safeGetElement<HTMLElement>('network-diagram') || document.createElement('div'));\nconst storage = new LocalStorageService();\nconst session = new TrainingSession(neuralNet, visualizer, dataRepo);\n\n// Initialize Controllers\nconst datasetController = new DatasetController(session, visualizer, getDatasetElements());\n\nconst trainingController = new TrainingController(\n  session,\n  getTrainingElements(),\n  {\n    onNetworkUpdate: () => {\n      const structure = neuralNet.getStructure();\n      if (structure) {\n        networkDiagram.render(structure.layers, structure.activations, neuralNet.getWeightMatrices());\n      }\n    },\n    onClearVisualization: () => {\n      lossChart.clear();\n      networkDiagram.clear();\n    },\n    onDismissSuggestions: () => dismissSuggestions('suggestions-panel'),\n  }\n);\n\nconst visualizationController = new VisualizationController(\n  session,\n  neuralNet,\n  visualizer,\n  getVisualizationElements()\n);\n\nconst _exportController = new ExportController(\n  session,\n  neuralNet,\n  visualizer,\n  getExportElements(),\n  {\n    onModelLoaded: () => {\n      // Refresh UI after loading model\n      const structure = neuralNet.getStructure();\n      if (structure) {\n        networkDiagram.render(structure.layers, structure.activations, neuralNet.getWeightMatrices());\n      }\n      visualizer.renderData(session.getData());\n    }\n  }\n);\n\nconst _sessionController = new SessionController(\n  session,\n  visualizer,\n  storage,\n  getSessionElements(),\n  {\n    onConfigLoaded: () => {\n      // Refresh UI\n      void datasetController.handleLoadData().catch((error) => {\n        console.error('Failed to load data after config loaded:', error);\n      });\n    },\n    onThemeChanged: (theme) => {\n      document.documentElement.setAttribute('data-theme', theme);\n    }\n  }\n);\n\nconst comparisonController = new ComparisonController(session, getComparisonElements());\n\nconst _researchController = new ResearchController(session, getResearchElements());\n\n// Global Event Listeners\nsession.onStateChange((state: TrainingState) => {\n  trainingController.updateUI(state);\n  lossChart.update(state.history);\n  comparisonController.updateComparisonDisplay();\n  visualizationController.updateGradientFlow();\n\n  // Update network diagram weights occasionally\n  if (state.currentEpoch % 5 === 0 && state.isRunning) {\n    const structure = neuralNet.getStructure();\n    if (structure) {\n      networkDiagram.render(structure.layers, structure.activations, neuralNet.getWeightMatrices());\n    }\n  }\n});\n\n// Initialize UI\nsetupSidebarTabs();\nsetupTouchGestures();\nsetupBottomSheet();\nsetupOnboardingWizard();\ninitELI5Tooltips();\n\n// Load initial data\nwindow.addEventListener('load', () => {\n  // Trigger initial dataset load\n  void datasetController.handleLoadData().catch((error) => {\n    console.error('Failed to load initial dataset:', error);\n  });\n\n  // Show app\n  const appContainer = document.querySelector('.app-container');\n  if (appContainer) {\n    appContainer.classList.add('loaded');\n  }\n});\n\n// Cleanup on page unload to prevent memory leaks\nwindow.addEventListener('beforeunload', () => {\n  // Dispose controllers (those with dispose methods)\n  if ('dispose' in datasetController && typeof datasetController.dispose === 'function') {\n    datasetController.dispose();\n  }\n\n  // Dispose visualizer (includes ResizeObserver cleanup)\n  if ('dispose' in visualizer && typeof visualizer.dispose === 'function') {\n    visualizer.dispose();\n  }\n\n  // Clear D3 visualizations\n  if ('clear' in lossChart && typeof lossChart.clear === 'function') {\n    lossChart.clear();\n  }\n  if ('clear' in networkDiagram && typeof networkDiagram.clear === 'function') {\n    networkDiagram.clear();\n  }\n\n  // Note: Add dispose() methods to remaining controllers following the pattern in DatasetController:\n  // Each controller should:\n  // 1. Store event handler references in a Map\n  // 2. Remove all event listeners in dispose()\n  // 3. Clear any timers or subscriptions\n  // 4. Clean up any other resources (tooltips, observers, etc.)\n});\n"],"file":"assets/index-B_w9MzxF.js"}