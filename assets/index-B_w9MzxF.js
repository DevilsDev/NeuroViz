import{t as H,l as kt,m as Ct,s as Bt,d as q,b as ct,a as ht,c as dt,o as It,e as At,f as G,g as zt,h as Tt}from"./vendor-tensorflow-BQ4mUeqF.js";import{D as ut,s as I,l as B,a as N,b as _,C as Mt,r as Dt,i as Rt,t as Nt,p as $t,z as Ft,c as Pt,d as K,m as Q,f as P,e as et,g as st,h as _t,j as Et,Y as Ot,v as Vt,k as mt,n as Ht}from"./vendor-d3-CBiZgAeM.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function e(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=e(i);fetch(i.href,n)}})();const R={optimizer:"adam",momentum:.9,activation:"relu"},Lt={type:"none",decayRate:.95,decaySteps:10,warmupEpochs:0,cycleLength:20,minLR:.001},Gt={batchSize:0,maxEpochs:0,targetFps:60,epochDelayMs:0,validationSplit:.2,lrSchedule:Lt,earlyStoppingPatience:0};function Y(){return{records:[],bestLoss:null,bestEpoch:null,bestValLoss:null,bestValEpoch:null,totalTimeMs:0}}function pt(l,t){const e=[...l.records,t],s=l.bestLoss===null||t.loss<l.bestLoss,i=t.valLoss!==null&&(l.bestValLoss===null||t.valLoss<l.bestValLoss);return{records:e,bestLoss:s?t.loss:l.bestLoss,bestEpoch:s?t.epoch:l.bestEpoch,bestValLoss:i?t.valLoss:l.bestValLoss,bestValEpoch:i?t.epoch:l.bestValEpoch,totalTimeMs:t.timestamp-(l.records[0]?.timestamp??t.timestamp)}}function Ut(l,t){const e=l.records[l.records.length-1];if(t==="json")return JSON.stringify({records:l.records,summary:{totalEpochs:l.records.length,bestLoss:l.bestLoss,bestEpoch:l.bestEpoch,bestValLoss:l.bestValLoss,bestValEpoch:l.bestValEpoch,totalTimeMs:l.totalTimeMs,finalLoss:e?.loss??null,finalAccuracy:e?.accuracy??null,finalValLoss:e?.valLoss??null,finalValAccuracy:e?.valAccuracy??null}},null,2);const s="epoch,loss,accuracy,val_loss,val_accuracy,timestamp",i=l.records.map(n=>`${n.epoch},${n.loss.toFixed(6)},${n.accuracy.toFixed(4)},${n.valLoss?.toFixed(6)??""},${n.valAccuracy?.toFixed(4)??""},${n.timestamp}`);return[s,...i].join(`
`)}const Wt={boundaryOpacity:.7,pointRadius:5,colourScheme:"default",zoomEnabled:!0,tooltipsEnabled:!0,contourCount:10},jt={default:{low:"#00D9FF",high:"#f97316"},viridis:{low:"#440154",high:"#fde725"},plasma:{low:"#0d0887",high:"#f0f921"},cool:{low:"#00D9FF",high:"#06b6d4"},warm:{low:"#FF00AA",high:"#facc15"}},V=["#00D9FF","#f97316","#10B981","#FF00AA","#EF4444","#06b6d4","#F59E0B","#ec4899","#64748b","#8B5CF6"];class Xt{config;history=[];timers=new Map;constructor(t={}){this.config={minLevel:t.minLevel??1,enableConsole:t.enableConsole??!0,enableHistory:t.enableHistory??!1,maxHistorySize:t.maxHistorySize??100,externalLogger:t.externalLogger}}debug(t,e){this.log(0,t,e)}info(t,e){this.log(1,t,e)}warn(t,e){this.log(2,t,e)}error(t,e,s){this.log(3,t,s,e),this.config.externalLogger?.captureException&&e?this.config.externalLogger.captureException(e,s):this.config.externalLogger?.captureMessage&&this.config.externalLogger.captureMessage(t,"error",s)}log(t,e,s,i){if(t<this.config.minLevel){const o={level:t,message:e,timestamp:Date.now(),context:s,error:i};return this.config.enableHistory&&this.addToHistory(o),o}const n={level:t,message:e,timestamp:Date.now(),context:s,error:i};return this.config.enableConsole&&this.logToConsole(n),this.config.enableHistory&&this.addToHistory(n),n}logToConsole(t){const e=new Date(t.timestamp).toLocaleTimeString(),i=`${t.context?.component?`[${t.context.component}]`:""} ${t.message}`;switch(t.level){case 0:t.context&&Object.keys(t.context).length>0?console.log(`%c${e} DEBUG`,"color: #888",i,t.context):console.log(`%c${e} DEBUG`,"color: #888",i);break;case 1:t.context&&Object.keys(t.context).length>0?console.log(`%c${e} INFO`,"color: #0ea5e9",i,t.context):console.log(`%c${e} INFO`,"color: #0ea5e9",i);break;case 2:t.context&&Object.keys(t.context).length>0?console.warn(`%c${e} WARN`,"color: #f59e0b",i,t.context):console.warn(`%c${e} WARN`,"color: #f59e0b",i);break;case 3:t.error?t.context&&Object.keys(t.context).length>0?console.error(`%c${e} ERROR`,"color: #ef4444",i,t.error,t.context):console.error(`%c${e} ERROR`,"color: #ef4444",i,t.error):t.context&&Object.keys(t.context).length>0?console.error(`%c${e} ERROR`,"color: #ef4444",i,t.context):console.error(`%c${e} ERROR`,"color: #ef4444",i);break}}addToHistory(t){this.history.push(t),this.history.length>this.config.maxHistorySize&&this.history.shift()}getLevelName(t){switch(t){case 0:return"DEBUG";case 1:return"INFO";case 2:return"WARN";case 3:return"ERROR";default:return"UNKNOWN"}}time(t){this.timers.set(t,performance.now())}timeEnd(t){const e=this.timers.get(t);if(!e){this.warn(`Timer "${t}" does not exist`);return}const s=performance.now()-e;return this.timers.delete(t),this.info(`${t}: ${s.toFixed(2)}ms`),s}getHistory(){return[...this.history]}clearHistory(){this.history=[]}setLevel(t){this.config.minLevel=t}getLevel(){return this.config.minLevel}setConsoleEnabled(t){this.config.enableConsole=t}isLevelEnabled(t){return t>=this.config.minLevel}}const S=new Xt({enableHistory:!0,maxHistorySize:100}),Jt={renderInterval:10,gridSize:50};class qt{constructor(t,e,s,i={}){this.neuralNet=t,this.visualizer=e,this.dataRepo=s,this.config={...Jt,...i},this.initialisePredictionGrid()}config;stateListeners=new Set;currentEpoch=0;currentLoss=null;currentAccuracy=null;currentValLoss=null;currentValAccuracy=null;isInitialised=!1;datasetLoaded=!1;history=Y();trainingStartTime=0;isTraining=!1;isPaused=!1;isProcessingStep=!1;allData=[];trainingData=[];validationData=[];predictionGrid=[];cachedPredictions=[];trainingConfig={...Gt};lastFrameTime=0;frameInterval=0;bestValLoss=null;epochsWithoutImprovement=0;initialLearningRate=.03;currentLearningRate=.03;currentHyperparameters=null;onCompleteCallback=null;boundarySnapshots=[];recordingEnabled=!1;snapshotInterval=10;getState(){return{currentEpoch:this.currentEpoch,currentLoss:this.currentLoss,currentAccuracy:this.currentAccuracy,currentValLoss:this.currentValLoss,currentValAccuracy:this.currentValAccuracy,isRunning:this.isTraining,isPaused:this.isPaused,isInitialised:this.isInitialised,datasetLoaded:this.datasetLoaded,maxEpochs:this.trainingConfig.maxEpochs,batchSize:this.trainingConfig.batchSize,targetFps:this.trainingConfig.targetFps,validationSplit:this.trainingConfig.validationSplit,history:this.history}}setTrainingConfig(t){this.trainingConfig={...this.trainingConfig,...t},t.targetFps!==void 0&&(this.frameInterval=t.targetFps>0?1e3/t.targetFps:0),t.epochDelayMs!==void 0&&t.epochDelayMs>0&&(this.frameInterval=t.epochDelayMs),t.validationSplit!==void 0&&this.allData.length>0&&this.splitData(),this.notifyListeners()}async setHyperparameters(t){await this.neuralNet.initialize(t),this.isInitialised=!0,this.currentEpoch=0,this.currentLoss=null,this.currentAccuracy=null,this.history=Y(),this.currentHyperparameters=t,this.initialLearningRate=t.learningRate,this.currentLearningRate=t.learningRate,this.bestValLoss=null,this.epochsWithoutImprovement=0,this.notifyListeners()}exportHistory(t){return Ut(this.history,t)}async loadData(t,e){const s=await this.dataRepo.getDataset(t,e);this.allData=this.applyPreprocessing(s,e?.preprocessing??"none"),this.splitData(),this.datasetLoaded=!0,this.visualizer.renderData(this.allData),this.notifyListeners()}applyPreprocessing(t,e){if(e==="none"||t.length===0)return t;const s=t.map(n=>n.x),i=t.map(n=>n.y);if(e==="normalize"){const n=Math.min(...s),o=Math.max(...s),a=Math.min(...i),r=Math.max(...i),c=o-n||1,h=r-a||1;return t.map(m=>({x:(m.x-n)/c*2-1,y:(m.y-a)/h*2-1,label:m.label}))}if(e==="standardize"){const n=s.reduce((c,h)=>c+h,0)/s.length,o=i.reduce((c,h)=>c+h,0)/i.length,a=Math.sqrt(s.reduce((c,h)=>c+(h-n)**2,0)/s.length)||1,r=Math.sqrt(i.reduce((c,h)=>c+(h-o)**2,0)/i.length)||1;return t.map(c=>({x:(c.x-n)/a,y:(c.y-o)/r,label:c.label}))}return t}splitData(){const{validationSplit:t}=this.trainingConfig;if(t<=0||t>=1){this.trainingData=this.allData,this.validationData=[];return}const e=[...this.allData];for(let i=e.length-1;i>0;i--){const n=Math.floor(Math.random()*(i+1)),o=e[i];e[i]=e[n],e[n]=o}const s=Math.floor(e.length*(1-t));this.trainingData=e.slice(0,s).map(i=>({...i,isValidation:!1})),this.validationData=e.slice(s).map(i=>({...i,isValidation:!0})),this.allData=[...this.trainingData,...this.validationData]}start(){this.assertReadyToTrain(),!(this.isTraining&&!this.isPaused)&&(this.isTraining=!0,this.isPaused=!1,this.notifyListeners(),this.loop())}pause(){this.isTraining&&(this.isPaused=!0,this.notifyListeners())}reset(){this.isTraining=!1,this.isPaused=!1,this.isProcessingStep=!1,this.currentEpoch=0,this.currentLoss=null,this.currentAccuracy=null,this.currentValLoss=null,this.currentValAccuracy=null,this.history=Y(),this.allData.length>0&&this.splitData(),this.datasetLoaded&&this.visualizer.renderData(this.allData),this.notifyListeners()}clearAll(){this.isTraining=!1,this.isPaused=!1,this.isProcessingStep=!1,this.currentEpoch=0,this.currentLoss=null,this.currentAccuracy=null,this.currentValLoss=null,this.currentValAccuracy=null,this.history=Y(),this.allData=[],this.trainingData=[],this.validationData=[],this.datasetLoaded=!1,this.isInitialised=!1,this.visualizer.clear(),this.notifyListeners()}async step(){if(this.assertReadyToTrain(),!this.isProcessingStep){this.isProcessingStep=!0;try{this.currentEpoch++;const t=await this.neuralNet.train(this.trainingData);this.currentLoss=t.loss,this.currentAccuracy=t.accuracy;let e=null,s=null;if(this.validationData.length>0){const i=await this.neuralNet.evaluate(this.validationData);e=i.loss,s=i.accuracy,this.currentValLoss=e,this.currentValAccuracy=s}this.history=pt(this.history,{epoch:this.currentEpoch,loss:t.loss,accuracy:t.accuracy,valLoss:e,valAccuracy:s,timestamp:performance.now()}),this.currentEpoch%this.config.renderInterval===0&&await this.updateVisualisation(),this.notifyListeners()}finally{this.isProcessingStep=!1}}}onStateChange(t){return this.stateListeners.add(t),()=>this.stateListeners.delete(t)}dispose(){this.isTraining=!1,this.isPaused=!1,this.isProcessingStep=!1,this.stateListeners.clear()}async loop(){if(!this.isTraining||this.isPaused)return;const{maxEpochs:t}=this.trainingConfig;if(t>0&&this.currentEpoch>=t){this.isTraining=!1,this.notifyListeners(),this.onCompleteCallback?.("maxEpochs");return}if(this.isProcessingStep){requestAnimationFrame(()=>void this.loop());return}const e=performance.now();if(this.frameInterval>0&&e-this.lastFrameTime<this.frameInterval){requestAnimationFrame(()=>void this.loop());return}this.lastFrameTime=e,this.isProcessingStep=!0;try{const s=this.getTrainingBatch();this.currentEpoch++;const i=await this.neuralNet.train(s);this.currentLoss=i.loss,this.currentAccuracy=i.accuracy;let n=null,o=null;if(this.validationData.length>0){const a=await this.neuralNet.evaluate(this.validationData);n=a.loss,o=a.accuracy,this.currentValLoss=n,this.currentValAccuracy=o}if(this.history=pt(this.history,{epoch:this.currentEpoch,loss:i.loss,accuracy:i.accuracy,valLoss:n,valAccuracy:o,timestamp:performance.now()}),this.checkEarlyStopping(n)){this.isTraining=!1,this.notifyListeners(),this.onCompleteCallback?.("earlyStopping"),S.info(`Early stopping triggered at epoch ${this.currentEpoch}`,{component:"TrainingSession",action:"earlyStopping",epoch:this.currentEpoch});return}this.updateLearningRateIfNeeded(),this.currentEpoch%this.config.renderInterval===0&&await this.updateVisualisation(),this.recordingEnabled&&this.currentEpoch%this.snapshotInterval===0&&this.boundarySnapshots.push({epoch:this.currentEpoch,predictions:[...this.cachedPredictions]}),this.notifyListeners()}catch(s){this.isTraining=!1,this.notifyListeners(),console.error("Training loop error:",s),S.error("Training loop crashed",s instanceof Error?s:new Error(String(s)),{component:"TrainingSession",action:"loop",epoch:this.currentEpoch})}finally{this.isProcessingStep=!1}this.isTraining&&!this.isPaused&&(t===0||this.currentEpoch<t?requestAnimationFrame(()=>void this.loop()):(this.isTraining=!1,this.notifyListeners(),this.onCompleteCallback?.("maxEpochs")))}getTrainingBatch(){const{batchSize:t}=this.trainingConfig;if(t<=0||t>=this.trainingData.length)return this.trainingData;const e=[...this.trainingData];for(let s=e.length-1;s>0;s--){const i=Math.floor(Math.random()*(s+1)),n=e[s];e[s]=e[i],e[i]=n}return e.slice(0,t)}async updateVisualisation(){this.datasetLoaded&&(this.cachedPredictions=await this.neuralNet.predict(this.predictionGrid),this.datasetLoaded&&(this.visualizer.renderBoundary(this.cachedPredictions,this.config.gridSize),this.visualizer.renderData(this.allData)))}initialisePredictionGrid(){const{gridSize:t}=this.config;this.predictionGrid.length=0;for(let e=0;e<t;e++)for(let s=0;s<t;s++){const i=e/(t-1)*2-1,n=s/(t-1)*2-1;this.predictionGrid.push({x:i,y:n,label:0})}}notifyListeners(){const t=this.getState();for(const e of this.stateListeners)e(t)}assertReadyToTrain(){if(!this.isInitialised)throw new Error("Hyperparameters not set. Call setHyperparameters() first.");if(!this.datasetLoaded)throw new Error("No data loaded. Call loadData() first.")}setCustomData(t){this.allData=[...t],this.datasetLoaded=t.length>0,t.length>0?this.splitData():(this.trainingData=[],this.validationData=[]),this.notifyListeners()}getData(){return[...this.allData]}getHistory(){return this.history}getCurrentLearningRate(){return this.currentLearningRate}calculateScheduledLR(t){const e=this.trainingConfig.lrSchedule??Lt,s=this.initialLearningRate,i=e.warmupEpochs??0;if(i>0&&t<i)return s*(t+1)/i;const n=i>0?t-i:t;switch(e.type){case"exponential":{const o=e.decayRate??.95;return s*Math.pow(o,n)}case"step":{const o=e.decayRate??.5,a=e.decaySteps??10,r=Math.floor(n/a);return s*Math.pow(o,r)}case"cosine":{const o=Math.max((this.trainingConfig.maxEpochs||100)-i,1),a=Math.min(n/o,1);return s*.5*(1+Math.cos(Math.PI*a))}case"cyclic_triangular":{const o=e.cycleLength??20,a=e.minLR??s/10,r=n%o,c=o/2,h=r<c?r/c:1-(r-c)/c;return a+(s-a)*h}case"cyclic_cosine":{const o=e.cycleLength??20,a=e.minLR??s/10,r=n%o,c=.5*(1+Math.cos(Math.PI*r/o));return a+(s-a)*c}case"none":default:return s}}updateLearningRateIfNeeded(){const t=this.calculateScheduledLR(this.currentEpoch);Math.abs(t-this.currentLearningRate)/this.currentLearningRate>.01&&this.currentHyperparameters&&(this.currentLearningRate=t,this.neuralNet.updateLearningRate(t))}checkEarlyStopping(t){const e=this.trainingConfig.earlyStoppingPatience??0;return e<=0||t===null?!1:this.bestValLoss===null?(this.bestValLoss=t,this.epochsWithoutImprovement=0,!1):t<this.bestValLoss?(this.bestValLoss=t,this.epochsWithoutImprovement=0,!1):(this.epochsWithoutImprovement++,this.epochsWithoutImprovement>=e)}onComplete(t){this.onCompleteCallback=t}setRecording(t,e=10){this.recordingEnabled=t,this.snapshotInterval=e,t&&(this.boundarySnapshots=[])}getBoundarySnapshots(){return[...this.boundarySnapshots]}clearBoundarySnapshots(){this.boundarySnapshots=[]}async runLRFinder(t=1e-7,e=1,s=100){this.assertReadyToTrain();const i=[],n=Math.pow(e/t,1/s);let o=t;const a=this.currentHyperparameters;if(!a)throw new Error("Model not initialized");for(let r=0;r<s;r++){"setLearningRate"in this.neuralNet?this.neuralNet.setLearningRate(o):await this.neuralNet.initialize({...a,learningRate:o});const c=this.getTrainingBatch(),h=await this.neuralNet.train(c);if(i.push({lr:o,loss:h.loss}),!isFinite(h.loss)||h.loss>1e10)break;o*=n}return await this.neuralNet.initialize(a),i}}class ot extends Error{code="GRADIENT_EXPLOSION";constructor(t="Training produced NaN loss. Try lowering the learning rate."){super(t),this.name="GradientExplosionError",Object.setPrototypeOf(this,ot.prototype)}}class tt extends Error{code="MODEL_NOT_INITIALISED";constructor(t="Model not initialised. Call initialize() first."){super(t),this.name="ModelNotInitialisedError",Object.setPrototypeOf(this,tt.prototype)}}class at{model=null;config=null;numClasses=2;clipNorm=0;async initialize(t){this.dispose(),this.config=t,this.numClasses=t.numClasses??2,this.model=this.buildModel(t)}updateLearningRate(t){const e=this.assertInitialised();if(!this.config)throw new tt;const s=e.getWeights();this.config={...this.config,learningRate:t};const i=this.createOptimizer(this.config.optimizer??R.optimizer,t,this.config.momentum??R.momentum,this.config.clipNorm??0),n=this.numClasses===2?"binaryCrossentropy":"categoricalCrossentropy";e.compile({optimizer:i,loss:n,metrics:["accuracy"]}),e.setWeights(s),s.forEach(o=>o.dispose())}async train(t){const e=this.assertInitialised(),s=H(t.map(n=>[n.x,n.y])),i=this.createLabelTensor(t);try{const n=await e.trainOnBatch(s,i);let o,a;if(Array.isArray(n)?(o=n[0]??0,a=n[1]??0):(o=n,a=0),Number.isNaN(o))throw new ot;return{loss:o,accuracy:a}}finally{s.dispose(),i.dispose()}}async evaluate(t){const e=this.assertInitialised(),s=H(t.map(n=>[n.x,n.y])),i=this.createLabelTensor(t);try{const n=e.evaluate(s,i),o=await n[0]?.data(),a=await n[1]?.data();return n.forEach(r=>r.dispose()),{loss:o?.[0]??0,accuracy:a?.[0]??0}}finally{s.dispose(),i.dispose()}}async predict(t){const e=this.assertInitialised(),s=H(t.map(i=>[i.x,i.y]));try{const i=e.predict(s);try{const n=await i.data();return t.map((o,a)=>{if(this.numClasses===2){const r=n[a]??.5;return{x:o.x,y:o.y,confidence:r,predictedClass:r>=.5?1:0,probabilities:[1-r,r]}}else{const r=a*this.numClasses,c=[];let h=0,m=0;for(let u=0;u<this.numClasses;u++){const d=n[r+u]??0;c.push(d),d>h&&(h=d,m=u)}return{x:o.x,y:o.y,confidence:h,predictedClass:m,probabilities:c}}})}finally{i.dispose()}}finally{s.dispose()}}dispose(){this.model&&(this.model.dispose(),this.model=null),this.config=null}async exportModel(){const t=this.assertInitialised(),e=await new Promise((c,h)=>{const m={save:async u=>(c(u),{modelArtifactsInfo:{dateSaved:new Date,modelTopologyType:"JSON"}})};t.save(m).catch(h)}),s=e.modelTopology,i=[{paths:["weights.bin"],weights:e.weightSpecs??[]}],n=JSON.stringify({modelTopology:s,weightsManifest:i,format:"layers-model",generatedBy:"NeuroViz",convertedBy:null}),o=new Blob([n],{type:"application/json"}),a=e.weightData;let r;if(a){const c=Array.isArray(a)?a:[a];r=new Blob(c,{type:"application/octet-stream"})}else r=new Blob([],{type:"application/octet-stream"});return{modelJson:o,weightsBlob:r}}async loadModel(t,e){this.dispose();const s=await t.text(),i=JSON.parse(s),n={load:async()=>{const o=await e.arrayBuffer();return{modelTopology:i.modelTopology,weightSpecs:i.weightsManifest?.[0]?.weights??[],weightData:o}}};this.model=await kt(n)}static getMemoryInfo(){const t=Ct();return{numTensors:t.numTensors,numBytes:t.numBytes}}getWeights(){if(!this.model)return[];const t=[],e=this.model.getWeights();for(const s of e){const i=s.dataSync();for(let n=0;n<i.length;n++){const o=i[n];o!==void 0&&t.push(o)}}return t}getWeightMatrices(){if(!this.model)return[];const t=[],e=this.model.getWeights();for(let s=0;s<e.length;s+=2){const i=e[s];if(!i)continue;const n=i.shape,o=i.dataSync(),[a,r]=n;if(a===void 0||r===void 0)continue;const c=[];for(let h=0;h<a;h++){const m=[];for(let u=0;u<r;u++){const d=h*r+u;m.push(o[d]??0)}c.push(m)}t.push(c)}return t}getLayerActivations(t){if(!this.model)return[];const e=[],s=H([[t.x,t.y]]);try{let i=s;for(const n of this.model.layers){const o=n.apply(i),a=o.dataSync();e.push(Array.from(a)),i!==s&&i.dispose(),i=o}i!==s&&i.dispose()}finally{s.dispose()}return e}getStructure(){if(!this.config)return null;const t=[2,...this.config.layers,this.numClasses],e=this.config.activation??R.activation,s=this.config.layerActivations??[],i=["linear"];for(let n=0;n<this.config.layers.length;n++)i.push(s[n]??e);return i.push(this.numClasses===2?"sigmoid":"softmax"),{layers:t,activations:i}}buildModel(t){const e=Bt(),s=t.activation??R.activation,i=t.layerActivations??[],n=this.createRegularizer(t.l1Regularization??0,t.l2Regularization??0),o=t.numClasses??2,a=t.dropoutRate??0,r=t.batchNorm??!1,c=u=>{const d=i[u]??s;return this.mapActivation(d)};e.add(q({inputShape:[2],units:t.layers[0]??4,activation:r?"linear":c(0),kernelInitializer:"heNormal",kernelRegularizer:n})),r&&(e.add(ct()),e.add(ht({activation:c(0)}))),a>0&&e.add(dt({rate:a}));for(let u=1;u<t.layers.length;u++)e.add(q({units:t.layers[u]??4,activation:r?"linear":c(u),kernelInitializer:"heNormal",kernelRegularizer:n})),r&&(e.add(ct()),e.add(ht({activation:c(u)}))),a>0&&e.add(dt({rate:a}));o===2?e.add(q({units:1,activation:"sigmoid"})):e.add(q({units:o,activation:"softmax"}));const h=this.createOptimizer(t.optimizer??R.optimizer,t.learningRate,t.momentum??R.momentum,t.clipNorm??0),m=o===2?"binaryCrossentropy":"categoricalCrossentropy";return e.compile({optimizer:h,loss:m,metrics:["accuracy"]}),e}createLabelTensor(t){return this.numClasses===2?H(t.map(e=>[e.label])):It(At(t.map(e=>e.label),"int32"),this.numClasses)}createOptimizer(t,e,s,i){switch(this.clipNorm=i,t){case"sgd":return G.momentum(e,s);case"adam":return G.adam(e);case"rmsprop":return G.rmsprop(e);case"adagrad":return G.adagrad(e);default:return G.adam(e)}}mapActivation(t){switch(t){case"relu":return"relu";case"sigmoid":return"sigmoid";case"tanh":return"tanh";case"elu":return"elu";default:return"relu"}}createRegularizer(t,e){if(t>0||e>0)return zt({l1:t,l2:e})}setLearningRate(t){const e=this.assertInitialised();if(this.model&&this.model.optimizer)this.model.optimizer.learningRate=t;else if(this.config){const s=this.createOptimizer(this.config.optimizer??R.optimizer,t,this.config.momentum??R.momentum,this.config.clipNorm??0);e.compile({optimizer:s,loss:this.numClasses===2?"binaryCrossentropy":"categoricalCrossentropy",metrics:["accuracy"]})}}assertInitialised(){if(!this.model)throw new tt;return this.model}}class Yt{svg;width;height;xScale;yScale;voronoiGroup=null;classColours=["#3b82f6","#ef4444","#22c55e","#f59e0b","#8b5cf6","#06b6d4","#ec4899","#84cc16"];constructor(t,e,s,i,n){this.svg=t,this.width=e,this.height=s,this.xScale=i,this.yScale=n}render(t,e,s=.3){if(this.clear(),t.length<3)return;this.voronoiGroup=this.svg.append("g").attr("class","voronoi-overlay").lower();const i=t.map(a=>[this.xScale(a.x),this.yScale(a.y)]),o=ut.from(i).voronoi([0,0,this.width,this.height]);this.voronoiGroup.selectAll("path").data(t).enter().append("path").attr("d",(a,r)=>o.renderCell(r)).attr("fill",(a,r)=>{const c=e[r];if(!c)return"transparent";const h=c.predictedClass;return this.classColours[h%this.classColours.length]??"#888"}).attr("fill-opacity",(a,r)=>{const c=e[r];return c?s*(.5+c.confidence*.5):0}).attr("stroke","var(--border-color)").attr("stroke-width",.5).attr("stroke-opacity",.3)}renderWithGradient(t,e){if(this.clear(),t.length<3)return;this.voronoiGroup=this.svg.append("g").attr("class","voronoi-overlay").lower();const s=t.map(a=>[this.xScale(a.x),this.yScale(a.y)]),n=ut.from(s).voronoi([0,0,this.width,this.height]),o=this.svg.select("defs").empty()?this.svg.append("defs"):this.svg.select("defs");t.forEach((a,r)=>{const c=e[r];if(!c)return;const h=`voronoi-gradient-${r}`,m=this.classColours[c.predictedClass%this.classColours.length]??"#888",u=o.append("radialGradient").attr("id",h).attr("cx","50%").attr("cy","50%").attr("r","50%");u.append("stop").attr("offset","0%").attr("stop-color",m).attr("stop-opacity",c.confidence*.6),u.append("stop").attr("offset","100%").attr("stop-color",m).attr("stop-opacity",c.confidence*.2)}),this.voronoiGroup.selectAll("path").data(t).enter().append("path").attr("d",(a,r)=>n.renderCell(r)).attr("fill",(a,r)=>`url(#voronoi-gradient-${r})`).attr("stroke","var(--border-color)").attr("stroke-width",.5).attr("stroke-opacity",.2)}clear(){this.voronoiGroup&&(this.voronoiGroup.remove(),this.voronoiGroup=null),this.svg.selectAll('defs radialGradient[id^="voronoi-gradient"]').remove()}updateScales(t,e){this.xScale=t,this.yScale=e}resize(t,e,s,i){this.width=t,this.height=e,this.xScale=s,this.yScale=i}}class Zt{container;svg;chartGroup;width;height;margin={top:8,right:8,bottom:28,left:32};xScale;yScale;config={...Wt};zoom=null;tooltip=null;cachedPoints=[];cachedPredictions=[];cachedGridSize=0;drawModeEnabled=!1;drawModeLabel=0;drawModeCallback=null;voronoiOverlay=null;voronoiEnabled=!1;constructor(t,e=500,s=500){const i=document.getElementById(t);if(!i)throw new Error(`Container element with ID "${t}" not found.`);this.container=I(i),this.width=e-this.margin.left-this.margin.right,this.height=s-this.margin.top-this.margin.bottom,this.container.selectAll("*").remove(),this.svg=this.container.append("svg").attr("viewBox",`0 0 ${e} ${s}`).attr("preserveAspectRatio","xMidYMid meet").style("width","100%").style("height","100%"),this.svg.append("defs").append("clipPath").attr("id","chart-clip").append("rect").attr("width",this.width).attr("height",this.height),this.chartGroup=this.svg.append("g").attr("transform",`translate(${this.margin.left},${this.margin.top})`).attr("clip-path","url(#chart-clip)"),this.xScale=B().domain([-1,1]).range([0,this.width]),this.yScale=B().domain([-1,1]).range([this.height,0]),this.renderAxes(),this.setupZoom(),this.setupTooltip(),this.resizeObserver=new ResizeObserver(n=>{for(const o of n)o.contentRect&&this.resize(o.contentRect.width,o.contentRect.height)}),this.resizeObserver.observe(i)}resize(t,e){t===0||e===0||(this.width=t-this.margin.left-this.margin.right,this.height=e-this.margin.top-this.margin.bottom,this.svg.attr("viewBox",`0 0 ${t} ${e}`),this.svg.select("#chart-clip rect").attr("width",this.width).attr("height",this.height),this.xScale.range([0,this.width]),this.yScale.range([this.height,0]),this.svg.select(".x-axis").attr("transform",`translate(0,${this.height})`).call(N(this.xScale).ticks(5)),this.svg.select(".y-axis").call(_(this.yScale).ticks(5)),this.cachedPoints.length>0&&this.renderData(this.cachedPoints),this.cachedPredictions.length>0&&this.renderBoundary(this.cachedPredictions,this.cachedGridSize),this.voronoiEnabled&&this.voronoiOverlay&&(this.voronoiOverlay.resize(this.width,this.height,this.xScale,this.yScale),this.voronoiOverlay.render(this.cachedPoints,this.cachedPredictions,this.config.boundaryOpacity)))}setConfig(t){this.config={...this.config,...t},this.cachedPoints.length>0&&this.renderData(this.cachedPoints),this.cachedPredictions.length>0&&this.renderBoundary(this.cachedPredictions,this.cachedGridSize),t.zoomEnabled!==void 0&&this.setupZoom()}setTheme(t){this.setConfig({colourScheme:t})}getConfig(){return{...this.config}}renderData(t){this.cachedPoints=t,this.chartGroup.selectAll(".data-point").remove();const e=i=>V[i%V.length]??"#888888",s=this.chartGroup.selectAll(".data-point").data(t).enter().append("circle").attr("class",i=>`data-point ${i.isValidation?"validation-point":"training-point"}`).attr("cx",i=>this.xScale(i.x)).attr("cy",i=>this.yScale(i.y)).attr("r",this.config.pointRadius).attr("fill",i=>e(i.label)).attr("stroke",i=>i.isValidation?"#fbbf24":"#fff").attr("stroke-width",i=>i.isValidation?2.5:1.5).attr("stroke-dasharray",i=>i.isValidation?"3,2":"none").attr("opacity",.9);if(this.config.tooltipsEnabled&&this.tooltip){const i=this.tooltip;s.on("mouseenter",(n,o)=>{i.style("opacity",1).html(`<strong>${o.isValidation?"Validation":"Training"} Point</strong><br/>x: ${o.x.toFixed(3)}<br/>y: ${o.y.toFixed(3)}<br/>class: ${o.label}`).style("left",`${n.pageX+10}px`).style("top",`${n.pageY-10}px`)}).on("mouseleave",()=>{i.style("opacity",0)})}s.on("click",(i,n)=>{i.stopPropagation(),this.pointClickCallback&&this.pointClickCallback(n)})}pointClickCallback=null;onPointClick(t){this.pointClickCallback=t}renderBoundary(t,e){if(this.cachedPredictions=t,this.cachedGridSize=e,this.chartGroup.selectAll(".boundary").remove(),t.length!==e*e){console.warn(`Expected ${e*e} predictions for gridSize ${e}, got ${t.length}`);return}(t[0]?.probabilities?.length??2)===2?this.renderBinaryBoundary(t,e):this.renderMultiClassBoundary(t,e)}renderBinaryBoundary(t,e){const s=t.map(u=>u.confidence),i=1/(this.config.contourCount||10),o=Mt().size([e,e]).thresholds(Dt(0,1+i,i))(s),a=jt[this.config.colourScheme],r=B().domain([0,.5,1]).range([a.low,"#f5f5f5",a.high]),c=B().domain([0,e]).range([0,this.width]),h=B().domain([0,e]).range([this.height,0]),m=Rt().projection(Nt({point(u,d){this.stream.point(c(u),h(d))}}));this.chartGroup.insert("g",".data-point").attr("class","boundary").selectAll("path").data(o).enter().append("path").attr("d",m).attr("fill",u=>r(u.value)).attr("stroke","none").attr("opacity",this.config.boundaryOpacity)}renderMultiClassBoundary(t,e){const s=this.width/e,i=this.height/e,n=a=>V[a.predictedClass%V.length]??"#888888";this.chartGroup.insert("g",".data-point").attr("class","boundary").selectAll("rect").data(t).enter().append("rect").attr("x",(a,r)=>r%e*s).attr("y",(a,r)=>this.height-Math.floor(r/e)*i-i).attr("width",s).attr("height",i).attr("fill",a=>n(a)).attr("opacity",a=>this.config.boundaryOpacity*(.3+a.confidence*.7)).attr("stroke","none")}clear(){this.cachedPoints=[],this.cachedPredictions=[],this.cachedGridSize=0,this.chartGroup.selectAll("*").remove()}highlightMisclassified(t){if(t.length!==this.cachedPoints.length)return;const e=new Set;for(let s=0;s<t.length;s++){const i=this.cachedPoints[s],n=t[s];i&&n&&i.label!==n.predictedClass&&e.add(s)}this.chartGroup.selectAll(".data-point").attr("stroke",(s,i)=>e.has(i)?"#ef4444":s.isValidation?"#fbbf24":"#fff").attr("stroke-width",(s,i)=>e.has(i)?3:s.isValidation?2.5:1.5).attr("stroke-dasharray",(s,i)=>e.has(i)?"none":s.isValidation?"3,2":"none")}clearMisclassifiedHighlight(){this.chartGroup.selectAll(".data-point").attr("stroke",t=>t.isValidation?"#fbbf24":"#fff").attr("stroke-width",t=>t.isValidation?2.5:1.5).attr("stroke-dasharray",t=>t.isValidation?"3,2":"none")}renderConfidenceCircles(t){if(t.length!==this.cachedPoints.length)return;this.chartGroup.selectAll(".confidence-circle").remove();const e=25,s=3;this.chartGroup.selectAll(".confidence-circle").data(this.cachedPoints).enter().insert("circle",".data-point").attr("class","confidence-circle").attr("cx",i=>this.xScale(i.x)).attr("cy",i=>this.yScale(i.y)).attr("r",(i,n)=>{const o=t[n];if(!o)return s;const a=1-o.confidence;return s+a*(e-s)}).attr("fill","none").attr("stroke",(i,n)=>{const o=t[n];if(!o)return"#888";const a=this.cachedPoints[n];return a&&o.predictedClass===a.label?"rgba(34, 197, 94, 0.6)":"rgba(239, 68, 68, 0.6)"}).attr("stroke-width",2).attr("stroke-dasharray","4,2").attr("opacity",.8)}clearConfidenceCircles(){this.chartGroup.selectAll(".confidence-circle").remove()}resizeObserver=null;dispose(){this.disableDrawMode(),this.tooltip&&this.tooltip.remove(),this.resizeObserver&&this.resizeObserver.disconnect(),this.container.selectAll("*").remove()}enableDrawMode(t,e){this.drawModeEnabled=!0,this.drawModeLabel=t,this.drawModeCallback=e,this.svg.style("cursor","crosshair"),this.svg.on("click.draw",s=>{if(!this.drawModeEnabled||!this.drawModeCallback)return;const[i,n]=$t(s,this.chartGroup.node()),o=this.xScale.invert(i),a=this.yScale.invert(n);if(o>=-1&&o<=1&&a>=-1&&a<=1){const r={x:o,y:a,label:this.drawModeLabel};this.drawModeCallback(r)}})}disableDrawMode(){this.drawModeEnabled=!1,this.drawModeCallback=null,this.svg.style("cursor","default"),this.svg.on("click.draw",null)}isDrawModeEnabled(){return this.drawModeEnabled}renderAxes(){const t=this.svg.append("g").attr("class","axes").attr("transform",`translate(${this.margin.left},${this.margin.top})`);t.append("g").attr("class","x-axis axis").attr("transform",`translate(0,${this.height})`).call(N(this.xScale).ticks(5)),t.append("g").attr("class","y-axis axis").call(_(this.yScale).ticks(5))}setupZoom(){if(!this.config.zoomEnabled){this.svg.on(".zoom",null);return}this.zoom=Ft().scaleExtent([.5,5]).on("zoom",t=>{this.chartGroup.attr("transform",t.transform)}),this.svg.call(this.zoom),this.svg.on("dblclick.zoom",()=>{this.svg.transition().duration(300).call(this.zoom.transform,Pt)})}setupTooltip(){this.tooltip=I("body").append("div").attr("class","chart-tooltip").style("opacity",0)}exportAsPNG(t="neuroviz-boundary"){const e=this.svg.node();if(!e)return;const s=e.cloneNode(!0);this.inlineStyles(s);const i=document.createElementNS("http://www.w3.org/2000/svg","rect");i.setAttribute("width","100%"),i.setAttribute("height","100%"),i.setAttribute("fill","#0a0f1a"),s.insertBefore(i,s.firstChild);const o=new XMLSerializer().serializeToString(s),a=new Blob([o],{type:"image/svg+xml;charset=utf-8"}),r=URL.createObjectURL(a),c=document.createElement("canvas"),h=2;c.width=this.width*h,c.height=this.height*h;const m=c.getContext("2d");if(!m)return;const u=new Image;u.onload=()=>{m.scale(h,h),m.drawImage(u,0,0),URL.revokeObjectURL(r);const d=c.toDataURL("image/png"),f=document.createElement("a");f.download=`${t}.png`,f.href=d,f.click()},u.src=r}exportAsPNGWithMetadata(t="neuroviz-boundary",e){const s=this.svg.node();if(!s)return;const i=s.cloneNode(!0);this.inlineStyles(i);const n=document.createElementNS("http://www.w3.org/2000/svg","rect");n.setAttribute("width","100%"),n.setAttribute("height","100%"),n.setAttribute("fill","#0a0f1a"),i.insertBefore(n,i.firstChild);const a=new XMLSerializer().serializeToString(i),r=new Blob([a],{type:"image/svg+xml;charset=utf-8"}),c=URL.createObjectURL(r),h=document.createElement("canvas"),m=2,u=80;h.width=this.width*m,h.height=(this.height+u)*m;const d=h.getContext("2d");if(!d)return;const f=new Image;f.onload=()=>{d.fillStyle="#0a0f1a",d.fillRect(0,0,h.width,h.height),d.scale(m,m),d.drawImage(f,0,0),URL.revokeObjectURL(c),d.fillStyle="rgba(15, 23, 42, 0.95)",d.fillRect(0,this.height,this.width,u),d.fillStyle="#94a3b8",d.font="11px Inter, system-ui, sans-serif";const w=Object.entries(e),g=3,y=this.width/g,v=this.height+18,L=16;w.forEach(([k,A],z)=>{const $=z%g,X=Math.floor(z/g),J=$*y+10,lt=v+X*L;d.fillStyle="#64748b",d.fillText(`${k}:`,J,lt),d.fillStyle="#e2e8f0",d.fillText(A,J+d.measureText(`${k}: `).width,lt)}),d.fillStyle="#475569",d.font="10px Inter, system-ui, sans-serif",d.fillText("NeuroViz",this.width-55,this.height+u-8);const b=h.toDataURL("image/png"),E=document.createElement("a");E.download=`${t}.png`,E.href=b,E.click()},f.src=c}exportAsSVG(t="neuroviz-boundary"){const e=this.svg.node();if(!e)return;const s=e.cloneNode(!0);this.inlineStyles(s);const i=document.createElementNS("http://www.w3.org/2000/svg","rect");i.setAttribute("width","100%"),i.setAttribute("height","100%"),i.setAttribute("fill","#0a0f1a"),s.insertBefore(i,s.firstChild);const o=new XMLSerializer().serializeToString(s),a=new Blob([o],{type:"image/svg+xml;charset=utf-8"}),r=URL.createObjectURL(a),c=document.createElement("a");c.download=`${t}.svg`,c.href=r,c.click(),URL.revokeObjectURL(r)}inlineStyles(t){t.querySelectorAll("*").forEach(s=>{const i=window.getComputedStyle(s),n=s.getAttribute("style")||"",a=["fill","stroke","stroke-width","opacity","font-family","font-size"].map(r=>`${r}: ${i.getPropertyValue(r)}`).join("; ");s.setAttribute("style",`${n}; ${a}`)})}setVoronoiOverlay(t){this.voronoiEnabled=t,t?(this.voronoiOverlay||(this.voronoiOverlay=new Yt(this.chartGroup,this.width,this.height,this.xScale,this.yScale)),this.cachedPoints.length>0&&this.cachedPredictions.length>0&&this.voronoiOverlay.render(this.cachedPoints,this.cachedPredictions,this.config.boundaryOpacity)):this.voronoiOverlay?.clear()}isVoronoiEnabled(){return this.voronoiEnabled}}class Kt{container;svg;width;height;margin={top:20,right:50,bottom:30,left:50};xScale;yScaleLoss;yScaleAccuracy;lossLine;valLossLine;accuracyLine;lossPath;valLossPath;accuracyPath;xAxisGroup;yAxisLossGroup;yAxisAccuracyGroup;constructor(t,e=400,s=200){const i=document.getElementById(t);if(!i)throw new Error(`Container element with ID "${t}" not found.`);this.container=I(i),this.width=e-this.margin.left-this.margin.right,this.height=s-this.margin.top-this.margin.bottom,this.container.selectAll("*").remove();const n=this.container.append("svg").attr("viewBox",`0 0 ${e} ${s}`).attr("preserveAspectRatio","xMidYMid meet").style("width","100%").style("height","100%").attr("class","loss-chart");this.svg=n.append("g").attr("transform",`translate(${this.margin.left},${this.margin.top})`),this.xScale=B().range([0,this.width]),this.yScaleLoss=B().range([this.height,0]),this.yScaleAccuracy=B().domain([0,1]).range([this.height,0]),this.lossLine=K().x(o=>this.xScale(o.epoch)).y(o=>this.yScaleLoss(o.loss)).curve(Q),this.valLossLine=K().defined(o=>o.valLoss!==null).x(o=>this.xScale(o.epoch)).y(o=>this.yScaleLoss(o.valLoss??0)).curve(Q),this.accuracyLine=K().x(o=>this.xScale(o.epoch)).y(o=>this.yScaleAccuracy(o.accuracy)).curve(Q),this.xAxisGroup=this.svg.append("g").attr("class","x-axis axis").attr("transform",`translate(0,${this.height})`),this.yAxisLossGroup=this.svg.append("g").attr("class","y-axis-loss axis"),this.yAxisAccuracyGroup=this.svg.append("g").attr("class","y-axis-accuracy axis").attr("transform",`translate(${this.width},0)`),this.lossPath=this.svg.append("path").attr("class","loss-line").attr("fill","none").attr("stroke","#00D9FF").attr("stroke-width",2),this.valLossPath=this.svg.append("path").attr("class","val-loss-line").attr("fill","none").attr("stroke","#FF00AA").attr("stroke-width",2).attr("stroke-dasharray","4,2"),this.accuracyPath=this.svg.append("path").attr("class","accuracy-line").attr("fill","none").attr("stroke","#10B981").attr("stroke-width",2),this.addLegend(),this.addAxisLabels(),this.resizeObserver=new ResizeObserver(o=>{for(const a of o)a.contentRect&&this.resize(a.contentRect.width,a.contentRect.height)}),this.resizeObserver.observe(i)}resize(t,e){if(t===0||e===0)return;this.width=t-this.margin.left-this.margin.right,this.height=e-this.margin.top-this.margin.bottom,this.svg.attr("viewBox",`0 0 ${t} ${e}`),this.xScale.range([0,this.width]),this.yScaleLoss.range([this.height,0]),this.yScaleAccuracy.range([this.height,0]),this.svg.select(".x-axis").attr("transform",`translate(0,${this.height})`).call(N(this.xScale).ticks(5).tickFormat(P("d"))),this.svg.select(".y-axis-loss").call(_(this.yScaleLoss).ticks(5).tickFormat(P(".3f"))),this.svg.select(".y-axis-accuracy").attr("transform",`translate(${this.width},0)`).call(et(this.yScaleAccuracy).ticks(5).tickFormat(P(".0%"))),this.svg.select(".legend").attr("transform",`translate(${this.width-80}, -5)`),this.svg.selectAll(".axis-label").remove(),this.addAxisLabels(),this.lossPath.datum()&&(this.lossPath.attr("d",this.lossLine),this.valLossPath.attr("d",this.valLossLine),this.accuracyPath.attr("d",this.accuracyLine))}update(t){const e=t.records;if(e.length===0){this.clear();return}const s=st(e,a=>a.epoch)??1,i=st(e,a=>a.loss)??1,n=st(e,a=>a.valLoss??0)??0,o=Math.max(i,n);this.xScale.domain([1,s]),this.yScaleLoss.domain([0,o*1.1]),this.xAxisGroup.call(N(this.xScale).ticks(Math.min(s,10)).tickFormat(P("d"))),this.yAxisLossGroup.call(_(this.yScaleLoss).ticks(5).tickFormat(P(".3f"))),this.yAxisAccuracyGroup.call(et(this.yScaleAccuracy).ticks(5).tickFormat(P(".0%"))),this.lossPath.datum(e).attr("d",this.lossLine),this.valLossPath.datum(e).attr("d",this.valLossLine),this.accuracyPath.datum(e).attr("d",this.accuracyLine)}clear(){this.lossPath.attr("d",null),this.valLossPath.attr("d",null),this.accuracyPath.attr("d",null),this.xScale.domain([1,10]),this.yScaleLoss.domain([0,1]),this.xAxisGroup.call(N(this.xScale).ticks(5)),this.yAxisLossGroup.call(_(this.yScaleLoss).ticks(5)),this.yAxisAccuracyGroup.call(et(this.yScaleAccuracy).ticks(5))}resizeObserver=null;dispose(){this.resizeObserver&&this.resizeObserver.disconnect(),this.container.selectAll("*").remove()}addLegend(){const t=this.svg.append("g").attr("class","legend").attr("transform",`translate(${this.width-80}, -5)`);t.append("line").attr("x1",0).attr("x2",20).attr("y1",0).attr("y2",0).attr("stroke","#14b8a6").attr("stroke-width",2),t.append("text").attr("x",25).attr("y",4).attr("class","legend-text").text("Train"),t.append("line").attr("x1",0).attr("x2",20).attr("y1",12).attr("y2",12).attr("stroke","#ef4444").attr("stroke-width",2).attr("stroke-dasharray","4,2"),t.append("text").attr("x",25).attr("y",16).attr("class","legend-text").text("Val"),t.append("line").attr("x1",0).attr("x2",20).attr("y1",24).attr("y2",24).attr("stroke","#22c55e").attr("stroke-width",2),t.append("text").attr("x",25).attr("y",28).attr("class","legend-text").text("Acc")}addAxisLabels(){this.svg.append("text").attr("class","axis-label").attr("x",this.width/2).attr("y",this.height+25).attr("text-anchor","middle").text("Epoch"),this.svg.append("text").attr("class","axis-label").attr("transform","rotate(-90)").attr("x",-this.height/2).attr("y",-35).attr("text-anchor","middle").attr("fill","#14b8a6").text("Loss"),this.svg.append("text").attr("class","axis-label").attr("transform","rotate(90)").attr("x",this.height/2).attr("y",-this.width-35).attr("text-anchor","middle").attr("fill","#22c55e").text("Accuracy")}}class Qt{svg;width;height;margin={top:20,right:20,bottom:20,left:20};constructor(t){const e=t.getBoundingClientRect();this.width=e.width||300,this.height=e.height||200,I(t).selectAll("*").remove(),this.svg=I(t).append("svg").attr("width","100%").attr("height","100%").attr("viewBox",`0 0 ${this.width} ${this.height}`).attr("preserveAspectRatio","xMidYMid meet")}render(t,e=[],s){if(t.length===0)return;const i=this.width-this.margin.left-this.margin.right,n=this.height-this.margin.top-this.margin.bottom;this.svg.selectAll("*").remove();const o=this.svg.append("g").attr("transform",`translate(${this.margin.left},${this.margin.top})`),a=[],r=[],c=i/(t.length-1||1),h=Math.max(...t);t.forEach((g,y)=>{const v=n/(g+1),L=y===0?"input":y===t.length-1?"output":"hidden";for(let b=0;b<g;b++){const E={id:`L${y}N${b}`,layer:y,index:b,x:y*c,y:(b+1)*v,type:L,activation:e[y]??(L==="output"?"softmax":"relu")};if(a.push(E),y>0){const k=t[y-1]??0;for(let A=0;A<k;A++){const z=s?.[y-1]?.[A]?.[b];r.push({source:`L${y-1}N${A}`,target:E.id,weight:z})}}}}),o.append("g").attr("class","links").selectAll("line").data(r).enter().append("line").attr("x1",g=>a.find(v=>v.id===g.source)?.x??0).attr("y1",g=>a.find(v=>v.id===g.source)?.y??0).attr("x2",g=>a.find(v=>v.id===g.target)?.x??0).attr("y2",g=>a.find(v=>v.id===g.target)?.y??0).attr("stroke",g=>g.weight===void 0?"var(--border-color)":g.weight>=0?"#22c55e":"#ef4444").attr("stroke-width",g=>g.weight===void 0?.5:Math.min(3,Math.abs(g.weight)*2)).attr("stroke-opacity",.3);const u=o.append("g").attr("class","nodes"),d=Math.min(15,n/(h*3));u.selectAll("circle").data(a).enter().append("circle").attr("cx",g=>g.x).attr("cy",g=>g.y).attr("r",d).attr("fill",g=>{switch(g.type){case"input":return"#3b82f6";case"output":return"#22c55e";default:return"#8b5cf6"}}).attr("stroke","var(--bg-primary)").attr("stroke-width",2);const f=o.append("g").attr("class","labels"),w=t.map((g,y)=>({x:y*c,label:y===0?"Input":y===t.length-1?"Output":`Hidden ${y}`,size:g}));f.selectAll("text").data(w).enter().append("text").attr("x",g=>g.x).attr("y",n+15).attr("text-anchor","middle").attr("fill","var(--text-secondary)").attr("font-size","9px").text(g=>`${g.label} (${g.size})`),e.length>0&&f.selectAll(".activation").data(w.slice(1)).enter().append("text").attr("class","activation").attr("x",g=>g.x).attr("y",-5).attr("text-anchor","middle").attr("fill","var(--text-muted)").attr("font-size","8px").text((g,y)=>e[y+1]??"")}clear(){this.svg.selectAll("*").remove()}}class te{latencyMs;constructor(t=500){this.latencyMs=t}async getDataset(t,e){await this.simulateLatency();const s=e?.samples??200,i=e?.noise??.1,n=e?.numClasses??2,o=e?.classBalance??.5;return this.getDatasetGenerator(t)(s,i,n,o)}getAvailableTypes(){return["circle","xor","spiral","gaussian","clusters","iris","wine"]}async simulateLatency(){return new Promise(t=>setTimeout(t,this.latencyMs))}getDatasetGenerator(t){const s={circle:(i,n,o,a)=>this.generateCircleDataset(i,n,o,a),xor:(i,n,o,a)=>this.generateXorDataset(i,n,o,a),spiral:(i,n,o,a)=>this.generateSpiralDataset(i,n,o,a),gaussian:(i,n,o,a)=>this.generateGaussianDataset(i,n,o,a),clusters:(i,n,o,a)=>this.generateClustersDataset(i,n,o,a),iris:()=>this.generateIrisDataset(),wine:()=>this.generateWineDataset()}[t.toLowerCase()];if(!s)throw new Error(`Unknown dataset type: "${t}". Available types: ${this.getAvailableTypes().join(", ")}`);return s}generateCircleDataset(t,e,s,i){const n=[],o=this.calculateClassSamples(t,s,i);for(let a=0;a<s;a++){const r=.2+a*.6/Math.max(s-1,1),c=o[a]??0;for(let h=0;h<c;h++){const m=2*Math.PI*h/c,u=r+this.noise(.05*e*5);n.push({x:u*Math.cos(m)+this.noise(e*.2),y:u*Math.sin(m)+this.noise(e*.2),label:a})}}return this.shuffle(n)}generateXorDataset(t,e,s,i){const n=[],o=this.calculateClassSamples(t,2,i),a=o[0]??0,r=o[1]??0;for(let c=0;c<Math.floor(a/2);c++)n.push({x:.2+Math.random()*.6+this.noise(e*.3),y:.2+Math.random()*.6+this.noise(e*.3),label:0}),n.push({x:-(.2+Math.random()*.6)+this.noise(e*.3),y:-(.2+Math.random()*.6)+this.noise(e*.3),label:0});for(let c=0;c<Math.floor(r/2);c++)n.push({x:.2+Math.random()*.6+this.noise(e*.3),y:-(.2+Math.random()*.6)+this.noise(e*.3),label:1}),n.push({x:-(.2+Math.random()*.6)+this.noise(e*.3),y:.2+Math.random()*.6+this.noise(e*.3),label:1});return this.shuffle(n)}generateSpiralDataset(t,e,s,i){const n=[],o=this.calculateClassSamples(t,s,i);for(let a=0;a<s;a++){const r=a*2*Math.PI/s,c=o[a]??0;for(let h=0;h<c;h++){const m=h/c*2*Math.PI,u=(.1+m/(2*Math.PI)*.8)*(1+this.noise(e)),d=m+r;n.push({x:u*Math.cos(d),y:u*Math.sin(d),label:a})}}return this.shuffle(n)}generateGaussianDataset(t,e,s,i){const n=[],o=this.calculateClassSamples(t,2,i),a=[{cx:-.5,cy:-.5,label:0,count:o[0]??0},{cx:.5,cy:.5,label:1,count:o[1]??0}];for(const{cx:r,cy:c,label:h,count:m}of a)for(let u=0;u<m;u++)n.push({x:r+this.gaussianNoise(.15+e*.3),y:c+this.gaussianNoise(.15+e*.3),label:h});return this.shuffle(n)}generateClustersDataset(t,e,s,i){const n=[],o=this.calculateClassSamples(t,s,i),a=Math.ceil(Math.sqrt(s));for(let r=0;r<s;r++){const c=Math.floor(r/a),m=(r%a+.5)/a*1.4-.7,u=(c+.5)/a*1.4-.7,d=o[r]??0;for(let f=0;f<d;f++)n.push({x:m+this.gaussianNoise(.12+e*.2),y:u+this.gaussianNoise(.12+e*.2),label:r})}return this.shuffle(n)}calculateClassSamples(t,e,s){if(e===2){const r=Math.round(t*s),c=t-r;return[r,c]}const i=Math.round(t*s),n=t-i,o=Math.floor(n/(e-1)),a=[i];for(let r=1;r<e;r++)a.push(o);return a}generateIrisDataset(){const t=[[-.9,.36,0],[-.87,-.14,0],[-.94,-.02,0],[-.91,-.14,0],[-.92,.39,0],[-.79,.59,0],[-.89,.14,0],[-.88,.25,0],[-.93,-.31,0],[-.87,-.04,0],[-.83,.52,0],[-.86,.17,0],[-.89,-.11,0],[-.99,-.2,0],[-.8,.73,0],[-.73,.82,0],[-.82,.59,0],[-.88,.36,0],[-.74,.61,0],[-.84,.47,0],[-.78,.36,0],[-.84,.42,0],[-.98,.22,0],[-.8,.17,0],[-.82,.17,0],[-.83,-.02,0],[-.84,.25,0],[-.87,.39,0],[-.87,.31,0],[-.86,-.02,0],[-.85,-.08,0],[-.81,.36,0],[-.83,.64,0],[-.78,.7,0],[-.87,-.04,0],[-.91,.17,0],[-.85,.45,0],[-.92,.28,0],[-.95,-.17,0],[-.87,.28,0],[-.89,.33,0],[-.82,-.56,0],[-.94,-.08,0],[-.81,.33,0],[-.78,.47,0],[-.87,-.11,0],[-.84,.45,0],[-.92,0,0],[-.84,.5,0],[-.88,.2,0],[.14,.33,1],[-.05,.17,1],[.08,.36,1],[-.22,-.36,1],[0,.11,1],[-.11,-.02,1],[.03,.28,1],[-.45,-.31,1],[-.03,.08,1],[-.27,-.17,1],[-.41,-.56,1],[-.14,.03,1],[-.19,-.42,1],[-.03,-.08,1],[-.22,-.08,1],[.03,.22,1],[-.11,.08,1],[-.08,-.25,1],[.11,-.42,1],[-.24,-.28,1],[.08,-.02,1],[-.08,0,1],[.19,-.25,1],[-.05,-.22,1],[-.14,-.08,1],[-.03,.03,1],[.03,.17,1],[.08,.25,1],[-.05,.11,1],[-.3,-.22,1],[-.27,-.31,1],[-.3,-.36,1],[-.19,-.17,1],[.14,-.14,1],[-.11,-.17,1],[.03,.31,1],[0,.22,1],[-.05,0,1],[-.16,-.02,1],[-.16,-.17,1],[-.19,-.08,1],[0,-.22,1],[-.14,-.11,1],[-.03,-.25,1],[-.16,-.14,1],[-.16,-.08,1],[-.05,.06,1],[-.19,-.02,1],[-.38,-.17,1],[-.19,-.06,1],[.54,.06,2],[.3,-.22,2],[.49,.08,2],[.35,-.17,2],[.43,-.03,2],[.68,.33,2],[-.03,-.47,2],[.57,.14,2],[.41,-.31,2],[.62,.39,2],[.35,.11,2],[.38,-.11,2],[.46,0,2],[.27,-.28,2],[.32,.03,2],[.41,.14,2],[.38,0,2],[.73,.5,2],[.76,-.08,2],[.19,-.39,2],[.51,.17,2],[.24,-.11,2],[.7,0,2],[.27,-.17,2],[.43,.11,2],[.49,.17,2],[.22,-.06,2],[.24,.03,2],[.38,-.06,2],[.3,-.03,2],[.35,-.22,2],[.62,-.06,2],[.35,-.14,2],[.3,-.08,2],[.3,-.25,2],[.57,.36,2],[.43,.11,2],[.35,.22,2],[.27,-.14,2],[.41,.03,2],[.38,0,2],[.41,-.03,2],[.3,-.22,2],[.46,.08,2],[.49,.17,2],[.43,.06,2],[.3,0,2],[.35,.03,2],[.41,.14,2],[.24,-.03,2]];return this.shuffle(t.map(([e,s,i])=>({x:e,y:s,label:i})))}generateWineDataset(){const t=[[.65,-.22,0],[.47,-.35,0],[.52,-.08,0],[.78,.03,0],[.38,.14,0],[.68,-.11,0],[.73,-.06,0],[.49,-.25,0],[.6,.08,0],[.65,-.03,0],[.57,.11,0],[.52,-.17,0],[.7,-.14,0],[.84,0,0],[.62,.06,0],[.76,.17,0],[.54,.03,0],[.68,-.08,0],[.81,.11,0],[.43,-.19,0],[.65,.14,0],[.49,-.11,0],[.57,-.03,0],[.73,.06,0],[.6,-.14,0],[.46,-.28,0],[.54,0,0],[.62,-.06,0],[.7,.03,0],[.41,-.22,0],[.68,.08,0],[.76,-.03,0],[.52,-.14,0],[.84,.06,0],[.57,.17,0],[.65,-.11,0],[.49,.03,0],[.73,0,0],[.6,-.08,0],[.43,-.25,0],[.54,.11,0],[.78,-.06,0],[.46,-.17,0],[.62,.14,0],[.7,-.03,0],[.38,-.31,0],[.81,.03,0],[.52,.06,0],[.68,-.14,0],[.57,-.06,0],[.65,0,0],[.49,-.08,0],[.73,.11,0],[.41,-.19,0],[.6,.03,0],[.76,-.11,0],[.54,-.03,0],[.84,.08,0],[.46,0,0],[-.16,.22,1],[-.27,.08,1],[-.08,.31,1],[-.35,.14,1],[-.19,.25,1],[-.11,.17,1],[-.3,.03,1],[-.22,.28,1],[-.03,.19,1],[-.38,.11,1],[-.14,.33,1],[-.27,.22,1],[-.05,.14,1],[-.32,.06,1],[-.19,.17,1],[-.24,.28,1],[-.11,.25,1],[-.35,.19,1],[-.16,.08,1],[-.08,.31,1],[-.3,.14,1],[-.22,.22,1],[-.03,.17,1],[-.38,.03,1],[-.14,.28,1],[-.27,.11,1],[-.19,.33,1],[-.05,.22,1],[-.32,.17,1],[-.24,.06,1],[-.11,.19,1],[-.35,.25,1],[-.16,.14,1],[-.08,.28,1],[-.3,.08,1],[-.22,.17,1],[-.03,.33,1],[-.38,.22,1],[-.14,.11,1],[-.27,.25,1],[-.19,.03,1],[-.05,.19,1],[-.32,.28,1],[-.24,.14,1],[-.11,.31,1],[-.35,.08,1],[-.16,.22,1],[-.08,.17,1],[-.3,.33,1],[-.22,.11,1],[-.03,.25,1],[-.38,.14,1],[-.14,.06,1],[-.27,.19,1],[-.19,.28,1],[-.05,.08,1],[-.32,.22,1],[-.24,.31,1],[-.11,.14,1],[-.35,.17,1],[-.16,.25,1],[-.08,.03,1],[-.3,.19,1],[-.22,.33,1],[-.03,.11,1],[-.38,.28,1],[-.14,.22,1],[-.27,.06,1],[-.19,.14,1],[-.05,.25,1],[-.32,.08,1],[-.68,-.42,2],[-.54,-.31,2],[-.76,-.36,2],[-.62,-.47,2],[-.49,-.39,2],[-.7,-.28,2],[-.57,-.44,2],[-.81,-.33,2],[-.65,-.5,2],[-.52,-.36,2],[-.73,-.42,2],[-.6,-.31,2],[-.84,-.39,2],[-.46,-.47,2],[-.68,-.28,2],[-.54,-.44,2],[-.76,-.36,2],[-.62,-.5,2],[-.49,-.33,2],[-.7,-.42,2],[-.57,-.31,2],[-.81,-.47,2],[-.65,-.39,2],[-.52,-.28,2],[-.73,-.44,2],[-.6,-.36,2],[-.84,-.5,2],[-.46,-.33,2],[-.68,-.42,2],[-.54,-.47,2],[-.76,-.31,2],[-.62,-.39,2],[-.49,-.28,2],[-.7,-.44,2],[-.57,-.36,2],[-.81,-.5,2],[-.65,-.33,2],[-.52,-.42,2],[-.73,-.47,2],[-.6,-.28,2],[-.84,-.44,2],[-.46,-.36,2],[-.68,-.5,2],[-.54,-.33,2],[-.76,-.42,2],[-.62,-.31,2],[-.49,-.47,2],[-.7,-.39,2]];return this.shuffle(t.map(([e,s,i])=>({x:e,y:s,label:i})))}noise(t){return(Math.random()-.5)*2*t}gaussianNoise(t){const e=Math.random(),s=Math.random();return Math.sqrt(-2*Math.log(e))*Math.cos(2*Math.PI*s)*t}shuffle(t){const e=[...t];for(let s=e.length-1;s>0;s--){const i=Math.floor(Math.random()*(s+1)),n=e[s];e[s]=e[i],e[i]=n}return e}}class St{available;constructor(){this.available=this.checkAvailability()}checkAvailability(){try{const t="__ls_test__";return localStorage.setItem(t,"test"),localStorage.removeItem(t),!0}catch{return!1}}setItem(t,e){if(!this.available)return{success:!1,error:"localStorage is not supported or disabled"};try{const s=JSON.stringify(e);return localStorage.setItem(t,s),{success:!0}}catch(s){return s instanceof DOMException&&(s.code===22||s.code===1014||s.name==="QuotaExceededError")?{success:!1,error:"Storage quota exceeded"}:{success:!1,error:"Unknown storage error"}}}getItem(t,e){if(!this.available)return{success:!1,data:e,error:"localStorage is not supported or disabled"};try{const s=localStorage.getItem(t);return s===null?{success:!0,data:e}:{success:!0,data:JSON.parse(s)}}catch(s){return console.warn(`Failed to parse localStorage item "${t}":`,s),{success:!1,data:e,error:"Failed to parse stored data"}}}removeItem(t){if(!this.available)return{success:!1,error:"localStorage is not supported or disabled"};try{return localStorage.removeItem(t),{success:!0}}catch{return{success:!1,error:"Unknown storage error"}}}clear(){if(!this.available)return{success:!1,error:"localStorage is not supported or disabled"};try{return localStorage.clear(),{success:!0}}catch{return{success:!1,error:"Unknown storage error"}}}hasItem(t){if(!this.available)return!1;try{return localStorage.getItem(t)!==null}catch{return!1}}getAllKeys(){if(!this.available)return[];try{const t=[];for(let e=0;e<localStorage.length;e++){const s=localStorage.key(e);s&&t.push(s)}return t}catch{return[]}}getStorageSize(){if(!this.available)return 0;try{let t=0;for(let e=0;e<localStorage.length;e++){const s=localStorage.key(e);if(s){const i=localStorage.getItem(s);i&&(t+=(s.length+i.length)*2)}}return t}catch{return 0}}isAvailable(){return this.available}}new St;const rt={visualization:{width:500,height:500,gridSize:50,renderInterval:10},api:{latencyMs:0},validation:{maxLayers:10,maxLayerSize:1024,minLearningRate:1e-4,maxLearningRate:1},ui:{toastDuration:5e3,toastAnimationDuration:300},build:{basePath:"/"}};let x=null;function ee(){return x||(x=document.createElement("div"),x.id="toast-container",x.className="toast-container",x.setAttribute("role","region"),x.setAttribute("aria-label","Notifications"),x.setAttribute("aria-live","polite"),document.body.appendChild(x)),x}function Z(l,t={}){const{type:e="info",duration:s=rt.ui.toastDuration,dismissible:i=!0}=t,n=ee(),o=document.createElement("div");o.className=`toast toast-${e}`,o.setAttribute("role","status"),o.setAttribute("aria-live",e==="error"?"assertive":"polite");const a=se(e),r=document.createElement("span");if(r.className="toast-message",r.textContent=l,o.appendChild(a),o.appendChild(r),i){const h=document.createElement("button");h.className="toast-close",h.setAttribute("aria-label","Close notification"),h.innerHTML="&times;",h.onclick=()=>it(o),o.appendChild(h)}n.appendChild(o),o.offsetHeight,o.classList.add("toast-show");let c=null;return s>0&&(c=window.setTimeout(()=>{it(o)},s)),()=>{c!==null&&clearTimeout(c),it(o)}}function it(l){l.classList.remove("toast-show"),l.classList.add("toast-hide"),setTimeout(()=>{l.remove(),x&&x.children.length===0&&(x.remove(),x=null)},rt.ui.toastAnimationDuration)}function se(l){const t=document.createElement("span");switch(t.className="toast-icon",t.setAttribute("aria-hidden","true"),l){case"success":t.innerHTML="&#10003;";break;case"error":t.innerHTML="&#10006;";break;case"warning":t.innerHTML="&#9888;";break;case"info":default:t.innerHTML="&#9432;";break}return t}const p={success:(l,t)=>Z(l,{...t,type:"success"}),error:(l,t)=>Z(l,{...t,type:"error"}),warning:(l,t)=>Z(l,{...t,type:"warning"}),info:(l,t)=>Z(l,{...t,type:"info"})};class xt{config;errorCount=0;lastErrorTime=0;ERROR_THROTTLE_MS=5e3;MAX_ERRORS_BEFORE_DISABLE=10;constructor(t={}){this.config={showToasts:t.showToasts??!0,enableReporting:t.enableReporting??!1,onError:t.onError,ignoreErrors:t.ignoreErrors}}init(){window.addEventListener("error",this.handleError.bind(this)),window.addEventListener("unhandledrejection",this.handleUnhandledRejection.bind(this)),S.info("Global error boundary initialized",{component:"ErrorBoundary",action:"init"})}handleError(t){const e={type:"error",message:t.message,filename:t.filename,lineno:t.lineno,colno:t.colno,stack:t.error?.stack,timestamp:Date.now()};if(this.shouldIgnoreError(t.message)){S.debug("Ignoring error (matches ignore pattern)",e);return}if(S.error(`Uncaught error: ${t.message}`,t.error,{...e,component:"ErrorBoundary"}),this.config.enableReporting&&this.config.onError)try{this.config.onError(t.error,e)}catch(s){S.error("Failed to report error",s)}this.config.showToasts&&this.shouldShowToast()&&this.showErrorToast("An unexpected error occurred"),t.preventDefault()}handleUnhandledRejection(t){const e=t.reason instanceof Error?t.reason:new Error(String(t.reason)),s={type:"unhandledRejection",message:e.message,stack:e.stack,timestamp:Date.now()};if(this.shouldIgnoreError(e.message)){S.debug("Ignoring promise rejection (matches ignore pattern)",s);return}if(S.error(`Unhandled promise rejection: ${e.message}`,e,{...s,component:"ErrorBoundary"}),this.config.enableReporting&&this.config.onError)try{this.config.onError(e,s)}catch(i){S.error("Failed to report error",i)}this.config.showToasts&&this.shouldShowToast()&&this.showErrorToast("An operation failed unexpectedly"),t.preventDefault()}shouldIgnoreError(t){return!this.config.ignoreErrors||this.config.ignoreErrors.length===0?!1:this.config.ignoreErrors.some(e=>e.test(t))}shouldShowToast(){const t=Date.now();return this.errorCount>=this.MAX_ERRORS_BEFORE_DISABLE?(S.warn("Error toast limit reached, disabling toasts",{component:"ErrorBoundary",errorCount:this.errorCount}),!1):t-this.lastErrorTime<this.ERROR_THROTTLE_MS?!1:(this.errorCount++,this.lastErrorTime=t,!0)}showErrorToast(t){p.error(t)}resetErrorCount(){this.errorCount=0,this.lastErrorTime=0}getErrorCount(){return this.errorCount}reportError(t,e){const s={type:"error",message:t.message,stack:t.stack,timestamp:Date.now(),...e};if(S.error(`Manually reported error: ${t.message}`,t,{...s,component:"ErrorBoundary"}),this.config.enableReporting&&this.config.onError)try{this.config.onError(t,s)}catch(i){S.error("Failed to report error",i)}}}new xt({showToasts:!0,enableReporting:!1,ignoreErrors:[/Script error\./i,/ResizeObserver loop/i]});function ie(l){const t=document.createElement("div");return t.textContent=l,t.innerHTML}function U(l,...t){return l.reduce((e,s,i)=>{const n=t[i],o=n==null?"":typeof n=="number"||typeof n=="boolean"?String(n):ie(String(n));return e+s+o},"")}const gt={"learning-rate":{title:"Learning Rate",simple:"How big of steps the network takes when learning. Too big = overshoots, too small = takes forever.",analogy:" Like adjusting how far you jump when playing hot/cold. Big jumps find the area fast, but small steps find the exact spot.",tip:"Start with 0.01-0.1. If loss jumps around, go smaller. If it barely moves, go bigger."},layers:{title:"Hidden Layers",simple:'The "thinking" layers between input and output. More layers = can learn more complex patterns.',analogy:" Like having multiple people pass a message, each adding their interpretation.",tip:"Start with 1-2 layers of 4-8 neurons. Add more only if needed."},neurons:{title:"Neurons per Layer",simple:'How many "detectors" in each layer. More neurons = can detect more features.',analogy:" Like having more eyes looking at different parts of a picture.",tip:"Usually 2-4x the input size. Too many can cause overfitting."},epochs:{title:"Epochs",simple:"How many times the network sees all the training data.",analogy:" Like re-reading a textbook. First read = get the gist. More reads = deeper understanding.",tip:"Watch the loss curve. Stop when it flattens or validation loss rises."},"batch-size":{title:"Batch Size",simple:"How many examples to look at before updating. Smaller = noisier but faster learning.",analogy:" Like deciding how many pizza slices to taste before judging the whole pizza.",tip:"Try 16-64. Smaller batches add noise that can help escape bad spots."},"activation-relu":{title:"ReLU Activation",simple:"Keeps positive values, zeros out negatives. Simple and fast.",analogy:" Like a one-way valve that only lets positive signals through.",tip:"Default choice for hidden layers. Fast and works well most of the time."},"activation-sigmoid":{title:"Sigmoid Activation",simple:"Squashes values between 0 and 1. Good for probabilities.",analogy:" Like a dimmer switch that smoothly goes from off (0) to on (1).",tip:'Use for binary classification output. Can cause "vanishing gradients" in deep networks.'},"activation-tanh":{title:"Tanh Activation",simple:"Squashes values between -1 and 1. Centered around zero.",analogy:" Like a balance scale that tips left (-1) or right (+1).",tip:"Good when you need negative outputs. Often works better than sigmoid in hidden layers."},"activation-softmax":{title:"Softmax Activation",simple:"Converts scores to probabilities that sum to 1. Used for multi-class output.",analogy:" Like dividing a pie so all slices add up to 100%.",tip:"Always use for multi-class classification output layer."},"optimizer-sgd":{title:"SGD (Stochastic Gradient Descent)",simple:"The classic optimizer. Simple but can be slow.",analogy:" Like walking downhill by always stepping in the steepest direction.",tip:"Good baseline. Add momentum to speed it up."},"optimizer-adam":{title:"Adam Optimizer",simple:"Smart optimizer that adapts learning rate for each parameter.",analogy:" Like a car with automatic transmission that adjusts speed for the terrain.",tip:"Usually the best default choice. Works well out of the box."},"optimizer-rmsprop":{title:"RMSprop Optimizer",simple:"Adapts learning rate based on recent gradients. Good for noisy data.",analogy:" Like adjusting volume based on how loud the recent notes were.",tip:"Good for recurrent networks and noisy problems."},dropout:{title:"Dropout",simple:'Randomly "turns off" neurons during training. Prevents over-reliance on any single neuron.',analogy:" Like training a team where random members sit out each practice, so everyone learns to contribute.",tip:"Try 0.1-0.5. Higher values = stronger regularization."},"l1-regularization":{title:"L1 Regularization (Lasso)",simple:"Pushes small weights to exactly zero. Creates sparse networks.",analogy:" Like a strict editor who cuts unnecessary words entirely.",tip:"Good for feature selection. Makes some weights exactly 0."},"l2-regularization":{title:"L2 Regularization (Ridge)",simple:"Keeps weights small but not zero. Prevents any weight from dominating.",analogy:" Like a fair teacher who makes sure no student does all the work.",tip:"Most common choice. Try 0.001-0.01."},"batch-norm":{title:"Batch Normalization",simple:"Normalizes layer inputs. Helps training be faster and more stable.",analogy:" Like making sure everyone uses the same units before comparing.",tip:"Usually helps. Can sometimes hurt with very small batches."},loss:{title:"Loss",simple:"How wrong the network is. Lower = better. The goal is to minimize this.",analogy:" Like the distance from the bullseye. Training tries to get closer.",tip:"Watch for: decreasing = good, stuck = try different settings, increasing = problem!"},accuracy:{title:"Accuracy",simple:"Percentage of correct predictions. Higher = better.",analogy:" Like your test score. 90% = got 9 out of 10 right.",tip:"Good for balanced datasets. Can be misleading if classes are imbalanced."},overfitting:{title:"Overfitting",simple:"Network memorizes training data instead of learning patterns. Works great on training, fails on new data.",analogy:" Like memorizing answers instead of understanding the subject.",tip:"Signs: train accuracy >> validation accuracy. Fix: more data, dropout, regularization."},underfitting:{title:"Underfitting",simple:"Network is too simple to learn the pattern. Bad on both training and new data.",analogy:" Like using a hammer for everything. Sometimes you need more tools.",tip:"Signs: both train and val accuracy are low. Fix: more layers, more neurons, train longer."},"validation-split":{title:"Validation Split",simple:"Portion of data held back to test how well the model generalizes.",analogy:" Like saving some practice problems to test yourself before the real exam.",tip:"Usually 10-20%. Helps detect overfitting early."},"dataset-circle":{title:"Circle Dataset",simple:"Points inside vs outside a circle. Tests if network can learn curved boundaries.",analogy:" Like separating darts that hit the bullseye from those that missed.",tip:"Simple dataset. Good for testing basic setups."},"dataset-xor":{title:"XOR Dataset",simple:"Classic problem that requires at least one hidden layer to solve.",analogy:' Like "opposite corners are friends" - needs non-linear thinking.',tip:"If your network can't solve this, something is wrong with the setup."},"dataset-spiral":{title:"Spiral Dataset",simple:"Intertwined spirals. Very hard! Requires deep networks.",analogy:" Like separating two tangled phone cords by color.",tip:"Needs multiple layers and many neurons. Great for testing network capacity."},"dataset-moons":{title:"Moons Dataset",simple:"Two interleaving half-circles. Moderately challenging.",analogy:" Like separating two crescent moons facing each other.",tip:"Good middle-ground difficulty. 1-2 hidden layers usually enough."},"decision-boundary":{title:"Decision Boundary",simple:"The line (or curve) where the network switches from predicting one class to another.",analogy:" Like borders on a map showing where one country ends and another begins.",tip:"Smooth = good generalization. Too wiggly = overfitting."},"confusion-matrix":{title:"Confusion Matrix",simple:"Table showing what the model predicted vs what was actually true.",analogy:" Like a report card showing which questions you got right and which you confused.",tip:"Diagonal = correct. Off-diagonal = mistakes. Look for patterns in errors."},"what-if":{title:"What-If Analysis",simple:"Tests different settings to see which works best for your data.",analogy:" Like trying different recipes to see which tastes best.",tip:"Run this before long training sessions to find optimal settings."},"gradient-flow":{title:"Gradient Flow",simple:"Shows how much each layer is learning. Higher bars = more learning happening.",analogy:" Like a fitness tracker showing which muscles are working hardest.",tip:'If early layers have tiny gradients, you might have "vanishing gradients" - try ReLU or batch norm.'}};class ne{tooltipElement=null;hideTimeout=null;constructor(){this.createTooltipElement(),this.attachListeners()}createTooltipElement(){this.tooltipElement=document.createElement("div"),this.tooltipElement.id="eli5-tooltip",this.tooltipElement.className=`
      fixed z-[100] max-w-xs p-3 rounded-lg shadow-xl
      bg-navy-800 border border-navy-600
      text-sm text-slate-200
      opacity-0 pointer-events-none
      transition-opacity duration-200
    `.replace(/\s+/g," ").trim(),this.tooltipElement.style.display="none",document.body.appendChild(this.tooltipElement)}attachListeners(){document.addEventListener("mouseover",t=>{const e=t.target.closest("[data-eli5]");if(e){const s=e.getAttribute("data-eli5");s&&gt[s]&&this.show(gt[s],e)}}),document.addEventListener("mouseout",t=>{t.target.closest("[data-eli5]")&&this.scheduleHide()})}show(t,e){if(!this.tooltipElement)return;this.hideTimeout&&(clearTimeout(this.hideTimeout),this.hideTimeout=null);let s=U`
      <div class="font-semibold text-white mb-1">${t.title}</div>
      <div class="text-slate-300 mb-2">${t.simple}</div>
    `;t.analogy&&(s+=U`<div class="text-slate-400 text-xs mb-2">${t.analogy}</div>`),t.tip&&(s+=U`<div class="text-emerald-400 text-xs"> ${t.tip}</div>`),this.tooltipElement.innerHTML=s,this.tooltipElement.style.display="block";const i=e.getBoundingClientRect(),n=this.tooltipElement.getBoundingClientRect();let o=i.left+i.width/2-n.width/2,a=i.bottom+8;o<8&&(o=8),o+n.width>window.innerWidth-8&&(o=window.innerWidth-n.width-8),a+n.height>window.innerHeight-8&&(a=i.top-n.height-8),this.tooltipElement.style.left=`${o}px`,this.tooltipElement.style.top=`${a}px`,this.tooltipElement.style.opacity="1"}scheduleHide(){this.hideTimeout=setTimeout(()=>{this.hide()},150)}hide(){this.tooltipElement&&(this.tooltipElement.style.opacity="0",setTimeout(()=>{this.tooltipElement&&(this.tooltipElement.style.display="none")},200))}}function ae(){return new ne}function oe(l){const t=document.getElementById(l);t&&(t.innerHTML="",t.classList.add("hidden"))}function re(l){const t=document.getElementById(l);t&&t.classList.remove("hidden")}class le{constructor(t,e,s){this.session=t,this.visualizerService=e,this.elements=s,this.bindEvents()}customDataPoints=[];currentDrawLabel=0;boundHandlers=new Map;bindEvents(){const t=()=>void this.handleLoadData(),e=()=>this.handleDatasetSelectChange(),s=()=>this.handleClearCustomData(),i=()=>this.handleSamplesChange(),n=()=>this.handleNoiseChange(),o=r=>this.handleCsvUpload(r),a=()=>this.handleDownloadDataset();this.elements.btnLoadData.addEventListener("click",t),this.elements.datasetSelect.addEventListener("change",e),this.elements.btnClearCustom.addEventListener("click",s),this.elements.inputSamples.addEventListener("input",i),this.elements.inputNoise.addEventListener("input",n),this.elements.inputCsvUpload.addEventListener("change",o),this.elements.btnDownloadDataset.addEventListener("click",a),this.boundHandlers.set("loadData",t),this.boundHandlers.set("datasetChange",e),this.boundHandlers.set("clearCustom",s),this.boundHandlers.set("samplesChange",i),this.boundHandlers.set("noiseChange",n),this.boundHandlers.set("csvUpload",o),this.boundHandlers.set("download",a)}dispose(){this.elements.btnLoadData.removeEventListener("click",this.boundHandlers.get("loadData")),this.elements.datasetSelect.removeEventListener("change",this.boundHandlers.get("datasetChange")),this.elements.btnClearCustom.removeEventListener("click",this.boundHandlers.get("clearCustom")),this.elements.inputSamples.removeEventListener("input",this.boundHandlers.get("samplesChange")),this.elements.inputNoise.removeEventListener("input",this.boundHandlers.get("noiseChange")),this.elements.inputCsvUpload.removeEventListener("change",this.boundHandlers.get("csvUpload")),this.elements.btnDownloadDataset.removeEventListener("click",this.boundHandlers.get("download")),this.boundHandlers.clear()}async handleLoadData(){const t=this.elements.datasetSelect.value;if(t==="custom"){this.customDataPoints=[],this.visualizerService.renderData([]),this.enableDrawMode();return}this.showLoading(!0),this.elements.btnLoadData.disabled=!0;const e=t==="iris"||t==="wine",s=parseInt(this.elements.inputSamples.value,10)||200,i=(parseInt(this.elements.inputNoise.value,10)||10)/100,n=parseInt(this.elements.inputNumClasses.value,10)||2,o=(parseInt(this.elements.inputBalance.value,10)||50)/100,a=this.elements.inputPreprocessing.value;try{if(await this.session.loadData(t,{samples:s,noise:i,numClasses:n,classBalance:o,preprocessing:a}),e){const r=t==="iris"?"Iris (150 samples, 3 classes)":"Wine (178 samples, 3 classes)";p.success(`${r} loaded`),this.elements.inputNumClasses.value="3",this.updateDrawClassButtons()}else p.success(`Dataset "${t}" loaded (${s} samples, ${n} classes)`);this.visualizerService.renderData(this.session.getData()),this.visualizerService.disableDrawMode(),this.elements.drawControls.classList.add("hidden")}catch(r){console.error("Failed to load dataset:",r),p.error(`Failed to load dataset: ${r instanceof Error?r.message:"Unknown error"}`)}finally{this.showLoading(!1),this.elements.btnLoadData.disabled=!1}}handleDatasetSelectChange(){const t=this.elements.datasetSelect.value,e=t==="custom",s=t==="iris"||t==="wine";e?(this.elements.drawControls.classList.remove("hidden"),this.elements.datasetOptions.classList.add("hidden"),this.updateDrawClassButtons(),this.enableDrawMode()):(this.elements.drawControls.classList.add("hidden"),this.elements.datasetOptions.classList.remove("hidden"),this.visualizerService.disableDrawMode(),s?this.elements.datasetOptions.classList.add("opacity-50","pointer-events-none"):this.elements.datasetOptions.classList.remove("opacity-50","pointer-events-none"))}handleClearCustomData(){this.customDataPoints=[],this.visualizerService.renderData([]),this.session.setCustomData([]),p.info("Custom data cleared")}handleSamplesChange(){this.elements.samplesValue.textContent=this.elements.inputSamples.value}handleNoiseChange(){this.elements.noiseValue.textContent=this.elements.inputNoise.value}enableDrawMode(){this.visualizerService.enableDrawMode(this.currentDrawLabel,t=>this.handlePointAdded(t)),p.info("Draw mode enabled - click on chart to add points")}handlePointAdded(t){this.customDataPoints.push(t),this.visualizerService.renderData(this.customDataPoints),this.session.setCustomData(this.customDataPoints)}updateDrawClassButtons(){const t=parseInt(this.elements.inputNumClasses.value,10)||2;this.elements.drawClassButtons.innerHTML="";for(let e=0;e<t;e++){const s=V[e%V.length],i=document.createElement("button");i.className=`btn-draw${e===0?" active":""}`,i.dataset.class=String(e),i.innerHTML=`
        <span class="w-3 h-3 rounded-full inline-block" style="background-color: ${s}"></span>
        Class ${e}
      `,i.addEventListener("click",()=>this.handleDrawClassSelect(e)),this.elements.drawClassButtons.appendChild(i)}this.currentDrawLabel=0}handleDrawClassSelect(t){this.currentDrawLabel=t,this.elements.drawClassButtons.querySelectorAll(".btn-draw").forEach((s,i)=>{s.classList.toggle("active",i===t)}),this.visualizerService.isDrawModeEnabled()&&this.visualizerService.enableDrawMode(t,s=>this.handlePointAdded(s))}showLoading(t){t?this.elements.loadingOverlay.classList.remove("hidden"):this.elements.loadingOverlay.classList.add("hidden")}handleCsvUpload(t){const e=t.target;if(!e.files||e.files.length===0)return;const s=e.files[0];if(!s)return;const i=new FileReader;i.onload=n=>{const o=n.target?.result;if(o){try{const a=this.parseCsvData(o);if(a.length===0)throw new Error("No valid data points found in CSV");this.customDataPoints=a,this.session.setCustomData(a),this.visualizerService.renderData(a),this.elements.datasetSelect.value="custom",this.handleDatasetSelectChange(),p.success(`Loaded ${a.length} points from CSV`)}catch(a){console.error("CSV Parse Error:",a),p.error("Failed to parse CSV file. Check format (x,y,label)")}e.value=""}},i.readAsText(s)}parseCsvData(t){const e=t.split(`
`),s=[];let i=0;e[0]&&(e[0].toLowerCase().includes("x")||e[0].toLowerCase().includes("label"))&&(i=1);for(let n=i;n<e.length;n++){const o=e[n].trim();if(!o)continue;const a=o.split(",");if(a.length<3)continue;let r,c,h;a.length===3?(r=parseFloat(a[0]),c=parseFloat(a[1]),h=parseInt(a[2],10),isNaN(h)&&!isNaN(parseFloat(a[0]))&&(h=parseInt(a[0],10),r=parseFloat(a[1]),c=parseFloat(a[2]))):(r=parseFloat(a[0]),c=parseFloat(a[1]),h=parseInt(a[a.length-1],10)),!isNaN(r)&&!isNaN(c)&&!isNaN(h)&&s.push({x:r,y:c,label:h})}return s}handleDownloadDataset(){const t=this.session.getData();if(t.length===0){p.warning("No dataset to download");return}let e=`x,y,label
`;t.forEach(o=>{e+=`${o.x.toFixed(6)},${o.y.toFixed(6)},${o.label}
`});const s=new Blob([e],{type:"text/csv;charset=utf-8;"}),i=URL.createObjectURL(s),n=document.createElement("a");n.setAttribute("href",i),n.setAttribute("download","neuroviz_dataset.csv"),n.style.visibility="hidden",document.body.appendChild(n),n.click(),document.body.removeChild(n)}}class ce{constructor(t,e,s){this.session=t,this.elements=e,this.callbacks=s,this.bindEvents()}bindEvents(){this.elements.btnInit.addEventListener("click",()=>void this.handleInitialise()),this.elements.btnStart.addEventListener("click",()=>this.handleStart()),this.elements.btnPause.addEventListener("click",()=>this.handlePause()),this.elements.btnStep.addEventListener("click",()=>void this.handleStep()),this.elements.btnReset.addEventListener("click",()=>this.handleReset()),this.elements.btnStartSticky.addEventListener("click",()=>this.handleStart()),this.elements.btnPauseSticky.addEventListener("click",()=>this.handlePause()),this.elements.btnStepSticky.addEventListener("click",()=>void this.handleStep()),this.elements.btnResetSticky.addEventListener("click",()=>this.handleReset()),this.elements.fabStart.addEventListener("click",()=>this.handleStart()),this.elements.fabPause.addEventListener("click",()=>this.handlePause()),this.elements.inputLrSchedule.addEventListener("change",()=>this.handleLrScheduleChange()),this.elements.inputFps.addEventListener("input",()=>this.handleFpsChange()),this.elements.inputBatchSize.addEventListener("change",()=>this.handleBatchSizeChange()),this.elements.inputMaxEpochs.addEventListener("change",()=>this.handleMaxEpochsChange()),this.elements.inputValSplit.addEventListener("change",()=>this.handleValSplitChange()),this.elements.inputTargetFps.addEventListener("change",()=>this.handleFpsChange()),this.elements.inputOptimizer.addEventListener("change",()=>{this.elements.inputOptimizer.value==="sgd"?this.elements.momentumControl.classList.remove("hidden"):this.elements.momentumControl.classList.add("hidden")}),this.elements.inputMomentum.addEventListener("input",()=>{this.elements.momentumValue.textContent=this.elements.inputMomentum.value})}async handleInitialise(){const t=parseFloat(this.elements.inputLr.value);if(isNaN(t)||t<=0){p.warning("Please enter a valid learning rate (positive number).");return}let e;try{e=this.parseLayersInput(this.elements.inputLayers.value)}catch(f){p.warning(f instanceof Error?f.message:"Invalid layer configuration");return}const s=this.elements.inputOptimizer.value,i=parseFloat(this.elements.inputMomentum.value)||.9,n=this.elements.inputActivation.value,o=parseFloat(this.elements.inputL1.value)||0,a=parseFloat(this.elements.inputL2.value)||0,r=parseInt(this.elements.inputNumClasses.value,10)||2,c=parseFloat(this.elements.inputDropout.value)||0,h=parseFloat(this.elements.inputClipNorm.value)||0,m=this.elements.inputBatchNorm.checked,u=this.parseLayerActivations(this.elements.inputLayerActivations.value),d={learningRate:t,layers:e,optimizer:s,momentum:i,activation:n,layerActivations:u.length>0?u:void 0,l1Regularization:o,l2Regularization:a,numClasses:r,dropoutRate:c,clipNorm:h,batchNorm:m};this.elements.btnInit.disabled=!0,this.elements.btnInit.textContent="Initialising...";try{await this.session.setHyperparameters(d),this.applyTrainingConfig(),this.callbacks.onNetworkUpdate(),p.success(`Network initialized with ${s.toUpperCase()} optimizer!`)}catch(f){console.error("Failed to initialise network:",f),p.error(`Failed to initialise network: ${f instanceof Error?f.message:"Unknown error"}`)}finally{this.elements.btnInit.disabled=!1,this.elements.btnInit.textContent="Initialise Network"}}applyTrainingConfig(){const t=parseInt(this.elements.inputBatchSize.value,10)||0,e=parseInt(this.elements.inputMaxEpochs.value,10)||0,s=parseInt(this.elements.inputFps.value,10)||60,i=this.elements.inputLrSchedule.value,n=parseInt(this.elements.inputWarmup.value,10)||0,o=parseInt(this.elements.inputCycleLength.value,10)||20,a=parseFloat(this.elements.inputMinLr.value)||.001,r=parseInt(this.elements.inputEarlyStop.value,10)||0;this.session.setTrainingConfig({batchSize:t,maxEpochs:e,targetFps:s,lrSchedule:{type:i,decayRate:.95,decaySteps:10,warmupEpochs:n,cycleLength:o,minLR:a},earlyStoppingPatience:r})}handleLrScheduleChange(){const t=this.elements.inputLrSchedule.value;t==="cyclic_triangular"||t==="cyclic_cosine"?this.elements.cyclicLrControls.classList.remove("hidden"):this.elements.cyclicLrControls.classList.add("hidden"),this.applyTrainingConfig()}handleFpsChange(){const t=parseInt(this.elements.inputFps.value,10)||60;this.elements.fpsValue.textContent=t.toString(),this.session.setTrainingConfig({targetFps:t})}handleBatchSizeChange(){const t=parseInt(this.elements.inputBatchSize.value,10)||0;this.session.setTrainingConfig({batchSize:t})}handleMaxEpochsChange(){const t=parseInt(this.elements.inputMaxEpochs.value,10)||0;this.session.setTrainingConfig({maxEpochs:t})}handleValSplitChange(){const t=parseInt(this.elements.inputValSplit.value,10);this.session.setTrainingConfig({validationSplit:t/100})}handleStart(){try{re("suggestions-panel"),this.session.start()}catch(t){console.error("Failed to start training:",t),p.error(`Failed to start: ${t instanceof Error?t.message:"Unknown error"}`)}}handlePause(){this.session.pause()}async handleStep(){if(!this.elements.btnStep.disabled){this.elements.btnStep.disabled=!0;try{await this.session.step(),await new Promise(t=>requestAnimationFrame(t))}catch(t){console.error("Step failed:",t),p.error(`Step failed: ${t instanceof Error?t.message:"Unknown error"}`)}finally{const t=this.session.getState();this.elements.btnStep.disabled=!t.isInitialised||!t.datasetLoaded||t.isRunning}}}handleReset(){this.session.reset(),this.callbacks.onClearVisualization(),this.callbacks.onDismissSuggestions()}updateUI(t){this.elements.epochValue.textContent=t.currentEpoch.toString(),this.elements.lossValue.textContent=t.currentLoss?.toFixed(4)??"",this.elements.accuracyValue.textContent=t.currentAccuracy?`${(t.currentAccuracy*100).toFixed(1)}%`:"",this.elements.valLossValue.textContent=t.currentValLoss?.toFixed(4)??"",this.elements.valAccuracyValue.textContent=t.currentValAccuracy?`${(t.currentValAccuracy*100).toFixed(1)}%`:"";let e="Idle";t.isRunning&&!t.isPaused?e="Training":t.isPaused?e="Paused":t.isInitialised&&t.datasetLoaded&&(e="Ready"),this.elements.stateDisplay.textContent=e;const s=t.isInitialised&&t.datasetLoaded&&(!t.isRunning||t.isPaused);t.isRunning&&!t.isPaused?(this.elements.btnStart.classList.add("hidden"),this.elements.btnPause.classList.remove("hidden"),this.elements.btnPause.disabled=!1,this.elements.btnStep.disabled=!0,this.elements.btnStartSticky.classList.add("hidden"),this.elements.btnPauseSticky.classList.remove("hidden"),this.elements.btnPauseSticky.disabled=!1,this.elements.btnStepSticky.disabled=!0,this.elements.fabStart.classList.add("hidden"),this.elements.fabPause.classList.remove("hidden")):(this.elements.btnStart.classList.remove("hidden"),this.elements.btnPause.classList.add("hidden"),this.elements.btnPause.disabled=!0,this.elements.btnStep.disabled=!s,this.elements.btnStartSticky.classList.remove("hidden"),this.elements.btnPauseSticky.classList.add("hidden"),this.elements.btnPauseSticky.disabled=!0,this.elements.btnStepSticky.disabled=!s,this.elements.fabStart.classList.remove("hidden"),this.elements.fabPause.classList.add("hidden"));const i=t.isInitialised&&(!t.isRunning||t.isPaused);this.elements.btnReset.disabled=!i,this.elements.btnResetSticky.disabled=!i,this.elements.btnStart.disabled=!s,this.elements.btnStartSticky.disabled=!s,this.elements.fabStart.classList.toggle("opacity-50",!s),this.elements.fabStart.classList.toggle("pointer-events-none",!s)}parseLayersInput(t){return t.split(",").map(e=>parseInt(e.trim(),10)).filter(e=>!isNaN(e)&&e>0)}parseLayerActivations(t){if(!t||t.trim()==="")return[];const e=["linear","relu","sigmoid","tanh","leaky_relu","elu","selu","softmax"];return t.split(",").map(s=>s.trim().toLowerCase()).filter(s=>e.includes(s))}}const he="modulepreload",de=function(l){return"/NeuroViz/"+l},ft={},ue=function(t,e,s){let i=Promise.resolve();if(e&&e.length>0){let o=function(c){return Promise.all(c.map(h=>Promise.resolve(h).then(m=>({status:"fulfilled",value:m}),m=>({status:"rejected",reason:m}))))};document.getElementsByTagName("link");const a=document.querySelector("meta[property=csp-nonce]"),r=a?.nonce||a?.getAttribute("nonce");i=o(e.map(c=>{if(c=de(c),c in ft)return;ft[c]=!0;const h=c.endsWith(".css"),m=h?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${c}"]${m}`))return;const u=document.createElement("link");if(u.rel=h?"stylesheet":he,h||(u.as="script"),u.crossOrigin="",u.href=c,r&&u.setAttribute("nonce",r),document.head.appendChild(u),h)return new Promise((d,f)=>{u.addEventListener("load",d),u.addEventListener("error",()=>f(new Error(`Unable to preload CSS for ${c}`)))})}))}function n(o){const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=o,window.dispatchEvent(a),!a.defaultPrevented)throw o}return i.then(o=>{for(const a of o||[])a.status==="rejected"&&n(a.reason);return t().catch(n)})};class me{svg;width;height;margin={top:20,right:20,bottom:30,left:40};constructor(t){I(t).selectAll("*").remove();const e=t.getBoundingClientRect();this.width=e.width||300,this.height=e.height||150,this.svg=I(t).append("svg").attr("width","100%").attr("height","100%").attr("viewBox",`0 0 ${this.width} ${this.height}`).attr("preserveAspectRatio","xMidYMid meet").attr("class","gradient-flow-chart")}render(t){const{layerGradients:e,layerNames:s,maxGradient:i}=t;if(e.length===0)return;const n=this.width-this.margin.left-this.margin.right,o=this.height-this.margin.top-this.margin.bottom;this.svg.selectAll("*").remove();const a=this.svg.append("g").attr("transform",`translate(${this.margin.left},${this.margin.top})`),r=_t().domain(s).range([0,n]).padding(.2),c=B().domain([0,i>0?i:1]).range([o,0]),h=Et(Ot).domain([0,i>0?i:1]);e.forEach((y,v)=>{const L=s[v]??`L${v}`,b=(r.bandwidth()??20)/Math.max(y.length,1),E=r(L)??0;y.forEach((k,A)=>{const z=E+A*b,$=o-c(k);a.append("rect").attr("x",z).attr("y",c(k)).attr("width",Math.max(b-1,2)).attr("height",$).attr("fill",h(k)).attr("opacity",.8).attr("rx",1),k>i*.7&&a.append("rect").attr("x",z).attr("y",c(k)).attr("width",Math.max(b-1,2)).attr("height",$).attr("fill","none").attr("stroke","#fff").attr("stroke-width",1).attr("opacity",0).attr("rx",1).transition().duration(500).attr("opacity",.5).transition().duration(500).attr("opacity",0)})}),a.append("g").attr("transform",`translate(0,${o})`).call(N(r)).selectAll("text").attr("fill","#94a3b8").attr("font-size","10px"),a.append("g").call(_(c).ticks(4).tickFormat(P(".2f"))).selectAll("text").attr("fill","#94a3b8").attr("font-size","10px"),this.svg.append("text").attr("x",this.width/2).attr("y",12).attr("text-anchor","middle").attr("fill","#94a3b8").attr("font-size","11px").text("Gradient Magnitudes by Layer");const m=80,u=10,d=this.width-m-10,f=5,g=this.svg.append("defs").append("linearGradient").attr("id","gradient-legend").attr("x1","0%").attr("x2","100%");g.append("stop").attr("offset","0%").attr("stop-color",h(0)),g.append("stop").attr("offset","100%").attr("stop-color",h(i)),this.svg.append("rect").attr("x",d).attr("y",f).attr("width",m).attr("height",u).attr("fill","url(#gradient-legend)").attr("rx",2)}clear(){this.svg.selectAll("*").remove()}}function pe(l,t,e){const s=[];let i=0;for(let o=0;o<t.length;o++){const a=l[o]??[],r=t[o]??[],c=[],h=r[0]?.length??0;for(let m=0;m<h;m++){let u=0;const d=r.length;for(let w=0;w<d;w++){const g=a[w]?.[m]??0,v=((r[w]?.[m]??0)-g)/e;u+=v*v}const f=Math.sqrt(u/d);c.push(f),i=Math.max(i,f)}s.push(c)}const n=s.map((o,a)=>a===0?"InputH1":a===s.length-1?`H${a}Out`:`H${a}H${a+1}`);return{layerGradients:s,layerNames:n,maxGradient:i}}class ge{svg;width;height;margin={top:20,right:10,bottom:20,left:40};colorScale=Et(Vt).domain([0,1]);constructor(t){const e=t.getBoundingClientRect();this.width=e.width||300,this.height=e.height||100,I(t).selectAll("*").remove(),this.svg=I(t).append("svg").attr("width","100%").attr("height","100%").attr("viewBox",`0 0 ${this.width} ${this.height}`).attr("preserveAspectRatio","xMidYMid meet")}render(t,e){if(t.length===0)return;const s=this.width-this.margin.left-this.margin.right,i=this.height-this.margin.top-this.margin.bottom;this.svg.selectAll("*").remove();const n=this.svg.append("g").attr("transform",`translate(${this.margin.left},${this.margin.top})`),o=t.length,a=Math.max(...t.map(L=>L.length)),r=s/o,c=Math.min(i/a,15);t.forEach((L,b)=>{const E=n.append("g").attr("transform",`translate(${b*r}, 0)`),k=L.length*c,A=(i-k)/2;L.forEach(($,X)=>{const J=Math.max(0,Math.min(1,$));E.append("rect").attr("x",2).attr("y",A+X*c).attr("width",r-4).attr("height",c-2).attr("rx",2).attr("fill",this.colorScale(J)).attr("stroke","var(--border-color)").attr("stroke-width",.5).append("title").text(`Layer ${b+1}, Neuron ${X+1}: ${$.toFixed(4)}`)});const z=e?.[b]??`L${b+1}`;E.append("text").attr("x",r/2).attr("y",i+12).attr("text-anchor","middle").attr("fill","var(--text-secondary)").attr("font-size","8px").text(z)});const h=60,m=8,u=s-h,d=-15,f=B().domain([0,1]).range([0,h]),w=N(f).ticks(3).tickSize(3),g=n.append("g").attr("transform",`translate(${u}, ${d})`),v=this.svg.append("defs").append("linearGradient").attr("id","activation-gradient").attr("x1","0%").attr("x2","100%");v.append("stop").attr("offset","0%").attr("stop-color",this.colorScale(0)),v.append("stop").attr("offset","100%").attr("stop-color",this.colorScale(1)),g.append("rect").attr("width",h).attr("height",m).attr("fill","url(#activation-gradient)"),g.append("g").attr("transform",`translate(0, ${m})`).call(w).selectAll("text").attr("fill","var(--text-muted)").attr("font-size","6px"),g.selectAll(".domain, .tick line").attr("stroke","var(--text-muted)")}clear(){this.svg.selectAll("*").remove()}}class fe{constructor(t,e,s,i){this.session=t,this.neuralNetService=e,this.visualizerService=s,this.elements=i,this.bindEvents()}gradientFlow=null;activationHeatmap=null;threeViz=null;previousWeights=[];bindEvents(){this.elements.inputColourScheme.addEventListener("change",()=>this.handleColourSchemeChange()),this.elements.inputPointSize.addEventListener("change",()=>this.handlePointSizeChange()),this.elements.inputOpacity.addEventListener("input",()=>this.handleOpacityChange()),this.elements.inputContours.addEventListener("input",()=>this.handleContourChange()),this.elements.inputZoom.addEventListener("change",()=>this.handleZoomToggle()),this.elements.inputTooltips.addEventListener("change",()=>this.handleTooltipsToggle()),this.elements.input3dView&&this.elements.input3dView.addEventListener("change",()=>void this.handle3dViewToggle()),this.elements.btn3dReset&&this.elements.btn3dReset.addEventListener("click",()=>this.threeViz?.resetCamera()),this.elements.btn3dTop&&this.elements.btn3dTop.addEventListener("click",()=>this.threeViz?.setTopView()),this.elements.btn3dSide&&this.elements.btn3dSide.addEventListener("click",()=>this.threeViz?.setSideView()),this.elements.inputShowGradients&&this.elements.inputShowGradients.addEventListener("change",()=>this.handleGradientToggle()),this.elements.inputShowActivations&&this.elements.inputShowActivations.addEventListener("change",()=>this.handleActivationToggle())}handleColourSchemeChange(){const t=this.elements.inputColourScheme.value;this.visualizerService.setConfig({colourScheme:t})}handlePointSizeChange(){const t=parseInt(this.elements.inputPointSize.value,10)||5;this.visualizerService.setConfig({pointRadius:t})}handleOpacityChange(){const t=parseInt(this.elements.inputOpacity.value,10)/100;this.elements.opacityValue.textContent=this.elements.inputOpacity.value,this.visualizerService.setConfig({boundaryOpacity:t})}handleContourChange(){const t=parseInt(this.elements.inputContours.value,10);this.elements.contourValue.textContent=this.elements.inputContours.value,this.visualizerService.setConfig({contourCount:t})}handleZoomToggle(){this.visualizerService.setConfig({zoomEnabled:this.elements.inputZoom.checked})}handleTooltipsToggle(){this.visualizerService.setConfig({tooltipsEnabled:this.elements.inputTooltips.checked})}async handle3dViewToggle(){if(!(!this.elements.input3dView||!this.elements.threeContainer))if(this.elements.input3dView.checked){if(this.elements.threeContainer.classList.remove("hidden"),!this.threeViz)try{const{ThreeVisualization:t}=await ue(async()=>{const{ThreeVisualization:e}=await import("./index-oeJjMs7Z.js");return{ThreeVisualization:e}},[]);this.threeViz=new t(this.elements.threeContainer),p.success("3D view enabled")}catch(t){console.error("Failed to load 3D visualization:",t),p.error("Failed to load 3D visualization"),this.elements.input3dView.checked=!1,this.elements.threeContainer.classList.add("hidden");return}await this.update3dView()}else this.elements.threeContainer.classList.add("hidden")}async update3dView(){if(!this.threeViz||!this.elements.input3dView?.checked)return;const t=this.session.getState();if(!(!t.isInitialised||!t.datasetLoaded))try{const e=rt.visualization.gridSize,s=[];for(let r=0;r<e;r++)for(let c=0;c<e;c++)s.push({x:-1+2*c/(e-1),y:-1+2*r/(e-1),label:0});const n=(await this.neuralNetService.predict(s)).map(r=>({x:r.x,y:r.y,confidence:r.confidence,predictedClass:r.predictedClass}));this.threeViz.renderSurface(n,e);const a=this.session.getData().map(r=>({x:r.x,y:r.y,label:r.label}));this.threeViz.renderPoints(a)}catch(e){console.error("Failed to update 3D view:",e)}}handleGradientToggle(){!this.elements.inputShowGradients||!this.elements.gradientFlowContainer||(this.elements.inputShowGradients.checked?(this.elements.gradientFlowContainer.classList.remove("hidden"),this.gradientFlow||(this.gradientFlow=new me(this.elements.gradientFlowContainer)),this.previousWeights=this.neuralNetService.getWeightMatrices()):this.elements.gradientFlowContainer.classList.add("hidden"))}updateGradientFlow(){if(!this.elements.inputShowGradients?.checked||!this.gradientFlow)return;const t=this.neuralNetService.getWeightMatrices();if(this.previousWeights.length===0||t.length===0){this.previousWeights=t;return}const e=this.session.getCurrentLearningRate(),s=pe(this.previousWeights,t,e);this.gradientFlow.render(s),this.previousWeights=t}handleActivationToggle(){!this.elements.inputShowActivations||!this.elements.activationHeatmap||(this.elements.inputShowActivations.checked?(this.elements.activationHeatmap.classList.remove("hidden"),this.elements.activationHint&&this.elements.activationHint.classList.remove("hidden"),this.activationHeatmap||(this.activationHeatmap=new ge(this.elements.activationHeatmap)),this.updateActivationHeatmap()):(this.elements.activationHeatmap.classList.add("hidden"),this.elements.activationHint&&this.elements.activationHint.classList.add("hidden")))}updateActivationHeatmap(){if(!this.elements.inputShowActivations?.checked||!this.activationHeatmap)return;const t=this.neuralNetService.getStructure();if(!t)return;const e=t.layers.map((s,i)=>Array(s).fill(0).map(()=>Math.random()));this.activationHeatmap.render(e)}}function ye(l,t,e){const s=[];if(s.push('"""'),s.push("Neural Network Configuration - Generated by NeuroViz"),s.push(`Generated: ${new Date().toISOString()}`),s.push('"""'),s.push(""),s.push("import numpy as np"),s.push("import tensorflow as tf"),s.push("from tensorflow import keras"),s.push("from tensorflow.keras import layers, regularizers, optimizers"),s.push("from tensorflow.keras.callbacks import EarlyStopping, LearningRateScheduler"),s.push("from sklearn.datasets import make_circles, make_moons, make_blobs, make_classification"),s.push("from sklearn.model_selection import train_test_split"),s.push("from sklearn.preprocessing import StandardScaler"),s.push(""),e){switch(s.push("# Generate dataset"),s.push(`n_samples = ${e.samples}`),s.push(`noise = ${e.noise}`),s.push(""),e.datasetType){case"circle":s.push("X, y = make_circles(n_samples=n_samples, noise=noise, factor=0.5)");break;case"xor":s.push("X, y = make_classification(n_samples=n_samples, n_features=2, n_redundant=0,"),s.push("                           n_informative=2, n_clusters_per_class=1, flip_y=noise)");break;case"spiral":s.push("# Spiral dataset"),s.push("theta = np.sqrt(np.random.rand(n_samples // 2)) * 2 * np.pi"),s.push("r_a = 2 * theta + np.pi"),s.push("r_b = -2 * theta - np.pi"),s.push("X = np.vstack(["),s.push("    np.column_stack([r_a * np.cos(theta), r_a * np.sin(theta)]),"),s.push("    np.column_stack([r_b * np.cos(theta), r_b * np.sin(theta)])"),s.push("]) + np.random.randn(n_samples, 2) * noise"),s.push("y = np.hstack([np.zeros(n_samples // 2), np.ones(n_samples // 2)])");break;case"moons":s.push("X, y = make_moons(n_samples=n_samples, noise=noise)");break;case"clusters":s.push(`X, y = make_blobs(n_samples=n_samples, centers=${l.numClasses}, cluster_std=noise * 2)`);break;default:s.push("X, y = make_circles(n_samples=n_samples, noise=noise, factor=0.5)")}s.push(""),s.push("# Normalize features"),s.push("scaler = StandardScaler()"),s.push("X = scaler.fit_transform(X)"),s.push(""),s.push("# Train/test split"),s.push("X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42)"),s.push("")}s.push("# Build model"),s.push("model = keras.Sequential(["),s.push("    layers.Input(shape=(2,)),");const i=l.layers,n=l.activation??"relu",o=l.layerActivations??[];for(let c=0;c<i.length;c++){const h=i[c],m=o[c]??n,u=[];l.l1Regularization&&l.l1Regularization>0&&u.push(`l1=${l.l1Regularization}`),l.l2Regularization&&l.l2Regularization>0&&u.push(`l2=${l.l2Regularization}`);const d=u.length>0?`, kernel_regularizer=regularizers.L1L2(${u.join(", ")})`:"";s.push(`    layers.Dense(${h}, activation='${m}'${d}),`),l.batchNorm&&s.push("    layers.BatchNormalization(),"),l.dropoutRate&&l.dropoutRate>0&&s.push(`    layers.Dropout(${l.dropoutRate}),`)}const a=l.numClasses??2;a===2?s.push("    layers.Dense(1, activation='sigmoid')"):s.push(`    layers.Dense(${a}, activation='softmax')`),s.push("])"),s.push(""),s.push("# Configure optimizer");const r=l.learningRate;switch(l.optimizer){case"sgd":{const c=l.momentum??.9;s.push(`optimizer = optimizers.SGD(learning_rate=${r}, momentum=${c})`);break}case"adam":s.push(`optimizer = optimizers.Adam(learning_rate=${r})`);break;case"rmsprop":s.push(`optimizer = optimizers.RMSprop(learning_rate=${r})`);break;case"adagrad":s.push(`optimizer = optimizers.Adagrad(learning_rate=${r})`);break;default:s.push(`optimizer = optimizers.Adam(learning_rate=${r})`)}if(s.push(""),s.push("# Compile model"),a===2?s.push("model.compile(optimizer=optimizer, loss='binary_crossentropy', metrics=['accuracy'])"):s.push("model.compile(optimizer=optimizer, loss='sparse_categorical_crossentropy', metrics=['accuracy'])"),s.push(""),t&&t.type!=="none"){switch(s.push("# Learning rate schedule"),t.type){case"exponential":s.push(`def lr_schedule(epoch):
    initial_lr = ${r}
    decay_rate = 0.95
    return initial_lr * (decay_rate ** epoch)`);break;case"step":s.push(`def lr_schedule(epoch):
    initial_lr = ${r}
    drop_rate = 0.5
    epochs_drop = 50
    return initial_lr * (drop_rate ** (epoch // epochs_drop))`);break;case"cosine":s.push(`def lr_schedule(epoch, total_epochs=500):
    initial_lr = ${r}
    return initial_lr * 0.5 * (1 + np.cos(np.pi * epoch / total_epochs))`);break;case"cyclic_triangular":s.push(`def lr_schedule(epoch):
    initial_lr = ${r}
    min_lr = ${t.minLR??.001}
    cycle_length = ${t.cycleLength??20}
    cycle_position = epoch % cycle_length
    if cycle_position < cycle_length / 2:
        return min_lr + (initial_lr - min_lr) * (2 * cycle_position / cycle_length)
    else:
        return initial_lr - (initial_lr - min_lr) * (2 * (cycle_position - cycle_length / 2) / cycle_length)`);break;default:s.push(`def lr_schedule(epoch):
    return ${r}`)}s.push(""),s.push("lr_callback = LearningRateScheduler(lr_schedule)"),s.push("")}return s.push("# Callbacks"),s.push("callbacks = ["),s.push("    EarlyStopping(monitor='val_loss', patience=20, restore_best_weights=True),"),t&&t.type!=="none"&&s.push("    lr_callback,"),s.push("]"),s.push(""),s.push("# Train model"),s.push("history = model.fit("),s.push("    X_train, y_train,"),s.push("    validation_data=(X_test, y_test),"),s.push("    epochs=500,"),s.push("    batch_size=32,"),s.push("    callbacks=callbacks,"),s.push("    verbose=1"),s.push(")"),s.push(""),s.push("# Evaluate"),s.push("test_loss, test_acc = model.evaluate(X_test, y_test, verbose=0)"),s.push("print(f'Test accuracy: {test_acc:.4f}')"),s.push(""),s.push("# Model summary"),s.push("model.summary()"),s.join(`
`)}function ve(l,t,e,s){const i=[],n=[];let o="input";for(let a=0;a<l.length-1;a++){const r=l[a]??2,c=l[a+1]??1,h=e[a]??[],m=s[a]??[],u=t[a+1]??"relu",d=`layer${a}_weight`,f=`layer${a}_bias`,w=`layer${a}_matmul`,g=`layer${a}_add`,y=a===l.length-2?"output":`layer${a}_activation`,v=[];for(let b=0;b<c;b++)for(let E=0;E<r;E++)v.push(h[E]?.[b]??0);n.push({name:d,shape:[c,r],data:v}),n.push({name:f,shape:[c],data:m.length>0?m:Array(c).fill(0)}),i.push({name:`${w}_node`,opType:"Gemm",inputs:[o,d,f],outputs:[g],attributes:{alpha:1,beta:1,transB:1}});const L=be(u);L!=="Identity"?(i.push({name:`${y}_node`,opType:L,inputs:[g],outputs:[y]}),o=y):o=g}return{opsetVersion:13,producerName:"NeuroViz",producerVersion:"1.0.0",inputs:[{name:"input",shape:[-1,l[0]??2],dataType:"float32"}],outputs:[{name:"output",shape:[-1,l[l.length-1]??1],dataType:"float32"}],nodes:i,initializers:n}}function be(l){switch(l.toLowerCase()){case"relu":return"Relu";case"sigmoid":return"Sigmoid";case"tanh":return"Tanh";case"elu":return"Elu";case"softmax":return"Softmax";case"linear":case"none":default:return"Identity"}}function we(l){const t=l.inputs[0]?.shape??[-1,2],e=l.outputs[0]?.shape??[-1,1];return`"""
ONNX Model Generator
Generated by NeuroViz - https://github.com/your-repo/neuroviz

This script creates an ONNX model from the exported NeuroViz configuration.
Requires: pip install onnx numpy
"""

import numpy as np
import onnx
from onnx import helper, TensorProto

# Model metadata
opset_version = ${l.opsetVersion}
producer_name = "${l.producerName}"
producer_version = "${l.producerVersion}"

# Create initializers (weights and biases)
initializers = []
${l.initializers.map(s=>`
# ${s.name}
${s.name}_data = np.array(${JSON.stringify(s.data)}, dtype=np.float32).reshape(${JSON.stringify(s.shape)})
initializers.append(helper.make_tensor(
    name="${s.name}",
    data_type=TensorProto.FLOAT,
    dims=${JSON.stringify(s.shape)},
    vals=${s.name}_data.flatten().tolist()
))
`).join("")}

# Create nodes
nodes = []
${l.nodes.map(s=>`
nodes.append(helper.make_node(
    "${s.opType}",
    inputs=${JSON.stringify(s.inputs)},
    outputs=${JSON.stringify(s.outputs)},
    name="${s.name}"${s.attributes?`,
    **${JSON.stringify(s.attributes)}`:""}
))
`).join("")}

# Create input/output
input_tensor = helper.make_tensor_value_info("input", TensorProto.FLOAT, ${JSON.stringify(t)})
output_tensor = helper.make_tensor_value_info("output", TensorProto.FLOAT, ${JSON.stringify(e)})

# Create graph
graph = helper.make_graph(
    nodes,
    "neuroviz_model",
    [input_tensor],
    [output_tensor],
    initializers
)

# Create model
model = helper.make_model(graph, opset_imports=[helper.make_opsetid("", opset_version)])
model.producer_name = producer_name
model.producer_version = producer_version

# Validate and save
onnx.checker.check_model(model)
onnx.save(model, "neuroviz_model.onnx")
print("Model saved to neuroviz_model.onnx")

# Test inference (optional)
try:
    import onnxruntime as ort
    session = ort.InferenceSession("neuroviz_model.onnx")
    test_input = np.random.randn(1, ${t[1]??2}).astype(np.float32)
    result = session.run(None, {"input": test_input})
    print(f"Test inference successful. Output shape: {result[0].shape}")
except ImportError:
    print("Install onnxruntime to test inference: pip install onnxruntime")
`}function Ee(l,t="generate_onnx.py"){const e=we(l),s=new Blob([e],{type:"text/x-python"}),i=URL.createObjectURL(s),n=document.createElement("a");n.href=i,n.download=t,n.click(),URL.revokeObjectURL(i)}class Le{constructor(t,e,s,i,n){this.session=t,this.neuralNetService=e,this.visualizerService=s,this.elements=i,this.callbacks=n,this.bindEvents()}pendingModelJson=null;bindEvents(){this.elements.btnExportJson.addEventListener("click",()=>this.handleExportJson()),this.elements.btnExportCsv.addEventListener("click",()=>this.handleExportCsv()),this.elements.btnExportPng.addEventListener("click",()=>this.handleExportPng()),this.elements.btnExportSvg.addEventListener("click",()=>this.handleExportSvg()),this.elements.btnScreenshot.addEventListener("click",()=>this.handleScreenshot()),this.elements.btnExportModel.addEventListener("click",()=>void this.handleExportModel()),this.elements.btnExportPython.addEventListener("click",()=>this.handleExportPython()),this.elements.btnExportOnnx.addEventListener("click",()=>this.handleExportOnnx()),this.elements.inputLoadModel.addEventListener("change",t=>this.handleLoadModelJson(t)),this.elements.inputLoadWeights.addEventListener("change",t=>void this.handleLoadModelWeights(t))}handleExportJson(){const t=this.session.exportHistory("json");this.downloadFile(t,"training-history.json","application/json"),p.success("Training history exported as JSON")}handleExportCsv(){const t=this.session.exportHistory("csv");this.downloadFile(t,"training-history.csv","text/csv"),p.success("Training history exported as CSV")}handleExportPng(){this.visualizerService.exportAsPNG("neuroviz-boundary"),p.success("Decision boundary exported as PNG")}handleExportSvg(){this.visualizerService.exportAsSVG("neuroviz-boundary"),p.success("Decision boundary exported as SVG")}handleScreenshot(){const t=this.session.getState(),e={Epoch:t.currentEpoch.toString(),Loss:t.currentLoss?.toFixed(4)??"",Accuracy:t.currentAccuracy?`${(t.currentAccuracy*100).toFixed(1)}%`:"",LR:this.elements.inputLr.value,Layers:this.elements.inputLayers.value,Optimizer:this.elements.inputOptimizer.value,Activation:this.elements.inputActivation.value,Batch:this.elements.inputBatchSize.value||"all",Dropout:this.elements.inputDropout.value==="0"?"none":this.elements.inputDropout.value,L1:this.elements.inputL1.value||"0",L2:this.elements.inputL2.value||"0","Val Split":`${this.elements.inputValSplit.value}%`};this.visualizerService.exportAsPNGWithMetadata("neuroviz-screenshot",e),p.success("Screenshot with metadata exported")}handleExportPython(){if(!this.session.getState().isInitialised){p.warning("Please initialise a model first");return}const e=this.parseLayersInput(this.elements.inputLayers.value),s=this.parseLayerActivations(this.elements.inputLayerActivations.value),i={learningRate:parseFloat(this.elements.inputLr.value),layers:e,optimizer:this.elements.inputOptimizer.value,momentum:parseFloat(this.elements.inputMomentum.value)||.9,activation:this.elements.inputActivation.value,layerActivations:s.length>0?s:void 0,l1Regularization:parseFloat(this.elements.inputL1.value)||0,l2Regularization:parseFloat(this.elements.inputL2.value)||0,numClasses:parseInt(this.elements.inputNumClasses.value,10)||2,dropoutRate:parseFloat(this.elements.inputDropout.value)||0,clipNorm:parseFloat(this.elements.inputClipNorm.value)||0,batchNorm:this.elements.inputBatchNorm.checked},n={type:this.elements.inputLrSchedule.value,warmupEpochs:parseInt(this.elements.inputWarmup.value,10)||0,cycleLength:parseInt(this.elements.inputCycleLength.value,10)||20,minLR:parseFloat(this.elements.inputMinLr.value)||.001},o={samples:parseInt(this.elements.inputSamples.value,10)||200,noise:(parseInt(this.elements.inputNoise.value,10)||10)/100,datasetType:this.elements.datasetSelect.value},a=ye(i,n,o),r=new Blob([a],{type:"text/x-python"}),c=URL.createObjectURL(r),h=document.createElement("a");h.href=c,h.download=`neuroviz-model-${Date.now()}.py`,h.click(),URL.revokeObjectURL(c),p.success("Python code exported")}handleExportOnnx(){if(!this.session.getState().isInitialised){p.warning("Please initialise a model first");return}const e=this.parseLayersInput(this.elements.inputLayers.value),s=parseInt(this.elements.inputNumClasses.value,10)||2,i=[2,...e,s],n=this.parseLayerActivations(this.elements.inputLayerActivations.value),o=this.elements.inputActivation.value,a=["linear",...e.map((m,u)=>n[u]??o),s>2?"softmax":"sigmoid"],r=this.neuralNetService.getWeightMatrices(),c=r.map(m=>{const u=m[0]?.length??1;return Array(u).fill(0)}),h=ve(i,a,r,c);Ee(h,`neuroviz-onnx-${Date.now()}.py`),p.success("ONNX export script downloaded. Run with Python to generate .onnx file.")}async handleExportModel(){if(!this.session.getState().isInitialised){p.warning("Please initialise a model first");return}try{const{modelJson:e,weightsBlob:s}=await this.neuralNetService.exportModel(),i=URL.createObjectURL(e),n=document.createElement("a");n.href=i,n.download="model.json",n.click(),URL.revokeObjectURL(i);const o=URL.createObjectURL(s),a=document.createElement("a");a.href=o,a.download="weights.bin",a.click(),URL.revokeObjectURL(o),p.success("Model exported (model.json + weights.bin)")}catch(e){console.error("Failed to export model:",e),p.error("Failed to export model")}}handleLoadModelJson(t){const e=t.target,s=e.files?.[0];s&&(this.pendingModelJson=s,this.elements.inputLoadWeights.click(),e.value="")}async handleLoadModelWeights(t){const e=t.target,s=e.files?.[0];if(!s||!this.pendingModelJson){this.pendingModelJson=null;return}try{p.info("Loading model..."),await this.neuralNetService.loadModel(this.pendingModelJson,s),p.success("Model loaded successfully"),this.callbacks.onModelLoaded()}catch(i){console.error("Failed to load model:",i),p.error("Failed to load model. Ensure files are valid TF.js format.")}finally{this.pendingModelJson=null,e.value=""}}downloadFile(t,e,s){const i=new Blob([t],{type:s}),n=URL.createObjectURL(i),o=document.createElement("a");o.href=n,o.download=e,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(n)}parseLayersInput(t){return t.split(",").map(e=>parseInt(e.trim(),10)).filter(e=>!isNaN(e)&&e>0)}parseLayerActivations(t){if(!t||t.trim()==="")return[];const e=["linear","relu","sigmoid","tanh","leaky_relu","elu","selu","softmax"];return t.split(",").map(s=>s.trim().toLowerCase()).filter(s=>e.includes(s))}}const nt="neuroviz-session",yt="neuroviz-bookmarks",vt="neuroviz-theme";class Se{constructor(t,e,s,i,n){this.session=t,this.visualizerService=e,this.storage=s,this.elements=i,this.callbacks=n,this.bindEvents(),this.initTheme(),this.renderBookmarkOptions()}bindEvents(){this.elements.btnSaveSession.addEventListener("click",()=>this.saveSession()),this.elements.btnLoadSession.addEventListener("click",()=>void this.loadSession()),this.elements.btnClearSession.addEventListener("click",()=>this.clearSession()),this.elements.btnShareUrl.addEventListener("click",()=>this.handleShareUrl()),this.elements.btnLoadConfig.addEventListener("click",()=>this.handleLoadConfigCode()),this.elements.btnSaveBookmark.addEventListener("click",()=>this.handleSaveBookmark()),this.elements.btnDeleteBookmark.addEventListener("click",()=>this.handleDeleteBookmark()),this.elements.btnThemeToggle.addEventListener("click",()=>this.handleThemeToggle()),this.elements.presetSelect.addEventListener("change",()=>{const t=this.elements.presetSelect.value;if(t.startsWith("bookmark:")){const e=t.replace("bookmark:",""),i=this.loadBookmarks().find(n=>n.id===e);i&&(this.applyBookmarkConfig(i),this.elements.btnDeleteBookmark.disabled=!1)}else this.elements.btnDeleteBookmark.disabled=!0})}initTheme(){const t=this.storage.getItem(vt).data,e=t==="light"||t==="dark"?t:window.matchMedia("(prefers-color-scheme: light)").matches?"light":"dark";this.applyTheme(e)}applyTheme(t){const e=document.documentElement;t==="dark"?(e.classList.add("dark"),document.body.removeAttribute("data-theme"),this.elements.iconSun.classList.remove("hidden"),this.elements.iconMoon.classList.add("hidden")):(e.classList.remove("dark"),document.body.setAttribute("data-theme","light"),this.elements.iconSun.classList.add("hidden"),this.elements.iconMoon.classList.remove("hidden")),this.storage.setItem(vt,t),this.callbacks.onThemeChanged(t)}handleThemeToggle(){const e=document.documentElement.classList.contains("dark")?"light":"dark";this.applyTheme(e),p.info(`Switched to ${e} theme`)}collectSessionConfig(){return{datasetType:this.elements.datasetSelect.value,samples:parseInt(this.elements.inputSamples.value,10)||200,noise:parseInt(this.elements.inputNoise.value,10)||10,numClasses:parseInt(this.elements.inputNumClasses.value,10)||2,learningRate:parseFloat(this.elements.inputLr.value)||.03,layers:this.elements.inputLayers.value,optimizer:this.elements.inputOptimizer.value,activation:this.elements.inputActivation.value,l2Regularization:parseFloat(this.elements.inputL2.value)||0,batchSize:parseInt(this.elements.inputBatchSize.value,10)||0,maxEpochs:parseInt(this.elements.inputMaxEpochs.value,10)||0,targetFps:parseInt(this.elements.inputFps.value,10)||60,validationSplit:parseInt(this.elements.inputValSplit.value,10)/100,colourScheme:this.elements.inputColourScheme.value,pointSize:this.elements.inputPointSize.value,opacity:parseInt(this.elements.inputOpacity.value,10),zoomEnabled:this.elements.inputZoom.checked,tooltipsEnabled:this.elements.inputTooltips.checked}}saveSession(){try{const t={version:1,timestamp:Date.now(),config:this.collectSessionConfig(),data:this.session.getData(),history:this.session.getHistory()};this.storage.setItem(nt,t),p.success("Session saved successfully!")}catch(t){console.error("Failed to save session:",t),p.error("Failed to save session")}}async loadSession(){try{const t=this.storage.getItem(nt);if(!t.success||!t.data){p.info("No saved session found");return}const e=t.data;this.elements.datasetSelect.value=e.config.datasetType,this.elements.inputSamples.value=e.config.samples.toString(),this.elements.samplesValue.textContent=e.config.samples.toString(),this.elements.inputNoise.value=e.config.noise.toString(),this.elements.noiseValue.textContent=e.config.noise.toString(),this.elements.inputNumClasses.value=e.config.numClasses.toString(),this.elements.inputLr.value=e.config.learningRate.toString(),this.elements.inputLayers.value=e.config.layers,this.elements.inputOptimizer.value=e.config.optimizer,this.elements.inputActivation.value=e.config.activation,this.elements.inputL2.value=e.config.l2Regularization.toString(),this.elements.inputBatchSize.value=e.config.batchSize.toString(),this.elements.inputMaxEpochs.value=e.config.maxEpochs.toString(),this.elements.inputFps.value=e.config.targetFps.toString(),this.elements.fpsValue.textContent=e.config.targetFps.toString(),this.elements.inputValSplit.value=(e.config.validationSplit*100).toString(),this.elements.inputColourScheme.value=e.config.colourScheme,this.elements.inputPointSize.value=e.config.pointSize,this.elements.inputOpacity.value=e.config.opacity.toString(),this.elements.opacityValue.textContent=e.config.opacity.toString(),this.elements.inputZoom.checked=e.config.zoomEnabled,this.elements.inputTooltips.checked=e.config.tooltipsEnabled,this.callbacks.onConfigLoaded(),e.data&&e.data.length>0&&this.session.setCustomData(e.data),p.success("Session loaded successfully!")}catch(t){console.error("Failed to load session:",t),p.error("Failed to load session")}}clearSession(){this.storage.removeItem(nt),p.info("Saved session cleared")}loadBookmarks(){const t=this.storage.getItem(yt);return t.success&&t.data?t.data:[]}saveBookmarks(t){this.storage.setItem(yt,t)}renderBookmarkOptions(){const t=this.loadBookmarks();if(this.elements.presetSelect&&this.elements.presetSelect.options&&Array.from(this.elements.presetSelect.options).forEach(e=>{(e.value.startsWith("bookmark:")||e.text==="")&&e.remove()}),t.length>0){const e=document.createElement("option");e.disabled=!0,e.text="",this.elements.presetSelect.add(e),t.forEach(s=>{const i=document.createElement("option");i.value=`bookmark:${s.id}`,i.text=` ${s.name}`,this.elements.presetSelect.add(i)})}}handleSaveBookmark(){if(!this.elements.inputBookmarkName){p.warning("Bookmark feature not available");return}const t=this.elements.inputBookmarkName.value.trim();if(!t){p.warning("Please enter a name for the bookmark");return}const e={id:crypto.randomUUID(),name:t,createdAt:Date.now(),config:{datasetType:this.elements.datasetSelect.value,samples:parseInt(this.elements.inputSamples.value,10)||200,noise:parseInt(this.elements.inputNoise.value,10)||10,numClasses:parseInt(this.elements.inputNumClasses.value,10)||2,classBalance:parseInt(this.elements.inputBalance.value,10)||50,learningRate:parseFloat(this.elements.inputLr.value)||.03,layers:this.elements.inputLayers.value,optimizer:this.elements.inputOptimizer.value,activation:this.elements.inputActivation.value,l2Regularization:parseFloat(this.elements.inputL2.value)||0,batchSize:parseInt(this.elements.inputBatchSize.value,10)||0,maxEpochs:parseInt(this.elements.inputMaxEpochs.value,10)||0,targetFps:parseInt(this.elements.inputFps.value,10)||60,validationSplit:parseInt(this.elements.inputValSplit.value,10)/100}},s=this.loadBookmarks();s.push(e),this.saveBookmarks(s),this.renderBookmarkOptions(),this.elements.inputBookmarkName.value="",p.success(`Bookmark "${t}" saved!`)}handleDeleteBookmark(){const t=this.elements.presetSelect.value;if(!t.startsWith("bookmark:"))return;const e=t.replace("bookmark:",""),i=this.loadBookmarks().filter(n=>n.id!==e);this.saveBookmarks(i),this.renderBookmarkOptions(),this.elements.presetSelect.value="circle",this.elements.btnDeleteBookmark.disabled=!0,p.info("Bookmark deleted")}applyBookmarkConfig(t){const e=t.config;this.elements.datasetSelect.value=e.datasetType,this.elements.inputSamples.value=e.samples.toString(),this.elements.samplesValue.textContent=e.samples.toString(),this.elements.inputNoise.value=e.noise.toString(),this.elements.noiseValue.textContent=e.noise.toString(),this.elements.inputNumClasses.value=e.numClasses.toString(),this.elements.inputBalance.value=e.classBalance.toString(),this.elements.balanceValue.textContent=e.classBalance.toString(),this.elements.inputLr.value=e.learningRate.toString(),this.elements.inputLayers.value=e.layers,this.elements.inputOptimizer.value=e.optimizer,this.elements.inputActivation.value=e.activation,this.elements.inputL2.value=e.l2Regularization.toString(),this.elements.inputBatchSize.value=e.batchSize.toString(),this.elements.inputMaxEpochs.value=e.maxEpochs.toString(),this.elements.inputFps.value=e.targetFps.toString(),this.elements.fpsValue.textContent=e.targetFps.toString(),this.elements.inputValSplit.value=(e.validationSplit*100).toString(),this.callbacks.onConfigLoaded(),p.success(`Loaded bookmark: ${t.name}`)}handleShareUrl(){const t=this.collectSessionConfig(),e=JSON.stringify(t),s=btoa(e),i=`${window.location.origin}${window.location.pathname}?config=${s}`;navigator.clipboard.writeText(i).then(()=>{p.success("Configuration URL copied to clipboard!")}).catch(()=>{p.error("Failed to copy URL")})}handleLoadConfigCode(){const t=prompt("Paste configuration code here:");if(t)try{const e=atob(t),s=JSON.parse(e);s.datasetType&&(this.elements.datasetSelect.value=s.datasetType),s.learningRate&&(this.elements.inputLr.value=s.learningRate),s.layers&&(this.elements.inputLayers.value=s.layers),this.callbacks.onConfigLoaded(),p.success("Configuration loaded!")}catch(e){console.error("Invalid configuration code:",e),p.error("Invalid configuration code")}}}class xe{constructor(t){this.createModel=t}modelA=null;modelB=null;configA=null;configB=null;stateA=null;stateB=null;trainingData=[];validationData=[];async setupModelA(t){this.modelA=this.createModel(),await this.modelA.initialize(t.hyperparameters),this.configA=t,this.stateA={name:t.name,epoch:0,loss:null,accuracy:null,valLoss:null,valAccuracy:null,history:[],isTraining:!1}}async setupModelB(t){this.modelB=this.createModel(),await this.modelB.initialize(t.hyperparameters),this.configB=t,this.stateB={name:t.name,epoch:0,loss:null,accuracy:null,valLoss:null,valAccuracy:null,history:[],isTraining:!1}}setData(t,e){this.trainingData=t,this.validationData=e}async trainStep(){if(!this.modelA||!this.modelB||!this.stateA||!this.stateB||this.trainingData.length===0)return null;this.stateA.isTraining=!0;const t=await this.modelA.train(this.trainingData);if(this.stateA.epoch++,this.stateA.loss=t.loss,this.stateA.accuracy=t.accuracy,this.stateA.history.push({epoch:this.stateA.epoch,loss:t.loss,accuracy:t.accuracy}),this.validationData.length>0){const s=await this.modelA.evaluate(this.validationData);this.stateA.valLoss=s.loss,this.stateA.valAccuracy=s.accuracy}this.stateA.isTraining=!1,this.stateB.isTraining=!0;const e=await this.modelB.train(this.trainingData);if(this.stateB.epoch++,this.stateB.loss=e.loss,this.stateB.accuracy=e.accuracy,this.stateB.history.push({epoch:this.stateB.epoch,loss:e.loss,accuracy:e.accuracy}),this.validationData.length>0){const s=await this.modelB.evaluate(this.validationData);this.stateB.valLoss=s.loss,this.stateB.valAccuracy=s.accuracy}return this.stateB.isTraining=!1,this.getComparison()}getComparison(){if(!this.stateA||!this.stateB)return null;let t=null;const e="accuracy",s=this.stateA.valAccuracy??this.stateA.accuracy,i=this.stateB.valAccuracy??this.stateB.accuracy;return s!==null&&i!==null&&(s>i+.01?t="A":i>s+.01?t="B":t="tie"),{modelA:{...this.stateA},modelB:{...this.stateB},winner:t,metric:e}}async predictA(t){if(!this.modelA)throw new Error("Model A not initialized");return this.modelA.predict(t)}async predictB(t){if(!this.modelB)throw new Error("Model B not initialized");return this.modelB.predict(t)}reset(){this.stateA=this.stateA?{...this.stateA,epoch:0,loss:null,accuracy:null,valLoss:null,valAccuracy:null,history:[],isTraining:!1}:null,this.stateB=this.stateB?{...this.stateB,epoch:0,loss:null,accuracy:null,valLoss:null,valAccuracy:null,history:[],isTraining:!1}:null}dispose(){this.modelA=null,this.modelB=null,this.configA=null,this.configB=null,this.stateA=null,this.stateB=null}isReady(){return this.modelA!==null&&this.modelB!==null&&this.trainingData.length>0}getConfigA(){return this.configA}getConfigB(){return this.configB}}class ke{constructor(t,e=5){this.createModel=t,this.maxMembers=e}members=[];trainingData=[];validationData=[];isTraining=!1;currentEpoch=0;async addMember(t,e,s=1){if(this.members.length>=this.maxMembers)throw new Error(`Ensemble is full (max ${this.maxMembers} members)`);const i=`member-${Date.now()}-${Math.random().toString(36).slice(2,7)}`,n=this.createModel();return await n.initialize(e),this.members.push({id:i,name:t,model:n,config:e,weight:s,accuracy:null}),i}removeMember(t){const e=this.members.findIndex(s=>s.id===t);return e===-1?!1:(this.members.splice(e,1),!0)}setData(t,e){this.trainingData=t,this.validationData=e}async trainStep(){if(this.members.length===0||this.trainingData.length===0)return this.getState();this.isTraining=!0,this.currentEpoch++;for(const t of this.members){const e=await t.model.train(this.trainingData);if(this.validationData.length>0){const s=await t.model.evaluate(this.validationData);t.accuracy=s.accuracy}else t.accuracy=e.accuracy}return this.isTraining=!1,this.getState()}async predict(t){if(this.members.length===0)return t.map(s=>({x:s.x,y:s.y,predictedClass:0,confidence:0,memberPredictions:[],agreement:0}));const e=await Promise.all(this.members.map(s=>s.model.predict(t)));return t.map((s,i)=>{const n=this.members.map((d,f)=>{const w=e[f]?.[i];return{memberId:d.id,predictedClass:w?.predictedClass??0,confidence:w?.confidence??0,weight:d.weight}}),o=new Map;let a=0;for(const d of n){const f=o.get(d.predictedClass)??0;o.set(d.predictedClass,f+d.weight*d.confidence),a+=d.weight}let r=0,c=0;for(const[d,f]of o)f>c&&(c=f,r=d);const m=n.filter(d=>d.predictedClass===r).length/n.length,u=a>0?c/a:0;return{x:s.x,y:s.y,predictedClass:r,confidence:u,memberPredictions:n.map(d=>({memberId:d.memberId,predictedClass:d.predictedClass,confidence:d.confidence})),agreement:m}})}getState(){return{members:this.members.map(t=>({...t})),isTraining:this.isTraining,currentEpoch:this.currentEpoch}}getMemberCount(){return this.members.length}async reset(){this.currentEpoch=0;for(const t of this.members)await t.model.initialize(t.config),t.accuracy=null}dispose(){this.members=[],this.trainingData=[],this.validationData=[],this.isTraining=!1,this.currentEpoch=0}}class Ce{constructor(t,e){this.session=t,this.elements=e,this.bindEvents()}baseline=null;abComparison=null;abTrainingInterval=null;abTargetEpochs=100;ensemble=null;ensembleTrainingInterval=null;bindEvents(){this.elements.btnSaveBaseline.addEventListener("click",()=>this.handleSaveBaseline()),this.elements.btnClearBaseline.addEventListener("click",()=>this.handleClearBaseline()),this.elements.btnStartAbTest.addEventListener("click",()=>void this.handleStartAbTest()),this.elements.btnStopAbTest.addEventListener("click",()=>this.stopAbTest()),this.elements.btnAddEnsembleMember.addEventListener("click",()=>void this.addEnsembleMember()),this.elements.btnTrainEnsemble.addEventListener("click",()=>void this.toggleEnsembleTraining()),this.elements.btnResetEnsemble.addEventListener("click",()=>this.resetEnsemble())}handleSaveBaseline(){const t=this.session.getState();if(t.currentAccuracy===null||t.currentLoss===null){p.warning("Train a model first to set baseline");return}const e=`${this.elements.inputLayers.value} | ${this.elements.inputOptimizer.value} | LR ${this.elements.inputLr.value}`;this.baseline={accuracy:t.currentAccuracy,loss:t.currentLoss,config:e},this.elements.comparisonPanel.classList.remove("hidden"),this.elements.baselineAccuracy.textContent=`${(this.baseline.accuracy*100).toFixed(1)}%`,this.elements.baselineLoss.textContent=this.baseline.loss.toFixed(4),this.elements.baselineConfig.textContent=this.baseline.config,this.updateComparisonDisplay(),p.success("Baseline saved")}handleClearBaseline(){this.baseline=null,this.elements.comparisonPanel.classList.add("hidden"),p.info("Baseline cleared")}updateComparisonDisplay(){if(!this.baseline)return;const t=this.session.getState();if(t.currentAccuracy!==null&&(this.elements.currentAccuracy.textContent=`${(t.currentAccuracy*100).toFixed(1)}%`),t.currentLoss!==null&&(this.elements.currentLoss.textContent=t.currentLoss.toFixed(4)),t.currentAccuracy!==null&&t.currentLoss!==null){const e=(t.currentAccuracy-this.baseline.accuracy)*100,s=t.currentLoss-this.baseline.loss,i=e>=0?"text-green-400":"text-red-400",n=s<=0?"text-green-400":"text-red-400",o=e>=0?"+":"",a=s>=0?"+":"";this.elements.comparisonDiff.innerHTML=U`
        <span class="${i}">${o}${e.toFixed(1)}% acc</span> |
        <span class="${n}">${a}${s.toFixed(4)} loss</span>
      `}}async handleStartAbTest(){if(!this.session.getState().datasetLoaded){p.warning("Please load a dataset first");return}this.stopAbTest();const e=this.elements.inputLayers.value.split(",").map(a=>parseInt(a.trim(),10)).filter(a=>!isNaN(a)&&a>0),s=[...e],i=parseInt(this.elements.inputNumClasses.value,10)||2,n={name:"Model A",hyperparameters:{learningRate:parseFloat(this.elements.abLrA.value)||.03,layers:e,activation:this.elements.abActivationA.value,optimizer:this.elements.abOptimizerA.value,numClasses:i}},o={name:"Model B",hyperparameters:{learningRate:parseFloat(this.elements.abLrB.value)||.1,layers:s,activation:this.elements.abActivationB.value,optimizer:this.elements.abOptimizerB.value,numClasses:i}};this.abTargetEpochs=parseInt(this.elements.abEpochs.value,10)||100,this.abComparison=new xe(()=>new at);try{await this.abComparison.setupModelA(n),await this.abComparison.setupModelB(o);const a=this.session.getData(),r=parseFloat(this.elements.inputValSplit.value)/100||.2,c=Math.floor(a.length*(1-r)),h=[...a].sort(()=>Math.random()-.5),m=h.slice(0,c),u=h.slice(c);this.abComparison.setData(m,u),this.elements.abComparisonPanel.classList.remove("hidden"),p.info("Starting A/B test...");let d=0;this.abTrainingInterval=setInterval(()=>{(async()=>{if(d>=this.abTargetEpochs){this.stopAbTest(),this.determineAbWinner();return}d++;const f=await this.abComparison?.trainStep();f&&this.updateAbDisplay(f,d)})().catch(f=>{console.error("A/B test training step failed:",f),p.error("A/B test training failed"),this.stopAbTest()})},100)}catch(a){console.error("Failed to start A/B test:",a),p.error("Failed to start A/B test")}}stopAbTest(){this.abTrainingInterval&&(clearInterval(this.abTrainingInterval),this.abTrainingInterval=null),this.elements.abComparisonPanel.classList.add("hidden")}updateAbDisplay(t,e){this.elements.abEpochA.textContent=e.toString(),this.elements.abEpochB.textContent=e.toString(),this.elements.abAccuracyA.textContent=`${((t.modelA.valAccuracy??0)*100).toFixed(1)}%`,this.elements.abLossA.textContent=(t.modelA.valLoss??0).toFixed(4),this.elements.abAccuracyB.textContent=`${((t.modelB.valAccuracy??0)*100).toFixed(1)}%`,this.elements.abLossB.textContent=(t.modelB.valLoss??0).toFixed(4)}determineAbWinner(){if(!this.abComparison)return;const t=this.abComparison.getComparison();if(!t)return;const e=t.modelA.valAccuracy??0,s=t.modelB.valAccuracy??0;let i="";e>s?(i=` Model A Wins! (+${((e-s)*100).toFixed(1)}%)`,this.elements.abWinner.className="mt-4 p-3 bg-blue-900/30 border border-blue-500/50 rounded text-center font-bold text-blue-300"):s>e?(i=` Model B Wins! (+${((s-e)*100).toFixed(1)}%)`,this.elements.abWinner.className="mt-4 p-3 bg-purple-900/30 border border-purple-500/50 rounded text-center font-bold text-purple-300"):(i="It's a Tie!",this.elements.abWinner.className="mt-4 p-3 bg-gray-800 border border-gray-600 rounded text-center font-bold text-gray-300"),this.elements.abWinner.textContent=i,this.elements.abWinner.classList.remove("hidden"),p.success(i)}async addEnsembleMember(){this.ensemble||(this.ensemble=new ke(()=>new at));const t=this.elements.inputLayers.value.split(",").map(i=>parseInt(i.trim(),10)).filter(i=>!isNaN(i)&&i>0),e=parseInt(this.elements.inputNumClasses.value,10)||2,s={learningRate:parseFloat(this.elements.inputLr.value)||.03,layers:t,activation:this.elements.inputActivation.value,optimizer:this.elements.inputOptimizer.value,numClasses:e};await this.ensemble.addMember(`Member ${this.ensemble.getMemberCount()+1}`,s),this.updateEnsembleDisplay(),p.success(`Added ensemble member ${this.ensemble.getMemberCount()}`)}async toggleEnsembleTraining(){if(this.ensembleTrainingInterval){clearInterval(this.ensembleTrainingInterval),this.ensembleTrainingInterval=null,this.elements.btnTrainEnsemble.textContent="Train Ensemble";return}if(!this.ensemble||this.ensemble.getMemberCount()===0){p.warning("Add ensemble members first");return}if(!this.session.getState().datasetLoaded){p.warning("Please load a dataset first");return}const e=this.session.getData(),s=parseFloat(this.elements.inputValSplit.value)/100||.2,i=Math.floor(e.length*(1-s)),n=[...e].sort(()=>Math.random()-.5),o=n.slice(0,i),a=n.slice(i);this.ensemble.setData(o,a),this.elements.btnTrainEnsemble.textContent="Stop Training";let r=0;this.ensembleTrainingInterval=setInterval(()=>{(async()=>{r++,this.elements.ensembleEpoch.textContent=r.toString(),await this.ensemble?.trainStep(),r%10===0&&p.info(`Ensemble Epoch ${r} complete`)})().catch(c=>{console.error("Ensemble training step failed:",c),p.error("Ensemble training failed"),clearInterval(this.ensembleTrainingInterval),this.ensembleTrainingInterval=null,this.elements.btnTrainEnsemble.textContent="Train Ensemble"})},100)}resetEnsemble(){this.ensembleTrainingInterval&&(clearInterval(this.ensembleTrainingInterval),this.ensembleTrainingInterval=null),this.ensemble=null,this.updateEnsembleDisplay(),p.info("Ensemble reset")}updateEnsembleDisplay(){const t=this.ensemble?this.ensemble.getMemberCount():0;this.elements.ensembleMemberCount.textContent=t.toString(),t>0?this.elements.ensemblePanel.classList.remove("hidden"):this.elements.ensemblePanel.classList.add("hidden")}}class Be{svg;width;height;margin={top:10,right:10,bottom:35,left:45};constructor(t){const e=t.getBoundingClientRect();this.width=e.width||300,this.height=e.height||150,I(t).selectAll("*").remove(),this.svg=I(t).append("svg").attr("width","100%").attr("height","100%").attr("viewBox",`0 0 ${this.width} ${this.height}`).attr("preserveAspectRatio","xMidYMid meet")}render(t,e){if(t.length===0)return;const s=this.width-this.margin.left-this.margin.right,i=this.height-this.margin.top-this.margin.bottom;this.svg.selectAll("*").remove();const n=this.svg.append("g").attr("transform",`translate(${this.margin.left},${this.margin.top})`),o=t.filter(d=>d.loss>0&&isFinite(d.loss)&&d.lr>0);if(o.length===0)return;const a=mt(o,d=>d.lr),r=mt(o,d=>d.loss),c=Ht().domain([a[0]*.9,a[1]*1.1]).range([0,s]),h=B().domain([r[0]*.9,r[1]*1.1]).range([i,0]),m=K().x(d=>c(d.lr)).y(d=>h(d.loss)).curve(Q);n.append("path").datum(o).attr("fill","none").attr("stroke","var(--accent-500)").attr("stroke-width",2).attr("d",m),e&&e>=a[0]&&e<=a[1]&&(n.append("line").attr("x1",c(e)).attr("y1",0).attr("x2",c(e)).attr("y2",i).attr("stroke","#22c55e").attr("stroke-width",2).attr("stroke-dasharray","4,4"),n.append("text").attr("x",c(e)+5).attr("y",15).attr("fill","#22c55e").attr("font-size","10px").text(`Best: ${e.toExponential(1)}`));const u=N(c).ticks(5,".0e");n.append("g").attr("transform",`translate(0,${i})`).call(u).selectAll("text").attr("fill","var(--text-secondary)").attr("font-size","9px"),n.selectAll(".domain, .tick line").attr("stroke","var(--border-color)"),n.append("g").call(_(h).ticks(5)).selectAll("text").attr("fill","var(--text-secondary)").attr("font-size","9px"),n.append("text").attr("x",s/2).attr("y",i+30).attr("text-anchor","middle").attr("fill","var(--text-secondary)").attr("font-size","10px").text("Learning Rate"),n.append("text").attr("transform","rotate(-90)").attr("x",-i/2).attr("y",-35).attr("text-anchor","middle").attr("fill","var(--text-secondary)").attr("font-size","10px").text("Loss")}clear(){this.svg.selectAll("*").remove()}}function Ie(l){if(l.length<10)return null;const t=l.filter(n=>n.loss>0&&isFinite(n.loss)&&n.lr>0);if(t.length<10)return null;let e=0,s=0;for(let n=1;n<t.length-1;n++){const o=t[n-1],a=t[n],r=t[n+1];if(!o||!a||!r)continue;const c=Math.log10(r.lr)-Math.log10(o.lr),m=(r.loss-o.loss)/c;m<s&&(s=m,e=n)}const i=Math.max(0,e-2);return t[i]?.lr??null}class Ae{constructor(t,e){this.session=t,this.elements=e,this.lrFinderViz=new Be(e.lrFinderContainer),this.bindEvents()}lrFinderViz;bindEvents(){this.elements.btnLrFinder.addEventListener("click",()=>void this.handleLRFinder()),this.elements.btnStopLrFinder&&this.elements.btnStopLrFinder.addEventListener("click",()=>this.handleStopLRFinder())}async handleLRFinder(){const t=this.session.getState();if(!t.datasetLoaded){p.warning("Please load a dataset first");return}if(t.isRunning){p.warning("Please stop training first");return}this.elements.lrFinderContainer.classList.remove("hidden"),this.elements.lrFinderResult.classList.add("hidden"),this.elements.lrFinderPanel&&this.elements.lrFinderPanel.classList.remove("hidden"),p.info("Running Learning Rate Finder...");try{const e=await this.session.runLRFinder(1e-5,1,50);this.lrFinderViz.render(e);const s=Ie(e);if(s){this.elements.lrFinderResult.classList.remove("hidden"),this.elements.lrFinderResult.innerHTML=U`
          <div class="flex items-center justify-between">
            <span>Optimal LR found: <strong>${s.toExponential(2)}</strong></span>
            <button id="btn-apply-lr" class="px-2 py-1 text-xs bg-blue-600 hover:bg-blue-500 rounded text-white">
              Apply
            </button>
          </div>
        `;const i=document.getElementById("btn-apply-lr");i&&i.addEventListener("click",()=>{this.elements.inputLr.value=s.toString(),p.success(`Applied learning rate: ${s.toExponential(2)}`)}),p.success(`LR Finder complete. Optimal: ${s.toExponential(2)}`)}else p.warning("Could not determine optimal LR")}catch(e){console.error("LR Finder failed:",e),p.error("LR Finder failed")}}handleStopLRFinder(){this.clear(),p.info("LR Finder stopped")}clear(){this.elements.lrFinderContainer.classList.add("hidden"),this.elements.lrFinderResult.classList.add("hidden"),this.elements.lrFinderPanel&&this.elements.lrFinderPanel.classList.add("hidden"),this.lrFinderViz.clear()}}function C(l,t){const e=document.getElementById(l);return e||(console.warn(`[DOM] Missing element: #${l}${t?` (expected ${t})`:""}`),null)}function F(l,t){const e=C(l,t);if(!e)throw new Error(`Critical element missing: #${l}`);return e}function ze(){return{datasetSelect:F("dataset-select","HTMLSelectElement"),btnLoadData:F("btn-load-data","HTMLButtonElement"),loadingOverlay:C("loading-overlay")||document.createElement("div"),drawControls:C("draw-controls")||document.createElement("div"),btnClearCustom:C("btn-clear-custom")||document.createElement("button"),datasetOptions:C("dataset-options")||document.createElement("div"),inputSamples:F("input-samples","HTMLInputElement"),samplesValue:F("samples-value","HTMLSpanElement"),inputNoise:F("input-noise","HTMLInputElement"),noiseValue:F("noise-value","HTMLSpanElement"),inputBalance:C("input-balance")||document.createElement("input"),balanceValue:C("balance-value")||document.createElement("span"),inputPreprocessing:C("input-preprocessing")||document.createElement("select"),inputNumClasses:F("input-num-classes","HTMLSelectElement"),drawClassButtons:C("draw-class-buttons")||document.createElement("div"),inputCsvUpload:C("input-csv-upload")||document.createElement("input"),btnDownloadDataset:C("btn-download-dataset")||document.createElement("button")}}function Te(){return{btnInit:document.getElementById("btn-init"),btnStart:document.getElementById("btn-start"),btnStep:document.getElementById("btn-step"),btnReset:document.getElementById("btn-reset"),inputLayers:document.getElementById("input-layers"),inputLayerActivations:document.getElementById("input-layer-activations"),inputLr:document.getElementById("input-lr"),inputOptimizer:document.getElementById("input-optimizer"),inputMomentum:document.getElementById("input-momentum"),inputActivation:document.getElementById("input-activation"),inputL1:document.getElementById("input-l1"),inputL2:document.getElementById("input-l2"),inputNumClasses:document.getElementById("input-num-classes"),inputDropout:document.getElementById("input-dropout"),inputClipNorm:document.getElementById("input-clip-norm"),inputBatchNorm:document.getElementById("input-batch-norm"),inputBatchSize:document.getElementById("input-batch-size"),inputMaxEpochs:document.getElementById("input-max-epochs"),epochValue:document.getElementById("status-epoch"),lossValue:document.getElementById("status-loss"),accuracyValue:document.getElementById("status-accuracy"),valLossValue:document.getElementById("status-val-loss"),valAccuracyValue:document.getElementById("status-val-accuracy"),stateDisplay:document.getElementById("status-state"),suggestionsPanel:document.getElementById("suggestions-panel"),suggestionsList:document.getElementById("suggestions-list"),momentumValue:document.getElementById("momentum-value"),momentumControl:document.getElementById("momentum-control"),inputFps:document.getElementById("input-fps"),fpsValue:document.getElementById("fps-value"),inputLrSchedule:document.getElementById("input-lr-schedule"),inputWarmup:document.getElementById("input-warmup"),inputCycleLength:document.getElementById("input-cycle-length"),inputMinLr:document.getElementById("input-min-lr"),inputEarlyStop:document.getElementById("input-early-stop"),cyclicLrControls:document.getElementById("cyclic-lr-controls"),inputValSplit:document.getElementById("input-val-split"),inputTargetFps:document.getElementById("input-perf-mode"),btnStartSticky:document.getElementById("btn-start-sticky"),btnPauseSticky:document.getElementById("btn-pause-sticky"),btnStepSticky:document.getElementById("btn-step-sticky"),btnResetSticky:document.getElementById("btn-reset-sticky"),fabStart:document.getElementById("fab-start"),fabPause:document.getElementById("fab-pause"),btnPause:document.getElementById("btn-pause")}}function Me(){return{inputColourScheme:document.getElementById("input-colour-scheme"),inputPointSize:document.getElementById("input-point-size"),inputOpacity:document.getElementById("input-opacity"),opacityValue:document.getElementById("opacity-value"),inputContours:document.getElementById("input-contours"),contourValue:document.getElementById("contour-value"),inputZoom:document.getElementById("input-zoom"),inputTooltips:document.getElementById("input-tooltips"),inputHighlightErrors:document.getElementById("input-highlight-errors"),inputConfidenceCircles:document.getElementById("input-confidence-circles"),inputNotifications:document.getElementById("input-notifications"),inputRecordEvolution:document.getElementById("input-record-evolution"),inputShowGrid:document.getElementById("input-show-grid"),inputShowDiscretized:document.getElementById("input-show-discretized"),inputVoronoi:document.getElementById("input-voronoi"),inputMisclassified:document.getElementById("input-misclassified"),inputConfidence:document.getElementById("input-confidence"),gradientFlowChart:document.getElementById("gradient-flow-chart"),confusionMatrix:document.getElementById("confusion-matrix"),weightHistogram:document.getElementById("weight-histogram"),rocCurve:document.getElementById("roc-curve"),input3dView:document.getElementById("input-3d-view"),threeContainer:document.getElementById("three-container"),btn3dReset:document.getElementById("btn-3d-reset"),btn3dTop:document.getElementById("btn-3d-top"),btn3dSide:document.getElementById("btn-3d-side"),inputShowGradients:document.getElementById("input-show-gradients"),gradientFlowContainer:document.getElementById("gradient-flow-container"),inputShowActivations:document.getElementById("input-show-activations"),activationHeatmap:document.getElementById("activation-heatmap"),activationHint:document.getElementById("activation-hint")}}function De(){return{btnExportJson:document.getElementById("btn-export-json"),btnExportCsv:document.getElementById("btn-export-csv"),btnExportPng:document.getElementById("btn-export-png"),btnExportSvg:document.getElementById("btn-export-svg"),btnScreenshot:document.getElementById("btn-screenshot"),btnExportModel:document.getElementById("btn-export-model"),btnExportPython:document.getElementById("btn-export-python"),btnExportOnnx:document.getElementById("btn-export-onnx"),inputLoadModel:document.getElementById("input-load-model"),inputLoadWeights:document.getElementById("input-load-weights"),inputLayers:document.getElementById("input-layers"),inputLayerActivations:document.getElementById("input-layer-activations"),inputLr:document.getElementById("input-lr"),inputOptimizer:document.getElementById("input-optimizer"),inputMomentum:document.getElementById("input-momentum"),inputActivation:document.getElementById("input-activation"),inputL1:document.getElementById("input-l1"),inputL2:document.getElementById("input-l2"),inputNumClasses:document.getElementById("input-num-classes"),inputDropout:document.getElementById("input-dropout"),inputClipNorm:document.getElementById("input-clip-norm"),inputBatchNorm:document.getElementById("input-batch-norm"),inputLrSchedule:document.getElementById("input-lr-schedule"),inputWarmup:document.getElementById("input-warmup"),inputCycleLength:document.getElementById("input-cycle-length"),inputMinLr:document.getElementById("input-min-lr"),inputSamples:document.getElementById("input-samples"),inputNoise:document.getElementById("input-noise"),datasetSelect:document.getElementById("dataset-select"),inputBatchSize:document.getElementById("input-batch-size"),inputMaxEpochs:document.getElementById("input-max-epochs"),inputValSplit:document.getElementById("input-val-split")}}function Re(){return{btnSaveSession:document.getElementById("btn-save-session"),btnLoadSession:document.getElementById("btn-load-session"),btnShareUrl:document.getElementById("btn-share-url"),btnLoadConfig:document.getElementById("btn-load-config"),btnClearSession:document.getElementById("btn-clear-session"),inputBookmarkName:document.getElementById("input-bookmark-name"),btnSaveBookmark:document.getElementById("btn-save-bookmark"),bookmarkOptions:document.getElementById("bookmark-options"),btnDeleteBookmark:document.getElementById("btn-delete-bookmark"),presetSelect:document.getElementById("preset-select"),iconSun:document.getElementById("icon-sun"),iconMoon:document.getElementById("icon-moon"),btnThemeToggle:document.getElementById("btn-theme-toggle"),datasetSelect:document.getElementById("dataset-select"),inputSamples:document.getElementById("input-samples"),samplesValue:document.getElementById("samples-value"),inputNoise:document.getElementById("input-noise"),noiseValue:document.getElementById("noise-value"),inputNumClasses:document.getElementById("input-num-classes"),inputLr:document.getElementById("input-lr"),inputLayers:document.getElementById("input-layers"),inputOptimizer:document.getElementById("input-optimizer"),inputActivation:document.getElementById("input-activation"),inputL2:document.getElementById("input-l2"),inputBatchSize:document.getElementById("input-batch-size"),inputMaxEpochs:document.getElementById("input-max-epochs"),inputFps:document.getElementById("input-target-fps"),fpsValue:document.getElementById("fps-value"),inputValSplit:document.getElementById("input-val-split"),inputColourScheme:document.getElementById("input-colour-scheme"),inputPointSize:document.getElementById("input-point-radius"),inputOpacity:document.getElementById("input-boundary-opacity"),opacityValue:document.getElementById("boundary-opacity-value"),inputZoom:document.getElementById("input-zoom"),inputTooltips:document.getElementById("input-tooltips"),inputBalance:document.getElementById("input-balance"),balanceValue:document.getElementById("balance-value"),inputMomentum:document.getElementById("input-momentum"),momentumValue:document.getElementById("momentum-value"),inputL1:document.getElementById("input-l1"),inputDropout:document.getElementById("input-dropout"),inputClipNorm:document.getElementById("input-clip-norm"),inputBatchNorm:document.getElementById("input-batch-norm"),inputLrSchedule:document.getElementById("input-lr-schedule"),inputWarmup:document.getElementById("input-warmup"),inputCycleLength:document.getElementById("input-cycle-length"),inputMinLr:document.getElementById("input-min-lr"),momentumControl:document.getElementById("momentum-control")}}function Ne(){return{comparisonPanel:document.getElementById("comparison-metrics"),baselineAccuracy:document.getElementById("baseline-accuracy"),baselineLoss:document.getElementById("baseline-loss"),baselineConfig:document.getElementById("baseline-config"),currentAccuracy:document.getElementById("current-accuracy"),currentLoss:document.getElementById("current-loss"),comparisonDiff:document.getElementById("comparison-diff"),btnSaveBaseline:document.getElementById("btn-save-baseline"),btnClearBaseline:document.getElementById("btn-clear-baseline"),comparisonMetrics:document.getElementById("comparison-metrics"),baselineMetrics:document.getElementById("baseline-metrics"),inputLayers:document.getElementById("input-layers"),inputOptimizer:document.getElementById("input-optimizer"),inputLr:document.getElementById("input-lr"),inputActivation:document.getElementById("input-activation"),inputNumClasses:document.getElementById("input-num-classes"),inputValSplit:document.getElementById("input-val-split"),abComparisonPanel:document.getElementById("ab-comparison-panel"),abEpochA:document.getElementById("ab-epoch-a"),abAccuracyA:document.getElementById("ab-accuracy-a"),abLossA:document.getElementById("ab-loss-a"),abEpochB:document.getElementById("ab-epoch-b"),abAccuracyB:document.getElementById("ab-accuracy-b"),abLossB:document.getElementById("ab-loss-b"),abWinner:document.getElementById("ab-winner"),abLrA:document.getElementById("ab-lr-a"),abActivationA:document.getElementById("ab-activation-a"),abOptimizerA:document.getElementById("ab-optimizer-a"),abLrB:document.getElementById("ab-lr-b"),abActivationB:document.getElementById("ab-activation-b"),abOptimizerB:document.getElementById("ab-optimizer-b"),abEpochs:document.getElementById("ab-epochs"),btnStartAbTest:document.getElementById("btn-start-ab"),btnStopAbTest:document.getElementById("btn-stop-ab"),ensemblePanel:document.getElementById("ensemble-panel"),ensembleMemberCount:document.getElementById("ensemble-member-count"),ensembleEpoch:document.getElementById("ensemble-epoch"),ensembleMembers:document.getElementById("ensemble-members"),btnAddEnsembleMember:document.getElementById("btn-add-ensemble-member"),btnTrainEnsemble:document.getElementById("btn-train-ensemble"),btnResetEnsemble:document.getElementById("btn-stop-ensemble")}}function $e(){return{btnLrFinder:document.getElementById("btn-lr-finder"),btnStopLrFinder:document.getElementById("btn-stop-lr-finder"),lrFinderContainer:document.getElementById("lr-finder-container"),lrFinderResult:document.getElementById("lr-finder-result"),lrFinderPanel:document.getElementById("lr-finder-panel"),inputLr:document.getElementById("input-lr")}}function Fe(){const l=document.querySelectorAll(".sidebar-tab"),t=document.querySelectorAll(".sidebar-panel");l.forEach(e=>{e.addEventListener("click",()=>{const s=e.getAttribute("data-target");s&&(l.forEach(i=>i.classList.remove("active")),e.classList.add("active"),t.forEach(i=>{i.id===s?i.classList.remove("hidden"):i.classList.add("hidden")}))})})}function Pe(){let l=0,t=0;document.addEventListener("touchstart",e=>{if(e.touches.length>0){const s=e.touches[0];s&&(l=s.screenX,t=s.screenY)}},{passive:!0}),document.addEventListener("touchend",e=>{if(e.changedTouches.length>0){const s=e.changedTouches[0];if(s){const i=s.screenX,n=s.screenY;_e(l,t,i,n)}}},{passive:!0})}function _e(l,t,e,s){const i=e-l,n=s-t,o=50;Math.abs(i)>Math.abs(n)?Math.abs(i)>o&&(i>0?document.dispatchEvent(new CustomEvent("swipe-right")):document.dispatchEvent(new CustomEvent("swipe-left"))):Math.abs(n)>o&&(n>0?document.dispatchEvent(new CustomEvent("swipe-down")):document.dispatchEvent(new CustomEvent("swipe-up")))}function Oe(){const l=document.getElementById("bottom-sheet"),t=document.getElementById("bottom-sheet-handle"),e=document.getElementById("bottom-sheet-overlay");if(!l||!t||!e)return;let s=0,i=0,n=!1;t.addEventListener("touchstart",o=>{if(o.touches.length>0){const a=o.touches[0];a&&(s=a.clientY,n=!0,l.style.transition="none")}},{passive:!0}),document.addEventListener("touchmove",o=>{if(n&&o.touches.length>0){const a=o.touches[0];if(a){i=a.clientY;const r=i-s;r>0&&(l.style.transform=`translateY(${r}px)`)}}},{passive:!0}),document.addEventListener("touchend",()=>{if(!n)return;n=!1,l.style.transition="transform 0.3s ease-out",i-s>100?bt():l.style.transform="translateY(0)"}),e.addEventListener("click",bt)}function bt(){const l=document.getElementById("bottom-sheet"),t=document.getElementById("bottom-sheet-overlay");l&&t&&(l.classList.add("translate-y-full"),l.style.transform="",t.classList.add("hidden"))}const wt=[{id:"getting-started",name:"Getting Started",description:"Learn the basics of NeuroViz",steps:[{id:"welcome",title:"Welcome to NeuroViz! ",content:"This interactive tutorial will guide you through the basics of training neural networks and visualizing decision boundaries.",position:"bottom"},{id:"dataset",title:"Step 1: Choose a Dataset",content:'Start by selecting a dataset. Try "Circle" for a simple classification problem, or "Spiral" for something more challenging.',target:"#dataset-select",position:"right"},{id:"load-data",title:"Step 2: Load the Data",content:`Click "Load Data" to generate the dataset. You'll see the data points appear on the chart.`,target:"#btn-load-data",position:"right"},{id:"architecture",title:"Step 3: Configure the Network",content:'Set the hidden layer sizes. For example, "8,8" creates two hidden layers with 8 neurons each. More layers = more complex boundaries.',target:"#input-layers",position:"right"},{id:"learning-rate",title:"Step 4: Set Learning Rate",content:"The learning rate controls how fast the network learns. Start with 0.03 - too high causes instability, too low is slow.",target:"#input-lr",position:"right"},{id:"initialize",title:"Step 5: Initialize",content:'Click "Initialise Network" to create the neural network with your settings.',target:"#btn-init",position:"right"},{id:"train",title:"Step 6: Start Training!",content:'Click "Start" to begin training. Watch the decision boundary evolve as the network learns!',target:"#btn-start",position:"right"},{id:"observe",title:"Observe the Training",content:"Watch the loss decrease and accuracy increase. The coloured regions show what the network predicts for each area.",target:"#chart",position:"left"},{id:"complete",title:"Congratulations! ",content:"You've trained your first neural network! Try experimenting with different datasets, architectures, and hyperparameters.",position:"bottom"}]},{id:"hyperparameters",name:"Understanding Hyperparameters",description:"Learn how each setting affects training",steps:[{id:"intro",title:"Hyperparameters Explained",content:"Hyperparameters are settings that control how your neural network learns. Let's explore each one.",position:"bottom"},{id:"layers",title:"Hidden Layers",content:'More layers allow the network to learn more complex patterns. "4,4" = 2 layers of 4 neurons. "8,8,8" = 3 layers of 8.',target:"#input-layers",position:"right"},{id:"activation",title:"Activation Function",content:"ReLU is fast and works well for most cases. Tanh can be better for data centered around zero. Sigmoid squashes values to 0-1.",target:"#input-activation",position:"right"},{id:"optimizer",title:"Optimizer",content:"Adam is a good default - it adapts the learning rate automatically. SGD with momentum is simpler but can work well too.",target:"#input-optimizer",position:"right"},{id:"regularization",title:"Regularization",content:"L1 and L2 regularization prevent overfitting by penalizing large weights. Dropout randomly disables neurons during training.",target:"#input-l2",position:"right"},{id:"batch-size",title:"Batch Size",content:"Smaller batches = noisier but faster updates. Larger batches = smoother but slower. 0 means use all data each step.",target:"#input-batch-size",position:"right"},{id:"experiment",title:"Experiment!",content:"The best way to learn is to experiment. Try changing one parameter at a time and observe how it affects training.",position:"bottom"}]},{id:"overfitting",name:"Recognizing Overfitting",description:"Learn to identify and fix overfitting",steps:[{id:"intro",title:"What is Overfitting?",content:"Overfitting occurs when your model memorizes the training data instead of learning general patterns. It performs well on training data but poorly on new data.",position:"bottom"},{id:"signs",title:"Signs of Overfitting",content:"Watch for: training accuracy much higher than validation accuracy, validation loss increasing while training loss decreases.",target:"#loss-chart-container",position:"left"},{id:"validation",title:"Enable Validation Split",content:"Set a validation split (e.g., 20%) to monitor how well your model generalizes to unseen data.",target:"#input-val-split",position:"right"},{id:"fix-dropout",title:"Fix: Add Dropout",content:"Dropout randomly disables neurons during training, forcing the network to learn more robust features.",target:"#input-dropout",position:"right"},{id:"fix-regularization",title:"Fix: Add Regularization",content:"L2 regularization penalizes large weights, encouraging simpler models that generalize better.",target:"#input-l2",position:"right"},{id:"fix-simplify",title:"Fix: Simplify Architecture",content:"Try using fewer layers or neurons. A simpler model is less likely to overfit.",target:"#input-layers",position:"right"},{id:"early-stopping",title:"Early Stopping",content:"Enable early stopping to automatically stop training when validation loss stops improving.",target:"#input-early-stopping",position:"right"}]}];class Ve{currentTutorial=null;currentStepIndex=0;overlay=null;tooltip=null;onComplete=null;constructor(){this.createOverlay(),this.createTooltip()}createOverlay(){this.overlay=document.createElement("div"),this.overlay.id="tutorial-overlay",this.overlay.className="fixed inset-0 bg-black/50 z-40 hidden",this.overlay.innerHTML=`
      <div id="tutorial-highlight" class="absolute border-2 border-accent-400 rounded-lg shadow-lg shadow-accent-400/30 transition-all duration-300"></div>
    `,document.body.appendChild(this.overlay)}createTooltip(){this.tooltip=document.createElement("div"),this.tooltip.id="tutorial-tooltip",this.tooltip.className="fixed z-50 bg-navy-800 border border-navy-600 rounded-lg shadow-xl p-4 max-w-sm hidden",this.tooltip.innerHTML=`
      <div class="flex items-start justify-between mb-2">
        <h3 id="tutorial-title" class="text-lg font-semibold text-white"></h3>
        <button id="tutorial-close" class="text-slate-400 hover:text-white">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <p id="tutorial-content" class="text-slate-300 text-sm mb-4"></p>
      <div class="flex items-center justify-between">
        <span id="tutorial-progress" class="text-xs text-slate-500"></span>
        <div class="flex gap-2">
          <button id="tutorial-prev" class="btn-secondary text-xs px-3 py-1">Previous</button>
          <button id="tutorial-next" class="btn-primary text-xs px-3 py-1">Next</button>
        </div>
      </div>
    `,document.body.appendChild(this.tooltip),document.getElementById("tutorial-close")?.addEventListener("click",()=>this.stop()),document.getElementById("tutorial-prev")?.addEventListener("click",()=>this.prev()),document.getElementById("tutorial-next")?.addEventListener("click",()=>this.next())}start(t,e){const s=wt.find(i=>i.id===t);return s?(this.currentTutorial=s,this.currentStepIndex=0,this.onComplete=e??null,this.overlay?.classList.remove("hidden"),this.tooltip?.classList.remove("hidden"),this.showStep(),!0):!1}stop(){this.currentTutorial=null,this.currentStepIndex=0,this.overlay?.classList.add("hidden"),this.tooltip?.classList.add("hidden")}showStep(){if(!this.currentTutorial||!this.tooltip)return;const t=this.currentTutorial.steps[this.currentStepIndex];if(!t)return;const e=document.getElementById("tutorial-title"),s=document.getElementById("tutorial-content"),i=document.getElementById("tutorial-progress"),n=document.getElementById("tutorial-prev"),o=document.getElementById("tutorial-next");e&&(e.textContent=t.title),s&&(s.textContent=t.content),i&&(i.textContent=`Step ${this.currentStepIndex+1} of ${this.currentTutorial.steps.length}`),n&&(n.disabled=this.currentStepIndex===0),o&&(o.textContent=this.currentStepIndex===this.currentTutorial.steps.length-1?"Finish":"Next"),this.positionTooltip(t),this.highlightTarget(t),t.action&&t.action()}positionTooltip(t){if(!this.tooltip)return;const e=t.target?document.querySelector(t.target):null,s=t.position??"bottom";if(e){const i=e.getBoundingClientRect(),n=this.tooltip.getBoundingClientRect(),o=16;let a=0,r=0;switch(s){case"top":a=i.top-n.height-o,r=i.left+(i.width-n.width)/2;break;case"bottom":a=i.bottom+o,r=i.left+(i.width-n.width)/2;break;case"left":a=i.top+(i.height-n.height)/2,r=i.left-n.width-o;break;case"right":a=i.top+(i.height-n.height)/2,r=i.right+o;break}a=Math.max(o,Math.min(window.innerHeight-n.height-o,a)),r=Math.max(o,Math.min(window.innerWidth-n.width-o,r)),this.tooltip.style.top=`${a}px`,this.tooltip.style.left=`${r}px`}else this.tooltip.style.top="50%",this.tooltip.style.left="50%",this.tooltip.style.transform="translate(-50%, -50%)"}highlightTarget(t){const e=document.getElementById("tutorial-highlight");if(e){if(t.target){const s=document.querySelector(t.target);if(s){const i=s.getBoundingClientRect(),n=4;e.style.top=`${i.top-n}px`,e.style.left=`${i.left-n}px`,e.style.width=`${i.width+n*2}px`,e.style.height=`${i.height+n*2}px`,e.style.display="block";return}}e.style.display="none"}}next(){this.currentTutorial&&(this.currentStepIndex<this.currentTutorial.steps.length-1?(this.currentStepIndex++,this.showStep()):(this.stop(),this.onComplete?.()))}prev(){this.currentStepIndex>0&&(this.currentStepIndex--,this.showStep())}getTutorials(){return wt}}const He=new Ve;function Ge(){localStorage.getItem("neuroviz-has-visited")||(localStorage.setItem("neuroviz-has-visited","true"),setTimeout(()=>{Ue()},1e3))}function Ue(){He.start("getting-started",()=>{S.info("Onboarding completed",{component:"Onboarding"})})}window.tf=Tt;const We=new xt;We.init();const je=new te,T=new at,M=new Zt("viz-container"),W=new Kt("loss-chart-container"),O=new Qt(C("network-diagram")||document.createElement("div")),Xe=new St,D=new qt(T,M,je),j=new le(D,M,ze()),Je=new ce(D,Te(),{onNetworkUpdate:()=>{const l=T.getStructure();l&&O.render(l.layers,l.activations,T.getWeightMatrices())},onClearVisualization:()=>{W.clear(),O.clear()},onDismissSuggestions:()=>oe("suggestions-panel")}),qe=new fe(D,T,M,Me());new Le(D,T,M,De(),{onModelLoaded:()=>{const l=T.getStructure();l&&O.render(l.layers,l.activations,T.getWeightMatrices()),M.renderData(D.getData())}});new Se(D,M,Xe,Re(),{onConfigLoaded:()=>{j.handleLoadData().catch(l=>{console.error("Failed to load data after config loaded:",l)})},onThemeChanged:l=>{document.documentElement.setAttribute("data-theme",l)}});const Ye=new Ce(D,Ne());new Ae(D,$e());D.onStateChange(l=>{if(Je.updateUI(l),W.update(l.history),Ye.updateComparisonDisplay(),qe.updateGradientFlow(),l.currentEpoch%5===0&&l.isRunning){const t=T.getStructure();t&&O.render(t.layers,t.activations,T.getWeightMatrices())}});Fe();Pe();Oe();Ge();ae();window.addEventListener("load",()=>{j.handleLoadData().catch(t=>{console.error("Failed to load initial dataset:",t)});const l=document.querySelector(".app-container");l&&l.classList.add("loaded")});window.addEventListener("beforeunload",()=>{"dispose"in j&&typeof j.dispose=="function"&&j.dispose(),"dispose"in M&&typeof M.dispose=="function"&&M.dispose(),"clear"in W&&typeof W.clear=="function"&&W.clear(),"clear"in O&&typeof O.clear=="function"&&O.clear()});
//# sourceMappingURL=index-B_w9MzxF.js.map
